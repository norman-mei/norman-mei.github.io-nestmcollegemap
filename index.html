             async function getNearbyTransitStopsHTML(lat, lng) {
            if (!google || !google.maps || !google.maps.places || !map || !lat || !lng) {
                return '';
            }

           const ICONS = {
    BUS: (
        `<svg class="transit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="5" width="18" height="12" rx="2.5" />
            <rect x="5" y="8" width="5" height="4" rx="0.8" />
            <rect x="14" y="8" width="5" height="4" rx="0.8" />
            <circle cx="8" cy="18" r="2" />
            <circle cx="16" cy="18" r="2" />
            <line x1="8" y1="17" x2="8" y2="15" />
            <line x1="16" y1="17" x2="16" y2="15" />
        </svg>`
    ),
    TRAIN: (
        `<svg class="transit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" fill-rule="evenodd" stroke="none">
            <path d="M9 22L7 14c0-5 3-10 5-10s5 5 5 10l-2 8h-6z M9 13v-5c0-2 6-2 6 0v5h-6z M11 16a1 1 0 1 1-2 0 1 1 0 0 1 2 0z M15 16a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
        </svg>`
    ),
    "LIGHT RAIL": (
        `<svg class="transit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 12h20" />
            <rect x="4" y="4" width="16" height="12" rx="2" />
            <path d="M12 4v12" />
            <circle cx="7" cy="18" r="2" />
            <circle cx="17" cy="18" r="2" />
            <path d="M10 8h4" />
        </svg>`
    ),
    SUBWAY: (
        `<svg class="transit-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="5" width="16" height="12" rx="2" />
            <path d="M8 5v12" />
            <path d="M16 5v12" />
            <circle cx="8" cy="17" r="1" />
            <circle cx="16" cy="17" r="1" />
            <path d="M10 9h4" />
            <path d="M2 12h20" />
            <path d="M8 2v3" />
            <path d="M16 2v3" />
        </svg>`
    )
};

            function getTransitDetails(place) {
                const types = place.types || [];
                let details = { type: 'Rail', color: '#0275d8', icon: ICONS.TRAIN, labelClass: 'rail' };

                if (types.includes('bus_station') || types.includes('bus_stop')) {
                    details = { type: 'Bus', color: '#d9534f', icon: ICONS.BUS, labelClass: 'bus' };
                } else if (types.includes('subway_station')) {
                    details = { type: 'Subway', color: '#4CAF50', icon: ICONS.TRAIN, labelClass: 'subway' };
                } else if (types.includes('light_rail_station')) {
                    details = { type: 'Light Rail', color: '#f59e0b', icon: ICONS.TRAIN, labelClass: 'light-rail' };
                }
                
                const lineMatch = place.displayName?.match(/\(([^)]+)\)/);
                details.lines = lineMatch ? lineMatch[1].split(',').map(s => s.trim()) : [];
                
                return details;
            }

            try {
                const { places } = await google.maps.places.Place.searchNearby({
                    fields: ['id', 'displayName', 'types', 'location'],
                    locationRestriction: { center: new google.maps.LatLng(lat, lng), radius: 1200 },
                    includedPrimaryTypes: ['transit_station'],
                    maxResultCount: 5,
                });

                if (!places || places.length === 0) return '';

                const departurePromises = places.map(place => fetchNextDepartureTime(place));
                const departureTimes = await Promise.all(departurePromises);

                let html = '<b>Nearby Transit Stops:</b><ul style="margin-top: 3px; margin-bottom: 3px; padding-left: 18px;">';

                places.forEach((place, index) => {
                    const details = getTransitDetails(place);
                    const departureTimestamp = departureTimes[index];
                    const gmapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.displayName)}&query_place_id=${place.id}`;
                    
                    let linesHtml = details.lines.map(line => `<span class="transit-line">${line}</span>`).join('');
                    const labelHtml = `<span class="transit-label ${details.labelClass}">${details.type}</span>`;
                    
                    let departureHtml = '';
                    if (departureTimestamp) {
                        const departureDate = new Date(departureTimestamp);
                        departureHtml = `<span class="transit-departure">Next: ${departureDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>`;
                    }

                    const cleanDisplayName = place.displayName.replace(/\s*\([^)]+\)$/, '').trim();

                    html += `
                        <li style="margin-bottom: 4px;">
                            ${linesHtml}
                            <a href="${gmapsUrl}" target="_blank" class="transit-stop-link" title="View on Google Maps">
                                ${details.icon.replace('currentColor', details.color)}
                                ${labelHtml}
                                ${cleanDisplayName}
                            </a>
                            ${departureHtml}
                        </li>
                    `;
                });

                html += '</ul>';
                return html;

            } catch (err) {
                console.warn('[Places API] Nearby search failed', err);
                return '';
            }
        }

        async function fetchNextDepartureTime(stop) {
            try {
                if (!stop || !stop.location) return Promise.resolve('');
                
                const directionsService = new google.maps.DirectionsService();
                const request = {
                    origin: stop.location, // DirectionsService can take a LatLng object directly
                    destination: stop.location, // Using the same origin and destination is a trick to get next departure
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {
                        departureTime: new Date(), // Use current time
                    }
                };

                return new Promise((resolve) => {
                    directionsService.route(request, (result, status) => {
                        if (status === google.maps.DirectionsStatus.OK) {
                            const leg = result.routes[0]?.legs[0];
                            const departureTime = leg?.departure_time?.value;
                            // The API returns seconds since epoch, convert to milliseconds for JS Date
                            resolve(departureTime ? departureTime * 1000 : '');
                        } else {
                            // Don't reject, just resolve with empty so Promise.all doesn't fail
                            console.warn(`[DirectionsService] failed for stop '${stop.displayName}' with status: ${status}`);
                            resolve(''); 
                        }
                    });
                });

            } catch (err) {
                console.warn('[DirectionsService] setup failed', err);
                return Promise.resolve(''); // Ensure a promise is always returned
            }
        }

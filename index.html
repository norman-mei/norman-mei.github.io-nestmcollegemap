<!DOCTYPE html>
<html lang="en">

    <script src="collegeCoordsAndInfo.js"></script>
    <script src="majorToAreaMapping.js"></script>
    <script src="normalizeCollegeName.js"></script>
     <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<head>
    <link rel="icon" href="photos/favicon/favicon.jpg" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEST+m Senior College Destinations Map ü¶Ö</title>
    <style>

    

/* when the panel is collapsed, go back to the very corner */
body .panel-desktop-hidden ~ .hamburger {
  left: .75rem;
}

.list-content li .social-icon-link svg,
.info-window-content .social-icon-link svg {
    width: 16px; /* Small size */
    height: 16px;
    vertical-align: middle;
    margin-left: 4px;
}
.list-content li .social-icon-link {
    text-decoration: none; /* Remove underline from link */
}

/* New Grad Class Info Box Styling */
#zoomed-grad-class-info {
    padding: 8px 12px;
    margin-bottom: 12px; /* Space below this box, before bio */
    border-radius: 5px;
    text-align: center;
    font-size: 1.05em;
    border: 1px solid #ddd; /* Light mode border */
    background-color: #111; /* Dark background for light mode */
    transition: background-color 0.3s, border-color 0.3s;
}

#zoomed-grad-class-info .grad-class-label {
    font-weight: bold;
    color: #f0f0f0; /* Light text for light mode (on dark background) */
    margin-right: 6px;
    transition: color 0.3s;
}

#zoomed-grad-class-info #zoomed-grad-class-value {
    font-weight: bold;
    /* Color will be set by JS using gradClassColors */
}

/* Dark Mode for Grad Class Info Box */
body.dark-mode #zoomed-grad-class-info {
    background-color: #f8f9fa; /* Light background for dark mode */
    border-color: #555;
}

body.dark-mode #zoomed-grad-class-info .grad-class-label {
    color: #222; /* Dark text for dark mode (on light background) */
}

/* Zoomed Info Panel for Senior Photo */
#zoomed-info-panel {
    position: fixed;
    right: 100px; /* Stays the same, ensures clearance from right arrow */
    top: 50%;
    transform: translateY(-50%);
    width: 500px; /* MODIFIED: Increased width from 280px */
    max-height: 80vh;
    overflow-y: auto;
    background-color: rgba(255, 255, 255, 0.92);
    color: #333;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 2020;
    font-size: 0.9em;
    line-height: 1.5;
    border: 1px solid #ccc;
    transition: background-color 0.3s, color 0.3s, border-color 0.3s, right .25s ease, width .25s ease; /* ADDED width to transition */
}
#zoomed-bio-caption-content {
    margin-top: 0;
    margin-bottom: 12px;
    white-space: pre-wrap; /* Respect line breaks in the caption */
}

#zoomed-social-links-container a {
    margin-right: 10px; /* Spacing between social icons */
    text-decoration: none;
    display: inline-block; /* Allows margin to work properly */
}
#zoomed-social-links-container svg {
    width: 28px; /* Medium size */
    height: 28px;
    vertical-align: middle;
}

body.dark-mode #zoomed-info-panel {
    background-color: rgba(40, 40, 40, 0.95); /* Darker background for dark mode */
    color: #e0e0e0;
    border-color: #555;
}


/* Ensure the main bottom caption is hidden when zoomed info panel is active */
#senior-photo-popup.zoomed-state.with-side-panel p#senior-photo-caption {
    display: none !important;
}


    /* Credits Section Styling */
    #credits {
        text-align: center;
        font-size: 0.8em;
        padding: 6px 15px;
        margin-top: -10px; /* Sits closely under the description-control */
        margin-bottom: 10px; /* Space before the next control */
        border-top: 1px solid #eee;
        position: relative;
        background-color: #f8f9fa; /* Light mode panel background default */
        color: #555; /* Subtler text color for light mode */
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    #credits a {
        text-decoration: none;
        vertical-align: middle;
        color: #007bff; /* Standard link color for light mode */
        font-weight: bold;
        transition: color 0.3s;
    }
    #credits a:hover {
        text-decoration: underline;
    }
    #credits svg {
        vertical-align: middle;
        fill: currentColor; /* Inherits color from the <a> tag */
        margin-right: 3px;
    }
    body.dark-mode #credits {
        color: #aaa;
        background-color: rgba(30,30,30,0.7);
        border-top-color: #444;
    }
    body.dark-mode #credits a {
        color: #ccc;
        font-weight: bold;
    }

    .grad-class-separator {
        height: 1px;
        background-color: #ccc;
        margin: 10px 5px;
        list-style-type: none;
        padding: 0;
    }
    body.dark-mode .grad-class-separator {
        background-color: #444;
    }
    .list-content.gallery-view .grad-class-separator {
        flex-basis: 100% !important; width: 100% !important; height: 1px !important;
        background-color: #ccc; margin: 15px 0 !important; padding: 0 !important;
        border: none !important; list-style-type: none !important; box-sizing: border-box !important;
        display: block !important; min-width: 0 !important; text-align: left !important;
        align-items: stretch !important;
    }
    body.dark-mode .list-content.gallery-view .grad-class-separator {
        background-color: #444 !important;
    }

    .honorary-suffix {
        font-weight: bold; font-style: normal; padding: 1px 4px; border-radius: 3px;
        background-color: rgba(0, 0, 0, 0.05); color: #333; margin-left: 4px;
        font-size: 0.9em; border: 1px solid rgba(0,0,0,0.1);
    }
    body.dark-mode .honorary-suffix {
        background-color: rgba(255, 255, 255, 0.1); color: #ddd;
        border-color: rgba(255,255,255,0.2);
    }

    html, body {
        height: 100%; margin: 0; padding: 0; font-family: sans-serif;
        background-color: #f8f9fa; color: #212529;
        transition: background-color 0.3s, color 0.3s; overflow: hidden;
    }
    #map-container {
        display: flex; height: 100%; width: 100%;
        position: relative; /* Context for absolute positioned hamburger */
    }

    /* CONTROLS PANEL / SIDEBAR / DRAWER */
    #controls-and-list-container {
        /* Desktop Default: Visible Sidebar */
        width: 30%;
        min-width: 250px; /* Minimum width it can be resized to */
        max-width: 60%;   /* Maximum width it can be resized to */
        height: 100%;
        background-color: #f8f9fa;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        padding: 10px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        position: relative; /* In normal flow on desktop by default */
        transform: translateX(0); /* Visible by default */
        transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s;
        z-index: 500; /* Below hamburger if it ever overlaps */
    }

    /* State for when hamburger hides the panel on DESKTOP */
    #controls-and-list-container.panel-desktop-hidden{
    transform: translateX(-100%);
    position: absolute;   /* remove from flex layout      */
    left: 0;              /* anchor for the slide-out     */
    top: 0;
    height: 100%;
}

    /* PANEL RESIZER (Desktop) */
    #panel-resizer {
        width: 14px;
        height: 100%;
        background-color: #ddd;
        cursor: col-resize;
        z-index: 501; /* Above panel content, below hamburger */
        display: flex; /* Visible by default on desktop */
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s, display 0s; /* Added display for smooth transition */
    }
    #panel-resizer::before {
        content: ""; display: block; width: 4px; height: 35px;
        background-image: repeating-linear-gradient(to bottom, #777, #777 3px, transparent 3px, transparent 7px);
        opacity: 0.5; transition: opacity 0.3s;
    }
    #panel-resizer:hover { background-color: #bbb; }
    /* State for when resizer is hidden because panel is hidden by hamburger on DESKTOP */
    #panel-resizer.resizer-desktop-hidden {
        display: none;
    }


    #map {
        flex-grow: 1; /* Takes remaining space */
        height: 100%;
        background-color: grey;
        position: relative;
    }

    /* HAMBURGER MENU ICON (Visible on all screen sizes) */
     /* HAMBURGER MENU ICON (Visible on all screen sizes) */
    /* HAMBURGER MENU ICON (Visible on all screen sizes) */
      .hamburger{
    position: absolute;
    top: .75rem;
    left: .75rem;           /* Default position (panel closed or mobile) */
    right: auto;
    width: 44px;
    height: 44px;
    font-size: 1.8rem;
    background: rgba(255,255,255,.85);
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 8px;
    line-height: 1;
    z-index: 1100;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    transition: background-color .3s, border-color .3s, color .3s, left .3s ease-out;
    /* margin-left: calc(var(--panel-width) + 14px + 12px); */ /* REMOVED THIS LINE */
}

body:not(.panel-desktop-hidden) .hamburger {
  left: .75rem !important;
  right: auto !important;   /* just in case another rule tries to set it */
}



    /* INFO WINDOW & GENERAL CONTROLS */
    .info-window-content { line-height: 1.4; max-width: 250px; }
    .info-window-content b { font-size: 1.1em; display: block; margin-bottom: 4px; }
    .info-window-content img { max-width: 100%; height: auto; display: block; margin-bottom: 8px; border-radius: 4px; border: none; }
    .info-window-content a { color: inherit; text-decoration: none; }
    .info-window-content a:hover { text-decoration: underline; cursor: pointer; }
    .info-window-type { color: #555; font-style: italic; }
    .info-window-grad-class { font-weight: bold; }

    .map-control { background-color: rgba(255, 255, 255, 0.9); padding: 10px 15px; margin-bottom: 10px; border: 1px solid #bbb; border-radius: 4px; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2); color: #222; box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; flex-shrink: 0;  }
    .map-control h4 { margin-top: 0; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; font-size: 1.1em; font-weight: bold; transition: border-color 0.3s; display: inline-block; margin-right: 10px; cursor: pointer; }
    .map-control h4::after { content: " [-]"; font-weight: normal; font-size: 0.9em; }
    .map-control h4.collapsed::after { content: " [+]"; }
    .map-control .control-content { display: block; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 2000px; opacity: 1; overflow: hidden; }
    .map-control .control-content.collapsed { max-height: 0; opacity: 0; margin-top:0; margin-bottom:0; padding-top:0; padding-bottom:0; border-top: none; }

    .tip-message { background-color: #eef5ff; border: 1px solid #b8d4ff; color: #31708f; padding: 8px 10px; margin-top: 8px; margin-bottom: 12px; border-radius: 4px; font-size: 0.85em; line-height: 1.4; position: relative; overflow: hidden; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    .dismiss-button { float: right; cursor: pointer; font-weight: bold; margin-left: 10px; padding: 0 5px; color: #a1a1a1; border-radius: 3px; line-height: 1.4; user-select: none; transition: color 0.2s, background-color 0.2s; }
    .dismiss-button:hover { color: #333; background-color: #e0e0e0; }

    #description-control {
    font-size: 1.0em;
    cursor: default;
    overflow: hidden; /* Keep an eye on this if hamburger overflows, but should be fine */
    padding: 10px 15px;
    text-align: center;
    background-color: purple;
    color: white;
    position: relative; /* Added for hamburger positioning */
}
    #description-control span { display: inline-block; line-height: 28px; vertical-align: middle; }

    #map-options-control { margin-bottom:10px; display: flex; justify-content: space-evenly; align-items: center; flex-wrap: wrap; }
    .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn, #showFaqBtn {
        font-size: 0.85em; padding: 5px 10px; margin: 5px; border: 1px solid #bbb; border-radius: 4px;
        background-color: rgba(245, 245, 245, 0.9); color: #222; cursor: pointer; user-select: none;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s; line-height: 1.5; flex-basis: auto; text-align: center;
        display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;
    }
    .dark-mode-toggle-control:hover, #toggleTransitBtn:hover, #toggleSatelliteViewBtn:hover, #zoomToVisibleBtn:hover, #clearAllFiltersBtn:hover, #toggleGalleryViewBtn:hover, #showFaqBtn:hover {
        background-color: rgba(230, 230, 230, 0.95);
    }

    #filter-control { font-size: 0.9em; }
    #filter-control .filter-header { margin-top: 0; margin-bottom: 6px; font-size: 1em; font-weight: bold; padding-bottom: 2px; border-bottom: 1px solid #ddd; }
    .filter-item { display: block; margin-bottom: 5px; cursor: pointer; }
    .filter-item label { margin-left: 5px; vertical-align: middle; cursor: pointer; }
    .filter-item input[type="checkbox"] { vertical-align: middle; cursor: pointer; }
    .filter-color-box { width: 12px; height: 12px; border: 1px solid #ccc; margin-right: 5px; display: inline-block; vertical-align: middle; transition: border-color 0.3s; }
    .filter-control-buttons { display: inline-block; vertical-align: middle; margin-bottom: 8px; margin-left: 5px; }
    .filter-control-buttons button { font-size: 0.8em; padding: 2px 6px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; }
    .filter-control-buttons button:hover { background-color: #e0e0e0; }

    #instagram-links-control { display: flex; justify-content: space-around; align-items: center; padding-top: 10px; margin-bottom: 8px; }
    .instagram-link-button { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: inherit; font-size: 0.8em; }
    .instagram-link-button svg.instagram-logo { width: 28px; height: 28px; margin-bottom: 3px; fill: #C13584; }
    body.dark-mode .instagram-link-button svg.instagram-logo { fill: #E1306C; }
    .instagram-link-button span { font-weight: bold; }

    #stats-table-control { font-size: 0.9em; margin-top: 10px; }
    #stats-table-control h4 { margin-bottom: 8px; }
    #stats-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    #stats-table th, #stats-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; font-size: 0.9em; }
    #stats-table th { background-color: #f0f0f0; font-weight: bold; }
    #stats-table td.row-header { text-align: left; font-weight: bold; background-color: #f9f9f9;}

    #major-summary-control { font-size: 0.9em; margin-top: 10px; }
    #major-summary-control h4 { margin-bottom: 8px; }
    #major-summary-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    #major-summary-table th, #major-summary-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 0.9em; }
    #major-summary-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
    #major-summary-table td:last-child { text-align: center; }
    #major-summary-table td:nth-last-child(2) { text-align: center; }

    #school-list-control { font-size: 0.9em; flex-grow: 1;  display: flex; flex-direction: column; overflow: hidden;  }
    .list-header-container { overflow: visible;  margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; transition: border-color 0.3s; flex-shrink: 0;  }
    .list-header-container h4 { float: left; margin-bottom: 0; border-bottom: none; padding-bottom: 0; line-height: 26px; }
    #toggleSchoolListBtn { float: right; font-size: 0.8em; padding: 3px 8px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; line-height: normal; vertical-align: middle; }
    #toggleSchoolListBtn:hover { background-color: #e0e0e0; }
    #schoolSearchContainer { float: right; width: 45%; position: relative;  }
    #schoolSearchInput { width: 100%; padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; box-sizing: border-box; }
    #searchSuggestions { position: absolute; top: 100%;  left: 0; right: 0; background-color: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 3px 3px; max-height: 150px;  overflow-y: auto; z-index: 1000;  box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;  }
    #searchSuggestions div { padding: 5px 8px; font-size: 0.9em; cursor: pointer; }
    #searchSuggestions div:hover { background-color: #eee; }

    #sort-controls-container { transition: border-color 0.3s; }
    body.dark-mode #sort-controls-container { border-bottom-color: #444; }
    body.dark-mode #sort-controls-container select { background-color: #333; border-color: #555; color: #e0e0e0; }
    #sort-controls-container optgroup { font-style: italic; }
    #sort-controls-container optgroup option { font-style: normal; }

    .school-list-collapsible-content { overflow-y: auto; flex-grow: 1; }
    .school-list-collapsible-content.hidden { display: none; }
    .list-content { overflow-y: auto; flex-grow: 1;  }
    .list-content ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
    .list-content li { padding: 3px 0; word-wrap: break-word; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s; position: relative; }
    .list-content li.list-item-highlight, .list-content li.current-selection-highlight { background-color: #d6eaff;  }
    body.dark-mode .list-content li.list-item-highlight, body.dark-mode .list-content li.current-selection-highlight { background-color: #2a3950; }
    .list-content li input[type="checkbox"] { margin-right: 6px; flex-shrink: 0; cursor: pointer; vertical-align: middle; }
    .list-content li span.school-name { flex-grow: 1; vertical-align: middle; line-height: 1.4;  }
    .list-content a { color: #007bff; text-decoration: none; }
    .list-content a:hover { text-decoration: underline; }
    .list-item-major { font-size: 0.85em; color: #555; margin-left: 3px; }
    #no-results-message { padding: 10px; text-align: center; font-style: italic; color: #777; display: none; }
    body.dark-mode #no-results-message { color: #aaa; }

    /* GALLERY VIEW STYLES */
    .list-content.gallery-view ul { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 10px; padding-top: 5px; }
    .list-content.gallery-view li:not(.grad-class-separator) {
        flex-direction: column; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;
        flex-grow: 0; flex-shrink: 1; flex-basis: calc((100% - 2 * 10px) / 3); min-width: 150px;
        box-sizing: border-box; margin-bottom: 10px; position: relative; height: 180px; justify-content: flex-start;
    }
    body.dark-mode .list-content.gallery-view li:not(.grad-class-separator) { border-color: #444; }
    .list-content.gallery-view li:not(.grad-class-separator) > input[type="checkbox"] {
        position: absolute; top: 4px; right: 4px; z-index: 2; margin: 0;
    }
    .gallery-grad-class-overlay {
        position: absolute; top: 4px; left: 0; right: 0; text-align: center; font-size: 1.6em; font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3), -1px -1px 2px rgba(0,0,0,0.3);
        z-index: 1; pointer-events: none; line-height: 1;
    }
    .list-content.gallery-view li .gallery-photo-div {
        width: calc(100% - 8px); height: calc(100% - 30px); margin-top: 28px;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .list-content.gallery-view li .gallery-photo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; width: 100%; }
    .list-content.gallery-view li .gallery-photo-container input[type="checkbox"] { margin-bottom: 8px; margin-right: 0; }
    .list-content.gallery-view li .gallery-photo { max-width: 100%; max-height: 100%; object-fit: cover; border-radius: 3px; display: block; }
    body.dark-mode .list-content.gallery-view li .gallery-photo { border-color: #555; }
    .list-content.gallery-view li span.school-name { display: none !important; }


    /* SENIOR PHOTO POPUP */
    #senior-photo-popup {
    position: fixed;
    background-color: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 5px;
    z-index: 2000;
    display: none;
    width: 200px; /* Default width, can be overridden by JS for panel-closed-desktop state */
    transition: opacity 0.2s, transform 0.2s;
    opacity: 0;
    transform: scale(0.95);
    max-height: 75vh; /* MODIFIED: Added max-height to constrain popup height */
    overflow-y: auto;  /* MODIFIED: Added overflow-y to enable scrollbar when content exceeds max-height */
}
    #senior-photo-popup.visible { display: block; opacity: 1; transform: scale(1); }
    #close-senior-photo-popup { position: absolute; top: 2px; right: 5px; font-size: 18px; line-height: 1; padding: 2px 5px; z-index: 2001; pointer-events: auto; }
    #senior-photo-popup img { max-width: 100%; height: auto; border-radius: 3px; cursor: zoom-in; display: block; pointer-events: auto; }
       #senior-photo-popup img.zoomed {
     position: fixed;
    top: 50%;
    left: 50%; /* Default centering */
    transform: translate(-50%, -50%); /* Default centering */
    max-width: 95vw;
    max-height: 95vh;
    object-fit: contain;    /* Preserves aspect ratio within the max bounds */
    z-index: 2000;
    cursor: default; /* Changed from zoom-in as per user's existing hover style */
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    border: 2px solid white; /* Border will now be around the actual scaled image */
    background: #fff; 
    transition: transform .25s ease, left .25s ease, max-width .25s ease; /* ADDED left and max-width to transition */
    pointer-events: auto;
}

#senior-photo-popup.with-side-panel img.zoomed {
    /*
      Panel width: 340px (new)
      Panel's new right offset: 100px
      Gap between image and panel: 20px
      Left arrow area width (approx): 65px (15px offset + 50px width)
      Total horizontal space NOT for image = 100px (panel right) + 340px (panel width) + 20px (gap) + 65px (left arrow) = 525px
    */
    max-width: calc(100vw - 525px); /* MODIFIED: Adjusted from 465px */
    /*
      Center the image in the available space.
      Available space starts after the left arrow (65px).
    */
    left: calc(65px + ( (100vw - 525px) / 2 ) ); /* MODIFIED: Adjusted from 465px */
    /* transform: translate(-50%, -50%); is still needed to center based on the new 'left' and 'max-width' */
}



/* Extra magnification while you hover over the zoomed photo */
#senior-photo-popup img.zoomed:hover {
    /* transform: translate(-50%, -50%) scale(1.25); /* 1.25√ó while hovered */
    cursor: default;
}


    body.dark-mode #senior-photo-popup img.zoomed { border-color: #333; background-color: #282828; }
    #senior-photo-popup p#senior-photo-caption { margin: 5px 0 0 0; font-size: 0.9em; text-align: center; pointer-events: auto; }
    #senior-photo-popup img.zoomed + p#senior-photo-caption,
    #senior-photo-popup.zoomed-state p#senior-photo-caption {
        position: fixed; bottom: 65px; left: 50%; transform: translateX(-50%);
        background-color: #222222; color: white; padding: 6px 12px; border-radius: 4px; font-size: 0.9em;
        z-index: 2001; pointer-events: auto;
    }
    body.dark-mode #senior-photo-popup img.zoomed + p#senior-photo-caption,
    body.dark-mode #senior-photo-popup.zoomed-state p#senior-photo-caption { background-color: #e0e0e0; color: #121212; }

    .photo-nav-arrow {
        position: fixed; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.4);
        color: white; border: none; font-size: 2.5em; padding: 10px; cursor: pointer; z-index: 2005;
        border-radius: 50%; width: 50px; height: 50px; line-height: 30px; text-align: center;
        opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; user-select: none;
    }
    .photo-nav-arrow:hover { opacity: 1; background-color: rgba(0, 0, 0, 0.7); }
    .photo-nav-arrow.prev { left: 15px; }
    .photo-nav-arrow.next { right: 15px; }
    body.dark-mode .photo-nav-arrow { background-color: rgba(255, 255, 255, 0.25); color: #e0e0e0; }
    body.dark-mode .photo-nav-arrow:hover { background-color: rgba(255, 255, 255, 0.5); }

    #photo-zoom-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        z-index: 1999; display: none;
    }
    #zoom-exit-note {
        position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
        z-index: 2001; padding: 8px 12px; border-radius: 4px;
    }

    /* COLLEGE GROUPING IN LIST */
    .college-group-header {
        font-weight: bold; padding: 6px 3px; background-color: #e9ecef;
        border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;
        margin-top: 3px; margin-bottom: 2px; position: sticky; top: -1px; z-index: 10; cursor: default;
    }
    body.dark-mode .college-group-header { background-color: #2c2c2c; border-color: #444; color: #e0e0e0; }
    .student-sublist { list-style: none; padding-left: 15px; margin: 0; }
    .list-content li.college-group-header:hover { background-color: #e9ecef; }
    body.dark-mode .list-content li.college-group-header:hover { background-color: #2c2c2c; }
    .list-content.gallery-view .college-group-header,
    .list-content.gallery-view .student-sublist { display: none !important; }
    .list-content.gallery-view ul > li:not(.grad-class-separator):not(.college-group-header) { display: flex !important; }
    .student-sublist li { padding: 3px 0; }
    .student-sublist li.list-item-highlight, .student-sublist li.current-selection-highlight { background-color: #d6eaff; }
    body.dark-mode .student-sublist li.list-item-highlight, body.dark-mode .student-sublist li.current-selection-highlight { background-color: #2a3950; }

    /* DARK MODE SPECIFIC STYLES (General) */
    body.dark-mode { background-color: #121212; color: #e0e0e0; }
    body.dark-mode #description-control { background-color: purple; color: white; }
    body.dark-mode #controls-and-list-container { background-color: #1a1a1a; border-right-color: #444; }
    body.dark-mode #panel-resizer { background-color: #333; }
    body.dark-mode #panel-resizer:hover { background-color: #555; }
    body.dark-mode .map-control { background-color: rgba(40, 40, 40, 0.9); color: #e0e0e0; border-color: #555; }
    body.dark-mode .map-control h4 { border-bottom-color: #444; }
    body.dark-mode #filter-control .filter-header { border-bottom-color: #555; }
    body.dark-mode #state-country-filters-container { border-color: #555; }
    body.dark-mode .list-header-container { border-bottom-color: #444; }
    body.dark-mode #stats-table th, body.dark-mode #stats-table td { border-color: #555; }
    body.dark-mode #stats-table th { background-color: #2a2a2a; }
    body.dark-mode #stats-table td.row-header { background-color: #222; }
    body.dark-mode #major-summary-table th, body.dark-mode #major-summary-table td { border-color: #555; }
    body.dark-mode #major-summary-table th { background-color: #2a2a2a; }
    body.dark-mode .list-item-major { color: #bbb; }
    body.dark-mode #toggleSchoolListBtn { background-color: #444; border-color: #666; color: #e0e0e0; }
    body.dark-mode #toggleSatelliteViewBtn { background-color: #444; border-color: #666; color: #e0e0e0; }
    body.dark-mode #senior-photo-popup { background-color: #282828; border-color: #555; color: #e0e0e0;}
    body.dark-mode #schoolSearchInput { background-color: #333; border-color: #555; color: #e0e0e0; }
    body.dark-mode #searchSuggestions { background-color: #333; border-color: #555; color: #e0e0e0; }
    body.dark-mode #searchSuggestions div:hover { background-color: #444; }
    body.dark-mode .filter-color-box { border-color: #666; }
    body.dark-mode .dark-mode-toggle-control, body.dark-mode #toggleTransitBtn, body.dark-mode #toggleSatelliteViewBtn, body.dark-mode #zoomToVisibleBtn, body.dark-mode #clearAllFiltersBtn, body.dark-mode #toggleGalleryViewBtn, body.dark-mode #showFaqBtn {
        background-color: rgba(50, 50, 50, 0.9); color: #e0e0e0; border-color: #555;
    }
    body.dark-mode .dark-mode-toggle-control:hover, body.dark-mode #toggleTransitBtn:hover, body.dark-mode #toggleSatelliteViewBtn:hover, body.dark-mode #zoomToVisibleBtn:hover, body.dark-mode #clearAllFiltersBtn:hover, body.dark-mode #toggleGalleryViewBtn:hover, body.dark-mode #showFaqBtn:hover {
        background-color: rgba(70, 70, 70, 0.95);
    }
    body.dark-mode .gm-style-iw-c { background-color: #282828 !important; box-shadow: 0 2px 7px 1px rgba(255, 255, 255, 0.2); }
    body.dark-mode .gm-style-iw-d { color: #e0e0e0 !important; overflow: visible !important; }
    body.dark-mode .info-window-content { color: #e0e0e0; }
    body.dark-mode .info-window-content b { color: #ffffff; }
    body.dark-mode .info-window-content a { color: #90caf9 !important; }
    body.dark-mode .info-window-content a:hover { color: #bbdefb !important; }
    body.dark-mode .info-window-type { color: #aaa; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] , body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] { background: none !important; border: none !important; box-shadow: none !important; opacity: 1 !important; border-radius: 2px !important; padding: 4px !important; right: 6px !important; top: 6px !important; cursor: pointer; transition: background-color 0.2s ease; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"]:hover, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"]:hover { background-color: rgba(255, 255, 255, 0.2) !important; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] img, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] img { display: block !important; width: 14px !important; height: 14px !important; filter: contrast(0) sepia(1) hue-rotate(0deg) saturate(0) brightness(1.5) invert(1) !important; opacity: 1 !important; transform: scale(1) !important; }
    body.dark-mode .gm-style .gm-style-mtc , body.dark-mode .gmnoprint .gm-style-mtc { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5); border: 1px solid #444 !important; border-radius: 2px; }
    body.dark-mode .gm-style .gm-style-mtc button, body.dark-mode .gm-style .gm-style-mtc div { color: #ffffff !important; font-weight: 500 !important; background-color: transparent !important; text-shadow: none !important; }
    body.dark-mode .gm-style .gm-style-mtc button:hover, body.dark-mode .gm-style .gm-style-mtc div:hover { background-color: #444 !important; }
    body.dark-mode .gm-style .gm-style-mtc .gm-active { background-color: #555 !important; color: #fff !important; border-left: none !important; border-right: none !important; }
    body.dark-mode .gm-style .gm-style-mtc .gm-active div, body.dark-mode .gm-style .gm-style-mtc .gm-active button { color: #fff !important; background-color: #555 !important; }
    body.dark-mode .gmnoprint .gm-control-active, body.dark-mode .gm-svpc, body.dark-mode .gm-fullscreen-control { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5) !important; border: 1px solid #444 !important; border-radius: 2px !important; }
    body.dark-mode .gmnoprint .gm-control-active:hover, body.dark-mode .gm-svpc:hover, body.dark-mode .gm-fullscreen-control:hover { background-color: #444 !important; }
    body.dark-mode .gm-fullscreen-control img, body.dark-mode .gm-svpc img, body.dark-mode .gm-style-mtc button img, body.dark-mode button[aria-label*="Zoom in"] img, body.dark-mode button[aria-label*="Zoom out"] img { filter: brightness(0) invert(1) !important; opacity: 1 !important; }
    body.dark-mode .gm-style > .gmnoprint > div { background: transparent !important; box-shadow: none !important; border: none !important; border-radius: 2px; }
    body.dark-mode .gm-style > .gmnoprint > div > div + div { background-color: #555 !important; }
    body.dark-mode .gm-style .gm-style-cc, body.dark-mode .gm-style .gm-style-cc a, body.dark-mode .gm-style .gm-style-cc span, body.dark-mode .gm-style .gm-style-cc div { color: #ffffff !important; text-shadow: none !important; font-weight: 400 !important; opacity: 0.9 !important; }
    body.dark-mode .gm-style .gm-style-cc a:link, body.dark-mode .gm-style .gm-style-cc a:visited { color: #ffffff !important; text-decoration: none !important; opacity: 0.9 !important; }
    body.dark-mode .gm-style .gm-style-cc a:hover { color: #ffffff !important; text-decoration: underline !important; opacity: 1 !important; }
    body.dark-mode .list-content li:hover span.school-name { text-decoration: underline; }
    body.dark-mode .tip-message { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
    body.dark-mode .dismiss-button { color: #888; }
    body.dark-mode .dismiss-button:hover { color: #ddd; background-color: #444; }
    body.dark-mode .filter-control-buttons button { background-color: #444; border-color: #666; color: #e0e0e0; }
    body.dark-mode .filter-control-buttons button:hover { background-color: #555; }
    body.dark-mode #zoom-exit-note { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
    body.dark-mode #zoom-exit-note .dismiss-button { color: #888;}
    body.dark-mode #zoom-exit-note .dismiss-button:hover { color: #ddd; background-color: #444; }

    /* TRENDS CHARTS */
    #trends-control { font-size: 0.9em; margin-top: 10px; }
    #trends-control h4 { margin-bottom: 10px; }
    #trends-control h5 { margin-top: 0; margin-bottom: 8px; font-size: 1em; font-weight: bold; text-align: center; }
    .chart-container {
        position: relative; margin: 0 auto 15px auto; padding: 5px; border: 1px solid #ddd; border-radius: 4px;
        background-color: #fdfdfd; width: 100%; height: 280px; box-sizing: border-box;
    }
    body.dark-mode .chart-container { border-color: #555; background-color: #2a2a2a; }
    #trends-control canvas { max-width: 100%; margin-bottom: 10px; }
    #trends-control .chart-container p { font-size: 0.8em; text-align: center; margin-top: 5px; margin-bottom: 5px; line-height: 1.3; color: black; }
    body.dark-mode #trends-control .chart-container p { color: #aaa; }

    /* FAQ POPUP */
    #faq-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        z-index: 2999; display: none;
    }
    #faq-popup {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 80%; max-width: 700px; max-height: 80vh; background-color: #ffffff;
        border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        padding: 20px; z-index: 3000; display: none; flex-direction: column;
    }
    #faq-popup h2 { margin-top: 0; margin-bottom: 15px; text-align: center; font-size: 1.5em; color: #333; }
    #close-faq-popup { position: absolute; top: 10px; right: 15px; font-size: 24px; /* Inherits .dismiss-button styles */ }
    #faq-content { overflow-y: auto; flex-grow: 1; line-height: 1.6; padding-right: 10px; }
    #faq-content h4 { margin-top: 15px; margin-bottom: 5px; color: #555; font-size: 1.1em; } /* Questions */
    #faq-content h4:first-child { margin-top: 0; }
    #faq-content p,
    #faq-content li { /* Combined rule for p and li */
        margin-top: 0;
        margin-bottom: 10px;
        color: #444;
        font-size: 0.95em; /* Answers and list items */
        font-weight: normal; /* Explicitly set font-weight */
    }
    #faq-content ol {
        margin-top: 0; 
        margin-bottom: 10px; 
        padding-left: 25px; 
    }
    #faq-content ul { 
        margin-top: 0;
        margin-bottom: 10px;
        padding-left: 25px;
    }

    body.dark-mode #faq-popup { background-color: #282c34; border-color: #555; color: #e0e0e0; }
    body.dark-mode #faq-popup h2 { color: #e8e8e8; }
    body.dark-mode #faq-content h4 { color: #bbbec3; }
    body.dark-mode #faq-content p,
    body.dark-mode #faq-content li { /* Combined rule for dark mode p and li */
        color: #afb3b8;
        font-weight: normal; /* Explicitly set font-weight for dark mode as well */
    }


    /* MOBILE RESPONSIVENESS & DRAWER OVERRIDES */
    @media (max-width: 768px) {
  #trends-control .chart-container {
        height: 300px; /* General default for all charts on mobile */
    }
    #trends-control .chart-container:first-child { /* Specific for Major Area Popularity chart */
        height: 360px; /* Increased from 340px to give more vertical room for the chart + legend */
    }

        #controls-and-list-container {
            /* Drawer specific styles for mobile */
            position: absolute;
            inset: 0 auto 0 0;
            width: 85%; /* Adjust width for mobile drawer */
            max-width: 320px; /* Max width for mobile drawer */
            transform: translateX(-100%); /* Hidden by default on mobile */
            border-right: none; /* Overlay drawer typically doesn't have a right border */
            box-shadow: 2px 0 10px rgba(0,0,0,.25);
            z-index: 1000; /* Ensure it's above map, below hamburger */
        }

        /* This class is toggled by JS for mobile drawer */
        #controls-and-list-container.panel-mobile-open {
            transform: translateX(0);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        /* Desktop hiding class should still work if viewport becomes mobile */
        #controls-and-list-container.panel-desktop-hidden {
            transform: translateX(-100%) !important; /* Ensure it stays hidden */
        }


        

        /* General mobile font/button size adjustments */
        .map-control h4 { font-size: 1em; }
        .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn, #showFaqBtn {
            font-size: 0.8em; padding: 4px 8px;
        }
        #schoolSearchContainer { width: 100%; float: none; margin-top: 5px; }
        .list-header-container h4 { float: none; display: block; }
        #toggleSchoolListBtn { font-size:0.75em; }
        .list-content.gallery-view li:not(.grad-class-separator) {
            flex-basis: calc((100% - 1 * 10px) / 2); min-width: 120px;
        }

        /* Finger-friendly list items & buttons on mobile, can be more specific */
        #controls-and-list-container button,
        #controls-and-list-container input[type="checkbox"] + label {
            font-size: 1.0rem; /* Slightly smaller than 1.05 for general buttons if needed */
            /* padding-block: 0.65rem; */
        }
        .list-content li, /* For list items */
        .filter-item label { /* For filter labels */
             font-size: 1.0rem;
        }

         #senior-photo-popup img.zoomed {
        max-width: 85vw;  /* MODIFIED: Reduced for mobile */
        max-height: 85vh; /* MODIFIED: Reduced for mobile */
        /* The :hover scale can also be reduced if it's too aggressive on mobile */
    }

        #senior-photo-popup.zoomed-state p#senior-photo-caption {
        bottom: 45px; /* Lower the caption slightly from 65px */
        font-size: 0.8em; /* Make caption font smaller */
        padding: 5px 10px; /* Reduce padding for the caption */
    }

    .photo-nav-arrow {
        font-size: 1.8em;    /* Make arrow icons smaller */
        width: 38px;       /* Reduce button size */
        height: 38px;
        line-height: 1;    /* Adjust line height for smaller button */
        padding: 6px;      /* Reduce padding inside arrow button */
    }
    .photo-nav-arrow.prev {
        left: 8px;        /* Bring arrows slightly closer to the edge if needed */
    }
    .photo-nav-arrow.next {
        right: 8px;
    }

    #zoom-exit-note {
        /* The "To exit zooming..." note is already at bottom: 10px. 
           Its general font-size is controlled by .tip-message. 
           If it still feels too large or wide on very small mobile, you could add: */
        font-size: 0.8em; /* Optional: Further reduce font size for this specific note on mobile zoom */
        padding: 6px 10px; /* Optional: Reduce padding */
        /* Consider if max-width is needed if it wraps awkwardly: */
        /* max-width: 90%; */ 
    }

    }

    @media (max-width: 480px) {
        /* For very small screens, drawer might take full width or a bit less */
        #controls-and-list-container {
             /* width: 90%; max-width: 280px; */ /* Example adjustment */
        }
        .list-content.gallery-view li:not(.grad-class-separator) {
            min-width: 100px;
        }
    }


    
</style>


</head>


<body>
   

   <div id="map-container">
        <!-- Hamburger button MOVED HERE, as a direct child of map-container -->
        <button id="menu-toggle" aria-label="Toggle list" class="hamburger">
          ‚ò∞
        </button>
        <div id="controls-and-list-container">
            <!-- The comment "Only visible on screens ‚â§ 768 px" was misleading for the button's previous placement;
                 The button itself is styled to be generally visible.
                 The hamburger button is NO LONGER here. -->
            <div id="description-control" class="map-control">
                <span><b>NEST+m Senior College Destinations Map</b> ü¶Ö</span>
            </div>

                        <div id="credits">
    <span>Created by: </span>
    <a href="https://github.com/norman-mei" target="_blank" title="GitHub Profile">
        Norman Mei ('25) <!-- Name first -->
        <svg height="18" viewBox="0 0 16 16" version="1.1" width="18" aria-hidden="true" style="margin-left: 4px;"> <!-- GitHub Icon, with small left margin to space from name. It will get margin-right from existing CSS -->
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
    </a>
    <a href="https://www.instagram.com/normanmei_/" target="_blank" title="Instagram Profile" style="vertical-align: middle;"> <!-- Instagram icon link. Spacing will come from GitHub SVG's margin-right -->
        <svg height="18" viewBox="0 0 24 24" width="18" aria-hidden="true"> <!-- This SVG will also get margin-right from existing CSS -->
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path>
        </svg>
    </a>
</div>

                        <div id="map-options-control" class="map-control">
                <button id="darkModeToggle" class="dark-mode-toggle-control" title="Toggle Dark Mode">üåô Dark Mode</button>
                <button id="toggleTransitBtn" title="Show Transit Layer">üöá Show Transit</button>
                <button id="toggleSatelliteViewBtn" title="Switch to Satellite View">üõ∞Ô∏è Satellite View</button>
                <button id="zoomToVisibleBtn" title="Zoom to fit all visible markers">üëÅÔ∏è Zoom to Visible</button>
                <button id="clearAllFiltersBtn" title="Clear all active filters and search">üßπ Clear All Filters</button>
                <button id="toggleGalleryViewBtn" title="Toggle Gallery View in List">üñºÔ∏è Toggle Gallery View</button>
                <button id="showFaqBtn" title="Show Frequently Asked Questions">‚ùì FAQ</button>
            </div>
            <div id="filter-control" class="map-control">
                 <h4 class="filter-header">Filter by Graduating Class</h4>
                 <div class="control-content">
                     <div class="filter-control-buttons">
                         <button id="checkAllGradClassesBtn" title="Check all graduating class filters">Check All</button>
                         <button id="uncheckAllGradClassesBtn" title="Uncheck all graduating class filters">Uncheck All</button>
                     </div>
                     <div id="instagram-links-control">
                        <a href="https://www.instagram.com/nestmdecisions2021/" target="_blank" class="instagram-link-button" title="Instagram '21 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'21</span>
                        </a>
                        <a href="https://www.instagram.com/nestm2022decisions/" target="_blank" class="instagram-link-button" title="Instagram '22 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                               <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'22</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions2023/" target="_blank" class="instagram-link-button" title="Instagram '23 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'23</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions2024/" target="_blank" class="instagram-link-button" title="Instagram '24 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                               <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'24</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions25/" target="_blank" class="instagram-link-button" title="Instagram '25 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'25</span>
                        </a>
                    </div>
                     <div style="clear: both;"></div>
                     <div id="grad-class-filters-container">
                         {} <!-- Grad class filters will be populated here -->
                     </div>

                      <h4 class="filter-header" style="margin-top: 15px;">Filter by State/Country</h4>
                      <div class="control-content">
                         <div class="filter-control-buttons">
                             <button id="checkAllStateCountryBtn" title="Check all state/country filters">Check All</button>
                             <button id="uncheckAllStateCountryBtn" title="Uncheck all state/country filters">Uncheck All</button>
                         </div>
                         <div id="state-country-filters-container" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; margin-top: 5px; font-size: 0.9em;">
                             <!-- State/Country filters will be populated here by JavaScript -->
                         </div>
                     </div> <!-- Closing control-content for State/Country -->
                 </div> <!-- Closing control-content for Grad Class -->
            </div>
            <div id="stats-table-control" class="map-control">
                <h4>College Attendance Statistics</h4>
                <div class="control-content">
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>Location Focus</th>
                                <th>Public</th>
                                <th>Private</th>
                                <th>Total</th>
                                <th>Filter <input type="checkbox" id="checkAllLocationFocusBtn" title="Toggle all location focus filters" checked></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-header">In City (NYC)</td>
                                <td data-stat="InCityNYC-Public">0</td>
                                <td data-stat="InCityNYC-Private">0</td>
                                <td data-stat="InCityNYC-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="InCityNYC" title="Filter by In City (NYC)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">In State (NY, Other)</td>
                                <td data-stat="InStateNYOther-Public">0</td>
                                <td data-stat="InStateNYOther-Private">0</td>
                                <td data-stat="InStateNYOther-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="InStateNYOther" title="Filter by In State (NY, Other)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">Out of State (US)</td>
                                <td data-stat="OutOfStateUS-Public">0</td>
                                <td data-stat="OutOfStateUS-Private">0</td>
                                <td data-stat="OutOfStateUS-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="OutOfStateUS" title="Filter by Out of State (US)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">International</td>
                                <td data-stat="International-Public">0</td>
                                <td data-stat="International-Private">0</td>
                                <td data-stat="International-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="International" title="Filter by International" checked></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="row-header">Grand Total</td>
                                <td data-stat="Total-Public" style="font-weight:bold;">0</td>
                                <td data-stat="Total-Private" style="font-weight:bold;">0</td>
                                <td data-stat="Total-Overall" style="font-weight:bold;">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div> <!-- Closing control-content for Stats Table -->
            </div>



            <div id="major-summary-control" class="map-control">
                <h4>Major Area Summary</h4>
                 <div class="control-content">
                    <table id="major-summary-table">
                        <thead>
                            <tr>
                                <th>Major Area</th>
                                <th>Count</th>
                                <th>Filter <input type="checkbox" id="checkAllMajorAreasBtn" title="Toggle all major area filters" checked></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div> <!-- Closing control-content for Major Summary -->
            </div>

             <div id="trends-control" class="map-control">
                <h4>Data Trends Over Time</h4>
                <div class="control-content">
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <h5>Major Area Popularity (% of Grads/Year)</h5>
                        <canvas id="majorAreaTrendChart"></canvas>
                    </div>
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <h5>Location Focus Distribution (% of Grads/Year)</h5>
                        <canvas id="locationFocusTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h5>Top 5 Colleges By Overall Attendance (% of Grads/Year)</h5>
                        <canvas id="popularCollegesTrendChart"></canvas>
                    </div>
                </div><!-- Closing control-content for Trends -->
            </div>

            <div id="school-list-control" class="map-control">
                <div class="list-header-container"> <!-- This h4 is not part of the general .map-control h4 collapsibility -->
                    <h4>College List & Seniors</h4>
                     <button id="toggleSchoolListBtn" title="Show/Hide List">Hide List</button>
                    <div id="schoolSearchContainer">
                        <input type="text" id="schoolSearchInput" placeholder="Search seniors or colleges..." autocomplete="off">
                        <div id="searchSuggestions"></div>
                    </div>
                </div>

                <div id="sort-controls-container" style="padding: 5px 0px 10px 0px; border-bottom: 1px solid #eee; margin-bottom: 8px;">
                    <div>
                        <label for="primarySortTarget" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Target:</label>
                        <select id="primarySortTarget" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc; margin-right: 10px;">
                            <option value="students" selected>Students</option>
                            <option value="colleges">Colleges</option>
                        </select>
                    </div>
                    <div id="collegeSortOptionsContainer" style="display: none; margin-top: 8px;">
                        <label for="collegeSortSelect" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Colleges by:</label>
                        <select id="collegeSortSelect" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc;">
                            <option value="name_asc" selected>Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                            <option value="count_desc">Student Count (Most)</option>
                            <option value="count_asc">Student Count (Least)</option>
                        </select>
                    </div>
                    <div id="studentSortOptionsContainer" style="margin-top: 8px;"> <!-- Default shown -->
                        <label for="studentSortSelect" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Students by:</label>
                        <select id="studentSortSelect" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc;">
                            <option value="grad_first" selected>Grad Class, First Name</option>
                            <option value="grad_last">Grad Class, Last Name</option>
                            <option value="first_name">First Name (Overall)</option>
                            <option value="last_name">Last Name (Overall)</option>
                        </select>
                    </div>
                </div>

                 <div class="list-content">
                     <div class="school-list-collapsible-content">
                         <!-- School list ul will be populated here -->
                          <div id="no-results-message">No seniors match your current filters.</div>
                     </div>
                 </div>
            </div>
        </div>
        <div id="panel-resizer"></div>
        <div id="map"></div>

    </div>

    <div id="senior-photo-popup">
        <span id="close-senior-photo-popup" class="dismiss-button" title="Close Photo (Esc)">&times;</span>
        <img src="#" alt="Senior Photo" onerror="this.style.display='none'; this.onerror=null;">
        <p id="senior-photo-caption">Senior Name</p>
        <button id="prev-senior-photo" class="photo-nav-arrow prev" title="Previous Senior (Left Arrow)" style="display: none;">&lt;</button>
        <button id="next-senior-photo" class="photo-nav-arrow next" title="Next Senior (Right Arrow)" style="display: none;">&gt;</button>
    </div>
    <div id="zoom-exit-note" class="tip-message" style="display: none;">
        <span>To exit zooming, click out of the picture or press Esc.</span>
        <span class="dismiss-button" onclick="this.parentElement.style.display='none';">√ó</span>
    </div>
    <!-- Overlay div for senior photo will be created and appended by JavaScript -->

    <!-- FAQ Popup and Overlay -->
    <div id="faq-overlay"></div>
    <div id="faq-popup">
        <span id="close-faq-popup" class="dismiss-button" title="Close FAQ">√ó</span>
        <h2>Frequently Asked Questions</h2>
        <div id="faq-content">
            
             <h4>Q: How can I contact you about this project / Q: How can I contribute or suggest improvements?</h4>
            <p> If you spot any bug (big or small) or want me to add a feature that hasn't been already added, please message me on Instagram: @normanmei_</p>
            
            <h4>Q: How is the data collected?</h4>
            <p>A: Data is pulled / sourced all done manually from publicly available Instagram posts (e.g., "college decisions" accounts for NEST+m graduating classes) and voluntarily submitted information. All data aims to be respectful of privacy and focuses on publicly shared commitments.</p>

            <h4>Q: How often is the data updated?</h4>
<p>A: Can't say for sure. I have real life obligiations to attend to so basically whenever I am free to do so.</p>

<h4> Q: What is the next thing you are going to add?</h4>
<p>A: Can't say. </p>

<h4>Q: How long did this project take? What was the inspiration?</h4>
            <p>A: I started this project in late May 2025 for my APCSP final project just for fun.</p>

            <h4>Q: Have you considered using the Instagram API?</h4>
<p>
  A: Yes, I thought of this at first to completely futureproof my project for future graduating classes but as I did a little more research, I found out that I simply <b>can't</b> do it because I need a solution that works for accounts I don‚Äôt own and maintains minimal ongoing effort, the official Instagram APIs simply won‚Äôt do.
</p>
<ol>
  <li><strong>Basic Display API is gone:</strong> Meta deprecated it on December 4, 2024, so any calls now just error out.</li>
  <li><strong>Graph API requires ownership & verification:</strong> I‚Äôd have to convert the school‚Äôs accounts to Business/Creator, pass App Review, and complete Business Verification‚Äînone of which I control.</li>
  <li><strong>oEmbed only returns embed HTML:</strong> I can‚Äôt pull separate JSON fields for photos, bios, or profile pics‚Äîjust a blockquote snippet.</li>
  <li><strong>Scraping is brittle (& against IG ToS):</strong> While it‚Äôs technically possible, it can break whenever the site changes (too much work to fix over time if it keeps breaking) and not to mention it violates Instagram‚Äôs Terms of Service, and risks bans.</li>
</ol>
<p>
  Bottom line: Without owning and verifying the accounts, there‚Äôs no official API route to auto-fetch seniors‚Äô photos or bios, so I that's why I don't use any API of sort, everything is done manually.
</p>

            <h4>Q: How are "Major Areas" determined?</h4>
            <p>A: Specific majors are mapped to broader "Major Areas" using a combination of a JS file and keyword-based logic in the main script. This helps in summarizing trends. Combined majors (e.g., "CS & Econ") may be split or categorized based on their components.</p>

            <h4>Q: Why can't I see a specific senior's photo?</h4>
            <p>A: Photos are linked based on filenames derived from senior names and graduating years. If a photo is missing, it might be because it wasn't available or a naming convention mismatch. The system attempts fallbacks (PNG, college logo) if the primary JPG is not found.</p>

            <h4>Q: How do the filters work?</h4>
            <p>A: You can filter by graduating class, state/country of the college, location focus (NYC, NY State, Out of State, International), and major area. Filters are generally additive (AND logic). The lists and map will update to show only seniors matching all active filter criteria. "Clear All Filters" resets everything.</p>

            <h4>Q: What do the different colors for map markers mean?</h4>
            <p>A: Map marker colors correspond to the graduating class of the senior, using the same color scheme as in the "Filter by Graduating Class" section.</p>

            <h4>Q: What is "Gallery View"?</h4>
            <p>A: Gallery View changes the student list into a card-based layout, often showing senior photos or college logos more prominently. It's an alternative way to browse the data.</p>

            <h4>Q: How can I use the list navigation with keyboard?</h4>
            <p>A: When the list has focus (and you're not typing in the search bar), use the Up and Down arrow keys to navigate between seniors. If a senior's photo is zoomed in, use Left and Right arrow keys to navigate to the previous/next senior's photo. Press 'Escape' to close popups or zoomed photos.</p>
            
            

            <h4>Q: When at some point when you stop maintaining this project or let someone else take over?</h4>
            <p>A: Probably whenever I am in college and preferably it has someone that my school's college counselor recommended me to let them take over the project.</p>
        
            <h4>Q: Is my personal information shared publicly?</h4>
<p>A: Only your first and last name, graduating class, the school you commmited to, Instagram profile, Linked profile, and college choice are displayed. No other personal details (e.g., home address, email) are collected or shown, to respect privacy.</p>
      

        
        </div>
    </div>
    <!-- Overlay div will be created and appended by JavaScript -->



     <script>

        // Global Variable Declarations
        let map;
        let infowindow;
        let isDarkMode = false;
        let allMarkers = []; // Stores { marker: google.maps.Marker, school: SeniorChoiceData }
        let gradClassFilterState = {};
        let schoolsSelectedForZoom = new Set();
        let zoomedGradClassInfoDiv, zoomedGradClassValueSpan; // NEW
     let panelJustToggledOpen = false;
        let activeHoverMarkerIndex = null; // Stores originalIndex of hovered/keyboard-selected item's marker
        let seniorPhotoPopup, seniorPopupImage, seniorPopupCaption, closeSeniorPhotoBtn, zoomExitNote, photoZoomOverlay;
        let prevSeniorPhotoBtn, nextSeniorPhotoBtn; // For zoomed photo navigation
        let faqPopup, faqOverlay;
        let currentlyZoomedSeniorOriginalIndex = null; // Tracks originalIndex of the currently zoomed senior
       
let panelToggleTimeout = null;
        let transitLayer;
           let currentPrimarySortTarget = 'students'; // 'students' or 'colleges'
let currentCollegeSortValue = 'name_asc'; // Default college sort
let currentStudentSortValue = 'grad_first'; // Default student sort
        let isSatelliteViewEnabled = false;
        let transitLayerEnabled = false;
        let locationFocusFilterState = {}; // Stores true/false for each location focus key
        let majorAreaFilterState = {}; // Stores true/false for each major area key
         let stateCountryFilterState = {};
        let isGalleryViewEnabled = false;
        let currentListSelectionIndex = -1; // Index within the *visible* list items. -1 means nothing selected

        // NEW: Add a global variable for the MarkerClusterer
        let markerClustererInstance;

        let majorAreaChartInstance, locationFocusChartInstance, popularCollegesChartInstance;


const LINKEDIN_SVG_PATH = "M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.776 13.019H3.561V9h3.552v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z";
        const INSTAGRAM_SVG_PATH = "M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z";

        function createSocialLinkSVG(type, size = 16, currentIsDarkMode, forZoomedPanel = false) {
            const path = type === 'linkedin' ? LINKEDIN_SVG_PATH : INSTAGRAM_SVG_PATH;
            let fillColor;
            if (type === 'linkedin') {
                fillColor = currentIsDarkMode ? (forZoomedPanel ? '#88C5F6' : '#70B4F0') : (forZoomedPanel ? '#0A66C2' : '#0077B5');
            } else { // instagram
                fillColor = currentIsDarkMode ? (forZoomedPanel ? '#F56040' :'#E1306C') : (forZoomedPanel ? '#E1306C' : '#C13584');
            }
            const marginStyle = forZoomedPanel ? 'margin: 5px;' : 'margin-left: 4px; margin-right: 1px;'; // More margin for zoomed panel
            return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${fillColor}" style="vertical-align: middle; ${marginStyle}"><path d="${path}"></path></svg>`;
        }
        const CHART_COLORS_LIST = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#8A2BE2', '#5F9EA0', '#D2691E', '#FF7F50', '#6495ED', '#DC143C',
    '#008B8B', '#B8860B', '#006400', '#8B0000', '#FF8C00', '#2F4F4F'
];
let chartColorIndex = 0;
function getNextChartColor() {
    const color = CHART_COLORS_LIST[chartColorIndex % CHART_COLORS_LIST.length];
    chartColorIndex++;
    return color;
}


        // Constants - Defer Google Maps dependent constants to initMap
        let baseMarkerIcon;
        let highlightedMarkerIcon;

        const gradClassColors = {
            "'21": "#AA66CC", // Purple
            "'22": "#FF0000", // Red
            "'23": "#99CC00", // Green
            "'24": "#FFBB33", // Orange
            "'25": "#007FFF"  // Blue
        };
        const gradClassNames = Object.keys(gradClassColors);



        const NYC_BOUNDS = { north: 40.92, south: 40.47, west: -74.26, east: -73.70 };
                const PREDEFINED_MAJOR_AREAS = [
             "Engineering", "Physical Sciences", "Life Sciences", // STEM-related
            "Business/Economics",
            "Humanities", "Social Sciences",  // HSS-related
            "Arts/Design", "Health Sciences", "Education",
            "Undecided/Other", "Other", 
        ].sort((a,b) => { // Sort, but keep "Undecided/Other", "Other", "Unknown" at the end
            const special = ["Undecided/Other", "Other", "Unknown"];
            if (special.includes(a) && !special.includes(b)) return 1;
            if (!special.includes(a) && special.includes(b)) return -1;
            if (special.includes(a) && special.includes(b)) return special.indexOf(a) - special.indexOf(b);
            return a.localeCompare(b);
        });




        // Add derived properties to collegeCoordsAndInfo
        for (const collegeName in collegeCoordsAndInfo) {
            if (collegeCoordsAndInfo.hasOwnProperty(collegeName)) {
                const properties = getCollegeProperties(collegeCoordsAndInfo[collegeName]);
                collegeCoordsAndInfo[collegeName].isCampusPublic = properties.isCampusPublic;
                collegeCoordsAndInfo[collegeName].locationFocus = properties.locationFocus;
            }
        }

        const collegeTypeMappings = {
            "FIT": TYPE_SUNY, "Fashion Institute of Technology": TYPE_SUNY,
            "AMDA": TYPE_OTHER_PRIVATE, "AMDA College of the Performing Arts": TYPE_OTHER_PRIVATE,
            "Undecided": TYPE_UNDECIDED,
        };




        // Google Maps Dark Style
        const darkMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
            { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
            { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
            { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
            { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
            { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
            { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
            { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
            { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] },
        ];

        let seniorCollegeChoices;
        let allData;
        window.isDataReadyForMap = false;

        


        function getMarkerIcon(seniorChoice, isHighlighted = false, currentIsDarkMode) {
            let displayColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
            if (seniorChoice.collegeName === "Undecided") displayColor = '#999999';

            const currentBaseIcon = baseMarkerIcon || { path: google.maps.SymbolPath.CIRCLE, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            const currentHighlightedIcon = highlightedMarkerIcon || { ...currentBaseIcon, scale: 10, strokeWeight: 2.0 };


            const iconConfig = isHighlighted ? currentHighlightedIcon : currentBaseIcon;
            return { ...iconConfig, fillColor: displayColor, strokeColor: currentIsDarkMode ? '#111111' : '#ffffff' };
        }

               function getCollegeProperties(collegeEntry) {
            let isCampusPublic = false;
            // Determine isCampusPublic (same as before)
            if ([TYPE_SUNY, TYPE_CUNY, TYPE_OTHER_PUBLIC, TYPE_PURDUE].includes(collegeEntry.type)) {
                isCampusPublic = true;
            } else if ([TYPE_IVY_LEAGUE, TYPE_OTHER_PRIVATE].includes(collegeEntry.type)) {
                isCampusPublic = false;
            }
            // Ensure Purdue is always public if it's a distinct type check elsewhere
            if (collegeEntry.type === "Purdue University System" || collegeEntry.name === "Purdue University") isCampusPublic = true;


            let locationFocus = "N/A"; // Default for Undecided or 0,0 coords
            const stateOrCountryUpper = collegeEntry.stateOrCountry ? collegeEntry.stateOrCountry.trim().toUpperCase() : null;

            if (collegeEntry.name === "Undecided" || (collegeEntry.lat === 0 && collegeEntry.lng === 0)) {
                // locationFocus remains "N/A" as set by default
            } else {
                let isInternationallyFlagged = false;

                // Explicit name checks for international campuses can override state/country logic
                if (collegeEntry.name) {
                    const lowerName = collegeEntry.name.toLowerCase();
                    if (lowerName.includes("shanghai") || 
                        lowerName.includes("london") || // Catches NYU London
                        lowerName.includes("edinburgh") || 
                        lowerName.includes("mcgill") ||
                        lowerName.includes("st andrews") ||
                        lowerName.includes("maastricht university")) { // Specifically check for Maastricht
                        isInternationallyFlagged = true;
                    }
                }

                // If not flagged by specific name, check by stateOrCountry code
                if (!isInternationallyFlagged && stateOrCountryUpper) {
                    const US_STATES_ABBR = [
                        "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", 
                        "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
                        "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
                        "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
                        "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"
                    ];
                    // If stateOrCountryUpper is not "USA" and not in the list of US states,
                    // it's considered international.
                    if (stateOrCountryUpper !== "USA" && !US_STATES_ABBR.includes(stateOrCountryUpper)) {
                        isInternationallyFlagged = true;
                    }
                }

                if (isInternationallyFlagged) {
                    locationFocus = "International";
                } else {
                    // Domestic (US) classification
                    if (collegeEntry.lat >= NYC_BOUNDS.south && collegeEntry.lat <= NYC_BOUNDS.north &&
                        collegeEntry.lng >= NYC_BOUNDS.west && collegeEntry.lng <= NYC_BOUNDS.east) {
                        locationFocus = "InCityNYC";
                    } else if (stateOrCountryUpper === "NY") {
                        locationFocus = "InStateNYOther";
                    } else {
                        // This will correctly catch "CA" (California) and other US states
                        locationFocus = "OutOfStateUS"; 
                    }
                }
            }
            return { isCampusPublic, locationFocus };
        }

        function normalizeForFilename(str) {
            if (!str) return '';
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
        }

        function getFirstName(seniorName) {
            if (!seniorName) return "";
            return seniorName.split(' ')[0];
        }

        function getLastName(seniorName) {
            if (!seniorName) return "";
            const parts = seniorName.split(' ');
            return parts.length > 1 ? parts[parts.length - 1] : parts[0];
        }


    function aggregateTrendsBase(data, categoryExtractor, itemValidator, categoryFilter) {
        const rawCounts = {}; // { 'Year': { 'Category': count, ... }, ... }
        const studentsPerYear = {}; // { 'Year': count_of_relevant_students }
        const allCategories = new Set();
        const years = [...new Set(data.map(item => item.gradClass))].sort();

        years.forEach(year => {
            rawCounts[year] = {};
            studentsPerYear[year] = 0;
        });

        data.forEach(item => {
            if (!itemValidator(item)) return;

            const year = item.gradClass;
            studentsPerYear[year]++;

            const categories = categoryExtractor(item);
            categories.forEach(cat => {
                if (categoryFilter(cat)) {
                    allCategories.add(cat);
                    rawCounts[year][cat] = (rawCounts[year][cat] || 0) + 1;
                }
            });
        });

        const trendsInPercentage = {};
        years.forEach(year => trendsInPercentage[year] = {});

        years.forEach(year => {
            const totalRelevantStudents = studentsPerYear[year];
            allCategories.forEach(cat => { // Initialize all categories for the year
                 trendsInPercentage[year][cat] = 0;
            });
            if (totalRelevantStudents > 0) {
                for (const cat in rawCounts[year]) {
                    trendsInPercentage[year][cat] = (rawCounts[year][cat] / totalRelevantStudents) * 100;
                }
            }
        });
        return { trends: trendsInPercentage, years, categories: Array.from(allCategories).sort() };
    }

    function aggregateMajorAreaTrends(data) {
        return aggregateTrendsBase(data,
            item => item.majorArea.split(' & ').map(s => s.trim()), // categoryExtractor
            item => item.collegeName !== "Undecided", // itemValidator
            area => area && area !== "Unknown" && area !== "Undecided/Other" // categoryFilter
        );
    }

    function aggregateLocationFocusTrends(data) {
        return aggregateTrendsBase(data,
            item => [item.locationFocus], // categoryExtractor
            item => item.collegeName !== "Undecided" && item.locationFocus !== "N/A", // itemValidator
            focus => focus // categoryFilter (all valid focuses are kept)
        );
    }

    function aggregatePopularCollegeTrends(data, topN = 5) {
        const collegeCountsOverall = {};
        data.forEach(item => {
            if (item.collegeName && item.collegeName !== "Undecided") {
                collegeCountsOverall[item.collegeName] = (collegeCountsOverall[item.collegeName] || 0) + 1;
            }
        });

        const popularCollegesOverall = Object.entries(collegeCountsOverall)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, topN)
            .map(([name]) => name);

        const result = aggregateTrendsBase(data,
            item => [item.collegeName], // categoryExtractor
            item => item.collegeName !== "Undecided" && popularCollegesOverall.includes(item.collegeName), // itemValidator
            collegeName => collegeName // categoryFilter
        );
        // Ensure `categories` in result is `popularCollegesOverall` in the correct order
        result.categories = popularCollegesOverall;
        return result;
    }


           // ==> utils for Chart.js styling
function getChartJsConfigOptions(
    titleText,
    currentIsDarkMode,
    isMobile = false,
    isMajorAreaChart = false
) {
    const gridColor   = currentIsDarkMode ? 'rgba(255, 255, 255, 0.1)'
                                          : 'rgba(0, 0, 0, 0.1)';
    const ticksColor  = currentIsDarkMode ? '#ccc' : '#666';
    const legendColor = currentIsDarkMode ? '#eee' : '#333';

    /*  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        Legend & padding logic
    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    // Default (desktop or non-major-area chart)
    let legendPosition     = 'top';
    let legendAlign        = 'start';
    let layoutPaddingTop   = 10;

    // Special handling: major-area chart on mobile
    if (isMobile && isMajorAreaChart) {
        legendPosition   = 'bottom';     // move legend below the plot
        legendAlign      = 'center';     // center the lines
        layoutPaddingTop = 10;           // no extra top padding needed now
    } else if (isMobile) {
        // other mobile charts keep legend on top but need more air
        layoutPaddingTop = 25;
    }

    /*  Font / box sizes get a gentle nudge down on mobile  */
    const legendFontSize     = isMobile ? 9.5 : Chart.defaults.font.size;
    const legendBoxWidth     = isMobile ? 9   : 12;
    const legendItemsPadding = isMobile ? 4   : 8;

    return {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                top  : layoutPaddingTop,
                right: isMobile ? 5  : 10,
                bottom: isMobile ? 15 : 20,
                left : isMobile ? 5  : 10
            }
        },
        plugins: {
            legend: {
                position: legendPosition,
                align   : legendAlign,
                labels  : {
                    color   : legendColor,
                    boxWidth: legendBoxWidth,
                    padding : legendItemsPadding,
                    font    : { size: legendFontSize }
                }
            },
            // we still suppress the built-in title (h5 is used externally)
            title: { display: false, text: titleText, font: { size: 14 } },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        let l = ctx.dataset.label ? `${ctx.dataset.label}: ` : '';
                        if (ctx.parsed.y != null) l += `${ctx.parsed.y.toFixed(1)}%`;
                        return l;
                    }
                }
            }
        },
        scales: {
            x: { grid: { color: gridColor }, ticks: { color: ticksColor } },
            y: {
                beginAtZero: true,
                grid : { color: gridColor },
                ticks: {
                    color: ticksColor,
                    precision: 0,
                    callback: (v) => `${v}%`
                }
            }
        }
    };
}


        function calculateDynamicYAxisMax(datasets) {
            let maxValue = 0;
            datasets.forEach(dataset => {
                if (dataset.data && Array.isArray(dataset.data)) {
                    dataset.data.forEach(value => {
                        if (typeof value === 'number' && value > maxValue) {
                            maxValue = value;
                        }
                    });
                }
            });

            if (maxValue === 0) {
                return 10; // Default max if all data is zero, to give some visual space and avoid flat line at 0
            }

            // Add ~20% headroom, then round up to the nearest 5
            let yMaxWithHeadroom = maxValue * 1.2;
            let yMax = Math.ceil(yMaxWithHeadroom / 5) * 5;
            
            return Math.min(100, yMax); // Cap at 100%
        }




        function renderMajorAreaTrendChart(data, years, majorAreasList, currentIsDarkMode) {
            const ctx = document.getElementById('majorAreaTrendChart').getContext('2d');
            if (majorAreaChartInstance) majorAreaChartInstance.destroy();
            chartColorIndex = 0;

            const datasets = majorAreasList.map(area => { /* ... */ });

            const isMobile = window.innerWidth <= 768;
            const chartOptions = getChartJsConfigOptions('Major Area Popularity Over Years', currentIsDarkMode, isMobile, true); // true for isMajorAreaChart
            
            const yAxisMax = calculateDynamicYAxisMax(datasets);
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            majorAreaChartInstance = new Chart(ctx, { /* ... */ options: chartOptions });
        }

        // In renderLocationFocusTrendChart:
        function renderLocationFocusTrendChart(data, years, locationFocusesList, currentIsDarkMode) {
            const ctx = document.getElementById('locationFocusTrendChart').getContext('2d');
            if (locationFocusChartInstance) locationFocusChartInstance.destroy();
            chartColorIndex = 0;

            const datasets = locationFocusesList.map(focus => { /* ... */ });

            const isMobile = window.innerWidth <= 768;
            const chartOptions = getChartJsConfigOptions('Location Focus Distribution Over Years', currentIsDarkMode, isMobile, false); // false for isMajorAreaChart

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            locationFocusChartInstance = new Chart(ctx, { /* ... */ options: chartOptions });
        }

        // In renderPopularCollegesTrendChart:
               function renderMajorAreaTrendChart(data, years, majorAreasList, currentIsDarkMode) {
            const ctx = document.getElementById('majorAreaTrendChart').getContext('2d');
            if (majorAreaChartInstance) majorAreaChartInstance.destroy();
            chartColorIndex = 0; // Reset color index for this chart

            const datasets = majorAreasList.map(area => {
                const areaData = years.map(year => data[year][area] || 0);
                return {
                    label: area,
                    data: areaData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const isMobile = window.innerWidth <= 768;
            const chartOptions = getChartJsConfigOptions('Major Area Popularity Over Years', currentIsDarkMode, isMobile, true); // true for isMajorAreaChart
            
            const yAxisMax = calculateDynamicYAxisMax(datasets);
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            majorAreaChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions
            });
        }

        function renderLocationFocusTrendChart(data, years, locationFocusesList, currentIsDarkMode) {
            const ctx = document.getElementById('locationFocusTrendChart').getContext('2d');
            if (locationFocusChartInstance) locationFocusChartInstance.destroy();
            chartColorIndex = 0; // Reset color index

            const datasets = locationFocusesList.map(focus => {
                const focusData = years.map(year => data[year][focus] || 0);
                return {
                    label: focus,
                    data: focusData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Location Focus Distribution Over Years', currentIsDarkMode);
            // Ensure scales.y exists before setting max
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            locationFocusChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions // Use the modified options
            });
        }

        function renderPopularCollegesTrendChart(data, years, popularCollegesList, currentIsDarkMode) {
            const ctx = document.getElementById('popularCollegesTrendChart').getContext('2d');
            if (popularCollegesChartInstance) popularCollegesChartInstance.destroy();
            chartColorIndex = 0; // Reset color index

            const datasets = popularCollegesList.map(college => {
                const collegeData = years.map(year => data[year][college] || 0);
                return {
                    label: college,
                    data: collegeData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Top College Attendance Over Years', currentIsDarkMode);
            // Ensure scales.y exists before setting max
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            popularCollegesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions // Use the modified options
            });
        }

              function getMajorArea(specificMajor) {
            if (!specificMajor) return "Unknown";

            const lowerSpecificMajor = specificMajor.toLowerCase().trim();
            if (lowerSpecificMajor === "" || lowerSpecificMajor === "undecided" || lowerSpecificMajor === "undecided major" || lowerSpecificMajor === "n/a" || lowerSpecificMajor === "exploratory") {
                return "Undecided/Other";
            }

            // Attempt to use majorToAreaMapping first (user needs to update this file)
            for (const keyInMap in majorToAreaMapping) {
                if (keyInMap.toLowerCase() === lowerSpecificMajor) {
                    return majorToAreaMapping[keyInMap]; // This should map to the new granular areas
                }
            }

            // Handle combined majors like "Computer Science & Economics"
            if (lowerSpecificMajor.includes('&') || lowerSpecificMajor.includes(' and ')) {
                const rawParts = lowerSpecificMajor.split(/\s*&\s*|\s+and\s+/);
                const areas = rawParts.map(part => {
                    part = part.trim();
                    if (part === "") return "Unknown";

                    let mappedAreaOfPart = "Other"; // Default for this part

                    // Check majorToAreaMapping for the part
                    for (const keyInMapForPart in majorToAreaMapping) {
                        if (keyInMapForPart.toLowerCase() === part) {
                            mappedAreaOfPart = majorToAreaMapping[keyInMapForPart];
                            break;
                        }
                    }

                    // Fallback keyword logic for the part if not in majorToAreaMapping
                    if (mappedAreaOfPart === "Other" || !PREDEFINED_MAJOR_AREAS.includes(mappedAreaOfPart)) {
                        if (part.includes("computer sci") || part.includes("information tech") || (part.includes("software eng") && !part.includes("game design"))) mappedAreaOfPart = "Computer Science & IT";
                        else if (part.includes("engineering") && !part.includes("software eng") && !part.includes("financial eng")) mappedAreaOfPart = "Engineering"; // Ensure "Software Engineering" goes to CS
                        else if (part.includes("math") || part.includes("stat")) mappedAreaOfPart = "Mathematics & Statistics";
                        else if (part.includes("physics") || part.includes("chemist") || part.includes("astronomy") || part.includes("earth sci") || (part.includes("environmental sci") && !part.includes("studies") && !part.includes("policy"))) mappedAreaOfPart = "Physical Sciences";
                        else if (part.includes("biolog") || part.includes("neurosci") || part.includes("biochem") || part.includes("molecular bio") || part.includes("genetics") || (part.includes("environmental sci") && (part.includes("studies") || part.includes("policy")) )) mappedAreaOfPart = "Life Sciences";
                        else if (part.includes("business") || part.includes("econ") || part.includes("financ") || part.includes("market") || part.includes("account") || part.includes("manag")) mappedAreaOfPart = "Business/Economics";
                        else if (part.includes("english") || part.includes("history") || part.includes("philosophy") || part.includes("literature") || part.includes("language") || part.includes("classic") || part.includes("liberal arts") || part.includes("humanities")) mappedAreaOfPart = "Humanities";
                        else if (part.includes("psych") || part.includes("socio") || part.includes("anthro") || part.includes("political sci") || part.includes("internation rel") || part.includes("government") || part.includes("urban studies") || part.includes("cognitive sci") || part.includes("gender studies") || part.includes("area studies") || part.includes("public policy")) mappedAreaOfPart = "Social Sciences";
                        else if (part.includes("communicat") || part.includes("journalis") || part.includes("media studies")) mappedAreaOfPart = "Communications & Journalism";
                        else if (part.includes("art") || part.includes("design") || part.includes("music") || part.includes("theat") || part.includes("film") || part.includes("drama") || part.includes("visual") || part.includes("game design")) mappedAreaOfPart = "Arts/Design";
                        else if (part.includes("health") || part.includes("medic") || part.includes("nurs") || part.includes("pre-med") || part.includes("public health") || part.includes("pharmacy")) mappedAreaOfPart = "Health Sciences";
                        else if (part.includes("educat") || part.includes("teach")) mappedAreaOfPart = "Education";
                        else mappedAreaOfPart = "Other"; // Fallback for the part
                    }
                    return mappedAreaOfPart;
                });

                const finalAreas = areas.filter(a => a !== "Unknown" && a !== "Other");
                if (finalAreas.length > 0) {
                    const uniqueFinalAreas = [...new Set(finalAreas)];
                    if (uniqueFinalAreas.length === 1) return uniqueFinalAreas[0];
                    // If multiple distinct valid areas, sort them for consistent combined display.
                    return uniqueFinalAreas.sort().join(' & ');
                } else {
                    return "Other"; // If all parts were "Other" or "Unknown"
                }
            }

            // Single major - try substring mapping from majorToAreaMapping (if user updates it with keywords)
            let bestContainedKey = null;
            let longestContainedKeyLength = 0;
            for (const keyInMap in majorToAreaMapping) {
                if (lowerSpecificMajor.includes(keyInMap.toLowerCase())) {
                    // Prefer longer, more specific keys from the mapping file
                    if (keyInMap.length > longestContainedKeyLength) {
                        longestContainedKeyLength = keyInMap.length;
                        bestContainedKey = keyInMap;
                    }
                }
            }
            if (bestContainedKey) {
                return majorToAreaMapping[bestContainedKey]; // Expecting this to be a new granular area
            }

            // Fallback keyword logic for single major
            if (lowerSpecificMajor.includes("computer sci") || lowerSpecificMajor.includes("information tech") || (lowerSpecificMajor.includes("software eng") && !lowerSpecificMajor.includes("game design"))) return "Computer Science & IT";
            if (lowerSpecificMajor.includes("engineering") && !lowerSpecificMajor.includes("software eng") && !lowerSpecificMajor.includes("financial eng")) return "Engineering";
            if (lowerSpecificMajor.includes("math") || lowerSpecificMajor.includes("stat")) return "Mathematics & Statistics";
            if (lowerSpecificMajor.includes("physics") || lowerSpecificMajor.includes("chemist") || lowerSpecificMajor.includes("astronomy")|| lowerSpecificMajor.includes("earth sci") || (lowerSpecificMajor.includes("environmental sci") && !lowerSpecificMajor.includes("studies") && !lowerSpecificMajor.includes("policy"))) return "Physical Sciences";
            if (lowerSpecificMajor.includes("biolog") || lowerSpecificMajor.includes("neurosci") || lowerSpecificMajor.includes("biochem") || lowerSpecificMajor.includes("molecular bio") || lowerSpecificMajor.includes("genetics") || (lowerSpecificMajor.includes("environmental sci") && (lowerSpecificMajor.includes("studies") || lowerSpecificMajor.includes("policy")) )) return "Life Sciences";
            if (lowerSpecificMajor.includes("business") || lowerSpecificMajor.includes("econ") || lowerSpecificMajor.includes("financ") || lowerSpecificMajor.includes("market") || lowerSpecificMajor.includes("account")|| lowerSpecificMajor.includes("manag")) return "Business/Economics";
            if (lowerSpecificMajor.includes("english") || lowerSpecificMajor.includes("history") || lowerSpecificMajor.includes("philosophy") || lowerSpecificMajor.includes("literature") || lowerSpecificMajor.includes("language") || lowerSpecificMajor.includes("classic") || lowerSpecificMajor.includes("liberal arts") || lowerSpecificMajor.includes("humanities")) return "Humanities";
            if (lowerSpecificMajor.includes("psych") || lowerSpecificMajor.includes("socio") || lowerSpecificMajor.includes("anthro") || lowerSpecificMajor.includes("political sci") || lowerSpecificMajor.includes("internation rel") || lowerSpecificMajor.includes("government") || lowerSpecificMajor.includes("urban studies") || lowerSpecificMajor.includes("cognitive sci") || lowerSpecificMajor.includes("gender studies") || lowerSpecificMajor.includes("area studies") || lowerSpecificMajor.includes("public policy")) return "Social Sciences";
            if (lowerSpecificMajor.includes("communicat") || lowerSpecificMajor.includes("journalis") || lowerSpecificMajor.includes("media studies")) return "Communications & Journalism";
            if (lowerSpecificMajor.includes("art") || lowerSpecificMajor.includes("design") || lowerSpecificMajor.includes("music") || lowerSpecificMajor.includes("theat") || lowerSpecificMajor.includes("film") || lowerSpecificMajor.includes("drama") || lowerSpecificMajor.includes("visual") || lowerSpecificMajor.includes("game design")) return "Arts/Design";
            if (lowerSpecificMajor.includes("health") || lowerSpecificMajor.includes("medic") || lowerSpecificMajor.includes("nurs") || lowerSpecificMajor.includes("pre-med") || lowerSpecificMajor.includes("public health") || lowerSpecificMajor.includes("pharmacy")) return "Health Sciences";
            if (lowerSpecificMajor.includes("educat") || lowerSpecificMajor.includes("teach")) return "Education";

            return "Other"; // Final fallback for single major
        }

       function parseRawData(jsonData) { // jsonData will be the rawDataJSON array
            if (!Array.isArray(jsonData)) {
                console.error("Error: Input to parseRawData is not a JSON array.", jsonData);
                return [];
            }

            const rawEntries = [];

            for (const entry of jsonData) {
                if (!entry || typeof entry.name !== 'string' || typeof entry.classYear !== 'string' || typeof entry.college !== 'string') {
                    console.warn("Skipping malformed entry in JSON data:", entry);
                    continue;
                }

                const seniorName = entry.name.trim();
                const collegeNameRaw = entry.college.trim();
                const major = (entry.major && entry.major.trim() !== "") ? entry.major.trim() : "Undecided Major";
                const gradClass = entry.classYear.trim(); // Expecting "21", "22", etc.
                
                const linkedInUrl = (entry.linkedin && entry.linkedin.trim() !== "") ? entry.linkedin.trim() : null;
                const instagramUrl = (entry.instagram && entry.instagram.trim() !== "") ? entry.instagram.trim() : null;
                const bioCaption = (entry.congratsCaption && entry.congratsCaption.trim() !== "") ? entry.congratsCaption.trim() : null;

                const originalFirstName = seniorName.split(' ')[0];

                rawEntries.push({
                    seniorName,
                    collegeNameRaw,
                    major,
                    gradClass: `'${gradClass}`, // Add the apostrophe back for consistency with old format if needed
                    originalFirstName,
                    linkedInUrl,
                    instagramUrl,
                    bioCaption
                });
            }

            // The rest of the logic for photo filenames and creating the final 'choices' array
            // remains similar, but it now consumes the processed 'rawEntries'.

            const firstNameCountsByClass = new Map();
            for (const entry of rawEntries) {
                // gradClass already has the apostrophe from the step above
                if (!firstNameCountsByClass.has(entry.gradClass)) {
                    firstNameCountsByClass.set(entry.gradClass, new Map());
                }
                const classCounts = firstNameCountsByClass.get(entry.gradClass);
                const normalizedFirstNameForCount = normalizeForFilename(entry.originalFirstName.split(' ')[0]);
                classCounts.set(normalizedFirstNameForCount, (classCounts.get(normalizedFirstNameForCount) || 0) + 1);
            }

            const choices = [];
            for (const entry of rawEntries) {
                const { seniorName, collegeNameRaw, major, gradClass, originalFirstName, linkedInUrl, instagramUrl, bioCaption } = entry;
                
                // gradClass here is like "'21"
                const photoYear = gradClass.replace("'", ""); // Results in "21"
                let photoFilename;

                const normalizedFirstNameForLookup = normalizeForFilename(originalFirstName.split(' ')[0]);

                // Ensure gradClass used for map lookup is the one with the apostrophe
                const classCountsMap = firstNameCountsByClass.get(gradClass);
                if (classCountsMap && classCountsMap.get(normalizedFirstNameForLookup) > 1) {
                    photoFilename = normalizeForFilename(seniorName);
                } else {
                    photoFilename = normalizedFirstNameForLookup;
                }

                const seniorPhotoUrlBase = `photos/${photoYear}/${photoFilename}`;
                const normalizedNameKey = normalizeCollegeName(collegeNameRaw);
                const collegeDetails = collegeCoordsAndInfo[normalizedNameKey] || collegeCoordsAndInfo["Generic College"];

                let finalCollegeName = collegeDetails.name;
                if (collegeDetails === collegeCoordsAndInfo["Generic College"] && normalizedNameKey !== "Undecided") {
                    finalCollegeName = normalizedNameKey;
                }
                if (normalizedNameKey === "Undecided") finalCollegeName = "Undecided";

                let collegeTypeToUse = collegeDetails.type;
                if (collegeTypeMappings[normalizedNameKey]) {
                    collegeTypeToUse = collegeTypeMappings[normalizedNameKey];
                } else if (collegeTypeMappings[collegeNameRaw]) {
                     collegeTypeToUse = collegeTypeMappings[collegeNameRaw];
                }

                choices.push({
                    seniorName: seniorName,
                    gradClass: gradClass, // Already in format like "'21"
                    collegeName: finalCollegeName,
                    collegeKey: normalizedNameKey,
                    collegeNameRaw: collegeNameRaw,
                    major: major,
                    lat: collegeDetails.lat,
                    lng: collegeDetails.lng,
                    collegeType: collegeTypeToUse,
                    collegeImageUrl: collegeDetails.imageUrl,
                    collegeHomepageUrl: collegeDetails.homepageUrl,
                    isCampusPublic: collegeDetails.isCampusPublic,
                    locationFocus: collegeDetails.locationFocus,
                    stateOrCountry: collegeDetails.stateOrCountry,
                    seniorPhotoUrl: `${seniorPhotoUrlBase}.jpg`,
                    seniorPhotoUrlPng: `${seniorPhotoUrlBase}.png`,
                    linkedInUrl: linkedInUrl,
                    instagramUrl: instagramUrl,
                    bioCaption: bioCaption,
                });
            }
            return choices;
        }

        function updateStatsTable() {
            const stats = {
                "InCityNYC": { Public: 0, Private: 0, Total: 0 },
                "InStateNYOther": { Public: 0, Private: 0, Total: 0 },
                "OutOfStateUS": { Public: 0, Private: 0, Total: 0 },
                "International": { Public: 0, Private: 0, Total: 0 },
                "Total": { Public: 0, Private: 0, Overall: 0 }
            };

            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided" && school.locationFocus !== "N/A") {
                    const focus = school.locationFocus;
                    const type = school.isCampusPublic ? "Public" : "Private";

                    if (stats[focus]) {
                        stats[focus][type]++;
                        stats[focus].Total++;
                        stats.Total[type]++;
                        stats.Total.Overall++;
                    }
                }
            });

            for (const focus in stats) {
                if (stats.hasOwnProperty(focus)) {
                    if (focus === "Total") {
                        document.querySelector(`#stats-table td[data-stat="Total-Public"]`).textContent = stats.Total.Public;
                        document.querySelector(`#stats-table td[data-stat="Total-Private"]`).textContent = stats.Total.Private;
                        document.querySelector(`#stats-table td[data-stat="Total-Overall"]`).textContent = stats.Total.Overall;
                    } else {
                        document.querySelector(`#stats-table td[data-stat="${focus}-Public"]`).textContent = stats[focus].Public;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Private"]`).textContent = stats[focus].Private;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Total"]`).textContent = stats[focus].Total;
                    }
                }
            }
        }


        function updateMajorSummaryTable() {
            const majorAreaCounts = {};
            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaCounts[area] = 0);
            const allPresentMajorAreasInFilteredData = new Set(PREDEFINED_MAJOR_AREAS);


            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided") {
                    const majorAreaResult = school.majorArea;
                    const areasToCount = [];
                    if (typeof majorAreaResult === 'string' && majorAreaResult.includes(' & ')) {
                        areasToCount.push(...majorAreaResult.split(' & ').map(s => s.trim()));
                    } else if (typeof majorAreaResult === 'string') {
                        areasToCount.push(majorAreaResult.trim());
                    }


                    areasToCount.forEach(area => {
                        if (area && area !== "Unknown") {
                             allPresentMajorAreasInFilteredData.add(area);
                            if (majorAreaCounts.hasOwnProperty(area)) {
                                majorAreaCounts[area]++;
                            } else {
                                majorAreaCounts[area] = 1;
                                if (!PREDEFINED_MAJOR_AREAS.includes(area)) {
                                     // console.warn(`Unexpected major area encountered: ${area} from major: ${school.major}. Adding to table dynamically.`);
                                }
                            }
                        }
                    });
                }
            });

            const tableBody = document.querySelector("#major-summary-table tbody");
            tableBody.innerHTML = "";

            const sortedAreasToDisplay = Array.from(allPresentMajorAreasInFilteredData).sort((a, b) => {
                if ((a === "Undecided/Other" || a === "Other") && (b !== "Undecided/Other" && b !== "Other")) return 1;
                if ((b === "Undecided/Other" || b === "Other") && (a !== "Undecided/Other" && a !== "Other")) return -1;
                return a.localeCompare(b);
            });


            sortedAreasToDisplay.forEach(area => {
                if (majorAreaCounts[area] > 0 || PREDEFINED_MAJOR_AREAS.includes(area) || majorAreaFilterState.hasOwnProperty(area) ) {
                    const row = tableBody.insertRow();
                    const cellArea = row.insertCell();
                    const cellCount = row.insertCell();
                    const cellFilter = row.insertCell();

                    cellArea.textContent = area;
                    cellCount.textContent = majorAreaCounts[area] || 0;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = majorAreaFilterState[area] !== undefined ? majorAreaFilterState[area] : true;
                    checkbox.title = `Filter by ${area}`;
                    checkbox.dataset.majorArea = area;
                    checkbox.addEventListener('change', (event) => {
                        majorAreaFilterState[area] = event.target.checked;
                        updateCheckAllMajorAreasButtonState();
                        updateMarkersVisibility();
                    });
                    cellFilter.appendChild(checkbox);
                }
            });
            updateCheckAllMajorAreasButtonState();
        }

        function updateCheckAllMajorAreasButtonState() {
            const checkAllBtn = document.getElementById('checkAllMajorAreasBtn');
            if (!checkAllBtn) return;
            const allMajorCheckboxes = document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]');
            if (allMajorCheckboxes.length === 0) {
                 checkAllBtn.checked = true;
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allMajorCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allMajorCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }


   function updateMarkersVisibility() {
            if (!allMarkers || !allData) return;

            let visibleCount = 0; // Will be used later if needed, or remove if not

            // --- Grad Class Filter Logic ---
            // True if all grad class filters are checked.
            const allGradClassesEffectivelyChecked = gradClassNames.every(gc => gradClassFilterState[gc]);
            // True if grad class filters exist and all of them are unchecked.
            const noGradClassesActuallyChecked = gradClassNames.length > 0 && gradClassNames.every(gc => !gradClassFilterState[gc]);

            // --- Location Focus Filter Logic ---
            const locationFocusFilterKeys = Object.keys(locationFocusFilterState);
            const allLocationFocusEffectivelyChecked = locationFocusFilterKeys.length === 0 || locationFocusFilterKeys.every(key => locationFocusFilterState[key]);
            const noLocationFocusActuallyChecked = locationFocusFilterKeys.length > 0 && locationFocusFilterKeys.every(key => !locationFocusFilterState[key]);

            // --- Major Area Filter Logic ---
            const majorAreaFilterKeys = Object.keys(majorAreaFilterState);
            const allMajorAreasEffectivelyChecked = majorAreaFilterKeys.length === 0 || majorAreaFilterKeys.every(key => majorAreaFilterState[key]);
            const noMajorAreasActuallyChecked = majorAreaFilterKeys.length > 0 && majorAreaFilterKeys.every(key => !majorAreaFilterState[key]);

            // --- State/Country Filter Logic ---
            const UNKNOWN_STATE_COUNTRY_KEY_FOR_CHECK = "Unknown/Not Applicable";
            const stateCountryFilterKeys = Object.keys(stateCountryFilterState);
            const allStateCountryEffectivelyChecked = stateCountryFilterKeys.length === 0 || stateCountryFilterKeys.every(key => stateCountryFilterState[key]);
            const noStateCountryActuallyChecked = stateCountryFilterKeys.length > 0 && stateCountryFilterKeys.every(key => !stateCountryFilterState[key]);


            allData.forEach((school) => {
                let meetsGradClassCriteria;
                if (noGradClassesActuallyChecked) {
                    meetsGradClassCriteria = false;
                } else {
                    // School meets criteria if all grad classes are checked OR its specific grad class is checked.
                    meetsGradClassCriteria = allGradClassesEffectivelyChecked || (gradClassFilterState[school.gradClass] === true);
                }

                let meetsLocationFocusCriteria;
                if (noLocationFocusActuallyChecked) {
                    meetsLocationFocusCriteria = false;
                } else {
                    meetsLocationFocusCriteria = allLocationFocusEffectivelyChecked || (locationFocusFilterState[school.locationFocus] === true);
                }

                let meetsMajorAreaCriteria;
                if (noMajorAreasActuallyChecked) {
                    meetsMajorAreaCriteria = false;
                } else {
                    const schoolMajorAreas = school.majorArea.split(' & ').map(s => s.trim());
                    meetsMajorAreaCriteria = allMajorAreasEffectivelyChecked || schoolMajorAreas.some(area => majorAreaFilterState[area] === true);
                }

                let meetsStateCountryCriteria;
                const schoolSCKey = (school.stateOrCountry && school.stateOrCountry.trim() !== "" && school.stateOrCountry !== "N/A") ? school.stateOrCountry.trim() : UNKNOWN_STATE_COUNTRY_KEY_FOR_CHECK;
                if (noStateCountryActuallyChecked) {
                    meetsStateCountryCriteria = false;
                } else {
                    meetsStateCountryCriteria = allStateCountryEffectivelyChecked || (stateCountryFilterState[schoolSCKey] === true);
                }

                // Special handling for "Undecided" schools regarding Major Area.
                // Other criteria (Grad Class, Location Focus, State/Country) are handled by the general logic above.
                if (school.collegeName === "Undecided") {
                    const undecidedMajorAreaKey = "Undecided/Other";
                    let passesUndecidedMajorAreaLogic;
                    if (noMajorAreasActuallyChecked) {
                        passesUndecidedMajorAreaLogic = false;
                    } else {
                         // Check if all major areas are effectively checked OR if "Undecided/Other" itself is checked.
                        passesUndecidedMajorAreaLogic = allMajorAreasEffectivelyChecked || (majorAreaFilterState[undecidedMajorAreaKey] === true);
                    }
                    school.isVisible = meetsGradClassCriteria && passesUndecidedMajorAreaLogic && meetsLocationFocusCriteria && meetsStateCountryCriteria;
                } else {
                    school.isVisible = meetsGradClassCriteria && meetsLocationFocusCriteria && meetsMajorAreaCriteria && meetsStateCountryCriteria;
                }


                if (school.isVisible) {
                    visibleCount++;
                } else {
                    // Clean up if item becomes invisible
                    if(schoolsSelectedForZoom.has(school.originalIndex)) {
                        schoolsSelectedForZoom.delete(school.originalIndex);
                        // Potentially update checkbox in list if it reflects schoolsSelectedForZoom
                        const checkboxInList = document.getElementById(`school-checkbox-${school.originalIndex}`);
                        if (checkboxInList) checkboxInList.checked = false;
                    }
                    const markerInfo = allMarkers[school.originalIndex];
                    if (infowindow && infowindow.getMap() && markerInfo && infowindow.anchor === markerInfo.marker) {
                        infowindow.close();
                    }
                    // If this item was the one with the active senior photo popup, close it
                    if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible') && currentlyZoomedSeniorOriginalIndex === school.originalIndex) {
                        hideSeniorPhotoPopup();
                    }

                    // If this item was the one highlighted by keyboard/list-click, reset activeHoverMarkerIndex
                    if (activeHoverMarkerIndex === school.originalIndex) {
                        if (markerInfo && markerInfo.marker) {
                            markerInfo.marker.setIcon(getMarkerIcon(school, false, isDarkMode)); // Revert icon
                            markerInfo.marker.setZIndex(null);
                        }
                        activeHoverMarkerIndex = null;
                    }
                }
            });

            filterSchoolList(); // Updates list display based on school.isVisible and search
            updateStatsTable();
            updateMajorSummaryTable();
            updateCurrentSelectionHighlight(); // Updates list selection visual

            // Update MarkerClusterer with only the visible markers
            if (markerClustererInstance && typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
                markerClustererInstance.clearMarkers();
                const visibleMapMarkers = [];
                allData.forEach(schoolDataFromAllData => {
                    if (schoolDataFromAllData.isVisible) {
                        const markerInfo = allMarkers[schoolDataFromAllData.originalIndex];
                        // Ensure marker exists and is not for an "Undecided" at 0,0 (unless you want to show those)
                        if (markerInfo && markerInfo.marker && !(schoolDataFromAllData.lat === 0 && schoolDataFromAllData.lng === 0)) {
                            visibleMapMarkers.push(markerInfo.marker);
                        }
                    }
                });
                markerClustererInstance.addMarkers(visibleMapMarkers);
            }
        }

        // Helper to get current visible LIs from DOM for selection logic
        function getVisibleListItemsDOM() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return [];

            // For gallery view OR when primary sort target is 'students' (flat list),
            // visible items are student LIs not hidden by search/filters.
            if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
                 return Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'))
                            .filter(li => li.style.display !== 'none' && !li.classList.contains('college-group-header'));
            } 
            // For grouped list view (primary sort target is 'colleges' and not gallery)
            else {
                const items = [];
                const collegeGroupHeaders = listUl.querySelectorAll('li.college-group-header');
                collegeGroupHeaders.forEach(header => {
                    // Only process students under visible headers/sublists
                    if (header.style.display !== 'none') {
                        const studentSublist = header.nextElementSibling;
                        if (studentSublist && studentSublist.classList.contains('student-sublist') && studentSublist.style.display !== 'none') {
                            Array.from(studentSublist.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'))
                                .filter(li => li.style.display !== 'none')
                                .forEach(li => items.push(li));
                        }
                    }
                });
                return items;
            }
        }


            function filterSchoolList() {
            const searchTerm = document.getElementById('schoolSearchInput').value.toLowerCase().trim();
            const listContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            if (!listContentDiv || !listContentDiv.querySelector('ul')) return;

            const mainUl = listContentDiv.querySelector('ul');
            const noResultsMessage = document.getElementById('no-results-message');
            let hasVisibleItemsOverall = false;

            // Case 1: Gallery View OR Flat Student List (currentPrimarySortTarget === 'students')
            if (isGalleryViewEnabled || (currentPrimarySortTarget === 'students' && !isGalleryViewEnabled) ) {
                const listItems = mainUl.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'); // These are all student LIs
                listItems.forEach(item => {
                    const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                    const schoolData = (!isNaN(originalIndex) && allData && allData[originalIndex]) ? allData[originalIndex] : null;

                    if (!schoolData) { // Should not happen if list is built correctly
                        item.style.display = 'none';
                        return;
                    }

                    // Visibility is determined by global filters (schoolData.isVisible) AND search term
                    const meetsGlobalFilters = schoolData.isVisible;
                    let matchesSearch = searchTerm === '';
                    if (!matchesSearch && meetsGlobalFilters) { // Only search if it meets global filters
                        const itemTextContent = item.textContent.toLowerCase(); // Includes Name, College (if present), Major
                        matchesSearch = itemTextContent.includes(searchTerm);
                    }

                    if (meetsGlobalFilters && matchesSearch) {
                        item.style.display = isGalleryViewEnabled ? 'flex' : 'flex'; // Default display for student LIs
                        hasVisibleItemsOverall = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
            // Case 2: Grouped List (currentPrimarySortTarget === 'colleges' AND not isGalleryViewEnabled)
            else {
                const collegeGroupHeaders = mainUl.querySelectorAll('li.college-group-header');
                collegeGroupHeaders.forEach(header => {
                    let groupHasVisibleStudentsMatchingSearchOrFilter = false;
                    const studentSublist = header.nextElementSibling;
                    let collegeNameInHeaderText = header.textContent.toLowerCase(); // Text of the college header itself

                    if (studentSublist && studentSublist.classList.contains('student-sublist')) {
                        const studentItems = studentSublist.querySelectorAll('li[data-original-index]');
                        studentItems.forEach(item => {
                            const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                            const schoolData = (!isNaN(originalIndex) && allData && allData[originalIndex]) ? allData[originalIndex] : null;

                            if (!schoolData) { item.style.display = 'none'; return; }

                            const meetsGlobalFilters = schoolData.isVisible;
                            let matchesSearch = searchTerm === '';

                            if (!matchesSearch && meetsGlobalFilters) {
                                const nameSpan = item.querySelector('span.school-name');
                                const studentLiText = nameSpan ? nameSpan.textContent.toLowerCase() : item.textContent.toLowerCase(); // student name, grad, major (no college here)

                                // A student matches search if:
                                // 1. Their own details (name, major) match the search term
                                // 2. The college they are attending (schoolData.collegeName) matches the search term
                                // 3. The text of the college group header itself matches the search term
                                matchesSearch = studentLiText.includes(searchTerm) ||
                                                (schoolData.collegeName && schoolData.collegeName.toLowerCase().includes(searchTerm)) ||
                                                collegeNameInHeaderText.includes(searchTerm);
                            }

                            if (meetsGlobalFilters && matchesSearch) {
                                item.style.display = 'flex';
                                groupHasVisibleStudentsMatchingSearchOrFilter = true;
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    }

                    // A group header is visible if:
                    // 1. It has at least one student LI that is visible (due to global filters + search)
                    // OR 2. The search term is not empty AND the college header text itself matches the search term
                    //    (even if no specific student detail matches, show the group and its filter-passing students)
                    let headerItselfMatchesSearch = searchTerm !== '' && collegeNameInHeaderText.includes(searchTerm);

                    if (groupHasVisibleStudentsMatchingSearchOrFilter || headerItselfMatchesSearch) {
                        header.style.display = 'list-item';
                        if (studentSublist) studentSublist.style.display = 'block';
                        hasVisibleItemsOverall = true;

                        // If header itself matches, ensure all its filter-passing students are visible
                        // (they might have been hidden if their individual details didn't match search,
                        // but now the parent college matches)
                        if (headerItselfMatchesSearch && !groupHasVisibleStudentsMatchingSearchOrFilter && studentSublist) {
                             const studentItems = studentSublist.querySelectorAll('li[data-original-index]');
                             studentItems.forEach(item => {
                                const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                                const schoolData = allData[originalIndex];
                                if(schoolData && schoolData.isVisible) { // If student passes global filters
                                    item.style.display = 'flex'; // Show them because the college header matched
                                    // No need to set groupHasVisibleStudentsMatchingSearchOrFilter = true here, already handled by headerItselfMatchesSearch
                                }
                             });
                        }

                    } else {
                        header.style.display = 'none';
                        if (studentSublist) studentSublist.style.display = 'none';
                    }
                });
            }

            noResultsMessage.style.display = hasVisibleItemsOverall ? 'none' : 'block';
            updateCurrentSelectionHighlight();
            updateSeparators();
        }

        function updateSeparators() {
            const listContentDiv = document.querySelector('#school-list-control .list-content');
            if (!listContentDiv) return;

            const mainUl = listContentDiv.querySelector('ul');
            if (!mainUl) return;

            // Helper function to process a given UL (either main UL or a sublist UL)
            const processUlForSeparators = (ulElement, isSubListContext) => {
                // Remove existing separators within this specific ulElement using :scope to target direct children
                ulElement.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());

                // Determine if separators should be added for this context
                let shouldAddSeparatorsInThisContext = false;
                if (isSubListContext) { // Separators within a college group's student list
                    shouldAddSeparatorsInThisContext = (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last');
                } else { // Separators in the main list (flat student list or gallery)
                    shouldAddSeparatorsInThisContext =
                        (isGalleryViewEnabled && (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last')) ||
                        (currentPrimarySortTarget === 'students' && !isGalleryViewEnabled && (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last'));
                }

                if (!shouldAddSeparatorsInThisContext) {
                    return;
                }

                // Get visible LI elements *directly within this ulElement* that represent students
                const visibleListItemsInUl = Array.from(ulElement.querySelectorAll(':scope > li:not(.grad-class-separator)[data-original-index]'))
                    .filter(li => li.style.display !== 'none' && !li.classList.contains('college-group-header'));

                if (visibleListItemsInUl.length === 0) return;

                const visibleGradClassesInUl = visibleListItemsInUl.map(li => {
                    const originalIndex = parseInt(li.dataset.originalIndex);
                    return allData[originalIndex]?.gradClass;
                }).filter(gc => gc); // Filter out undefined if any originalIndex was bad

                const uniqueVisibleGradClassesInUl = new Set(visibleGradClassesInUl);

                if (uniqueVisibleGradClassesInUl.size <= 1) {
                    return; // No separators if only one (or zero) unique grad class is visible in this specific list/sublist
                }

                // Iterate through the visible student LIs and insert separators
                let previousVisibleGradClass = null;
                for (let i = 0; i < visibleListItemsInUl.length; i++) {
                    const currentLi = visibleListItemsInUl[i];
                    const originalIndex = parseInt(currentLi.dataset.originalIndex);
                    const currentGradClass = allData[originalIndex]?.gradClass;

                    if (currentGradClass) {
                        if (previousVisibleGradClass !== null && currentGradClass !== previousVisibleGradClass) {
                            const separatorLi = document.createElement('li');
                            separatorLi.className = 'grad-class-separator';
                            // The existing CSS for .grad-class-separator and its gallery-view variant will apply
                            ulElement.insertBefore(separatorLi, currentLi);
                        }
                        previousVisibleGradClass = currentGradClass;
                    }
                }
            };

            if (currentPrimarySortTarget === 'students' || isGalleryViewEnabled) {
                // Processing the main UL for flat student list or gallery view
                processUlForSeparators(mainUl, false);
            } else { // currentPrimarySortTarget === 'colleges' and not gallery view (grouped list)
                // First, ensure no top-level separators in mainUl from a previous state.
                mainUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());

                const studentSublists = mainUl.querySelectorAll('ul.student-sublist');
                studentSublists.forEach(sublistUl => {
                    const parentHeader = sublistUl.previousElementSibling;
                    // Only process sublists whose parent group header is visible and the sublist itself is visible
                    if (parentHeader && parentHeader.classList.contains('college-group-header') && parentHeader.style.display !== 'none') {
                        if (sublistUl.style.display !== 'none') {
                           processUlForSeparators(sublistUl, true);
                        } else {
                           // If sublist is hidden, ensure no separators within it
                           sublistUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());
                        }
                    } else {
                         // If parent group is hidden, also clear separators from its sublist
                         sublistUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());
                    }
                });
            }
        }

                      function showSeniorPhotoPopup(listItem, schoolData) {
         if (!seniorPhotoPopup || !seniorPopupImage || !seniorPopupCaption) {
             console.error("[DEBUG] Senior photo popup elements not initialized properly.");
             return;
         }
         currentlyZoomedSeniorOriginalIndex = schoolData.originalIndex;

         seniorPopupImage.style.display = 'block';
         seniorPopupImage.src = schoolData.seniorPhotoUrl;

         seniorPopupImage.onerror = function() {
             this.src = schoolData.seniorPhotoUrlPng;
             this.onerror = function() {
                 if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                     this.src = schoolData.collegeImageUrl;
                     this.onerror = function() {
                         this.style.display = 'none';
                         this.onerror = null;
                     };
                 } else {
                     this.style.display = 'none';
                     this.onerror = null;
                 }
             };
         };

         seniorPopupImage.alt = `${schoolData.seniorName}'s Photo / ${schoolData.collegeName} Logo`;

         const isImageFullyZoomed = seniorPopupImage && seniorPopupImage.classList.contains('zoomed');
         const isPopupContainerInZoomedState = seniorPhotoPopup && seniorPhotoPopup.classList.contains('zoomed-state');
         const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
         const zoomedBioCaptionEl = document.getElementById('zoomed-bio-caption-content');
         const zoomedSocialLinksEl = document.getElementById('zoomed-social-links-container');
         // --- Ensure new global vars are accessible or re-fetch if needed (though global should be fine) ---
         // const zoomedGradClassInfoDiv = document.getElementById('zoomed-grad-class-info'); 
         // const zoomedGradClassValueSpan = document.getElementById('zoomed-grad-class-value');


         if (isImageFullyZoomed && isPopupContainerInZoomedState && zoomedInfoPanel && zoomedBioCaptionEl && zoomedSocialLinksEl) {
             // Mode: Image is fully zoomed, update side panel caption
             
             // --- NEW: Populate Graduating Class Info ---
             if (zoomedGradClassInfoDiv && zoomedGradClassValueSpan) {
                 zoomedGradClassValueSpan.textContent = schoolData.gradClass;
                 zoomedGradClassValueSpan.style.color = gradClassColors[schoolData.gradClass] || (isDarkMode ? '#EEE' : '#111'); // Fallback color
                 zoomedGradClassInfoDiv.style.display = 'block';
             }
             // --- END NEW ---

             zoomedBioCaptionEl.innerHTML = schoolData.bioCaption || `Congrats, ${schoolData.seniorName}!`;

             zoomedSocialLinksEl.innerHTML = ''; 
             if (schoolData.linkedInUrl) { 
                 const liLink = document.createElement('a');
                 liLink.href = schoolData.linkedInUrl;
                 liLink.target = "_blank";
                 liLink.title = "LinkedIn Profile";
                 liLink.innerHTML = createSocialLinkSVG('linkedin', 28, isDarkMode, true);
                 zoomedSocialLinksEl.appendChild(liLink);
             }
             if (schoolData.instagramUrl) { 
                 const igLink = document.createElement('a');
                 igLink.href = schoolData.instagramUrl;
                 igLink.target = "_blank";
                 igLink.title = "Instagram Profile";
                 igLink.innerHTML = createSocialLinkSVG('instagram', 28, isDarkMode, true);
                 zoomedSocialLinksEl.appendChild(igLink);
             }

             zoomedInfoPanel.style.display = 'block';
             seniorPhotoPopup.classList.add('with-side-panel');
             if (seniorPopupCaption) seniorPopupCaption.style.display = 'none'; 

         } else {
             // Mode: Small hover/click popup
             if (schoolData.bioCaption && schoolData.bioCaption.trim() !== "") {
                 seniorPopupCaption.innerHTML = schoolData.bioCaption;
             } else {
                 seniorPopupCaption.textContent = `Congrats, ${schoolData.seniorName}!`;
             }
             if (seniorPopupCaption) seniorPopupCaption.style.display = ''; 

             if (zoomedInfoPanel) zoomedInfoPanel.style.display = 'none'; 
             // --- NEW: Hide Graduating Class Info for small popup ---
             if (zoomedGradClassInfoDiv) zoomedGradClassInfoDiv.style.display = 'none';
             // --- END NEW ---
             seniorPhotoPopup.classList.remove('with-side-panel'); 
         }


         const controlsPanel = document.getElementById('controls-and-list-container');
         const isDesktopView = window.innerWidth > 768;
         const isPanelClosedDesktop = isDesktopView && controlsPanel.classList.contains('panel-desktop-hidden');

         let popupFinalWidth, popupLeft, popupTop;

         if (isPanelClosedDesktop && !(isImageFullyZoomed && isPopupContainerInZoomedState) ) { 
             popupFinalWidth = 350;
             seniorPhotoPopup.style.width = `${popupFinalWidth}px`;
             seniorPopupImage.style.maxHeight = '450px';
             popupLeft = 20;
             popupTop = 70;
              if (popupLeft + popupFinalWidth > window.innerWidth - 10) {
                 popupLeft = Math.max(10, window.innerWidth - popupFinalWidth - 10);
             }
             let approxPopupHeight = Math.min(seniorPopupImage.naturalHeight || 450, 450) + (seniorPopupCaption.offsetHeight || 20) + 20;
             if (popupTop + approxPopupHeight > window.innerHeight - 10) {
                 popupTop = Math.max(10, window.innerHeight - approxPopupHeight - 10);
             }
             popupTop = Math.max(10, popupTop);


         } else if (!(isImageFullyZoomed && isPopupContainerInZoomedState)) { 
             seniorPhotoPopup.style.width = '200px';
             seniorPopupImage.style.maxHeight = '';
             popupFinalWidth = seniorPhotoPopup.offsetWidth;
             let popupCurrentHeight = seniorPhotoPopup.offsetHeight;
             const viewportWidth = window.innerWidth;
             const viewportHeight = window.innerHeight;
             const marginFromPanel = 15;
             const paddingFromViewportEdge = 10;
             const leftPanelRect = controlsPanel.getBoundingClientRect();

             if (listItem) {
                 const listItemRect = listItem.getBoundingClientRect();
                 popupTop = listItemRect.top;
             } else {
                 popupTop = (viewportHeight - popupCurrentHeight) / 2;
             }
             popupTop = Math.max(paddingFromViewportEdge, popupTop);
             if (popupTop + popupCurrentHeight > viewportHeight - paddingFromViewportEdge) {
                 popupTop = viewportHeight - popupCurrentHeight - paddingFromViewportEdge;
             }
             popupTop = Math.max(paddingFromViewportEdge, popupTop);
             popupLeft = leftPanelRect.right + marginFromPanel;
             if ((popupLeft + popupFinalWidth > viewportWidth - paddingFromViewportEdge) ||
                 (leftPanelRect.width > viewportWidth * 0.6 && leftPanelRect.left < viewportWidth / 2)) {
                 popupLeft = leftPanelRect.left - popupFinalWidth - marginFromPanel;
                 if (popupLeft < paddingFromViewportEdge || leftPanelRect.width >= viewportWidth - (2 * paddingFromViewportEdge)) {
                     const mapElement = document.getElementById('map');
                     if (mapElement && mapElement.offsetWidth > popupFinalWidth / 2) {
                         popupLeft = leftPanelRect.right + marginFromPanel;
                         if (popupLeft + popupFinalWidth > viewportWidth - paddingFromViewportEdge) {
                             const mapRect = mapElement.getBoundingClientRect();
                             popupLeft = mapRect.left + (mapRect.width - popupFinalWidth) / 2;
                         }
                     } else {
                         popupLeft = (viewportWidth - popupFinalWidth) / 2;
                     }
                 }
             }
             popupLeft = Math.max(paddingFromViewportEdge, popupLeft);
             popupLeft = Math.min(popupLeft, viewportWidth - popupFinalWidth - paddingFromViewportEdge);
         }

         if (!(isImageFullyZoomed && isPopupContainerInZoomedState)) {
              seniorPhotoPopup.style.left = `${popupLeft}px`;
              seniorPhotoPopup.style.top = `${popupTop}px`;
         }
         seniorPhotoPopup.classList.add('visible');
     }

            function exitZoomMode(hideSmallPopupAfter = true) {
         if (!seniorPhotoPopup || !seniorPopupImage) return;

         const parentPopup = seniorPhotoPopup;
          if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
          if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
          parentPopup.classList.remove('zoomed-state');

           const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
         if (zoomedInfoPanel) zoomedInfoPanel.style.display = 'none';
         // --- NEW: Hide Graduating Class Info ---
         if (zoomedGradClassInfoDiv) zoomedGradClassInfoDiv.style.display = 'none';
         // --- END NEW ---
         parentPopup.classList.remove('with-side-panel');

         if (seniorPopupImage.classList.contains('zoomed')) {
             seniorPopupImage.classList.remove('zoomed');

             if (photoZoomOverlay) photoZoomOverlay.style.display = 'none';
             if (zoomExitNote) zoomExitNote.style.display = 'none';

             parentPopup.style.transform = parentPopup.dataset.originalTransform || '';
             parentPopup.style.left = parentPopup.dataset.originalLeft || '';
             parentPopup.style.top = parentPopup.dataset.originalTop || '';
             parentPopup.style.width = parentPopup.dataset.originalWidth || '';
             parentPopup.style.height = parentPopup.dataset.originalHeight || '';
             parentPopup.style.backgroundColor = parentPopup.dataset.originalBg || '';
             parentPopup.style.border = parentPopup.dataset.originalBorder || '';
             parentPopup.style.boxShadow = parentPopup.dataset.originalBoxShadow || '';
             parentPopup.style.padding = parentPopup.dataset.originalPadding || '';
             parentPopup.style.pointerEvents = parentPopup.dataset.originalPointerEvents || 'auto';

             delete parentPopup.dataset.originalTransform;
             delete parentPopup.dataset.originalLeft;
             // ... (rest of delete dataset properties)
             delete parentPopup.dataset.originalPointerEvents;


             if (hideSmallPopupAfter) {
                  hideSeniorPhotoPopup();
             }
         } else if (hideSmallPopupAfter) {
             hideSeniorPhotoPopup();
         }
     }


        function getHonorarySuffixHTML(rawCollegeName) {
            let suffixHtml = "";
            const rawLower = rawCollegeName.toLowerCase();
            if (rawLower.includes("(macaulay)")) suffixHtml = ' <span class="honorary-suffix">Macaulay</span>';
            else if (rawLower.includes("(questbridge)")) suffixHtml = ' <span class="honorary-suffix">QuestBridge</span>';
            else if (rawLower.includes("(posse)")) suffixHtml = ' <span class="honorary-suffix">POSSE</span>';
            return suffixHtml;
        }


                function handleListItemInteraction(event, originalIndex, isHover) {
             if (event && event.target && event.target.type === 'checkbox') return;
             if (originalIndex === undefined || !allData[originalIndex]) {
                console.warn("Invalid originalIndex or data for list item interaction:", originalIndex);
                return;
             }

             const schoolData = allData[originalIndex]; // This is the clicked/hovered student
             const markerInfo = allMarkers[originalIndex];

             if (!schoolData.isVisible) {
                if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                    const currentCaption = seniorPopupCaption.textContent;
                    if (currentCaption.includes(schoolData.seniorName)) {
                        hideSeniorPhotoPopup();
                    }
                }
                return;
             }
            const currentTargetListItem = event ? event.currentTarget : document.querySelector(`.list-content li[data-original-index="${originalIndex}"]`);


             if (isHover) { // Hover behavior remains largely the same: focus on the individual
                if (panelJustToggledOpen) return;
                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                    }
                }
                showSeniorPhotoPopup(currentTargetListItem, schoolData);
             } else { // Click behavior
                if (infowindow && infowindow.getMap()) {
                    infowindow.close();
                }

                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                        map.setZoom(Math.max(map.getZoom(), 12));

                        // ---- New InfoWindow Content Logic for Grouped Display ----
                        let contentString = `<div class="info-window-content">`;
                        const targetUrl = schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#' ? schoolData.collegeHomepageUrl : '#';
                        const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                        if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                            contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${schoolData.collegeImageUrl}" alt="${schoolData.collegeName} logo/photo"></a>`;
                        }

                        if (targetUrl !== '#') {
                            contentString += `<b><a href="${targetUrl}" ${openInNewTab}>${schoolData.collegeName}</a></b>`;
                        } else {
                            contentString += `<b>${schoolData.collegeName}</b>`;
                        }
                        contentString += `<br><span class="info-window-type">Type: ${schoolData.collegeType} (${schoolData.isCampusPublic ? 'Public' : 'Private'}, ${schoolData.locationFocus})</span>`;
                        if (schoolData.lat !== 0 || schoolData.lng !== 0) {
                            contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${schoolData.lat},${schoolData.lng}" target="_blank">Get Directions</a>`;
                        }
                        contentString += `<hr style="margin: 5px 0;">`;

                        if (schoolData.collegeName === "Undecided") {
                            const suffixHtml = getHonorarySuffixHTML(schoolData.collegeNameRaw);
                            contentString += `<b>${schoolData.seniorName}</b>${suffixHtml}`;
                            contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[schoolData.gradClass] || '#ccc'};">Class: ${schoolData.gradClass}</span>`;
                            contentString += `<br>Major: ${schoolData.major || 'Undecided Major'} (${schoolData.majorArea || 'N/A'})`;
                        } else {
                            const studentsAtSameCollege = allData.filter(s =>
                                s.isVisible &&
                                s.collegeName === schoolData.collegeName &&
                                s.collegeName !== "Undecided"
                            ).sort((a, b) => {
                                if (a.gradClass !== b.gradClass) return a.gradClass.localeCompare(b.gradClass);
                                const lastNameA = getLastName(a.seniorName);
                                const lastNameB = getLastName(b.seniorName);
                                if (lastNameA !== lastNameB) return lastNameA.localeCompare(lastNameB);
                                return getFirstName(a.seniorName).localeCompare(getFirstName(b.seniorName));
                            });

                            if (studentsAtSameCollege.length > 0) {
                                contentString += `<u>Students Attending (Visible):</u><ul style="margin-top: 3px; margin-bottom: 3px; padding-left: 18px;">`;
                                studentsAtSameCollege.forEach(student => {
                                    const suffixHtml = getHonorarySuffixHTML(student.collegeNameRaw);
                                    let studentEntry = `<li>`;
                                    if (student.originalIndex === originalIndex) studentEntry += `<b>`; // Highlight the clicked student
                                    studentEntry += `${student.seniorName}${suffixHtml} <span class="info-window-grad-class" style="color: ${gradClassColors[student.gradClass] || '#ccc'};">(${student.gradClass})</span>`;
                                    if (student.originalIndex === originalIndex) studentEntry += `</b>`;
                                    studentEntry += `<br><small style="padding-left: 10px;">Major: ${student.major || 'Undecided'} (${student.majorArea || 'N/A'})</small>`;
                                    studentEntry += `</li>`;
                                    contentString += studentEntry;
                                });
                                contentString += `</ul>`;
                            }
                        }
                        contentString += `</div>`;
                        // ---- End New InfoWindow Content Logic ----

                        infowindow.setContent(contentString);
                        infowindow.open({ map: map, anchor: markerInfo.marker });
                    }
                }
                // Show senior photo popup for the specific student whose list item was clicked
                showSeniorPhotoPopup(currentTargetListItem, schoolData);

                 if (event && (event.ctrlKey || event.metaKey) && schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#') {
                     window.open(schoolData.collegeHomepageUrl, '_blank');
                     event.preventDefault();
                 }
             }
        }

               function navigateToSeniorPhoto(direction) {
                console.log(`%c[NAV_DEBUG] NAVIGATE START (${direction}) ==================`, "color: blue; font-weight: bold;");
            console.log(`[NAV_DEBUG] Initial currentlyZoomedSeniorOriginalIndex: ${currentlyZoomedSeniorOriginalIndex}`);


            const visibleListItems = getVisibleListItemsDOM();
            console.log(`[NAV_DEBUG] Found ${visibleListItems.length} visible list items.`);
             if (visibleListItems.length > 0) {
                // Log first few to check order (optional, can be noisy)
                // console.log('[NAV_DEBUG] First 5 visible items (originalIndex):', visibleListItems.slice(0, 5).map(li => li.dataset.originalIndex));
            }
            if (visibleListItems.length === 0) {
                 console.warn("[NAV_DEBUG] No visible list items. Navigation aborted.");
                return;
            }
            let currentIndexInVisibleList = -1;
            if (currentlyZoomedSeniorOriginalIndex !== null) {
                currentIndexInVisibleList = visibleListItems.findIndex(li =>
                    parseInt(li.dataset.originalIndex) === currentlyZoomedSeniorOriginalIndex
                );
            }
             console.log(`[NAV_DEBUG] currentIndexInVisibleList (index in visibleListItems for current photo): ${currentIndexInVisibleList}`);

            let newIndexInVisibleList;
            if (currentIndexInVisibleList === -1) {
                newIndexInVisibleList = (direction === 'next') ? 0 : visibleListItems.length - 1;
                console.log(`[NAV_DEBUG] current index was -1, defaulting newIndexInVisibleList to: ${newIndexInVisibleList}`);
            } else {
                if (direction === 'next') {
                    newIndexInVisibleList = (currentIndexInVisibleList + 1) % visibleListItems.length;
                } else {
                    newIndexInVisibleList = (currentIndexInVisibleList - 1 + visibleListItems.length) % visibleListItems.length;
                }
                console.log(`[NAV_DEBUG] Calculated newIndexInVisibleList (0-based in visibleListItems): ${newIndexInVisibleList}`);
            }

            const newListItem = visibleListItems[newIndexInVisibleList];
            if (newListItem) {
                const newOriginalIndex = parseInt(newListItem.dataset.originalIndex);
                console.log(`[NAV_DEBUG] Target newListItem found. Its originalIndex: ${newOriginalIndex}`);
                const newSeniorData = allData[newOriginalIndex];

                if (newSeniorData) {
                      console.log(`[NAV_DEBUG] Navigating to senior: ${newSeniorData.seniorName} (originalIndex: ${newOriginalIndex})`);
                    currentlyZoomedSeniorOriginalIndex = newOriginalIndex; // Keep this for tracking
                    
                    // Update the main zoomed image
                    seniorPopupImage.src = newSeniorData.seniorPhotoUrl;
                     seniorPopupImage.onerror = function() {
                        this.src = newSeniorData.seniorPhotoUrlPng;
                        this.onerror = function() {
                            if (newSeniorData.collegeImageUrl && newSeniorData.collegeImageUrl !== 'x' && !newSeniorData.collegeImageUrl.startsWith('placeholder')) {
                                this.src = newSeniorData.collegeImageUrl;
                            } else { this.style.display = 'none'; }
                            this.onerror = null;
                        };
                    };
                    seniorPopupImage.alt = `${newSeniorData.seniorName}'s Photo / ${newSeniorData.collegeName} Logo`;
                    
                    // --- REMOVED THIS LINE ---
                    // seniorPopupCaption.textContent = `Congrats, ${newSeniorData.seniorName}!`; 
                    // The showSeniorPhotoPopup (called via handleListItemInteraction) will now handle caption placement.

                    currentListSelectionIndex = newIndexInVisibleList;
                    updateCurrentSelectionHighlight(); // Visually select in list
                    newListItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     newListItem.focus(); // For keyboard accessibility


                    // This call will trigger showSeniorPhotoPopup, which now correctly handles caption
                    // placement based on whether the image is fully zoomed or not.
                      console.log(`[NAV_DEBUG] Calling handleListItemInteraction for originalIndex: ${newOriginalIndex}. This should update currentlyZoomedSeniorOriginalIndex.`);
                    handleListItemInteraction({ currentTarget: newListItem, target: newListItem, ctrlKey: false, metaKey: false }, newOriginalIndex, false);

                     console.log(`[NAV_DEBUG] currentlyZoomedSeniorOriginalIndex *after* handleListItemInteraction: ${currentlyZoomedSeniorOriginalIndex}`);
                    if (currentlyZoomedSeniorOriginalIndex !== newOriginalIndex) {
                        console.error(`[NAV_DEBUG] CRITICAL MISMATCH! Expected currentlyZoomedSeniorOriginalIndex to be ${newOriginalIndex}, but it is ${currentlyZoomedSeniorOriginalIndex}. This is the cause of skipping!`);
                        // If this error appears, the problem is that showSeniorPhotoPopup isn't correctly setting the global, or there's an async issue.
                    }

                    // Marker highlighting logic
                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== newOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    if (allMarkers[newOriginalIndex]?.marker && allData[newOriginalIndex]) {
                         allMarkers[newOriginalIndex].marker.setIcon(getMarkerIcon(allData[newOriginalIndex], true, isDarkMode));
                         allMarkers[newOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                         activeHoverMarkerIndex = newOriginalIndex;
                    }
                } else {
                    console.warn(`[NAV_DEBUG] WARN: No senior data found for newOriginalIndex: ${newOriginalIndex}`);
                }
            } else {
                console.warn(`[NAV_DEBUG] WARN: newListItem is undefined for newIndexInVisibleList: ${newIndexInVisibleList}. This might happen if visibleListItems is unexpectedly empty or index is out of bounds.`);
            }
            console.log(`%c[NAV_DEBUG] NAVIGATE END (${direction}) ====================`, "color: blue; font-weight: bold;");
        }


        function zoomToSelectedSchools() {
            if (!google || !map || !allMarkers) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            schoolsSelectedForZoom.forEach(originalIndex => {
                const schoolData = allData[originalIndex];
                const markerInfo = allMarkers[originalIndex];

                if (schoolData && schoolData.isVisible && markerInfo && markerInfo.marker) {
                    if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {
                        // Skip
                    } else if (schoolData.lat === 0 && schoolData.lng === 0) {
                        console.warn("Skipping school with 0,0 coordinates from zoom:", schoolData.displayName);
                    }
                    else {
                        bounds.extend(markerInfo.marker.getPosition());
                        validVisiblePoints++;
                    }
                }
            });

            if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }

        function zoomToAllVisibleMarkers() {
            if (!google || !map || !allMarkers || !allData) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            allData.forEach(schoolData => {
                if (schoolData.isVisible) {
                    const markerInfo = allMarkers[schoolData.originalIndex];
                     if (markerInfo && markerInfo.marker) {
                        if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {
                           // skip
                        } else if (schoolData.lat === 0 && schoolData.lng === 0) {
                            // skip
                        } else {
                            bounds.extend(markerInfo.marker.getPosition());
                            validVisiblePoints++;
                        }
                    }
                }
            });
             if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }


        function hideSeniorPhotoPopup() {
    if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
        seniorPhotoPopup.classList.remove('visible'); // This makes it display: none via CSS

        // Reset inline styles that might have been set for the "large" mode
        // or by the regular positioning logic.
        seniorPhotoPopup.style.width = ''; 
        seniorPhotoPopup.style.maxHeight = '';
        seniorPhotoPopup.style.overflowY = '';
        seniorPhotoPopup.style.left = ''; // Important to reset positioning
        seniorPhotoPopup.style.top = '';  // Important to reset positioning
        
        if (seniorPopupImage) {
            seniorPopupImage.style.maxHeight = ''; // Reset image specific max-height
            if (seniorPopupImage.classList.contains('zoomed')) {
                // exitZoomMode will handle restoring the image from its zoomed state
                // and its `hideSmallPopupAfter = false` prevents re-hiding.
                exitZoomMode(false); 
            }
        }
        
        // If the popup being hidden was linked to the activeHoverMarkerIndex, reset that marker's icon
        // and clear activeHoverMarkerIndex.
        if (currentlyZoomedSeniorOriginalIndex !== null && 
            activeHoverMarkerIndex === currentlyZoomedSeniorOriginalIndex && // check if this was the marker that was hovered
            allMarkers[activeHoverMarkerIndex] && 
            allMarkers[activeHoverMarkerIndex].marker) {
            
            const schoolData = allData[activeHoverMarkerIndex];
            if (schoolData) { // Ensure schoolData is valid before using
                allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
            }
            activeHoverMarkerIndex = null; 
        }
        
        currentlyZoomedSeniorOriginalIndex = null; // Always reset this

        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
    }
}

        function handleSearchInput() {
             const input = document.getElementById('schoolSearchInput');
             const suggestionsDiv = document.getElementById('searchSuggestions');
             const searchTerm = input.value.toLowerCase().trim();

             suggestionsDiv.innerHTML = '';
             suggestionsDiv.style.display = 'none';

             if (searchTerm.length < 2) {
                filterSchoolList();
                return;
             }

             if (!allData) return;

             const matchingEntries = allData.filter(entry =>
                entry.isVisible &&
                 (
                    (entry.seniorName && entry.seniorName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeName && entry.collegeName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeNameRaw && entry.collegeNameRaw.toLowerCase().includes(searchTerm)) ||
                    (entry.major && entry.major.toLowerCase().includes(searchTerm)) ||
                    (entry.majorArea && entry.majorArea.toLowerCase().includes(searchTerm))
                )
             ).slice(0, 10);

             if (matchingEntries.length > 0) {
                 matchingEntries.forEach(entry => {
                     const div = document.createElement('div');
                     const suffixHtml = getHonorarySuffixHTML(entry.collegeNameRaw);
                     div.innerHTML = `${entry.seniorName} (${entry.gradClass}) ‚Üí ${entry.collegeName}${suffixHtml} (${entry.major || 'Undecided'})`;

                     div.onclick = () => {
                         input.value = entry.seniorName;
                         suggestionsDiv.style.display = 'none';
                         filterSchoolList();

                         const clickedOriginalIndex = entry.originalIndex;
                         const listItem = document.querySelector(`.list-content li[data-original-index="${clickedOriginalIndex}"]`);
                         if (listItem) {
                            handleListItemInteraction({ currentTarget: listItem, target: listItem, ctrlKey: false, metaKey: false }, clickedOriginalIndex, false);
                            listItem.scrollIntoView({behavior: 'smooth', block: 'nearest'});

                            const listUl = document.querySelector('#school-list-control .list-content ul');
                            const visibleListItemsAfterSearch = getVisibleListItemsDOM();
                            currentListSelectionIndex = visibleListItemsAfterSearch.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                            if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                                allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                                allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                            }
                            if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                                allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                                allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                                activeHoverMarkerIndex = clickedOriginalIndex;
                            }
                            updateCurrentSelectionHighlight();
                         }
                     };
                     suggestionsDiv.appendChild(div);
                 });
                 suggestionsDiv.style.display = 'block';
             }
             filterSchoolList();
        }


        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function sortAndRebuildList() {
        // This function now primarily sets the sort options.
        // The actual sorting of allData for gallery view happens here.
        // Grouping and sorting for list view happens within rebuildSchoolListHTML.

        if (!allData) return;

        // Sort the flat allData array based on currentStudentSortOption.
        // This is primarily for gallery view or if a flat list is ever needed.
        allData.sort((a, b) => {
            let comparison = 0;
            const gradClassA = parseInt(a.gradClass.substring(1));
            const gradClassB = parseInt(b.gradClass.substring(1));
            const firstNameA = getFirstName(a.seniorName);
            const firstNameB = getFirstName(b.seniorName);
            const lastNameA = getLastName(a.seniorName);
            const lastNameB = getLastName(b.seniorName);

            switch (currentStudentSortValue) { // MODIFIED from currentStudentSortOption
            case 'grad_first':
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = firstNameA.localeCompare(firstNameB);
                break;
            case 'grad_last':
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = lastNameA.localeCompare(lastNameB);
                if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                break;
            case 'first_name':
                comparison = firstNameA.localeCompare(firstNameB);
                if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB);
                break;
            case 'last_name':
                comparison = lastNameA.localeCompare(lastNameB);
                if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                break;
            default:
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = firstNameA.localeCompare(firstNameB);
                break;
        }
        return comparison;
    });

        rebuildSchoolListHTML(); // This will now handle grouping and its specific sorting
        currentListSelectionIndex = -1;
        updateCurrentSelectionHighlight();
    }

    function rebuildSchoolListHTML() {
        const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
        if (!schoolListCollapsibleContentDiv) {
            console.error("School list collapsible content div not found.");
            return;
        }
        let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
        const noResultsMessage = document.getElementById('no-results-message');

        if (!schoolListUl) {
            schoolListUl = document.createElement('ul');
            schoolListCollapsibleContentDiv.insertBefore(schoolListUl, noResultsMessage);
        }
        schoolListUl.innerHTML = ''; // Clear existing list

        if (!allData) {
            schoolListUl.innerHTML = '<li>Data is not available.</li>';
            if (noResultsMessage) noResultsMessage.style.display = 'none';
            return;
        }

        if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
            allData.forEach(seniorChoice => {
                if (seniorChoice.isVisible) { // Based on global filters, search will refine later
                    schoolListUl.appendChild(createStudentListItem(seniorChoice));
                }
            });
        } else { // GROUPED LIST: Primary Sort Target is "Colleges"
            const studentGroupsByCollege = new Map();
            allData.forEach(seniorChoice => {
                if (seniorChoice.isVisible) { // Based on global filters
                    const groupKey = seniorChoice.collegeKey || seniorChoice.collegeName;
                    if (!studentGroupsByCollege.has(groupKey)) {
                        studentGroupsByCollege.set(groupKey, { students: [], collegeInfo: seniorChoice });
                    }
                    studentGroupsByCollege.get(groupKey).students.push(seniorChoice);
                }
            });

            let collegeEntries = Array.from(studentGroupsByCollege.entries()).map(([key, data]) => {
                const collegeDetail = collegeCoordsAndInfo[key] || { name: data.collegeInfo.collegeName };
                return {
                    groupKey: key,
                    displayName: collegeDetail.name,
                    students: data.students
                };
            });

            collegeEntries.sort((entryA, entryB) => {
                const nameA = entryA.displayName.toLowerCase();
                const nameB = entryB.displayName.toLowerCase();
                const countA = entryA.students.length;
                const countB = entryB.students.length;
                switch (currentCollegeSortValue) {
                    case 'name_asc': return nameA.localeCompare(nameB);
                    case 'name_desc': return nameB.localeCompare(nameA);
                    case 'count_desc': return countB - countA || nameA.localeCompare(nameB);
                    case 'count_asc': return countA - countB || nameA.localeCompare(nameB);
                    default: return nameA.localeCompare(nameB);
                }
            });

            collegeEntries.forEach(collegeEntry => {
                const collegeHeaderLi = document.createElement('li');
                collegeHeaderLi.className = 'college-group-header';
                collegeHeaderLi.innerHTML = `${collegeEntry.displayName} <span style="font-weight:normal;">(Students: ${collegeEntry.students.length})</span>`;
                schoolListUl.appendChild(collegeHeaderLi);

                collegeEntry.students.sort((a, b) => { // Sort students within the group
                    let comparison = 0;
                    const gradClassA = parseInt(a.gradClass.substring(1));
                    const gradClassB = parseInt(b.gradClass.substring(1));
                    const firstNameA = getFirstName(a.seniorName);
                    const firstNameB = getFirstName(b.seniorName);
                    const lastNameA = getLastName(a.seniorName);
                    const lastNameB = getLastName(b.seniorName);
                    switch (currentStudentSortValue) {
                        case 'grad_first':
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = firstNameA.localeCompare(firstNameB); break;
                        case 'grad_last':
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = lastNameA.localeCompare(lastNameB);
                            if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB); break;
                        case 'first_name':
                            comparison = firstNameA.localeCompare(firstNameB);
                            if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB); break;
                        case 'last_name':
                            comparison = lastNameA.localeCompare(lastNameB);
                            if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB); break;
                        default:
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = firstNameA.localeCompare(firstNameB); break;
                    }
                    return comparison;
                });

                const studentSublistUl = document.createElement('ul');
                studentSublistUl.className = 'student-sublist';
                collegeEntry.students.forEach(student => { // Iterate and append
                    studentSublistUl.appendChild(createStudentListItem(student)); // THIS WAS THE MISSING LINE
                });
                schoolListUl.appendChild(studentSublistUl);
            });
        }
        filterSchoolList();
        updateCurrentSelectionHighlight();
    }


        // Helper function to create a student LI (used in both flat and grouped lists)
                       // This function is nested within rebuildSchoolListHTML
                // Helper function to create a student LI (used in both flat and grouped lists)
        function createStudentListItem(seniorChoice) {
            const studentLi = document.createElement('li');
            const originalIndex = seniorChoice.originalIndex;
            studentLi.setAttribute('data-original-index', originalIndex);
            studentLi.setAttribute('tabindex', '0');

            // Updated title to be conditional based on gallery view
            let liTitle = "Click: Zoom & Info. Ctrl+Click: Homepage. Hover: Photo.";
            if (isGalleryViewEnabled) {
                liTitle += " Shift+Click checkbox: Group Zoom.";
            }
            studentLi.setAttribute('title', liTitle);


            const schoolCheckbox = document.createElement('input');
            schoolCheckbox.type = 'checkbox';
            schoolCheckbox.id = `school-checkbox-${originalIndex}`;
            schoolCheckbox.className = 'school-select-checkbox';
            schoolCheckbox.checked = schoolsSelectedForZoom.has(originalIndex);
            schoolCheckbox.title = `Select for Group Zoom (Shift+Click to toggle all for '${seniorChoice.collegeName}')`;

            schoolCheckbox.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                if (isChecked) {
                    schoolsSelectedForZoom.add(originalIndex);
                } else {
                    schoolsSelectedForZoom.delete(originalIndex);
                }

                if (event.shiftKey && seniorChoice.collegeName !== "Undecided") {
                    const allStudentsAtThisCollege = allData.filter(s =>
                        s.isVisible &&
                        s.collegeName === seniorChoice.collegeName
                    );
                    allStudentsAtThisCollege.forEach(student => {
                        const studentCheckboxInDOM = document.getElementById(`school-checkbox-${student.originalIndex}`);
                        if (isChecked) {
                            schoolsSelectedForZoom.add(student.originalIndex);
                            if (studentCheckboxInDOM) studentCheckboxInDOM.checked = true;
                        } else {
                            schoolsSelectedForZoom.delete(student.originalIndex);
                            if (studentCheckboxInDOM) studentCheckboxInDOM.checked = false;
                        }
                    });
                    zoomToSelectedSchools();
                }
            });


            const nameSpan = document.createElement('span');
            nameSpan.className = 'school-name';

            let studentDisplayText = `${seniorChoice.seniorName} <span style="color: ${gradClassColors[seniorChoice.gradClass] || '#ccc'}; font-weight: bold;">(${seniorChoice.gradClass})</span>`;
            const individualSuffixHtml = getHonorarySuffixHTML(seniorChoice.collegeNameRaw);

            if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
                studentDisplayText += ` ‚Üí ${seniorChoice.collegeName}`;
            }
            studentDisplayText += ` <span class="list-item-major">(${(seniorChoice.major || 'Undecided Major')})</span>`;
            if (individualSuffixHtml) {
                 studentDisplayText += individualSuffixHtml;
            }
            nameSpan.innerHTML = studentDisplayText; // Set base text

            // Add social media icons to nameSpan
            if (seniorChoice.linkedInUrl) {
                const linkedInLink = document.createElement('a');
                linkedInLink.href = seniorChoice.linkedInUrl;
                linkedInLink.target = "_blank";
                linkedInLink.title = "LinkedIn Profile";
                linkedInLink.classList.add("social-icon-link");
                linkedInLink.innerHTML = createSocialLinkSVG('linkedin', 16, isDarkMode);
                nameSpan.appendChild(linkedInLink);
            }
            if (seniorChoice.instagramUrl) {
                const instagramLink = document.createElement('a');
                instagramLink.href = seniorChoice.instagramUrl;
                instagramLink.target = "_blank";
                instagramLink.title = "Instagram Profile";
                instagramLink.classList.add("social-icon-link");
                instagramLink.innerHTML = createSocialLinkSVG('instagram', 16, isDarkMode);
                nameSpan.appendChild(instagramLink);
            }

            if (isGalleryViewEnabled) {
                studentLi.style.backgroundColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
                studentLi.appendChild(schoolCheckbox); // Checkbox first for gallery

                const gradClassTextElement = document.createElement('div');
                gradClassTextElement.className = 'gallery-grad-class-overlay';
                gradClassTextElement.textContent = seniorChoice.gradClass;
                const bgColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
                if (bgColor.startsWith('#')) {
                    const r = parseInt(bgColor.slice(1, 3), 16);
                    const g = parseInt(bgColor.slice(3, 5), 16);
                    const b = parseInt(bgColor.slice(5, 7), 16);
                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                    gradClassTextElement.style.color = brightness > 135 ? '#1A1A1A' : '#FAFAFA';
                } else {
                    gradClassTextElement.style.color = '#FFFFFF'; // Default for non-hex (e.g. named colors)
                }
                studentLi.appendChild(gradClassTextElement);

                const galleryPhotoDiv = document.createElement('div');
                galleryPhotoDiv.className = 'gallery-photo-div';
                const galleryImg = document.createElement('img');
                galleryImg.className = 'gallery-photo';
                galleryImg.src = seniorChoice.seniorPhotoUrl;
                galleryImg.alt = `${seniorChoice.seniorName}'s Photo`;
                galleryImg.onerror = function() {
                    this.src = seniorChoice.seniorPhotoUrlPng; // Try PNG version
                    this.onerror = function() { // If PNG also fails, try college image
                        this.src = seniorChoice.collegeImageUrl && !seniorChoice.collegeImageUrl.startsWith('placeholder') ? seniorChoice.collegeImageUrl : 'placeholder-logo.png'; // Fallback to placeholder if no college image
                        this.onerror = null; // Prevent infinite loop if placeholder also fails
                    };
                };
                galleryPhotoDiv.appendChild(galleryImg);
                studentLi.appendChild(galleryPhotoDiv);
                // nameSpan is not appended in gallery view as per original CSS (display: none !important;)
            } else { // Default List View (either flat student list or grouped under college)
                // studentLi.appendChild(schoolCheckbox); // <<< THIS LINE IS REMOVED TO HIDE CHECKBOX IN LIST VIEW
                studentLi.appendChild(nameSpan);
            }

            studentLi.addEventListener('mouseenter', (event) => {
                if (panelJustToggledOpen) return;

                const currentOriginalIndex = originalIndex;
                const schoolData = allData[currentOriginalIndex];
                const markerInfo = allMarkers[currentOriginalIndex];
                if (markerInfo?.marker && schoolData?.isVisible) {
                    markerInfo.marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                    markerInfo.marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                    handleListItemInteraction(event, currentOriginalIndex, true);
                }
                studentLi.classList.add('list-item-highlight');
            });
            studentLi.addEventListener('mouseleave', (event) => {
                const currentOriginalIndex = originalIndex;
                const schoolData = allData[currentOriginalIndex];
                const markerInfo = allMarkers[currentOriginalIndex];

                let isKeyboardSelected = false;
                if (currentListSelectionIndex !== -1) {
                    const visibleLIs = getVisibleListItemsDOM();
                    if (currentListSelectionIndex < visibleLIs.length) {
                        const kbdSelectedLi = visibleLIs[currentListSelectionIndex];
                        if (kbdSelectedLi && parseInt(kbdSelectedLi.dataset.originalIndex) === currentOriginalIndex) {
                            isKeyboardSelected = true;
                        }
                    }
                }

                if (!isKeyboardSelected && markerInfo?.marker && schoolData && activeHoverMarkerIndex !== currentOriginalIndex) {
                    markerInfo.marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                    markerInfo.marker.setZIndex(null);
                }
                 if (!isKeyboardSelected) {
                    studentLi.classList.remove('list-item-highlight');
                }
            });
            studentLi.addEventListener('click', (event) => {
                // If a checkbox is part of the list item (e.g., in gallery view) and is clicked, let its own event handler manage it.
                if (event.target.type === 'checkbox' && studentLi.contains(event.target)) return;

                const clickedOriginalIndex = originalIndex;
                handleListItemInteraction(event, clickedOriginalIndex, false);

                const visibleListItems = getVisibleListItemsDOM();
                currentListSelectionIndex = visibleListItems.findIndex(li => li === studentLi);

                if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                }
                if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                     allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                     allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                     activeHoverMarkerIndex = clickedOriginalIndex;
                }
                updateCurrentSelectionHighlight();
            });
            return studentLi;
        }


         // Apply search term filtering to the newly built list


        function updateCurrentSelectionHighlight() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const allEntryListItems = Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)'));

            allEntryListItems.forEach(item => {
                item.classList.remove('current-selection-highlight');
                item.classList.remove('list-item-highlight');
            });

            const visibleListItems = getVisibleListItemsDOM();

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const selectedLi = visibleListItems[currentListSelectionIndex];
                if (selectedLi) {
                    selectedLi.classList.add('current-selection-highlight');
                }
            }
        }

        function navigateList(direction) {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const visibleListItems = getVisibleListItemsDOM();

            if (visibleListItems.length === 0) {
                if (activeHoverMarkerIndex !== null && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                }
                activeHoverMarkerIndex = null;
                currentListSelectionIndex = -1;
                updateCurrentSelectionHighlight();
                return;
            }

            let newVisibleIndex = currentListSelectionIndex;

            if (newVisibleIndex === -1) {
                newVisibleIndex = (direction === 'down') ? 0 : visibleListItems.length - 1;
            } else {
                if (direction === 'down') {
                    newVisibleIndex = (newVisibleIndex + 1) % visibleListItems.length;
                } else if (direction === 'up') {
                    newVisibleIndex = (newVisibleIndex - 1 + visibleListItems.length) % visibleListItems.length;
                }
            }

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const previouslySelectedLi = visibleListItems[currentListSelectionIndex];
                if (previouslySelectedLi) {
                    const prevOriginalIndex = parseInt(previouslySelectedLi.dataset.originalIndex);
                    const newOriginalIndexIfKnown = visibleListItems[newVisibleIndex] ? parseInt(visibleListItems[newVisibleIndex].dataset.originalIndex) : -1;

                    if (!isNaN(prevOriginalIndex) && allMarkers[prevOriginalIndex]?.marker && allData[prevOriginalIndex]) {
                         if(prevOriginalIndex !== newOriginalIndexIfKnown && prevOriginalIndex !== activeHoverMarkerIndex) {
                            allMarkers[prevOriginalIndex].marker.setIcon(getMarkerIcon(allData[prevOriginalIndex], false, isDarkMode));
                            allMarkers[prevOriginalIndex].marker.setZIndex(null);
                         }
                    }
                }
            }

            currentListSelectionIndex = newVisibleIndex;
            const selectedLi = visibleListItems[currentListSelectionIndex];

            if (selectedLi) {
                const originalIndexOfNewSelection = parseInt(selectedLi.dataset.originalIndex);
                if (!isNaN(originalIndexOfNewSelection) && allData[originalIndexOfNewSelection]) {
                    handleListItemInteraction({ currentTarget: selectedLi, target: selectedLi, ctrlKey: false, metaKey: false }, originalIndexOfNewSelection, false);
                    selectedLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    selectedLi.focus();

                    if (allMarkers[originalIndexOfNewSelection]?.marker) {
                        allMarkers[originalIndexOfNewSelection].marker.setIcon(getMarkerIcon(allData[originalIndexOfNewSelection], true, isDarkMode));
                        allMarkers[originalIndexOfNewSelection].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                        if(activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== originalIndexOfNewSelection && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                             allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                             allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                        }
                        activeHoverMarkerIndex = originalIndexOfNewSelection;
                    }
                }
            }
            updateCurrentSelectionHighlight();
        }


        async function initializeApp() {
    try {
        const response = await fetch('jsonData.json'); // Fetch the new JSON file
        if (!response.ok) {
            throw new Error(`Failed to fetch jsonData.json: ${response.status} ${response.statusText}`);
        }
        const jsonDataFromFile = await response.json(); // Parse it

        console.log("[DEBUG] Attempting to initialize seniorCollegeChoices and allData from jsonData.json...");
        // Use jsonDataFromFile with parseRawData
        seniorCollegeChoices = parseRawData(jsonDataFromFile);
        
        if (!Array.isArray(seniorCollegeChoices)) {
            console.error("[DEBUG] parseRawData did not return an array. Value:", seniorCollegeChoices);
            throw new Error("Data parsing failed: seniorCollegeChoices is not an array.");
        }
        console.log(`[DEBUG] seniorCollegeChoices initialized. Length: ${seniorCollegeChoices.length}`);

        console.log("[DEBUG] Initializing allData by mapping seniorCollegeChoices...");
        allData = seniorCollegeChoices.map((choice, index) => {
            if (!choice || typeof choice !== 'object') {
                console.error(`[DEBUG] Malformed item in seniorCollegeChoices at index ${index}:`, choice);
                // Return a dummy object or skip to prevent further errors
                return { 
                    displayName: `Error - Malformed Data (Index ${index})`, 
                    originalIndex: index, 
                    isVisible: false, 
                    majorArea: "Unknown" 
                };
            }
            // Ensure essential properties exist for the mapping logic
            if (typeof choice.seniorName !== 'string' || typeof choice.gradClass !== 'string' || typeof choice.collegeName !== 'string') {
                console.warn(`[DEBUG] Item with missing/invalid essential string properties in seniorCollegeChoices at index ${index}. Item:`, choice);
                return { 
                    ...choice, 
                    displayName: `Error - Missing Properties (Index ${index})`, 
                    originalIndex: index, 
                    isVisible: false,
                    majorArea: getMajorArea(choice.major) // Attempt to get majorArea even if other fields are problematic
                };
            }
            const majorArea = getMajorArea(choice.major); // getMajorArea should handle undefined major
            return {
                ...choice,
                displayName: `${choice.seniorName} (${choice.gradClass}) ‚Üí ${choice.collegeName}`,
                originalIndex: index,
                isVisible: true, 
                majorArea: majorArea
            };
            // Filter out items that became problematic during mapping
        }).filter(item => item && item.displayName && !item.displayName.startsWith("Error -")); 

        console.log(`[DEBUG] allData initialized. Length: ${allData.length}`);

        if (!allData || !Array.isArray(allData)) { 
            console.error("[DEBUG] allData is not a valid array after mapping.");
            throw new Error("allData initialization failed: result is not an array.");
        }
        console.log(`[DEBUG] Global: allData initialized successfully with ${allData.length} items.`);
        window.isDataReadyForMap = true;

    } catch (error) {
        console.error("CRITICAL ERROR during application data initialization:", error.message, error.stack);
        const criticalErrorDiv = document.createElement('div');
        criticalErrorDiv.id = "critical-initialization-error-message";
        criticalErrorDiv.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; background-color: #ffdddd; border-bottom: 2px solid red; padding: 15px; text-align: center; z-index: 10000; color: black; font-family: sans-serif;";
        criticalErrorDiv.innerHTML = `
            <h2 style="margin-top:0; color: red;">Application Initialization Error</h2>
            <p>There was a critical error while preparing the application's core data. The map functionality will be severely limited or unavailable.</p>
            <p><strong>Error details:</strong> ${error.message}</p>
            <p>Please check the browser's developer console for more technical information (specifically, look for errors logged *before* any 'initMap' errors).</p>`;
        
        // Prepend to body if body exists, otherwise alert as a last resort.
        if (document.body) {
            if (!document.getElementById("critical-initialization-error-message")) {
                 document.body.prepend(criticalErrorDiv);
            }
        } else {
            window.addEventListener('DOMContentLoaded', () => {
                if (document.body && !document.getElementById("critical-initialization-error-message")) {
                    document.body.prepend(criticalErrorDiv);
                }
            });
             setTimeout(() => { // Fallback alert
                 if (!document.getElementById("critical-initialization-error-message")) {
                    alert("CRITICAL ERROR during application data initialization: " + error.message + ". Check console.");
                 }
            }, 500);
        }
        window.isDataReadyForMap = false;
    }

    // Call initMap AFTER data processing attempt. 
    // initMap itself should check window.isDataReadyForMap.
    initMap();
}

                      function initMap() {
            console.log("[DEBUG] initMap function called.");

            if (!window.isDataReadyForMap || !allData || !Array.isArray(allData)) {
                console.error("[DEBUG] initMap: Data is not ready or allData is invalid. Aborting map initialization.");
                const mapDiv = document.getElementById("map");
                if (mapDiv) {
                    mapDiv.innerHTML = `<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;"><strong>Error: Map data is not available or is invalid.</strong><br>The map cannot be initialized. This usually indicates a problem during the initial data loading and processing phase.<br>Please check the browser's developer console for more detailed error messages that might have occurred before this point.</p>`;
                }
                const controlsContainer = document.getElementById('controls-and-list-container');
                if (controlsContainer) {
                    controlsContainer.style.opacity = '0.5';
                    controlsContainer.style.pointerEvents = 'none';
                }
                return;
            }
            console.log(`[DEBUG] initMap: Data is ready. Proceeding with allData containing ${allData.length} items.`);


             

            stateCountryFilterState = {}; // Initialize as empty object

            const stateCountryFiltersContainer = document.getElementById('state-country-filters-container');
            if (stateCountryFiltersContainer && allData && allData.length > 0) {
                const uniqueStateCountries = new Set();
                const UNKNOWN_STATE_COUNTRY_KEY = "Unknown/Not Applicable";

                allData.forEach(school => {
                    if (school.collegeName === "Undecided") { // Include "Undecided" for the "Unknown/Not Applicable" category
                         uniqueStateCountries.add(UNKNOWN_STATE_COUNTRY_KEY);
                         return;
                    }
                    const stateCountry = school.stateOrCountry;
                    if (stateCountry && stateCountry.trim() !== "" && stateCountry !== "N/A") {
                        uniqueStateCountries.add(stateCountry.trim());
                    } else {
                        uniqueStateCountries.add(UNKNOWN_STATE_COUNTRY_KEY);
                    }
                });

                const sortedStateCountries = Array.from(uniqueStateCountries).sort((a, b) => {
                    if (a === UNKNOWN_STATE_COUNTRY_KEY) return 1; // Push "Unknown" to the end
                    if (b === UNKNOWN_STATE_COUNTRY_KEY) return -1;
                    return a.localeCompare(b);
                });

                const fragmentStateCountryFilters = document.createDocumentFragment();
                                sortedStateCountries.forEach(scName => {
                    stateCountryFilterState[scName] = true; // Default to checked

                    const filterId = `filter-sc-${scName.replace(/\W+/g, '-')}`;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'filter-item'; // Re-use existing class for styling consistency

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = filterId;
                    checkbox.value = scName;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', (event) => {
                        stateCountryFilterState[scName] = event.target.checked;
                        updateMarkersVisibility();
                        // Optional: update a master check/uncheck button for states/countries if you add one
                    });

                    const label = document.createElement('label');
                    label.htmlFor = filterId;
                    
                    // Corrected logic for studentCountForSC:
                    const studentCountForSC = allData.filter(s => {
                        const studentActualSCKey = (s.stateOrCountry && s.stateOrCountry.trim() !== "" && s.stateOrCountry !== "N/A") 
                                                 ? s.stateOrCountry.trim() 
                                                 : UNKNOWN_STATE_COUNTRY_KEY;
                        // A student 's' contributes to the count of 'scName' if their actual SC key matches scName.
                        // This covers "Undecided" students correctly because their s.stateOrCountry will often be "N/A"
                        // (or missing) from collegeCoordsAndInfo, leading to studentActualSCKey being UNKNOWN_STATE_COUNTRY_KEY.
                        return studentActualSCKey === scName;
                    }).length;

                    label.appendChild(document.createTextNode(` ${scName} (${studentCountForSC})`));

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    fragmentStateCountryFilters.appendChild(itemDiv);
                });
                stateCountryFiltersContainer.appendChild(fragmentStateCountryFilters);

                // Add event listeners for the new Check All/Uncheck All buttons
                document.getElementById('checkAllStateCountryBtn').addEventListener('click', () => {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => {
                        stateCountryFilterState[cb.value] = true;
                        cb.checked = true;
                    });
                    updateMarkersVisibility();
                });
                document.getElementById('uncheckAllStateCountryBtn').addEventListener('click', () => {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => {
                        stateCountryFilterState[cb.value] = false;
                        cb.checked = false;
                    });
                    updateMarkersVisibility();
                });

            } else if (stateCountryFiltersContainer) {
                 stateCountryFiltersContainer.innerHTML = "<p style='font-style:italic; font-size:0.9em; padding:5px;'>No state/country data to filter.</p>";
            }


            // Collapsible sections for map controls
            document.querySelectorAll('.map-control > h4').forEach(header => {
                // Exclude the main description header from being collapsible
                if (header.parentElement && header.parentElement.id === 'description-control') {
                    header.style.cursor = 'default'; // Remove pointer cursor
                    if (header.querySelector('::after')) header.querySelector('::after').remove(); // Remove indicator if any
                    return;
                }
                 // Also exclude the school list header itself, as it has its own toggle button
                if (header.parentElement && header.parentElement.classList.contains('list-header-container')) {
                     header.style.cursor = 'default';
                     return;
                }


                const content = header.nextElementSibling;
                if (content && content.classList.contains('control-content')) {
                    header.addEventListener('click', () => {
                        content.classList.toggle('collapsed');
                        header.classList.toggle('collapsed'); // For +/- indicator styling
                    });
                } else {
                    // If h4 is not directly followed by .control-content (e.g. filter headers in #filter-control)
                    // find the relevant content block if structure is different
                    let currentElement = header;
                    let foundContent = null;
                    while(currentElement.nextElementSibling && !foundContent) {
                        currentElement = currentElement.nextElementSibling;
                        if (currentElement.classList.contains('control-content') ||
                            currentElement.id === 'grad-class-filters-container' || // Specific IDs that act as content blocks
                            currentElement.id === 'state-country-filters-container' ||
                            currentElement.tagName === 'TABLE' || // e.g. stats-table, major-summary-table
                            currentElement.classList.contains('chart-container') // For trends
                           ) {
                           foundContent = currentElement;
                           // If multiple chart containers, they need to be wrapped in a single parent .control-content
                        }
                    }
                    if (foundContent && foundContent.parentElement.id !== header.parentElement.id) { // Only if it's a direct child or specific structure
                         // This simple nextElementSibling might not work for complex layouts within a single .map-control.
                         // The current structure has .control-content divs for this.
                    }
                }
            });


            baseMarkerIcon = { path: google.maps.SymbolPath.CIRCLE, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            highlightedMarkerIcon = { ...baseMarkerIcon, scale: 10, strokeWeight: 2.0 };

            seniorPhotoPopup = document.getElementById('senior-photo-popup');
            if (!seniorPhotoPopup) {
                console.error("[DEBUG] CRITICAL: senior-photo-popup element not found in the DOM!");
                document.getElementById('map').innerHTML = '<p style="color:red; text-align:center;">Error: UI element (senior-photo-popup) missing. Cannot initialize map features.</p>';
                return;
            }

            seniorPopupImage = seniorPhotoPopup.querySelector('img');
            seniorPopupCaption = document.getElementById('senior-photo-caption');
            closeSeniorPhotoBtn = document.getElementById('close-senior-photo-popup');
            zoomExitNote = document.getElementById('zoom-exit-note');
            prevSeniorPhotoBtn = document.getElementById('prev-senior-photo');
            nextSeniorPhotoBtn = document.getElementById('next-senior-photo');
            zoomedGradClassInfoDiv = document.getElementById('zoomed-grad-class-info');
         zoomedGradClassValueSpan = document.getElementById('zoomed-grad-class-value');

         if (!zoomedGradClassInfoDiv || !zoomedGradClassValueSpan) console.error("[DEBUG] CRITICAL: Zoomed grad class info elements not found!");


            if (!seniorPopupImage) console.error("[DEBUG] CRITICAL: senior-photo-popup img element not found!");
            if (!seniorPopupCaption) console.error("[DEBUG] CRITICAL: senior-photo-caption element not found!");
            if (!closeSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: close-senior-photo-popup element not found!");
            if (!zoomExitNote) console.error("[DEBUG] CRITICAL: zoom-exit-note element not found!");
            if (!prevSeniorPhotoBtn || !nextSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: Photo navigation arrow buttons not found!");


            photoZoomOverlay = document.createElement('div');
            photoZoomOverlay.id = 'photo-zoom-overlay';
            document.body.appendChild(photoZoomOverlay);

            if (closeSeniorPhotoBtn) closeSeniorPhotoBtn.addEventListener('click', () => exitZoomMode(true));
            if (photoZoomOverlay) photoZoomOverlay.addEventListener('click', () => exitZoomMode(true));
            if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('prev'));
            if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('next'));


            if(zoomExitNote){
                const zoomExitNoteDismissButton = zoomExitNote.querySelector('.dismiss-button');
                if (zoomExitNoteDismissButton) {
                    zoomExitNoteDismissButton.removeAttribute('onclick');
                    zoomExitNoteDismissButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        this.parentElement.style.display = 'none';
                    });
                }
            }

                        if (seniorPopupImage) {
                seniorPopupImage.addEventListener('click', function(e) {
                    if (e.target === seniorPopupImage && !this.classList.contains('zoomed')) {
                        const parentPopup = this.closest('#senior-photo-popup');
                        parentPopup.classList.add('zoomed-state');

                        parentPopup.dataset.originalTransform = getComputedStyle(parentPopup).transform;
                        parentPopup.dataset.originalLeft = parentPopup.style.left;
                        parentPopup.dataset.originalTop = parentPopup.style.top;
                        parentPopup.dataset.originalWidth = parentPopup.style.width;
                        parentPopup.dataset.originalHeight = parentPopup.style.height;
                        parentPopup.dataset.originalBg = parentPopup.style.backgroundColor;
                        parentPopup.dataset.originalBorder = getComputedStyle(parentPopup).border;
                        parentPopup.dataset.originalBoxShadow = getComputedStyle(parentPopup).boxShadow;
                        parentPopup.dataset.originalPadding = getComputedStyle(parentPopup).padding;
                        parentPopup.dataset.originalPointerEvents = getComputedStyle(parentPopup).pointerEvents || 'auto';

                        parentPopup.style.transform = 'none';
                        parentPopup.style.left = '0px'; parentPopup.style.top = '0px';
                        parentPopup.style.width = '100vw'; parentPopup.style.height = '100vh';
                        parentPopup.style.padding = '0';
                        parentPopup.style.backgroundColor = 'transparent';
                        parentPopup.style.border = 'none'; parentPopup.style.boxShadow = 'none';
                        parentPopup.style.pointerEvents = 'none';

                        this.style.maxWidth = '';
                        this.style.maxHeight = '';

                        if (infowindow && infowindow.getMap()) {
                            infowindow.close();
                        }
                        
                        this.classList.add('zoomed');
                        if (photoZoomOverlay) photoZoomOverlay.style.display = 'block';
                        if (zoomExitNote) zoomExitNote.style.display = 'block';
                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'block';
                        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'block';

                        const seniorData = allData[currentlyZoomedSeniorOriginalIndex];
                        const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
                        const zoomedBioCaptionEl = document.getElementById('zoomed-bio-caption-content');
                        const zoomedSocialLinksEl = document.getElementById('zoomed-social-links-container');
                        // Note: zoomedGradClassInfoDiv and zoomedGradClassValueSpan are global and already defined

                          if (seniorData && zoomedInfoPanel && zoomedBioCaptionEl && zoomedSocialLinksEl) {
                            
                            // --- MODIFICATION START: Populate Grad Class Info on initial zoom ---
                            if (zoomedGradClassInfoDiv && zoomedGradClassValueSpan) {
                                zoomedGradClassValueSpan.textContent = seniorData.gradClass;
                                zoomedGradClassValueSpan.style.color = gradClassColors[seniorData.gradClass] || (isDarkMode ? '#EEE' : '#111'); // Fallback color
                                zoomedGradClassInfoDiv.style.display = 'block';
                            }
                            // --- MODIFICATION END ---

                            zoomedBioCaptionEl.innerHTML = seniorData.bioCaption || `Congrats, ${seniorData.seniorName}!`; // Default if bio is empty

                             zoomedSocialLinksEl.innerHTML = ''; // Clear previous links
                            if (seniorData.linkedInUrl) {
                                const liLink = document.createElement('a');
                                liLink.href = seniorData.linkedInUrl;
                                liLink.target = "_blank";
                                liLink.title = "LinkedIn Profile";
                                liLink.innerHTML = createSocialLinkSVG('linkedin', 28, isDarkMode, true); 
                                zoomedSocialLinksEl.appendChild(liLink);
                            }
                            if (seniorData.instagramUrl) {
                                const igLink = document.createElement('a');
                                igLink.href = seniorData.instagramUrl;
                                igLink.target = "_blank";
                                igLink.title = "Instagram Profile";
                                igLink.innerHTML = createSocialLinkSVG('instagram', 28, isDarkMode, true); 
                                zoomedSocialLinksEl.appendChild(igLink);
                            }
                            zoomedInfoPanel.style.display = 'block';
                            
                            if(seniorPopupCaption) seniorPopupCaption.style.display = 'none';
                            parentPopup.classList.add('with-side-panel');
                        }

                        this.style.pointerEvents = 'auto';
                        if(seniorPopupCaption) seniorPopupCaption.style.pointerEvents = 'auto';
                        if(closeSeniorPhotoBtn) closeSeniorPhotoBtn.style.pointerEvents = 'auto';

                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.pointerEvents = 'auto';
                        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.pointerEvents = 'auto';
                    }
                });
            }

            sortAndRebuildList();

            gradClassFilterState = {};
            gradClassNames.forEach(gc => gradClassFilterState[gc] = true);

            const locationFocusKeys = ["InCityNYC", "InStateNYOther", "OutOfStateUS", "International", "N/A"];
            locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);

            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);


            const mapOptions = {
                center: { lat: 41.8, lng: -74.5 }, zoom: 7,
                mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
                styles: null,
                fullscreenControl: true, streetViewControl: true, zoomControl: true, mapTypeControl: true,
                gestureHandling: 'greedy'
            };
            map = new google.maps.Map(document.getElementById("map"), mapOptions); // Correctly initialize map. Semicolon ends the statement.
            
            // Initialize infowindow, schoolsSelectedForZoom, and transitLayer separately.
            infowindow = new google.maps.InfoWindow();
            schoolsSelectedForZoom = new Set();
            transitLayer = new google.maps.TransitLayer();

            // The erroneous block and its contents have been removed/corrected.
            


            const locationFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            locationFocusCheckboxes.forEach(checkbox => {
                const focusKey = checkbox.dataset.locationFocus;
                checkbox.checked = locationFocusFilterState[focusKey];
                checkbox.addEventListener('change', (event) => {
                    locationFocusFilterState[focusKey] = event.target.checked;
                    updateCheckAllLocationFocusButtonState();
                    updateMarkersVisibility();
                });
            });

            const checkAllLocationFocusBtn = document.getElementById('checkAllLocationFocusBtn');
            checkAllLocationFocusBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                locationFocusCheckboxes.forEach(cb => {
                    const focusKey = cb.dataset.locationFocus;
                    locationFocusFilterState[focusKey] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });
            updateCheckAllLocationFocusButtonState();


            const gradClassFiltersContainer = document.getElementById('grad-class-filters-container');
            const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const schoolSearchInput = document.getElementById('schoolSearchInput');
            const listHeaderContainer = document.querySelector('#school-list-control .list-header-container');
            const toggleSchoolListBtn = document.getElementById('toggleSchoolListBtn');
            const toggleSatelliteViewBtn = document.getElementById('toggleSatelliteViewBtn');
            const toggleTransitBtn = document.getElementById('toggleTransitBtn');
            const checkAllGradClassesBtn = document.getElementById('checkAllGradClassesBtn');
            const uncheckAllGradClassesBtn = document.getElementById('uncheckAllGradClassesBtn');
            const zoomToVisibleBtn = document.getElementById('zoomToVisibleBtn');
            const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
            const toggleGalleryViewBtn = document.getElementById('toggleGalleryViewBtn');

            gradClassFiltersContainer.innerHTML = '';
            const fragmentGradClassFilters = document.createDocumentFragment();
            gradClassNames.sort().forEach(gcName => {
                const filterId = `filter-grad-${gcName.replace(/\W+/g, '-')}`;
                const itemDiv = document.createElement('div'); itemDiv.className = 'filter-item';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = filterId; checkbox.value = gcName;
                checkbox.checked = gradClassFilterState[gcName];
                checkbox.addEventListener('change', (event) => { gradClassFilterState[gcName] = event.target.checked; updateMarkersVisibility(); });
                const label = document.createElement('label'); label.htmlFor = filterId;
                const colorBox = document.createElement('span'); colorBox.className = 'filter-color-box'; colorBox.style.backgroundColor = gradClassColors[gcName] || '#cccccc';
                label.appendChild(colorBox);
                const seniorCountForClass = allData.filter(s => s.gradClass === gcName).length;
                label.appendChild(document.createTextNode(` ${gcName} (${seniorCountForClass})`));
                itemDiv.appendChild(checkbox); itemDiv.appendChild(label); fragmentGradClassFilters.appendChild(itemDiv);
            });
            gradClassFiltersContainer.appendChild(fragmentGradClassFilters);

            if (listHeaderContainer && !document.getElementById('schoolListTip')) {
                 const tipDiv = document.createElement('div'); tipDiv.id = 'schoolListTip'; tipDiv.className = 'tip-message';
                 const tipText = document.createElement('span');
                 tipText.innerHTML = 'Tips: <br>‚Ä¢ Filters update Stats & Major tables.<br>‚Ä¢ Checkboxes toggle visibility.<br>‚Ä¢ <b>Shift + Click checkbox</b>: Group Zoom.<br>‚Ä¢ <b>CTRL/CMD + Click name</b>: College Homepage.<br>‚Ä¢ Hover list/marker to highlight & see photo.<br>‚Ä¢ Click senior photo to zoom (Esc to close).<br>‚Ä¢ Use ‚Üë‚Üì keys to navigate list; ‚Üê ‚Üí in zoomed photo.<br>‚Ä¢ Left panel is resizable.<br>‚Ä¢ Explore different sort options for colleges and students!<br>‚Ä¢ Dark mode can be easier on the eyes.';
                 const dismissBtn = document.createElement('span'); dismissBtn.className = 'dismiss-button'; dismissBtn.textContent = 'x'; dismissBtn.title = 'Dismiss this tip';
                 dismissBtn.onclick = () => { tipDiv.style.display = 'none'; };
                 tipDiv.appendChild(tipText); tipDiv.appendChild(dismissBtn);
                 listHeaderContainer.insertAdjacentElement('afterend', tipDiv);
            }

            toggleSchoolListBtn.addEventListener('click', () => {
                const listContent = document.querySelector('.school-list-collapsible-content');
                const isHidden = listContent.classList.toggle('hidden');
                toggleSchoolListBtn.textContent = isHidden ? 'Show List' : 'Hide List';
                toggleSchoolListBtn.title = isHidden ? 'Show college and senior list' : 'Hide college and senior list';
            });

            toggleTransitBtn.addEventListener('click', () => {
                if (transitLayerEnabled) {
                    transitLayer.setMap(null); toggleTransitBtn.textContent = 'üöá Show Transit'; toggleTransitBtn.title = 'Show Transit Layer';
                } else {
                    transitLayer.setMap(map); toggleTransitBtn.textContent = 'üöá Hide Transit'; toggleTransitBtn.title = 'Hide Transit Layer';
                }
                transitLayerEnabled = !transitLayerEnabled;
            });

            zoomToVisibleBtn.addEventListener('click', zoomToAllVisibleMarkers);

                        if (closeSeniorPhotoBtn) {
                closeSeniorPhotoBtn.addEventListener('click', () => {
                    // This button is for the non-image-zoomed popup (small or large-styled)
                    // If the image *inside* happens to be zoomed, exit that specific image zoom first.
                    if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                        exitZoomMode(true); // exitZoomMode(true) will call hideSeniorPhotoPopup
                    } else {
                        hideSeniorPhotoPopup(); // Just hide the currently styled (small or large) popup
                    }
                });
            }



            clearAllFiltersBtn.addEventListener('click', () => {
                // ... (existing resets for grad class, location focus, major area) ...
                gradClassNames.forEach(gc => gradClassFilterState[gc] = true);
                gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = true);

                locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);
                document.querySelectorAll('.location-focus-filter').forEach(cb => cb.checked = true);
                updateCheckAllLocationFocusButtonState();

                PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);
                Object.keys(majorAreaFilterState).forEach(area => majorAreaFilterState[area] = true); // Ensure dynamic areas also reset
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCheckAllMajorAreasButtonState();

                // Reset State/Country filters
                Object.keys(stateCountryFilterState).forEach(sc => stateCountryFilterState[sc] = true);
                if (stateCountryFiltersContainer) {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = true);
                }
                // END Reset State/Country filters

                schoolSearchInput.value = '';
                updateMarkersVisibility();
            });

            toggleGalleryViewBtn.addEventListener('click', () => {
                isGalleryViewEnabled = !isGalleryViewEnabled;
                const listContentDiv = document.querySelector('#school-list-control .list-content');
                if (listContentDiv) listContentDiv.classList.toggle('gallery-view', isGalleryViewEnabled);
                toggleGalleryViewBtn.textContent = isGalleryViewEnabled ? 'üñºÔ∏è List View' : 'üñºÔ∏è Gallery View';
                toggleGalleryViewBtn.title = isGalleryViewEnabled ? 'Switch to List View' : 'Switch to Gallery View';
                rebuildSchoolListHTML();
            });

            if (toggleSatelliteViewBtn) {
                toggleSatelliteViewBtn.addEventListener('click', () => {
                    if (!map) return;
                    isSatelliteViewEnabled = !isSatelliteViewEnabled;
                    if (isSatelliteViewEnabled) {
                        map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                        toggleSatelliteViewBtn.textContent = 'üó∫Ô∏è Roadmap View';
                        toggleSatelliteViewBtn.title = 'Switch to Roadmap View';
                    } else {
                        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                        toggleSatelliteViewBtn.textContent = 'üõ∞Ô∏è Satellite View';
                        toggleSatelliteViewBtn.title = 'Switch to Satellite View';
                    }
                });
            }

            const checkAllMajorAreasBtn = document.getElementById('checkAllMajorAreasBtn');
            checkAllMajorAreasBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => {
                    const area = cb.dataset.majorArea;
                    majorAreaFilterState[area] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });


            let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
            if (!schoolListUl) {
                schoolListUl = document.createElement('ul');
                schoolListCollapsibleContentDiv.insertBefore(schoolListUl, document.getElementById('no-results-message'));
            }
            schoolListUl.setAttribute('tabindex', '-1');


           const primarySortTargetSelect = document.getElementById('primarySortTarget');
            const collegeSortOptionsContainer = document.getElementById('collegeSortOptionsContainer');
            const studentSortOptionsContainer = document.getElementById('studentSortOptionsContainer');
            const collegeSortSelect = document.getElementById('collegeSortSelect');
            const studentSortSelect = document.getElementById('studentSortSelect');

            // Initialize visibility based on default primary target
            if (currentPrimarySortTarget === 'students') {
                studentSortOptionsContainer.style.display = 'block';
                collegeSortOptionsContainer.style.display = 'none';
            } else {
                studentSortOptionsContainer.style.display = 'none';
                collegeSortOptionsContainer.style.display = 'block';
            }

            primarySortTargetSelect.addEventListener('change', (event) => {
                currentPrimarySortTarget = event.target.value;
                if (currentPrimarySortTarget === 'students') {
                    studentSortOptionsContainer.style.display = 'block';
                    collegeSortOptionsContainer.style.display = 'none';
                } else { // 'colleges'
                    studentSortOptionsContainer.style.display = 'none';
                    collegeSortOptionsContainer.style.display = 'block';
                }
                sortAndRebuildList();
            });

            collegeSortSelect.addEventListener('change', (event) => {
                currentCollegeSortValue = event.target.value;
                if (currentPrimarySortTarget === 'colleges') {
                    sortAndRebuildList();
                }
            });

            studentSortSelect.addEventListener('change', (event) => {
                currentStudentSortValue = event.target.value;
                // Student sort affects both primary student sort and secondary sort within colleges
                sortAndRebuildList();
            });

            // Keep track of coordinates that have been used for a marker to apply offsets
            const assignedCoordinatesCount = {}; // Key: "lat,lng", Value: count of markers at this exact spot

            allMarkers = new Array(allData.length).fill(null);
            allData.forEach((seniorChoice) => {
                 const index = seniorChoice.originalIndex;
                 let lat = seniorChoice.lat;
                 let lng = seniorChoice.lng;
                 const originalCoordKey = `${seniorChoice.lat},${seniorChoice.lng}`; // Use original for counting

                 if (seniorChoice.lat !== 0 || seniorChoice.lng !== 0) {
                    if (assignedCoordinatesCount[originalCoordKey]) {
                        const count = assignedCoordinatesCount[originalCoordKey];
                        const offsetMagnitude = 0.00002 * Math.sqrt(count); 
                        const angleIncrement = Math.PI / 3; 
                        const angle = (count * angleIncrement);
                        lat += offsetMagnitude * Math.cos(angle);
                        lng += offsetMagnitude * Math.sin(angle);
                        assignedCoordinatesCount[originalCoordKey]++;
                    } else {
                        assignedCoordinatesCount[originalCoordKey] = 1;
                    }
                 }

                 const markerInitialIcon = getMarkerIcon(seniorChoice, false, isDarkMode);
                 const marker = new google.maps.Marker({
                     position: { lat: lat, lng: lng },
                     title: `${seniorChoice.seniorName} (${seniorChoice.gradClass}) ‚Üí ${seniorChoice.collegeName} (${seniorChoice.major || 'Undecided Major'})`,
                     icon: markerInitialIcon,
                 });
                 allMarkers[index] = { marker: marker, school: seniorChoice };

                                  marker.addListener("click", () => {
                     const clickedOriginalIndex = index; 
                     const clickedSchoolData = allData[clickedOriginalIndex];
                     if (!clickedSchoolData || !clickedSchoolData.isVisible) return;

                     if (infowindow && infowindow.getMap()) { infowindow.close(); }

                     let contentString = `<div class="info-window-content">`;
                     const targetUrl = clickedSchoolData.collegeHomepageUrl && clickedSchoolData.collegeHomepageUrl !== '#' ? clickedSchoolData.collegeHomepageUrl : '#';
                     const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                     if (clickedSchoolData.collegeImageUrl && clickedSchoolData.collegeImageUrl !== 'x' && !clickedSchoolData.collegeImageUrl.startsWith('placeholder')) {
                         contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${clickedSchoolData.collegeImageUrl}" alt="${clickedSchoolData.collegeName} logo/photo"></a>`;
                     }

                     if (targetUrl !== '#') {
                        contentString += `<b><a href="${targetUrl}" ${openInNewTab}>${clickedSchoolData.collegeName}</a></b>`;
                     } else {
                        contentString += `<b>${clickedSchoolData.collegeName}</b>`;
                     }
                     contentString += `<br><span class="info-window-type">Type: ${clickedSchoolData.collegeType} (${clickedSchoolData.isCampusPublic ? 'Public' : 'Private'}, ${clickedSchoolData.locationFocus})</span>`;
                     if (clickedSchoolData.lat !== 0 || clickedSchoolData.lng !== 0) {
                        contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${clickedSchoolData.lat},${clickedSchoolData.lng}" target="_blank">Get Directions</a>`;
                     }
                     contentString += `<hr style="margin: 5px 0;">`;


                     if (clickedSchoolData.collegeName === "Undecided") {
                        const suffixHtml = getHonorarySuffixHTML(clickedSchoolData.collegeNameRaw);
                        contentString += `<b>${clickedSchoolData.seniorName}</b>${suffixHtml}`;
                        contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[clickedSchoolData.gradClass] || '#ccc'};">Class: ${clickedSchoolData.gradClass}</span>`;
                        contentString += `<br>Major: ${clickedSchoolData.major || 'Undecided Major'} (${clickedSchoolData.majorArea || 'N/A'})`;
                     } else {
                        const studentsAtSameCollege = allData.filter(s =>
                            s.isVisible &&
                            s.collegeName === clickedSchoolData.collegeName && 
                            s.collegeName !== "Undecided"
                        ).sort((a, b) => { 
                            if (a.gradClass !== b.gradClass) return a.gradClass.localeCompare(b.gradClass);
                            const lastNameA = getLastName(a.seniorName);
                            const lastNameB = getLastName(b.seniorName);
                            if (lastNameA !== lastNameB) return lastNameA.localeCompare(lastNameB);
                            return getFirstName(a.seniorName).localeCompare(getFirstName(b.seniorName));
                        });

                        if (studentsAtSameCollege.length > 0) {
                            contentString += `<u>Students Attending (Visible):</u><ul style="margin-top: 3px; margin-bottom: 3px; padding-left: 18px;">`;
                            studentsAtSameCollege.forEach(student => {
                                const suffixHtml = getHonorarySuffixHTML(student.collegeNameRaw);
                                 let studentEntry = `<li>`;
            if (student.originalIndex === originalIndex) studentEntry += `<b>`;
            studentEntry += `${student.seniorName}${suffixHtml} <span class="info-window-grad-class" style="color: ${gradClassColors[student.gradClass] || '#ccc'};">(${student.gradClass})</span>`;
            
            // Add social links
            if (student.linkedInUrl) {
                studentEntry += `<a href="${student.linkedInUrl}" target="_blank" title="LinkedIn Profile" class="social-icon-link">${createSocialLinkSVG('linkedin', 16, isDarkMode)}</a>`;
            }
            if (student.instagramUrl) {
                studentEntry += `<a href="${student.instagramUrl}" target="_blank" title="Instagram Profile" class="social-icon-link">${createSocialLinkSVG('instagram', 16, isDarkMode)}</a>`;
            }

            if (student.originalIndex === originalIndex) studentEntry += `</b>`;
            studentEntry += `<br><small style="padding-left: 10px;">Major: ${student.major || 'Undecided'} (${student.majorArea || 'N/A'})</small>`;
            studentEntry += `</li>`;
            contentString += studentEntry;
                            });
                            contentString += `</ul>`;
                        } else {
                            contentString += `No other visible students found for this college with current filters.`;
                        }
                     }
                     contentString += `</div>`;

                     infowindow.setContent(contentString);
                     infowindow.open({ map: map, anchor: marker });

                     const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${clickedOriginalIndex}"]`);
                     showSeniorPhotoPopup(listItem, clickedSchoolData); 

                     const visibleListItems = getVisibleListItemsDOM();
                     currentListSelectionIndex = visibleListItems.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    marker.setIcon(getMarkerIcon(clickedSchoolData, true, isDarkMode));
                    marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                    activeHoverMarkerIndex = clickedOriginalIndex;

                    updateCurrentSelectionHighlight();
                 });

                                  marker.addListener('mouseover', () => {
                     if (panelJustToggledOpen) return; // ADD THIS CHECK

                     const schoolData = allData[index]; // 'index' is from the forEach loop context
                     if (schoolData.isVisible) {
                        document.getElementById('searchSuggestions').style.display = 'none';
                        const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                        // Pass the correct listItem or null to showSeniorPhotoPopup
                        showSeniorPhotoPopup(listItem, schoolData); 
                        
                        marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                        marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                     }
                 });
                 marker.addListener('mouseout', () => {
                    const schoolData = allData[index];
                    const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                    if (listItem) {
                         listItem.classList.remove('list-item-highlight');
                    }
                    if (activeHoverMarkerIndex !== index) {
                         marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                         marker.setZIndex(null);
                    }
                 });
            });

            const customClusterRenderer = {
              render: ({ count, position, markers }) => {
                let color = "red"; 
                let diameter = 50;
                let labelColor = "white";
                let labelFontSize = "12px";
                let labelFontWeight = "bold";

                if (count <= 5) { 
                  color = "green";
                  diameter = 30;
                  labelFontSize = "10px";
                  labelFontWeight = "normal";
                } else if (count <= 10) { 
                  color = "#90EE90"; 
                  diameter = 35;
                  labelColor = "black"; 
                  labelFontSize = "11px";
                  labelFontWeight = "normal";
                } else if (count <= 20) { 
                  color = "yellow";
                  diameter = 40;
                  labelColor = "black"; 
                  labelFontSize = "12px";
                } else if (count <= 50) { 
                  color = "orange";
                  diameter = 45;
                  labelFontSize = "12px";
                }
        
                const svg = window.btoa(`
                  <svg xmlns="http://www.w3.org/2000/svg" width="${diameter}" height="${diameter}" viewBox="0 0 ${diameter} ${diameter}">
                    <circle cx="${diameter / 2}" cy="${diameter / 2}" r="${diameter / 2 * 0.9}" fill="${color}" stroke="rgba(0,0,0,0.3)" stroke-width="${Math.max(1, diameter * 0.04)}"/>
                  </svg>`);

                return new google.maps.Marker({
                  position,
                  icon: {
                    url: `data:image/svg+xml;base64,${svg}`,
                    scaledSize: new google.maps.Size(diameter, diameter),
                    anchor: new google.maps.Point(diameter / 2, diameter / 2) 
                  },
                  label: {
                    text: String(count),
                    color: labelColor,
                    fontSize: labelFontSize,
                    fontWeight: labelFontWeight,
                  },
                  zIndex: 100 + count, 
                });
              },
            };

            if (typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
                const initialMapMarkersForClustering = allMarkers
                    .filter(mInfo => {
                        if (!mInfo || !mInfo.marker || !mInfo.school) return false;
                        const originalSchoolData = allData[mInfo.school.originalIndex]; 
                        if (originalSchoolData.lat === 0 && originalSchoolData.lng === 0) return false;
                        return originalSchoolData.isVisible;
                    })
                    .map(mInfo => mInfo.marker);

                markerClustererInstance = new markerClusterer.MarkerClusterer({
                    map: map,
                    markers: initialMapMarkersForClustering,
                    renderer: customClusterRenderer,
                    maxZoom: 16 
                });
            } else {
                console.error("MarkerClusterer library is not loaded correctly! Markers will not be clustered.");
                allMarkers.forEach(mInfo => {
                    if (mInfo && mInfo.marker && mInfo.school) {
                        const originalSchoolData = allData[mInfo.school.originalIndex];
                         if (originalSchoolData.isVisible && !(originalSchoolData.lat === 0 && originalSchoolData.lng === 0)) {
                            mInfo.marker.setMap(map);
                        }
                    }
                });
            }


            darkModeToggle.addEventListener('click', () => {
                 isDarkMode = !isDarkMode; document.body.classList.toggle('dark-mode', isDarkMode);
                 map.setOptions({ styles: isDarkMode ? darkMapStyle : null });
                 allMarkers.forEach((mInfo, idx) => {
                     if (mInfo && mInfo.marker && mInfo.school) {
                         const currentSchoolData = allData[idx]; 
                         const isHighlighted = activeHoverMarkerIndex === idx;
                         mInfo.marker.setIcon(getMarkerIcon(currentSchoolData, isHighlighted, isDarkMode));
                     }
                 });
                 darkModeToggle.textContent = isDarkMode ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
                 darkModeToggle.title = isDarkMode ? 'Light Mode' : 'Dark Mode';


                  rebuildSchoolListHTML(); 

                   if (infowindow && infowindow.getMap()) {
                    // Simple approach: close it. User can reopen.
                    infowindow.close(); 
                }

                  if (allData && allData.length > 0) { 
                    const majorAreaData = aggregateMajorAreaTrends(allData);
                    if (document.getElementById('majorAreaTrendChart') && majorAreaData.categories.length > 0) {
                         renderMajorAreaTrendChart(majorAreaData.trends, majorAreaData.years, majorAreaData.categories, isDarkMode);
                    }

                    const locationFocusData = aggregateLocationFocusTrends(allData);
                     if (document.getElementById('locationFocusTrendChart') && locationFocusData.categories.length > 0) {
                        renderLocationFocusTrendChart(locationFocusData.trends, locationFocusData.years, locationFocusData.categories, isDarkMode);
                    }

                    const popularCollegesData = aggregatePopularCollegeTrends(allData, 5);
                    if (document.getElementById('popularCollegesTrendChart') && popularCollegesData.categories.length > 0) {
                        renderPopularCollegesTrendChart(popularCollegesData.trends, popularCollegesData.years, popularCollegesData.categories, isDarkMode);
                    }
                }
            });

            const debouncedSearch = debounce(handleSearchInput, 250);
            schoolSearchInput.addEventListener('input', debouncedSearch);
            document.addEventListener('click', (event) => {
                 const searchContainer = document.getElementById('schoolSearchContainer');
                 const suggestionsDiv = document.getElementById('searchSuggestions');
                 if (searchContainer && suggestionsDiv &&
                     !searchContainer.contains(event.target) &&
                     !suggestionsDiv.contains(event.target)) {
                     suggestionsDiv.style.display = 'none';
                 }
            });

            checkAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = true; cb.checked = true; });
                 updateMarkersVisibility();
            });
            uncheckAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = false; cb.checked = false; });
                 updateMarkersVisibility();
            });

                       // --- Resizer Logic ---
            const resizer = document.getElementById('panel-resizer');
            const controlPanel = document.getElementById('controls-and-list-container');
            const mapDisplayPanel = document.getElementById('map');

            // Initial setup of panel/map sizes - Primarily for desktop width persistence
            const isDesktopViewInitial = window.innerWidth > 768;
            if (isDesktopViewInitial) {
                const savedDesktopWidth = localStorage.getItem('controlPanelWidthDesktop');
                if (savedDesktopWidth) {
                    controlPanel.style.width = savedDesktopWidth;
                } else {
                    controlPanel.style.width = '30%'; // Default for desktop
                }
                // On desktop, both panel and map should be full height of the flex container
                controlPanel.style.height = '100%';
                mapDisplayPanel.style.height = '100%';
            } else {
                // Mobile view:
                // CSS media queries handle panel width, max-width, and absolute positioning.
                // Panel (drawer) and map should both aim for 100% height of their respective contexts.
                // Clear any inline width that might have been set by desktop logic.
                controlPanel.style.width = ''; 
                controlPanel.style.height = '100%'; // Drawer itself is full height
                mapDisplayPanel.style.height = '100%'; // Map should fill its container
            }

            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                const isMobileViewCurrent = window.innerWidth <= 768;
                // Resizer is hidden by CSS on mobile, so this event should primarily fire on desktop.
                // If it somehow fires on mobile, bail out.
                if (isMobileViewCurrent) {
                    return;
                }

                // Desktop horizontal resizing logic
                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(controlPanel).width, 10);

                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
                document.body.style.userSelect = 'none';
                document.body.style.pointerEvents = 'none'; 
                mapDisplayPanel.style.pointerEvents = 'none';
                controlPanel.style.pointerEvents = 'none';
            });

            function doDrag(e) {
                // This function should only execute for desktop horizontal resizing
                // as mousedown is guarded.
                const isMobileViewCurrent = window.innerWidth <= 768;
                if (isMobileViewCurrent) return; // Defensive check

                let newWidth = startWidth + e.clientX - startX;
                const containerWidth = document.getElementById('map-container').offsetWidth;
                const minWidth = parseFloat(getComputedStyle(controlPanel).minWidth) || 200;
                const maxWidthPercentage = 0.60; 
                newWidth = Math.max(minWidth, newWidth);
                newWidth = Math.min(newWidth, containerWidth * maxWidthPercentage);
                controlPanel.style.width = newWidth + 'px';
            }

            function stopDrag() {
                document.documentElement.removeEventListener('mousemove', doDrag, false);
                document.documentElement.removeEventListener('mouseup', stopDrag, false);
                document.body.style.userSelect = '';
                document.body.style.pointerEvents = '';
                mapDisplayPanel.style.pointerEvents = '';
                controlPanel.style.pointerEvents = '';

                // Only save width if it's desktop view
                if (window.innerWidth > 768) {
                    localStorage.setItem('controlPanelWidthDesktop', controlPanel.style.width);
                }

                if (map && google && google.maps && google.maps.event) {
                    google.maps.event.trigger(map, 'resize'); 
                }
            }
            // --- End Resizer Logic ---

           document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                    exitZoomMode(true);
                    event.preventDefault();
                } else if (faqPopup && faqPopup.style.display !== 'none') { // Check if FAQ is visible
                    const closeFaqFunc = () => { // Re-declare or make accessible
                        if (faqPopup) faqPopup.style.display = 'none';
                        if (faqOverlay) faqOverlay.style.display = 'none';
                        // document.body.style.overflow = '';
                    };
                    closeFaqFunc();
                    event.preventDefault();
                } else if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                    hideSeniorPhotoPopup();
                    event.preventDefault();
                } else if (infowindow && infowindow.getMap()) {
                    infowindow.close();
                    event.preventDefault();
                }
            } else if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                if (event.key === 'ArrowLeft') {
                    navigateToSeniorPhoto('prev');
                    event.preventDefault();
                } else if (event.key === 'ArrowRight') {
                    navigateToSeniorPhoto('next');
                    event.preventDefault();
                }
            } else if (document.activeElement !== schoolSearchInput && 
                       !(faqPopup && faqPopup.style.display !== 'none') && // Don't navigate list if FAQ is open
                       !(seniorPopupImage && seniorPopupImage.classList.contains('zoomed'))) {
                if (event.key === 'ArrowDown') {
                    navigateList('down');
                    event.preventDefault();
                } else if (event.key === 'ArrowUp') {
                    navigateList('up');
                    event.preventDefault();
                }
            }
        });
            if (allData && allData.length > 0) {
                const majorAreaData = aggregateMajorAreaTrends(allData);
                if (document.getElementById('majorAreaTrendChart') && majorAreaData.categories.length > 0) {
                     renderMajorAreaTrendChart(majorAreaData.trends, majorAreaData.years, majorAreaData.categories, isDarkMode);
                }

                const locationFocusData = aggregateLocationFocusTrends(allData);
                if (document.getElementById('locationFocusTrendChart') && locationFocusData.categories.length > 0) {
                    renderLocationFocusTrendChart(locationFocusData.trends, locationFocusData.years, locationFocusData.categories, isDarkMode);
                }

                const popularCollegesData = aggregatePopularCollegeTrends(allData, 5); // Show top 5
                if (document.getElementById('popularCollegesTrendChart') && popularCollegesData.categories.length > 0) {
                    renderPopularCollegesTrendChart(popularCollegesData.trends, popularCollegesData.years, popularCollegesData.categories, isDarkMode);
                }
            }

            rebuildSchoolListHTML(); 
            updateMarkersVisibility(); 

             const showFaqBtn = document.getElementById('showFaqBtn');
            const faqPopup = document.getElementById('faq-popup');
            const faqOverlay = document.getElementById('faq-overlay');
            const closeFaqPopupBtn = document.getElementById('close-faq-popup');

            if (showFaqBtn && faqPopup && faqOverlay && closeFaqPopupBtn) {
                showFaqBtn.addEventListener('click', () => {
                    faqPopup.style.display = 'flex'; // Use flex due to flex-direction: column
                    faqOverlay.style.display = 'block';
                    // Optionally, prevent background scroll when FAQ is open
                    // document.body.style.overflow = 'hidden'; 
                });

                const closeFaq = () => {
                    faqPopup.style.display = 'none';
                    faqOverlay.style.display = 'none';
                    // Restore background scroll if it was disabled
                    // document.body.style.overflow = ''; 
                };

                closeFaqPopupBtn.addEventListener('click', closeFaq);
                faqOverlay.addEventListener('click', (event) => {
                    // Only close if the overlay itself is clicked, not content within the popup
                    if (event.target === faqOverlay) {
                        closeFaq();
                    }
                });

                // Also add Escape key listener for FAQ, but ensure it doesn't conflict
                // with the existing Escape key listener for photo popups.
                // The existing keydown listener can be modified or this can be added carefully.
                // For simplicity, adding it to the existing listener:
            } else {
                console.warn("FAQ popup elements not found. FAQ functionality will be disabled.");
            }
        }

      const menuToggleBtn  = document.getElementById('menu-toggle');
const controlsPanel  = document.getElementById('controls-and-list-container');
const panelResizer   = document.getElementById('panel-resizer');



function handleMenuToggle() {
    const isMobileView      = window.innerWidth <= 768;
    const menuToggleBtn     = document.getElementById('menu-toggle');
    const controlsPanelEl   = document.getElementById('controls-and-list-container');
    const panelResizerEl    = document.getElementById('panel-resizer');

    panelJustToggledOpen = false;
    if (panelToggleTimeout) clearTimeout(panelToggleTimeout);

    /* ----------  MOBILE (‚â§ 768 px)  ---------- */
    if (isMobileView) {
        // Toggle the slide-in drawer
        controlsPanelEl.classList.toggle('panel-mobile-open');
        controlsPanelEl.classList.remove('panel-desktop-hidden');

        if (controlsPanelEl.classList.contains('panel-mobile-open')) {           // now OPEN
            panelResizerEl.style.display  = 'flex';
            panelResizerEl.style.position = 'absolute';
            const panelWidth = controlsPanelEl.offsetWidth;
            panelResizerEl.style.left   = `${panelWidth}px`;
            panelResizerEl.style.top    = '0';
            panelResizerEl.style.height = `${controlsPanelEl.offsetHeight}px`;
            panelResizerEl.style.zIndex =
                (parseInt(window.getComputedStyle(controlsPanelEl).zIndex) || 0) + 1;
        } else {                                                                 // now CLOSED
            panelResizerEl.style.display = 'none';
        }

        if (menuToggleBtn) menuToggleBtn.style.left = '.75rem';

        // Close any open photo pop-up when drawer opens
        if (controlsPanelEl.classList.contains('panel-mobile-open') &&
            seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
            hideSeniorPhotoPopup();
        }

    /* ----------  DESKTOP (> 768 px)  ---------- */
    } else {
        controlsPanelEl.classList.toggle('panel-desktop-hidden');
        const panelIsHidden = controlsPanelEl.classList.contains('panel-desktop-hidden');

        /* ---- Panel just CLOSED ---- */
        if (panelIsHidden) {
            panelResizerEl.style.display = 'none';
            panelResizerEl.classList.add('resizer-desktop-hidden');
            if (menuToggleBtn) menuToggleBtn.style.left = '.75rem';

            // If a small popup is showing, reposition it for the closed-panel state
            if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible') &&
                currentlyZoomedSeniorOriginalIndex !== null &&
                seniorPopupImage && !seniorPopupImage.classList.contains('zoomed')) {
                const item = document.querySelector(
                  `.list-content li[data-original-index="${currentlyZoomedSeniorOriginalIndex}"]`);
                if (item) showSeniorPhotoPopup(item, allData[currentlyZoomedSeniorOriginalIndex]);
            }

        /* ---- Panel just OPENED ---- */
        } else {
            panelResizerEl.style.display = 'flex';
            panelResizerEl.style.position = '';
            panelResizerEl.style.left   = '';
            panelResizerEl.style.top    = '';
            panelResizerEl.style.height = '100%';
            panelResizerEl.classList.remove('resizer-desktop-hidden');

            if (menuToggleBtn) {
                const panelWidth = controlsPanelEl.offsetWidth;

                /* -------------- NEW SAFETY PATCH --------------
                   getComputedStyle can return "auto" or "0px" before the
                   browser repaints, so we fall back to the default 14 px. */
                const cs = window.getComputedStyle(panelResizerEl);
                let resizerWidth = parseFloat(cs.width);
                if (isNaN(resizerWidth) || resizerWidth === 0) resizerWidth = 14;
                /* --------------------------------------------- */

                menuToggleBtn.style.left = `${panelWidth + resizerWidth + 12}px`;
            }

            // Hide the photo pop-up as the panel opens
            if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                hideSeniorPhotoPopup();
                panelJustToggledOpen = true;
                panelToggleTimeout   = setTimeout(() => { panelJustToggledOpen = false; }, 300);
            }
        }

        // Force a map resize once the CSS transition is done
        setTimeout(() => {
            if (window.map && google?.maps?.event) {
                google.maps.event.trigger(window.map, 'resize');
            }
        }, 310); // slightly longer than the 300 ms panel transition
    }
}


if (menuToggleBtn && controlsPanel && panelResizer) {
    menuToggleBtn.addEventListener('click', handleMenuToggle);
}
function initPhotoNavArrows() {
  if (!prevSeniorPhotoBtn.dataset.listenerAdded) {
    prevSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('prev'));
    prevSeniorPhotoBtn.dataset.listenerAdded = 'true';
  }
  if (!nextSeniorPhotoBtn.dataset.listenerAdded) {
    nextSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('next'));
    nextSeniorPhotoBtn.dataset.listenerAdded = 'true';
  }
}


function adjustLayoutOnResize() {
    const isMobileView = window.innerWidth <= 768;
    const menuToggleBtn = document.getElementById('menu-toggle');
    const mapDisplayPanel = document.getElementById('map');
    const controlPanel = document.getElementById('controls-and-list-container');
    const panelResizerEl = document.getElementById('panel-resizer');

    if (isMobileView) {
        // Mobile specific adjustments
        controlPanel.classList.remove('panel-desktop-hidden'); 

        if (controlPanel.classList.contains('panel-mobile-open')) {
            panelResizerEl.style.display = 'flex'; 
            panelResizerEl.style.position = 'absolute'; 
            const panelWidth = controlPanel.offsetWidth;
            panelResizerEl.style.left = `${panelWidth}px`; 
            panelResizerEl.style.top = '0px'; 
            panelResizerEl.style.height = controlPanel.offsetHeight + 'px'; 
            panelResizerEl.style.zIndex = (parseInt(window.getComputedStyle(controlPanel).zIndex) || 1000) + 1; // Ensure zIndex is higher
        } else {
            panelResizerEl.style.display = 'none'; 
        }

        if (menuToggleBtn) {
            menuToggleBtn.style.left = '.75rem'; // Hamburger ALWAYS stays top-left on mobile
            // REMOVED the setTimeout block that was here, which moved the hamburger
            // next to the opened mobile drawer. This ensures it stays fixed at .75rem.
        }
        if (mapDisplayPanel) mapDisplayPanel.style.height = '100%';
        if (controlPanel) {
            controlPanel.style.height = '100%';
            controlPanel.style.width = ''; 
        }

    } else { // Desktop specific adjustments
        if (controlPanel.classList.contains('panel-desktop-hidden')) {
            panelResizerEl.style.display = 'none';
            if (panelResizerEl) panelResizerEl.classList.add('resizer-desktop-hidden'); // panelResizer typo corrected to panelResizerEl
        } else {
            panelResizerEl.style.display = 'flex';
            panelResizerEl.style.position = ''; 
            panelResizerEl.style.left = '';     
            panelResizerEl.style.top = '';      
            panelResizerEl.style.height = '100%';
             if (panelResizerEl) panelResizerEl.classList.remove('resizer-desktop-hidden'); // panelResizer typo corrected to panelResizerEl
        }

        controlPanel.classList.remove('panel-mobile-open'); 

        if (menuToggleBtn) {
            if (controlPanel.classList.contains('panel-desktop-hidden')) {
                menuToggleBtn.style.left = '.75rem';
            } else {
                const panelWidth = controlPanel.offsetWidth;
                const resizerCurrentDisplay = window.getComputedStyle(panelResizerEl).display;
                // Fallback for resizerWidth is 14px (its CSS default width) if it's hidden or offsetWidth is 0
                const resizerWidth = (resizerCurrentDisplay !== 'none' && panelResizerEl.offsetWidth) ? panelResizerEl.offsetWidth : 14; 

                menuToggleBtn.style.left = `${panelWidth + resizerWidth + 12}px`; 
            }
        }
        if (mapDisplayPanel) mapDisplayPanel.style.height = '100%';
        if (controlPanel) {
            controlPanel.style.height = '100%';
        }
    }

    setTimeout(() => {
        if (window.map && typeof google !== 'undefined' && google.maps && google.maps.event) {
            google.maps.event.trigger(window.map, 'resize');
        }
    }, 50); 
}

// Debounce function (if not already defined)
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

window.addEventListener('resize', debounce(adjustLayoutOnResize, 200));

// Initial setup on load (can be at the end of initMap or DOMContentLoaded)
// Initial setup on load
document.addEventListener('DOMContentLoaded', () => {
    // Defer initial layout adjustment slightly to ensure DOM dimensions are stable.
    // setTimeout with 0ms delay pushes this to the end of the event queue,
    // after the browser has finished its current rendering and layout pass.
    setTimeout(() => {
        adjustLayoutOnResize();
        
    }, 0);

    // Get element references safely within DOMContentLoaded
    const panelResizerElement = document.getElementById('panel-resizer');
    const controlsPanelElement = document.getElementById('controls-and-list-container');

    if (panelResizerElement && controlsPanelElement) {
        panelResizerElement.addEventListener('mousedown', function(e) {
            const isMobileView = window.innerWidth <= 768;
            const isPanelDesktopHidden = controlsPanelElement.classList.contains('panel-desktop-hidden');

            if (isMobileView || isPanelDesktopHidden) {
                return;
            }
            // The rest of your mousedown logic (startX, startWidth, add/remove event listeners for doDrag/stopDrag)
            // should be here. Assuming it's correctly defined elsewhere or within this block.
            // For brevity, not repeating the full mousedown handler from your original code.
        });
    }
});


        

        function updateCheckAllLocationFocusButtonState() {
            const checkAllBtn = document.getElementById('checkAllLocationFocusBtn');
            if (!checkAllBtn) return;
            const allFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            if (allFocusCheckboxes.length === 0) {
                 checkAllBtn.checked = true;
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allFocusCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allFocusCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }


        function gmLoadError() {
            console.error("Google Maps failed to load.");
            document.getElementById('map').innerHTML = '<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;">Error: Could not load Google Maps. Please check your API key and ensure the Maps JavaScript API is enabled.</p>';
            const controlsContainer = document.getElementById('controls-and-list-container');
            if (controlsContainer) {
                controlsContainer.style.opacity = '0.5';
                controlsContainer.style.pointerEvents = 'none';
            }
            window.isDataReadyForMap = false;
        }

        (function attachZoomDebugging () {
  const img = document.querySelector('#senior-photo-popup img');

  if (!img) {
    console.warn('[SeniorPhotoDebug] <img> not found ‚Äì debug hooks not attached.');
    return;
  }

  img.addEventListener('mouseenter', () => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Hover-in on zoomed image ‚Äì size:',
                  img.getBoundingClientRect());
    }
  });

  img.addEventListener('mouseleave', () => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Hover-out on zoomed image');
    }
  });

  // Log final size right after we enter zoomed mode
  const observer = new MutationObserver(() => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Entered zoomed mode ‚Äì size:',
                  img.getBoundingClientRect());
    }
  });
  observer.observe(img, { attributes:true, attributeFilter:['class'] });
})();
    </script>



   <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVEZB2WjUpEhqnqGjY_zMCQSKUHTdjAWc&callback=initializeApp&onerror=gmLoadError&v=weekly"
    defer
></script>

 <div id="zoomed-info-panel" style="display: none;">
    <!-- NEW GRAD CLASS INFO BOX -->
    <div id="zoomed-grad-class-info" style="display: none;">
        <span class="grad-class-label">Graduating Class:</span>
        <span id="zoomed-grad-class-value"></span>
    </div>
    <!-- END NEW GRAD CLASS INFO BOX -->
    <p id="zoomed-bio-caption-content"></p>
    <div id="zoomed-social-links-container">
        <!-- Links will be added here by JS -->
    </div>
</div>

</body>
</html>

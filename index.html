<!DOCTYPE html>
<html lang="en">

    <script src="collegeCoordsAndInfo.js"></script>
    <script src="majorToAreaMapping.js"></script>
    <script src="rawData.js"></script>
    <script src="normalizeCollegeName.js"></script> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEST+m Senior College Destinations Map 🦅</title>
    <style>

        .grad-class-separator {
            height: 1px;
            background-color: #ccc; /* Separator color for light mode */
            margin: 10px 5px;    /* Vertical and a little horizontal margin */
            list-style-type: none; /* Ensure no bullet points if it's an <li> */
            padding: 0;
        }

        body.dark-mode .grad-class-separator {
            background-color: #444; /* Separator color for dark mode */
        }

        /* Styles for Gallery View Separator */
        .list-content.gallery-view .grad-class-separator {
            flex-basis: 100% !important;    /* Take full width of the flex container line */
            width: 100% !important;
            height: 1px !important;         /* Make it a thin line */
            background-color: #ccc;
            margin: 15px 0 !important;      /* Add some vertical spacing */
            padding: 0 !important;
            border: none !important;        /* Remove any default li borders */
            list-style-type: none !important;
            box-sizing: border-box !important;
            display: block !important;      /* Ensure it's treated as a block-level element for width */
            min-width: 0 !important;        /* Override min-width from gallery items */
            text-align: left !important;    /* Override text-align from gallery items */
            align-items: stretch !important; /* Override align-items from gallery items */
        }

        body.dark-mode .list-content.gallery-view .grad-class-separator {
            background-color: #444 !important;
        }


        .honorary-suffix {
            font-weight: bold;
            font-style: italic;
            text-decoration: underline;
            padding: 1px 3px;
            border-radius: 3px;
            background-color: black;
            color: white;
            margin-left: 4px; /* Optional: adds a little space */
        }

        body.dark-mode .honorary-suffix {
            background-color: white;
            color: black;
        }

        html, body { height: 100%; margin: 0; padding: 0; font-family: sans-serif; background-color: #f8f9fa; color: #212529; transition: background-color 0.3s, color 0.3s; overflow: hidden; }
        #map-container { display: flex; height: 100%; width: 100%; } /* Changed for resizer */
        #controls-and-list-container { /* float: left; */ width: 30%; min-width: 250px; max-width: 60%; /* Adjusted for resizer */ height: 100%; overflow-y: auto; background-color: #f8f9fa; border-right: 1px solid #ccc; padding: 10px; box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s; display: flex; flex-direction: column; position: relative; }
        #panel-resizer { width: 8px; height: 100%; background-color: #ddd; cursor: col-resize; /* float: left; */ z-index: 10; transition: background-color 0.3s; }
        #panel-resizer:hover { background-color: #bbb; }
        #map { /* float: left; */ flex-grow: 1; /* width: calc(70% - 1px - 8px); */ height: 100%; background-color: grey; } /* Adjusted for resizer */

        .info-window-content { line-height: 1.4; max-width: 250px; }
        .info-window-content b { font-size: 1.1em; display: block; margin-bottom: 4px; }
        .info-window-content img { max-width: 100%; height: auto; display: block; margin-bottom: 8px; border-radius: 4px; border: none; }
        .info-window-content a { color: inherit; text-decoration: none; }
        .info-window-content a:hover { text-decoration: underline; cursor: pointer; }
        .info-window-type { color: #555; font-style: italic; }
        .info-window-grad-class { font-weight: bold; }

        .map-control { background-color: rgba(255, 255, 255, 0.9); padding: 10px 15px; margin-bottom: 10px; border: 1px solid #bbb; border-radius: 4px; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2); color: #222; box-sizing: border-box; transition: background-color 0.3s, color 0.3s, border-color 0.3s; flex-shrink: 0;  }
        .map-control h4 { margin-top: 0; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; font-size: 1.1em; font-weight: bold; transition: border-color 0.3s; display: inline-block; margin-right: 10px; }
        .tip-message { background-color: #eef5ff; border: 1px solid #b8d4ff; color: #31708f; padding: 8px 10px; margin-top: 8px; margin-bottom: 12px; border-radius: 4px; font-size: 0.85em; line-height: 1.4; position: relative; overflow: hidden; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .dismiss-button { float: right; cursor: pointer; font-weight: bold; margin-left: 10px; padding: 0 5px; color: #a1a1a1; border-radius: 3px; line-height: 1.4; user-select: none; transition: color 0.2s, background-color 0.2s; }
        .dismiss-button:hover { color: #333; background-color: #e0e0e0; }
        #description-control {
    font-size: 1.0em;
    cursor: default;
    overflow: hidden;
    padding: 10px 15px;
    text-align: center;
    background-color: purple;
    color: white;
}
#description-control span { display: inline-block; line-height: 28px; vertical-align: middle; }

        #map-options-control {
            margin-bottom:10px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }
        .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn {
    font-size: 0.85em;
    padding: 5px 10px;
    margin: 5px;
    border: 1px solid #bbb;
    border-radius: 4px;
    background-color: rgba(245, 245, 245, 0.9);
    color: #222;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    line-height: 1.5; /* Keep this for text spacing */
    flex-basis: auto;
    text-align: center;
    /* Added for better internal alignment and consistent height */
    display: inline-flex; /* Treat the button itself as a flex container for its icon & text */
    align-items: center;  /* Vertically center the icon and text within the button */
    justify-content: center; /* Horizontally center if text-align isn't enough */
    box-sizing: border-box; /* Ensure padding and border are included in the total width/height */
}
        .dark-mode-toggle-control:hover, #toggleTransitBtn:hover, #zoomToVisibleBtn:hover, #clearAllFiltersBtn:hover, #toggleGalleryViewBtn:hover {
            background-color: rgba(230, 230, 230, 0.95);
        }


        #filter-control { font-size: 0.9em; }
        #filter-control .filter-header { margin-top: 0; margin-bottom: 6px; font-size: 1em; font-weight: bold; padding-bottom: 2px; border-bottom: 1px solid #ddd; }
        .filter-item { display: block; margin-bottom: 5px; cursor: pointer; }
        .filter-item label { margin-left: 5px; vertical-align: middle; cursor: pointer; }
        .filter-item input[type="checkbox"] { vertical-align: middle; cursor: pointer; }
        .filter-color-box { width: 12px; height: 12px; border: 1px solid #ccc; margin-right: 5px; display: inline-block; vertical-align: middle; transition: border-color 0.3s; }
        .filter-control-buttons { display: inline-block; vertical-align: middle; margin-bottom: 8px; margin-left: 5px; }
        .filter-control-buttons button { font-size: 0.8em; padding: 2px 6px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; }
        .filter-control-buttons button:hover { background-color: #e0e0e0; }

        #instagram-links-control {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-top: 10px; /* Space from filter buttons */
            margin-bottom: 8px;
        }
        .instagram-link-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: inherit;
            font-size: 0.8em;
        }
        .instagram-link-button svg.instagram-logo {
            width: 28px;
            height: 28px;
            margin-bottom: 3px;
            fill: #C13584; /* Instagram-like color */
        }
        body.dark-mode .instagram-link-button svg.instagram-logo {
            fill: #E1306C; /* Slightly different for dark mode if needed */
        }
        .instagram-link-button span {
            font-weight: bold;
        }


        #stats-table-control { font-size: 0.9em; margin-top: 10px; }
        #stats-table-control h4 { margin-bottom: 8px; }
        #stats-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        #stats-table th, #stats-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; font-size: 0.9em; }
        #stats-table th { background-color: #f0f0f0; font-weight: bold; }
        #stats-table td.row-header { text-align: left; font-weight: bold; background-color: #f9f9f9;}

        #major-summary-control { font-size: 0.9em; margin-top: 10px; }
        #major-summary-control h4 { margin-bottom: 8px; }
        #major-summary-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        #major-summary-table th, #major-summary-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 0.9em; }
        #major-summary-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
        #major-summary-table td:last-child { text-align: center; } /* For count column */
        #major-summary-table td:nth-last-child(2) { text-align: center; } /* For filter checkbox column */


        #school-list-control { font-size: 0.9em; flex-grow: 1;  display: flex; flex-direction: column; overflow: hidden;  }
        .list-header-container { overflow: visible;  margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; transition: border-color 0.3s; flex-shrink: 0;  }
        .list-header-container h4 { float: left; margin-bottom: 0; border-bottom: none; padding-bottom: 0; line-height: 26px; }
        #toggleSchoolListBtn { float: right; font-size: 0.8em; padding: 3px 8px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; line-height: normal; vertical-align: middle; }
        #toggleSchoolListBtn:hover { background-color: #e0e0e0; }


        #schoolSearchContainer { float: right; width: 45%; position: relative;  }
        #schoolSearchInput { width: 100%; padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; box-sizing: border-box; }

        #searchSuggestions { position: absolute; top: 100%;  left: 0; right: 0; background-color: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 3px 3px; max-height: 150px;  overflow-y: auto; z-index: 1000;  box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;  }
        #searchSuggestions div { padding: 5px 8px; font-size: 0.9em; cursor: pointer; }
        #searchSuggestions div:hover { background-color: #eee; }

        #sort-controls-container {
            transition: border-color 0.3s;
        }
        body.dark-mode #sort-controls-container {
            border-bottom-color: #444;
        }
        body.dark-mode #sort-controls-container select {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        #sort-controls-container optgroup { font-style: italic; }
        #sort-controls-container optgroup option { font-style: normal; }

        .school-list-collapsible-content { overflow-y: auto; flex-grow: 1; }
        .school-list-collapsible-content.hidden { display: none; }
        .list-content { overflow-y: auto; flex-grow: 1;  }
        .list-content ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
        .list-content li { padding: 3px 0; word-wrap: break-word; cursor: pointer; display: flex; align-items: center; transition: background-color 0.2s; position: relative; }
        .list-content li.list-item-highlight, .list-content li.current-selection-highlight { background-color: #d6eaff;  }
        body.dark-mode .list-content li.list-item-highlight, body.dark-mode .list-content li.current-selection-highlight { background-color: #2a3950; }

        .list-content li input[type="checkbox"] { margin-right: 6px; flex-shrink: 0; cursor: pointer; vertical-align: middle; }
        .list-content li span.school-name { flex-grow: 1; vertical-align: middle; line-height: 1.4;  }
        .list-content a { color: #007bff; text-decoration: none; }
        .list-content a:hover { text-decoration: underline; }

        .list-item-major {
            font-size: 0.85em;
            color: #555;
            margin-left: 3px;
        }
        #no-results-message {
            padding: 10px;
            text-align: center;
            font-style: italic;
            color: #777;
            display: none; /* Hidden by default */
        }
        body.dark-mode #no-results-message { color: #aaa; }

        /* Gallery View Styles */
        .list-content.gallery-view ul {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start; 
            gap: 10px; 
            padding-top: 5px;
        }

        .list-content.gallery-view li:not(.grad-class-separator) {
    flex-direction: column;
    align-items: center; /* Keep items centered in the flex column */
    padding: 8px; /* This padding creates the colored border */
    border: 1px solid #eee;
    border-radius: 4px;
    flex-grow: 0;
    flex-shrink: 1;
    flex-basis: calc((100% - 2 * 10px) / 3); /* Approx 3 items */
    min-width: 150px; /* Slightly wider to accommodate padding better */
    box-sizing: border-box;
    /* text-align: center; Remove, as align-items handles it */
    margin-bottom: 10px;
    position: relative; /* Crucial for absolute positioning of children */
    height: 180px; /* Give a fixed height to standardize gallery items */
    justify-content: flex-start; /* Align content to the top */
}

body.dark-mode .list-content.gallery-view li:not(.grad-class-separator) {
    border-color: #444;
}

.list-content.gallery-view li:not(.grad-class-separator) > input[type="checkbox"] {
     position: absolute;
     top: 4px;
     right: 4px;
     z-index: 2; /* Above overlay text */
     margin: 0; /* Reset default margins */
}

.gallery-grad-class-overlay {
    position: absolute;
    top: 4px; /* Position within the top padding */
    left: 0;  /* Stretch across the li */
    right: 0;
    text-align: center;
    font-size: 1.6em; /* "Giant" text - adjust as you like */
    font-weight: bold;
    /* Text color is set by JavaScript for contrast */
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3), -1px -1px 2px rgba(0,0,0,0.3);
    z-index: 1; /* Below checkbox if they overlap */
    pointer-events: none; /* Allow clicks to pass through to li/photo */
    line-height: 1; /* Prevent excessive height */
}

/* New: Div holding the photo in gallery view */
.list-content.gallery-view li .gallery-photo-div {
    width: calc(100% - 8px); /* Slightly less than full to respect internal li padding visually */
    height: calc(100% - 30px); /* Adjust height to fit after overlay and some bottom padding */
    margin-top: 28px; /* Space for the grad class overlay text (adjust based on overlay font-size) */
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* Ensure photo doesn't break layout */
}

        .list-content.gallery-view li .gallery-photo-container {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 5px;
            width: 100%;
        }
        .list-content.gallery-view li .gallery-photo-container input[type="checkbox"] {
             margin-bottom: 8px; 
             margin-right: 0; 
        }
        .list-content.gallery-view li .gallery-photo {
    max-width: 100%;
    max-height: 100%;
    object-fit: cover; /* Cover ensures the photo fills its container, cropping if necessary */
    border-radius: 3px; /* Optional: slight rounding for the photo itself */
    display: block;
    /* border: 1px solid #ccc; /* Remove this if the li's background provides the border effect */
}
        body.dark-mode .list-content.gallery-view li .gallery-photo {
            border-color: #555;
        }
        .list-content.gallery-view li span.school-name {
    display: none !important;
}


        #senior-photo-popup {
            position: fixed;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            z-index: 2000;
            display: none;
            width: 200px;
            transition: opacity 0.2s, transform 0.2s;
            opacity: 0;
            transform: scale(0.95);
        }
        #senior-photo-popup.visible {
            display: block;
            opacity: 1;
            transform: scale(1);
        }
        #close-senior-photo-popup {
            position: absolute;
            top: 2px;
            right: 5px;
            font-size: 18px;
            line-height: 1;
            padding: 2px 5px;
            z-index: 2001;
            pointer-events: auto;
        }

        #senior-photo-popup img {
            max-width: 100%;
            height: auto;
            border-radius: 3px;
            cursor: zoom-in;
            display: block;
            pointer-events: auto;
        }
        #senior-photo-popup img.zoomed {
            position: fixed;
            cursor: zoom-in; /* Should be zoom-out when zoomed? User asked for zoom-in */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 80vw;
            max-height: 80vh;
            object-fit: contain;
            z-index: 2000; /* Will be under arrows if arrows are 2002+ */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            border: 2px solid white;
            background-color: white; /* Background for image area */
            pointer-events: auto;
        }

        body.dark-mode #senior-photo-popup img.zoomed {
            border-color: #333;
            background-color: #282828; /* Dark background for image area */
        }
        #senior-photo-popup p#senior-photo-caption { /* Target specifically */
            margin: 5px 0 0 0;
            font-size: 0.9em;
            text-align: center;
            pointer-events: auto;
        }
        /* Caption for zoomed image */
        #senior-photo-popup img.zoomed + p#senior-photo-caption, /* If p is direct sibling */
        #senior-photo-popup.zoomed-state p#senior-photo-caption { /* Or if a class is added to popup */
            position: fixed;
            bottom: 65px; /* Keep it above zoom exit note potentially */
            left: 50%;
            transform: translateX(-50%);
            background-color: #222222;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            z-index: 2001; /* Below arrows, above image */
            pointer-events: auto;
        }
        body.dark-mode #senior-photo-popup img.zoomed + p#senior-photo-caption,
        body.dark-mode #senior-photo-popup.zoomed-state p#senior-photo-caption {
            background-color: #e0e0e0;
            color: #121212;
        }

        /* Photo Navigation Arrows */
        .photo-nav-arrow {
            position: fixed; /* Fixed to viewport when image is zoomed */
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            font-size: 2.5em; /* Larger for better visibility */
            padding: 10px;
            cursor: pointer;
            z-index: 2005; /* Above zoomed image and caption */
            border-radius: 50%; /* Circular buttons */
            width: 50px; /* Explicit width */
            height: 50px; /* Explicit height */
            line-height: 30px; /* Adjust for vertical centering of arrow char */
            text-align: center;
            opacity: 0.6;
            transition: opacity 0.2s, background-color 0.2s;
            user-select: none;
        }
        .photo-nav-arrow:hover {
            opacity: 1;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .photo-nav-arrow.prev {
            left: 15px;
        }
        .photo-nav-arrow.next {
            right: 15px;
        }
        body.dark-mode .photo-nav-arrow {
            background-color: rgba(255, 255, 255, 0.25);
            color: #e0e0e0;
        }
         body.dark-mode .photo-nav-arrow:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }


        #photo-zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
           -webkit-backdrop-filter: blur(5px);
            z-index: 1999; /* Below popup, above map */
            display: none;
        }

        #zoom-exit-note {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001; /* Same as zoomed caption, ensure one is slightly above if they overlap */
            padding: 8px 12px;
            border-radius: 4px;
        }


        body.dark-mode { background-color: #121212; color: #e0e0e0; }
        body.dark-mode #description-control {
    background-color: purple;
    color: white;
}
        body.dark-mode #controls-and-list-container { background-color: #1a1a1a; border-right-color: #444; }
        body.dark-mode #panel-resizer { background-color: #333; }
        body.dark-mode #panel-resizer:hover { background-color: #555; }
        body.dark-mode .map-control { background-color: rgba(40, 40, 40, 0.9); color: #e0e0e0; border-color: #555; }
        body.dark-mode .map-control h4 { border-bottom-color: #444; }
        body.dark-mode #filter-control .filter-header { border-bottom-color: #555; }
        body.dark-mode .list-header-container { border-bottom-color: #444; }

        body.dark-mode #stats-table th, body.dark-mode #stats-table td { border-color: #555; }
        body.dark-mode #stats-table th { background-color: #2a2a2a; }
        body.dark-mode #stats-table td.row-header { background-color: #222; }

        body.dark-mode #major-summary-table th, body.dark-mode #major-summary-table td { border-color: #555; }
        body.dark-mode #major-summary-table th { background-color: #2a2a2a; }
        body.dark-mode .list-item-major { color: #bbb; }


        body.dark-mode #toggleSchoolListBtn { background-color: #444; border-color: #666; color: #e0e0e0; }
        

        body.dark-mode #toggleSatelliteViewBtn { background-color: #444; border-color: #666; color: #e0e0e0; }
        

        body.dark-mode #senior-photo-popup { background-color: #282828; border-color: #555; color: #e0e0e0;}


        body.dark-mode #schoolSearchInput { background-color: #333; border-color: #555; color: #e0e0e0; }
        body.dark-mode #searchSuggestions { background-color: #333; border-color: #555; color: #e0e0e0; }
        body.dark-mode #searchSuggestions div:hover { background-color: #444; }
        body.dark-mode .filter-color-box { border-color: #666; }
                body.dark-mode .dark-mode-toggle-control, body.dark-mode #toggleTransitBtn, body.dark-mode #toggleSatelliteViewBtn, body.dark-mode #zoomToVisibleBtn, body.dark-mode #clearAllFiltersBtn, body.dark-mode #toggleGalleryViewBtn {
            background-color: rgba(50, 50, 50, 0.9); color: #e0e0e0; border-color: #555;
        }
                body.dark-mode .dark-mode-toggle-control:hover, body.dark-mode #toggleTransitBtn:hover, body.dark-mode #toggleSatelliteViewBtn:hover, body.dark-mode #zoomToVisibleBtn:hover, body.dark-mode #clearAllFiltersBtn:hover, body.dark-mode #toggleGalleryViewBtn:hover {
            background-color: rgba(70, 70, 70, 0.95);
        }
        body.dark-mode .gm-style-iw-c { background-color: #282828 !important; box-shadow: 0 2px 7px 1px rgba(255, 255, 255, 0.2); }
        body.dark-mode .gm-style-iw-d { color: #e0e0e0 !important; overflow: visible !important; }
        body.dark-mode .info-window-content { color: #e0e0e0; }
        body.dark-mode .info-window-content b { color: #ffffff; }
        body.dark-mode .info-window-content a { color: #90caf9 !important; }
        body.dark-mode .info-window-content a:hover { color: #bbdefb !important; }
        body.dark-mode .info-window-type { color: #aaa; }
        body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] , body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] { background: none !important; border: none !important; box-shadow: none !important; opacity: 1 !important; border-radius: 2px !important; padding: 4px !important; right: 6px !important; top: 6px !important; cursor: pointer; transition: background-color 0.2s ease; }
        body.dark-mode .gm-style .gm-style-iw-c button[title="Close"]:hover, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"]:hover { background-color: rgba(255, 255, 255, 0.2) !important; }
        body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] img, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] img { display: block !important; width: 14px !important; height: 14px !important; filter: contrast(0) sepia(1) hue-rotate(0deg) saturate(0) brightness(1.5) invert(1) !important; opacity: 1 !important; transform: scale(1) !important; }
        body.dark-mode .gm-style .gm-style-mtc , body.dark-mode .gmnoprint .gm-style-mtc { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5); border: 1px solid #444 !important; border-radius: 2px; }
        body.dark-mode .gm-style .gm-style-mtc button, body.dark-mode .gm-style .gm-style-mtc div { color: #ffffff !important; font-weight: 500 !important; background-color: transparent !important; text-shadow: none !important; }
        body.dark-mode .gm-style .gm-style-mtc button:hover, body.dark-mode .gm-style .gm-style-mtc div:hover { background-color: #444 !important; }
        body.dark-mode .gm-style .gm-style-mtc .gm-active { background-color: #555 !important; color: #fff !important; border-left: none !important; border-right: none !important; }
        body.dark-mode .gm-style .gm-style-mtc .gm-active div, body.dark-mode .gm-style .gm-style-mtc .gm-active button { color: #fff !important; background-color: #555 !important; }
        body.dark-mode .gmnoprint .gm-control-active, body.dark-mode .gm-svpc, body.dark-mode .gm-fullscreen-control { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5) !important; border: 1px solid #444 !important; border-radius: 2px !important; }
        body.dark-mode .gmnoprint .gm-control-active:hover, body.dark-mode .gm-svpc:hover, body.dark-mode .gm-fullscreen-control:hover { background-color: #444 !important; }
        body.dark-mode .gm-fullscreen-control img, body.dark-mode .gm-svpc img, body.dark-mode .gm-style-mtc button img, body.dark-mode button[aria-label*="Zoom in"] img, body.dark-mode button[aria-label*="Zoom out"] img { filter: brightness(0) invert(1) !important; opacity: 1 !important; }
        body.dark-mode .gm-style > .gmnoprint > div { background: transparent !important; box-shadow: none !important; border: none !important; border-radius: 2px; }
        body.dark-mode .gm-style > .gmnoprint > div > div + div { background-color: #555 !important; }
        body.dark-mode .gm-style .gm-style-cc, body.dark-mode .gm-style .gm-style-cc a, body.dark-mode .gm-style .gm-style-cc span, body.dark-mode .gm-style .gm-style-cc div { color: #ffffff !important; text-shadow: none !important; font-weight: 400 !important; opacity: 0.9 !important; }
        body.dark-mode .gm-style .gm-style-cc a:link, body.dark-mode .gm-style .gm-style-cc a:visited { color: #ffffff !important; text-decoration: none !important; opacity: 0.9 !important; }
        body.dark-mode .gm-style .gm-style-cc a:hover { color: #ffffff !important; text-decoration: underline !important; opacity: 1 !important; }
        body.dark-mode .list-content li:hover span.school-name { text-decoration: underline; }

        body.dark-mode .tip-message { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
        body.dark-mode .dismiss-button { color: #888; }
        body.dark-mode .dismiss-button:hover { color: #ddd; background-color: #444; }
        body.dark-mode .filter-control-buttons button { background-color: #444; border-color: #666; color: #e0e0e0; }
        body.dark-mode .filter-control-buttons button:hover { background-color: #555; }
        body.dark-mode #zoom-exit-note { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
        body.dark-mode #zoom-exit-note .dismiss-button { color: #888;}
        body.dark-mode #zoom-exit-note .dismiss-button:hover { color: #ddd; background-color: #444; }

    </style>
</head>
<body>
    <div id="map-container">
        <div id="controls-and-list-container">
            <div id="description-control" class="map-control">
                <span><b>NEST+m Senior College Destinations Map</b> 🦅</span>
            </div>
            <div id="map-options-control" class="map-control">
                <button id="darkModeToggle" class="dark-mode-toggle-control" title="Toggle Dark Mode">🌙 Dark Mode</button>
                <button id="toggleTransitBtn" title="Show Transit Layer">🚇 Show Transit</button>
                <button id="toggleSatelliteViewBtn" title="Switch to Satellite View">🛰️ Satellite View</button> 
                <button id="zoomToVisibleBtn" title="Zoom to fit all visible markers">👁️ Zoom to Visible</button>
                <button id="clearAllFiltersBtn" title="Clear all active filters and search">🧹 Clear All Filters</button>
                <button id="toggleGalleryViewBtn" title="Toggle Gallery View in List">🖼️ Toggle Gallery View</button>
            </div>
            <div id="filter-control" class="map-control">
                 <h4 class="filter-header">Filter by Graduating Class</h4>
                 <div class="filter-control-buttons">
                     <button id="checkAllGradClassesBtn" title="Check all graduating class filters">Check All</button>
                     <button id="uncheckAllGradClassesBtn" title="Uncheck all graduating class filters">Uncheck All</button>
                 </div>
                 <div id="instagram-links-control">
                    <a href="https://www.instagram.com/nestmdecisions2021/" target="_blank" class="instagram-link-button" title="Instagram '21 Decisions">
                        <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>'21</span>
                    </a>
                    <a href="https://www.instagram.com/nestm2022decisions/" target="_blank" class="instagram-link-button" title="Instagram '22 Decisions">
                        <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                           <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>'22</span>
                    </a>
                    <a href="https://www.instagram.com/nestmdecisions2023/" target="_blank" class="instagram-link-button" title="Instagram '23 Decisions">
                        <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>'23</span>
                    </a>
                    <a href="https://www.instagram.com/nestmdecisions2024/" target="_blank" class="instagram-link-button" title="Instagram '24 Decisions">
                        <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                           <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>'24</span>
                    </a>
                    <a href="https://www.instagram.com/nestmdecisions25/" target="_blank" class="instagram-link-button" title="Instagram '25 Decisions">
                        <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                        <span>'25</span>
                    </a>
                </div>
                 <div style="clear: both;"></div>
                 <div id="grad-class-filters-container">
                     {} <!-- Grad class filters will be populated here -->
                 </div>
            </div>
            <div id="stats-table-control" class="map-control">
                <h4>College Attendance Statistics</h4>
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th>Location Focus</th>
                            <th>Public</th>
                            <th>Private</th>
                            <th>Total</th>
                            <th>Filter <input type="checkbox" id="checkAllLocationFocusBtn" title="Toggle all location focus filters" checked></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-header">In City (NYC)</td>
                            <td data-stat="InCityNYC-Public">0</td>
                            <td data-stat="InCityNYC-Private">0</td>
                            <td data-stat="InCityNYC-Total">0</td>
                            <td><input type="checkbox" class="location-focus-filter" data-location-focus="InCityNYC" title="Filter by In City (NYC)" checked></td>
                        </tr>
                        <tr>
                            <td class="row-header">In State (NY, Other)</td>
                            <td data-stat="InStateNYOther-Public">0</td>
                            <td data-stat="InStateNYOther-Private">0</td>
                            <td data-stat="InStateNYOther-Total">0</td>
                            <td><input type="checkbox" class="location-focus-filter" data-location-focus="InStateNYOther" title="Filter by In State (NY, Other)" checked></td>
                        </tr>
                        <tr>
                            <td class="row-header">Out of State (US)</td>
                            <td data-stat="OutOfStateUS-Public">0</td>
                            <td data-stat="OutOfStateUS-Private">0</td>
                            <td data-stat="OutOfStateUS-Total">0</td>
                            <td><input type="checkbox" class="location-focus-filter" data-location-focus="OutOfStateUS" title="Filter by Out of State (US)" checked></td>
                        </tr>
                        <tr>
                            <td class="row-header">International</td>
                            <td data-stat="International-Public">0</td>
                            <td data-stat="International-Private">0</td>
                            <td data-stat="International-Total">0</td>
                            <td><input type="checkbox" class="location-focus-filter" data-location-focus="International" title="Filter by International" checked></td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td class="row-header">Grand Total</td>
                            <td data-stat="Total-Public" style="font-weight:bold;">0</td>
                            <td data-stat="Total-Private" style="font-weight:bold;">0</td>
                            <td data-stat="Total-Overall" style="font-weight:bold;">0</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div id="major-summary-control" class="map-control">
                <h4>Major Area Summary</h4>
                <table id="major-summary-table">
                    <thead>
                        <tr>
                            <th>Major Area</th>
                            <th>Count</th>
                            <th>Filter <input type="checkbox" id="checkAllMajorAreasBtn" title="Toggle all major area filters" checked></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="school-list-control" class="map-control">
                <div class="list-header-container">
                    <h4>College List & Seniors</h4>
                     <button id="toggleSchoolListBtn" title="Show/Hide List">Hide List</button>
                    <div id="schoolSearchContainer">
                        <input type="text" id="schoolSearchInput" placeholder="Search seniors or colleges..." autocomplete="off">
                        <div id="searchSuggestions"></div>
                    </div>
                </div>

                <div id="sort-controls-container" style="padding: 5px 0px 10px 0px; border-bottom: 1px solid #eee; margin-bottom: 8px;">
    <label for="sortOptions" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort by:</label>
    <select id="sortOptions" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc;">
        <optgroup label="Graduating Class Priority">
            <option value="grad_first" selected>Grad Class, then First Name</option>
            <option value="grad_last">Grad Class, then Last Name</option>
        </optgroup>
        <optgroup label="Overall Order">
            <option value="first_name">First Name (Overall)</option>
            <option value="last_name">Last Name (Overall)</option>
            <option value="college_name">College Name (Overall)</option>
        </optgroup>
    </select>
</div>

                 <div class="list-content">
                     <div class="school-list-collapsible-content">
                         <!-- School list ul will be populated here -->
                          <div id="no-results-message">No seniors match your current filters.</div>
                     </div>
                 </div>
            </div>
        </div>
        <div id="panel-resizer"></div>
        <div id="map"></div>
    </div>
    <div id="senior-photo-popup">
        <span id="close-senior-photo-popup" class="dismiss-button" title="Close Photo (Esc)">&times;</span>
        <img src="#" alt="Senior Photo" onerror="this.style.display='none'; this.onerror=null;">
        <p id="senior-photo-caption">Senior Name</p>
        <button id="prev-senior-photo" class="photo-nav-arrow prev" title="Previous Senior (Left Arrow)" style="display: none;">&lt;</button>
        <button id="next-senior-photo" class="photo-nav-arrow next" title="Next Senior (Right Arrow)" style="display: none;">&gt;</button>
    </div>
    <div id="zoom-exit-note" class="tip-message" style="display: none;">
        <span>To exit zooming, click out of the picture or press Esc.</span>
        <span class="dismiss-button" onclick="this.parentElement.style.display='none';">&times;</span>
    </div>
    <!-- Overlay div will be created and appended by JavaScript -->

     
     <script>

        // Global Variable Declarations
        let map;
        let infowindow;
        let isDarkMode = false;
        let allMarkers = []; // Stores { marker: google.maps.Marker, school: SeniorChoiceData }
        let gradClassFilterState = {};
        let schoolsSelectedForZoom = new Set();
        let activeHoverMarkerIndex = null; // Stores originalIndex of hovered/keyboard-selected item's marker
        let seniorPhotoPopup, seniorPopupImage, seniorPopupCaption, closeSeniorPhotoBtn, zoomExitNote, photoZoomOverlay;
        let prevSeniorPhotoBtn, nextSeniorPhotoBtn; // For zoomed photo navigation
        let currentlyZoomedSeniorOriginalIndex = null; // Tracks originalIndex of the currently zoomed senior

        let transitLayer;
        let currentSortOption = 'grad_first';
        let isSatelliteViewEnabled = false;
        let transitLayerEnabled = false;
        let locationFocusFilterState = {}; // Stores true/false for each location focus key
        let majorAreaFilterState = {}; // Stores true/false for each major area key
        let isGalleryViewEnabled = false;
        let currentListSelectionIndex = -1; // Index within the *visible* list items. -1 means nothing selected

        // Constants - Defer Google Maps dependent constants to initMap
        let baseMarkerIcon;
        let highlightedMarkerIcon;

        const gradClassColors = {
            "'21": "#AA66CC", // Purple
            "'22": "#FF0000", // Red
            "'23": "#99CC00", // Green
            "'24": "#FFBB33", // Orange
            "'25": "#007FFF"  // Blue
        };
        const gradClassNames = Object.keys(gradClassColors);

        

        const NYC_BOUNDS = { north: 40.92, south: 40.47, west: -74.26, east: -73.70 };
        const PREDEFINED_MAJOR_AREAS = ["STEM", "Engineering", "Business/Economics", "Humanities/Social Sciences", "Arts/Design", "Health Sciences", "Education", "Undecided/Other", "Other", "Unknown"];




        // Add derived properties to collegeCoordsAndInfo
        for (const collegeName in collegeCoordsAndInfo) {
            if (collegeCoordsAndInfo.hasOwnProperty(collegeName)) {
                const properties = getCollegeProperties(collegeCoordsAndInfo[collegeName]);
                collegeCoordsAndInfo[collegeName].isCampusPublic = properties.isCampusPublic;
                collegeCoordsAndInfo[collegeName].locationFocus = properties.locationFocus;
            }
        }

        const collegeTypeMappings = {
            "FIT": TYPE_SUNY, "Fashion Institute of Technology": TYPE_SUNY,
            "AMDA": TYPE_OTHER_PRIVATE, "AMDA College of the Performing Arts": TYPE_OTHER_PRIVATE,
            "Undecided": TYPE_UNDECIDED,
        };

       


        // Google Maps Dark Style
        const darkMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
            { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
            { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
            { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
            { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
            { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
            { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
            { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
            { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] },
        ];

        let seniorCollegeChoices; 
        let allData; 
        window.isDataReadyForMap = false;

        try {
            console.log("[DEBUG] Attempting to initialize seniorCollegeChoices and allData globally...");
            seniorCollegeChoices = parseRawData(rawData);
            if (!Array.isArray(seniorCollegeChoices)) {
                console.error("[DEBUG] parseRawData did not return an array. Value:", seniorCollegeChoices);
                throw new Error("Data parsing failed: seniorCollegeChoices is not an array.");
            }
            console.log(`[DEBUG] seniorCollegeChoices initialized. Length: ${seniorCollegeChoices.length}`);

            console.log("[DEBUG] Initializing allData by mapping seniorCollegeChoices...");
            allData = seniorCollegeChoices.map((choice, index) => {
                if (!choice || typeof choice !== 'object') {
                    console.error(`[DEBUG] Malformed item in seniorCollegeChoices at index ${index}:`, choice);
                    throw new Error(`Malformed item at index ${index} in seniorCollegeChoices during allData mapping.`);
                }
                if (typeof choice.seniorName !== 'string' || typeof choice.gradClass !== 'string' || typeof choice.collegeName !== 'string') {
                    console.error(`[DEBUG] Item with missing/invalid properties in seniorCollegeChoices at index ${index}:`, choice);
                    throw new Error(`Item with missing/invalid string properties at index ${index} for allData mapping.`);
                }
                const majorArea = getMajorArea(choice.major); 
                return {
                    ...choice,
                    displayName: `${choice.seniorName} (${choice.gradClass}) → ${choice.collegeName}`,
                    originalIndex: index,
                    isVisible: true, 
                    majorArea: majorArea 
                };
            });
            console.log(`[DEBUG] allData initialized. Length: ${allData.length}`);

            if (!allData || !Array.isArray(allData)) {
                console.error("[DEBUG] allData is not a valid array after mapping.");
                throw new Error("allData initialization failed: result is not an array.");
            }
            console.log(`[DEBUG] Global: allData initialized successfully with ${allData.length} items.`);
            window.isDataReadyForMap = true;

        } catch (error) {
            console.error("CRITICAL ERROR during global data initialization:", error.message, error.stack);
            document.body.innerHTML = `
                <div style="padding: 20px; text-align: center; background-color: #ffdddd; border: 1px solid red; color: black;">
                    <h1>Application Initialization Error</h1>
                    <p>There was a critical error while preparing the application data. The map cannot be displayed.</p>
                    <p><strong>Error details:</strong> ${error.message}</p>
                    <p>Please check the browser console for more technical information.</p>
                </div>`;
            window.isDataReadyForMap = false;
        }


        function getMarkerIcon(seniorChoice, isHighlighted = false, currentIsDarkMode) {
            let displayColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
            if (seniorChoice.collegeName === "Undecided") displayColor = '#999999';

            const currentBaseIcon = baseMarkerIcon || { path: 0, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            const currentHighlightedIcon = highlightedMarkerIcon || { ...currentBaseIcon, scale: 10, strokeWeight: 2.0 };

            const iconConfig = isHighlighted ? currentHighlightedIcon : currentBaseIcon;
            return { ...iconConfig, fillColor: displayColor, strokeColor: currentIsDarkMode ? '#111111' : '#ffffff' };
        }

        function getCollegeProperties(collegeEntry) {
            let isCampusPublic = false;

            if ([TYPE_SUNY, TYPE_CUNY, TYPE_OTHER_PUBLIC, TYPE_PURDUE].includes(collegeEntry.type)) {
                isCampusPublic = true;
            } else if ([TYPE_IVY_LEAGUE, TYPE_OTHER_PRIVATE].includes(collegeEntry.type)) {
                isCampusPublic = false;
            }
            if (collegeEntry.type === "Purdue University System") isCampusPublic = true;


            let locationFocus;
            const stateOrCountryUpper = collegeEntry.stateOrCountry ? collegeEntry.stateOrCountry.toUpperCase() : null;
            let isInternationallyFlagged = false;

            if (collegeEntry.name && (collegeEntry.name.includes("Shanghai") || collegeEntry.name.includes("London") || collegeEntry.name.includes("Edinburgh") || collegeEntry.name.includes("McGill") || collegeEntry.name.includes("St Andrews"))) {
                isInternationallyFlagged = true;
            } else if (stateOrCountryUpper) {
                if (["UK", "CANADA", "CHINA"].includes(stateOrCountryUpper)) {
                    isInternationallyFlagged = true;
                } else if (stateOrCountryUpper.length > 2 && stateOrCountryUpper !== "USA") {
                    isInternationallyFlagged = true;
                }
            }

            if (isInternationallyFlagged) {
                locationFocus = "International";
            } else {
                if (collegeEntry.lat >= NYC_BOUNDS.south && collegeEntry.lat <= NYC_BOUNDS.north &&
                    collegeEntry.lng >= NYC_BOUNDS.west && collegeEntry.lng <= NYC_BOUNDS.east) {
                    locationFocus = "InCityNYC";
                } else if (stateOrCountryUpper === "NY") {
                    locationFocus = "InStateNYOther";
                } else {
                    locationFocus = "OutOfStateUS";
                }
            }

            if (collegeEntry.name && (collegeEntry.name.includes("McGill University") || collegeEntry.name.includes("University of St Andrews") || collegeEntry.name.includes("University of Edinburgh"))) {
                locationFocus = "International";
            }
            if (collegeEntry.name && (collegeEntry.name.includes("Shanghai") || collegeEntry.name.includes("London"))) {
                 locationFocus = "International";
            }

            if (collegeEntry.name === "Undecided" || (collegeEntry.lat === 0 && collegeEntry.lng === 0)) {
                locationFocus = "N/A";
            }

            return { isCampusPublic, locationFocus };
        }

        function normalizeForFilename(str) {
            if (!str) return '';
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
        }

        function getFirstName(seniorName) {
            if (!seniorName) return "";
            return seniorName.split(' ')[0];
        }

        function getLastName(seniorName) {
            if (!seniorName) return "";
            const parts = seniorName.split(' ');
            return parts.length > 1 ? parts[parts.length - 1] : parts[0];
        }


       

        function getMajorArea(specificMajor) {
            if (!specificMajor) return "Unknown";

            const lowerSpecificMajor = specificMajor.toLowerCase().trim();
            if (lowerSpecificMajor === "" || lowerSpecificMajor === "undecided" || lowerSpecificMajor === "undecided major" || lowerSpecificMajor === "n/a" || lowerSpecificMajor === "exploratory") {
                return "Undecided/Other";
            }

            for (const keyInMap in majorToAreaMapping) {
                if (keyInMap.toLowerCase() === lowerSpecificMajor) {
                    return majorToAreaMapping[keyInMap];
                }
            }

            if (lowerSpecificMajor.includes('&') || lowerSpecificMajor.includes(' and ')) {
                const rawParts = lowerSpecificMajor.split(/\s*&\s*|\s+and\s+/);
                const areas = rawParts.map(part => {
                    part = part.trim();
                    if (part === "") return "Unknown";

                    let mappedAreaOfPart = "Other";

                    for (const keyInMapForPart in majorToAreaMapping) {
                        if (keyInMapForPart.toLowerCase() === part) {
                            mappedAreaOfPart = majorToAreaMapping[keyInMapForPart];
                            break;
                        }
                    }

                    if (mappedAreaOfPart === "Other") {
                        let bestSubMatchKey = null;
                        let bestSubMatchScore = 0;

                        for (const keyInMapForPart in majorToAreaMapping) {
                            const lowerKey = keyInMapForPart.toLowerCase();
                            if (part.includes(lowerKey) && lowerKey.length > 3) {
                                if (lowerKey.length > bestSubMatchScore) {
                                    bestSubMatchScore = lowerKey.length;
                                    bestSubMatchKey = keyInMapForPart;
                                }
                            } else if (lowerKey.includes(part) && part.length >= 2 && lowerKey.length > 3) {
                                let currentScore = part.length;
                                if (currentScore > bestSubMatchScore) {
                                     bestSubMatchScore = currentScore;
                                     bestSubMatchKey = keyInMapForPart;
                                }
                            }
                        }
                        if (bestSubMatchKey) {
                            mappedAreaOfPart = majorToAreaMapping[bestSubMatchKey];
                        }
                    }

                    if (mappedAreaOfPart === "Other") {
                        if (part.includes("engineering")) mappedAreaOfPart = "Engineering";
                        else if (part.includes("science") && !part.includes("social") && !part.includes("political") && !part.includes("environmental st")) mappedAreaOfPart = "STEM";
                        else if (part.includes("art") || part.includes("design") || part.includes("music") || part.includes("theat") || part.includes("film") || part.includes("drama")) mappedAreaOfPart = "Arts/Design";
                        else if (part.includes("business") || part.includes("econ") || part.includes("financ") || part.includes("market") || part.includes("account")) mappedAreaOfPart = "Business/Economics";
                    }
                    return mappedAreaOfPart;
                });

                const finalAreas = areas.filter(a => a !== "Unknown" && a !== "Other");
                if (finalAreas.length > 0) {
                    // Prioritize specific areas over "Other" if mixed
                    const uniqueFinalAreas = [...new Set(finalAreas)];
                    if (uniqueFinalAreas.length === 1) return uniqueFinalAreas[0];
                    return uniqueFinalAreas.join(' & ');
                } else {
                     // If all parts resolved to "Other" or "Unknown"
                    const otherOrUnknownAreas = areas.filter(a => a === "Other" || a === "Unknown");
                    if(otherOrUnknownAreas.length > 0) return "Other"; // Default to Other if only others/unknowns
                }
            }

            let bestContainedKey = null;
            let longestContainedKeyLength = 0;
            for (const keyInMap in majorToAreaMapping) {
                if (lowerSpecificMajor.includes(keyInMap.toLowerCase()) && keyInMap.length > 3) {
                    if (keyInMap.length > longestContainedKeyLength) {
                        longestContainedKeyLength = keyInMap.length;
                        bestContainedKey = keyInMap;
                    }
                }
            }
            if (bestContainedKey) {
                return majorToAreaMapping[bestContainedKey];
            }

            if (lowerSpecificMajor.includes("engineering")) return "Engineering";
            if (lowerSpecificMajor.includes("science") && !lowerSpecificMajor.includes("social") && !lowerSpecificMajor.includes("political") && !lowerSpecificMajor.includes("environmental st")) return "STEM";
            if (lowerSpecificMajor.includes("art") || lowerSpecificMajor.includes("design") || lowerSpecificMajor.includes("music") || lowerSpecificMajor.includes("theat") || lowerSpecificMajor.includes("film") || lowerSpecificMajor.includes("drama")) return "Arts/Design";
            if (lowerSpecificMajor.includes("business") || lowerSpecificMajor.includes("econ") || lowerSpecificMajor.includes("financ") || lowerSpecificMajor.includes("market") || lowerSpecificMajor.includes("account")) return "Business/Economics";
            if (lowerSpecificMajor.includes("politic") || lowerSpecificMajor.includes("gov") || lowerSpecificMajor.includes("socio") || lowerSpecificMajor.includes("psych") || lowerSpecificMajor.includes("anthro") || lowerSpecificMajor.includes("histor") || lowerSpecificMajor.includes("english") || lowerSpecificMajor.includes("philosophy")) return "Humanities/Social Sciences";
            if (lowerSpecificMajor.includes("health") || lowerSpecificMajor.includes("medic") || lowerSpecificMajor.includes("nurs") || lowerSpecificMajor.includes("pre-med")) return "Health Sciences";
            if (lowerSpecificMajor.includes("educat") || lowerSpecificMajor.includes("teach")) return "Education";

            return "Other";
        }

        function parseRawData(rawData) {
            const lines = rawData.trim().split('\n');
            const rawEntries = [];
            let currentGradClass = null;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith("Class of ")) {
                    currentGradClass = trimmedLine.substring("Class of ".length).trim();
                    continue;
                }
                if (!currentGradClass || !trimmedLine.includes(" - ") || trimmedLine === "") {
                    continue;
                }

                const parts = trimmedLine.split(" - ");
                if (parts.length < 2) {
                    console.warn("Skipping malformed line in rawData:", trimmedLine);
                    continue;
                }
                const seniorName = parts[0].trim();
                const collegeNameRaw = parts[1].trim();
                let major = "Undecided Major";
                if (parts.length > 2) {
                    major = parts[2].trim();
                    if (major === "") major = "Undecided Major";
                }

                const originalFirstName = seniorName.split(' ')[0];

                rawEntries.push({
                    seniorName,
                    collegeNameRaw,
                    major,
                    gradClass: currentGradClass,
                    originalFirstName
                });
            }

            const firstNameCountsByClass = new Map();
            for (const entry of rawEntries) {
                if (!firstNameCountsByClass.has(entry.gradClass)) {
                    firstNameCountsByClass.set(entry.gradClass, new Map());
                }
                const classCounts = firstNameCountsByClass.get(entry.gradClass);
                const normalizedFirstNameForCount = normalizeForFilename(entry.originalFirstName.split(' ')[0]);
                classCounts.set(normalizedFirstNameForCount, (classCounts.get(normalizedFirstNameForCount) || 0) + 1);
            }

            const choices = [];
            for (const entry of rawEntries) {
                const { seniorName, collegeNameRaw, major, gradClass, originalFirstName } = entry;
                const photoYear = gradClass.replace("'", "");
                let photoFilename;

                const normalizedFirstNameForLookup = normalizeForFilename(originalFirstName.split(' ')[0]);

                if (firstNameCountsByClass.get(gradClass).get(normalizedFirstNameForLookup) > 1) {
                    photoFilename = normalizeForFilename(seniorName);
                } else {
                    photoFilename = normalizedFirstNameForLookup;
                }

                const seniorPhotoUrlBase = `photos/${photoYear}/${photoFilename}`;
                const normalizedNameKey = normalizeCollegeName(collegeNameRaw);
                const collegeDetails = collegeCoordsAndInfo[normalizedNameKey] || collegeCoordsAndInfo["Generic College"];

                let finalCollegeName = collegeDetails.name;
                if (collegeDetails === collegeCoordsAndInfo["Generic College"] && normalizedNameKey !== "Undecided") {
                    finalCollegeName = normalizedNameKey;
                }
                if (normalizedNameKey === "Undecided") finalCollegeName = "Undecided";

                let collegeTypeToUse = collegeDetails.type;
                if (collegeTypeMappings[normalizedNameKey]) {
                    collegeTypeToUse = collegeTypeMappings[normalizedNameKey];
                } else if (collegeTypeMappings[collegeNameRaw]) {
                     collegeTypeToUse = collegeTypeMappings[collegeNameRaw];
                }

                choices.push({
                    seniorName: seniorName,
                    gradClass: gradClass,
                    collegeName: finalCollegeName,
                    collegeKey: normalizedNameKey,
                    collegeNameRaw: collegeNameRaw,
                    major: major,
                    lat: collegeDetails.lat,
                    lng: collegeDetails.lng,
                    collegeType: collegeTypeToUse,
                    collegeImageUrl: collegeDetails.imageUrl,
                    collegeHomepageUrl: collegeDetails.homepageUrl,
                    isCampusPublic: collegeDetails.isCampusPublic,
                    locationFocus: collegeDetails.locationFocus,
                    seniorPhotoUrl: `${seniorPhotoUrlBase}.jpg`,
                    seniorPhotoUrlPng: `${seniorPhotoUrlBase}.png`,
                });
            }
            return choices;
        }

        function updateStatsTable() {
            const stats = {
                "InCityNYC": { Public: 0, Private: 0, Total: 0 },
                "InStateNYOther": { Public: 0, Private: 0, Total: 0 },
                "OutOfStateUS": { Public: 0, Private: 0, Total: 0 },
                "International": { Public: 0, Private: 0, Total: 0 },
                "Total": { Public: 0, Private: 0, Overall: 0 }
            };

            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided" && school.locationFocus !== "N/A") {
                    const focus = school.locationFocus; 
                    const type = school.isCampusPublic ? "Public" : "Private";

                    if (stats[focus]) {
                        stats[focus][type]++;
                        stats[focus].Total++;
                        stats.Total[type]++;
                        stats.Total.Overall++;
                    }
                }
            });

            for (const focus in stats) {
                if (stats.hasOwnProperty(focus)) {
                    if (focus === "Total") {
                        document.querySelector(`#stats-table td[data-stat="Total-Public"]`).textContent = stats.Total.Public;
                        document.querySelector(`#stats-table td[data-stat="Total-Private"]`).textContent = stats.Total.Private;
                        document.querySelector(`#stats-table td[data-stat="Total-Overall"]`).textContent = stats.Total.Overall;
                    } else {
                        document.querySelector(`#stats-table td[data-stat="${focus}-Public"]`).textContent = stats[focus].Public;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Private"]`).textContent = stats[focus].Private;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Total"]`).textContent = stats[focus].Total;
                    }
                }
            }
        }


        function updateMajorSummaryTable() {
            const majorAreaCounts = {};
            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaCounts[area] = 0);
            // Collect all unique major areas present in the *filtered* data to ensure dynamic areas are handled for display
            const allPresentMajorAreasInFilteredData = new Set(PREDEFINED_MAJOR_AREAS);


            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided") {
                    const majorAreaResult = school.majorArea; 
                    const areasToCount = [];
                    if (typeof majorAreaResult === 'string' && majorAreaResult.includes(' & ')) {
                        areasToCount.push(...majorAreaResult.split(' & ').map(s => s.trim()));
                    } else if (typeof majorAreaResult === 'string') { // Ensure it's a string before trying to push
                        areasToCount.push(majorAreaResult.trim());
                    }


                    areasToCount.forEach(area => {
                        if (area && area !== "Unknown") { // Only count valid areas
                             allPresentMajorAreasInFilteredData.add(area); // Track for display
                            if (majorAreaCounts.hasOwnProperty(area)) {
                                majorAreaCounts[area]++;
                            } else {
                                // If it's a new dynamic area not in PREDEFINED_MAJOR_AREAS
                                majorAreaCounts[area] = 1;
                                if (!PREDEFINED_MAJOR_AREAS.includes(area)) {
                                     // console.warn(`Unexpected major area encountered: ${area} from major: ${school.major}. Adding to table dynamically.`);
                                }
                            }
                        }
                    });
                }
            });

            const tableBody = document.querySelector("#major-summary-table tbody");
            tableBody.innerHTML = "";

            const sortedAreasToDisplay = Array.from(allPresentMajorAreasInFilteredData).sort((a, b) => {
                // Put "Undecided/Other" and "Other" at the end
                if ((a === "Undecided/Other" || a === "Other") && (b !== "Undecided/Other" && b !== "Other")) return 1;
                if ((b === "Undecided/Other" || b === "Other") && (a !== "Undecided/Other" && a !== "Other")) return -1;
                return a.localeCompare(b); // Alphabetical for the rest
            });


            sortedAreasToDisplay.forEach(area => {
                 // Show if count > 0, or if it's a predefined/tracked category that has a filter checkbox
                if (majorAreaCounts[area] > 0 || PREDEFINED_MAJOR_AREAS.includes(area) || majorAreaFilterState.hasOwnProperty(area) ) {
                    const row = tableBody.insertRow();
                    const cellArea = row.insertCell();
                    const cellCount = row.insertCell();
                    const cellFilter = row.insertCell();

                    cellArea.textContent = area;
                    cellCount.textContent = majorAreaCounts[area] || 0; 

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = majorAreaFilterState[area] !== undefined ? majorAreaFilterState[area] : true; 
                    checkbox.title = `Filter by ${area}`;
                    checkbox.dataset.majorArea = area;
                    checkbox.addEventListener('change', (event) => {
                        majorAreaFilterState[area] = event.target.checked;
                        updateCheckAllMajorAreasButtonState();
                        updateMarkersVisibility();
                    });
                    cellFilter.appendChild(checkbox);
                }
            });
            updateCheckAllMajorAreasButtonState();
        }

        function updateCheckAllMajorAreasButtonState() {
            const checkAllBtn = document.getElementById('checkAllMajorAreasBtn');
            if (!checkAllBtn) return;
            const allMajorCheckboxes = document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]');
            if (allMajorCheckboxes.length === 0) { 
                 checkAllBtn.checked = true; 
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allMajorCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allMajorCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }


        function updateMarkersVisibility() {
            if (!allMarkers || !allData) return;

            let visibleCount = 0;
            const areAnyGradClassFiltersActive = gradClassNames.some(gc => gradClassFilterState[gc]);
            const areAllGradClassFiltersCheckedOrNoneActive = gradClassNames.every(gc => gradClassFilterState[gc]) || !areAnyGradClassFiltersActive;

            const areAnyLocationFiltersActive = Object.values(locationFocusFilterState).some(val => val);
            const areAllLocationFiltersCheckedOrNoneActive = Object.values(locationFocusFilterState).every(val => val) || !areAnyLocationFiltersActive;
            
            const numMajorAreaFilters = Object.keys(majorAreaFilterState).length;
            const areAnyMajorAreaFiltersActive = numMajorAreaFilters > 0 && Object.values(majorAreaFilterState).some(val => val);
            const areAllMajorAreaFiltersCheckedOrNoneActive = numMajorAreaFilters === 0 || Object.values(majorAreaFilterState).every(val => val) || !areAnyMajorAreaFiltersActive;


            allData.forEach((school) => { 
                let meetsGradClassCriteria = areAllGradClassFiltersCheckedOrNoneActive || gradClassFilterState[school.gradClass] === true;
                
                let meetsLocationFocusCriteria = areAllLocationFiltersCheckedOrNoneActive || school.locationFocus === "N/A" || locationFocusFilterState[school.locationFocus] === true;
                
                let meetsMajorAreaCriteria;
                if (areAllMajorAreaFiltersCheckedOrNoneActive) {
                    meetsMajorAreaCriteria = true;
                } else {
                    const schoolMajorAreas = school.majorArea.split(' & ').map(s => s.trim());
                    meetsMajorAreaCriteria = schoolMajorAreas.some(area => majorAreaFilterState[area] === true);
                }
                
                if (school.collegeName === "Undecided") {
                    const undecidedMajorAreaSelected = majorAreaFilterState["Undecided/Other"] !== undefined ? majorAreaFilterState["Undecided/Other"] : true;
                    // For Undecided, location is "N/A". It should follow the "N/A" location filter if such exists, or general visibility.
                    const undecidedLocationSelected = locationFocusFilterState["N/A"] !== undefined ? locationFocusFilterState["N/A"] : meetsLocationFocusCriteria;

                    school.isVisible = meetsGradClassCriteria && undecidedMajorAreaSelected && undecidedLocationSelected;
                } else {
                    school.isVisible = meetsGradClassCriteria && meetsLocationFocusCriteria && meetsMajorAreaCriteria;
                }


                const markerInfo = allMarkers[school.originalIndex];
                if (markerInfo && markerInfo.marker) {
                    if (markerInfo.marker.getVisible() !== school.isVisible) {
                        markerInfo.marker.setVisible(school.isVisible);
                    }
                }

                if (school.isVisible) {
                    visibleCount++;
                } else {
                    if(schoolsSelectedForZoom.has(school.originalIndex)) {
                        schoolsSelectedForZoom.delete(school.originalIndex);
                    }
                    if (infowindow && infowindow.getMap() && markerInfo && infowindow.anchor === markerInfo.marker) {
                        infowindow.close();
                    }
                    const listUl = document.querySelector('#school-list-control .list-content ul');
                    if (listUl && currentListSelectionIndex !== -1) {
                        const visibleListItems = getVisibleListItemsDOM(); // Use helper
                        if (currentListSelectionIndex < visibleListItems.length) { // Check against current visible list
                            const currentlySelectedVisibleLi = visibleListItems[currentListSelectionIndex];
                             // Check if the item about to be hidden was the selected one
                            if (currentlySelectedVisibleLi && parseInt(currentlySelectedVisibleLi.dataset.originalIndex) === school.originalIndex) {
                                // Reset selection if the currently selected item becomes hidden
                                currentListSelectionIndex = -1; 
                                // Also deselect its marker if it was the activeHoverMarker
                                if (activeHoverMarkerIndex === school.originalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                                    activeHoverMarkerIndex = null;
                                }
                            }
                        }
                    }
                }
            });

            filterSchoolList();
            updateStatsTable();
            updateMajorSummaryTable();
            updateCurrentSelectionHighlight(); 
        }

        // Helper to get current visible LIs from DOM for selection logic
        function getVisibleListItemsDOM() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return [];
            return Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)'))
                        .filter(li => li.style.display !== 'none' && li.dataset.originalIndex);
        }


        function filterSchoolList() {
            const searchTerm = document.getElementById('schoolSearchInput').value.toLowerCase().trim();
            const listContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            if (!listContentDiv) return;
            const listItems = listContentDiv.querySelectorAll('ul li'); 
            const noResultsMessage = document.getElementById('no-results-message');
            let hasVisibleItems = false;
            let lastVisibleGradClassForSeparator = null; 
            const showSeparators = currentSortOption === 'grad_first' || currentSortOption === 'grad_last';

            listItems.forEach(item => {
                if (item.classList.contains('grad-class-separator')) {
                    item.style.display = 'none'; 
                    return; 
                }

                const nameSpan = item.querySelector('span.school-name');
                const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                const schoolData = (!isNaN(originalIndex) && allData && allData[originalIndex]) ? allData[originalIndex] : null;

                if (!schoolData) { 
                    item.style.display = 'none';
                    return;
                }

                const isVisibleByFilters = schoolData.isVisible;

                let matchesSearch = searchTerm === '';
                if (!matchesSearch && nameSpan) {
                    const itemText = nameSpan.textContent.toLowerCase();
                    matchesSearch = itemText.includes(searchTerm);
                }

                const finalItemVisibility = isVisibleByFilters && matchesSearch;

                if (finalItemVisibility) {
                    item.style.display = isGalleryViewEnabled ? 'flex' : 'flex'; 
                    hasVisibleItems = true;

                    if (showSeparators) {
                        if (lastVisibleGradClassForSeparator !== null && schoolData.gradClass !== lastVisibleGradClassForSeparator) {
                            let potentialSeparator = item.previousElementSibling;
                            while(potentialSeparator && potentialSeparator.style.display === 'none' && potentialSeparator.classList.contains('grad-class-separator')) {
                                potentialSeparator = potentialSeparator.previousElementSibling; // Skip hidden separators
                            }
                            if (potentialSeparator && potentialSeparator.classList.contains('grad-class-separator')) {
                                potentialSeparator.style.display = isGalleryViewEnabled ? 'block' : 'list-item'; // Use 'block' for gallery, 'list-item' or 'flex' for default
                            }
                        }
                        lastVisibleGradClassForSeparator = schoolData.gradClass;
                    }
                } else {
                    item.style.display = 'none';
                }
            });

            noResultsMessage.style.display = hasVisibleItems ? 'none' : 'block';
            updateCurrentSelectionHighlight(); 
        }


        function showSeniorPhotoPopup(listItem, schoolData) {
            if (!seniorPhotoPopup || !seniorPopupImage || !seniorPopupCaption) {
                console.error("[DEBUG] Senior photo popup elements not initialized properly.");
                return;
            }
            currentlyZoomedSeniorOriginalIndex = schoolData.originalIndex; // Track for navigation

            seniorPopupImage.style.display = 'block';
            seniorPopupImage.src = schoolData.seniorPhotoUrl;

            seniorPopupImage.onerror = function() {
                this.src = schoolData.seniorPhotoUrlPng;
                this.onerror = function() {
                    if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                        this.src = schoolData.collegeImageUrl;
                        this.onerror = function() {
                            this.style.display = 'none';
                            this.onerror = null;
                        };
                    } else {
                        this.style.display = 'none';
                        this.onerror = null;
                    }
                };
            };

            seniorPopupImage.alt = `${schoolData.seniorName}'s Photo / ${schoolData.collegeName} Logo`;
            seniorPopupCaption.textContent = `Congrats, ${schoolData.seniorName}!`;
            seniorPhotoPopup.classList.add('visible');

            const popupWidth = seniorPhotoPopup.offsetWidth;
            const popupHeight = seniorPhotoPopup.offsetHeight;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const marginFromPanel = 15;
            const paddingFromViewportEdge = 10;

            const leftPanel = document.getElementById('controls-and-list-container');
            const leftPanelRect = leftPanel.getBoundingClientRect();

            let popupLeft, popupTop;

            if (listItem) {
                const listItemRect = listItem.getBoundingClientRect();
                popupTop = listItemRect.top;
            } else {
                popupTop = (viewportHeight - popupHeight) / 2;
            }

            popupTop = Math.max(paddingFromViewportEdge, popupTop);
            if (popupTop + popupHeight > viewportHeight - paddingFromViewportEdge) {
                popupTop = viewportHeight - popupHeight - paddingFromViewportEdge;
            }
            popupTop = Math.max(paddingFromViewportEdge, popupTop);

            popupLeft = leftPanelRect.right + marginFromPanel;

            if (popupLeft + popupWidth > viewportWidth - paddingFromViewportEdge) {
                popupLeft = leftPanelRect.left - popupWidth - marginFromPanel;
                if (popupLeft < paddingFromViewportEdge) {
                    popupLeft = viewportWidth - popupWidth - paddingFromViewportEdge;
                }
            }
            popupLeft = Math.max(paddingFromViewportEdge, popupLeft);
            if (popupLeft + popupWidth > viewportWidth - paddingFromViewportEdge) {
                popupLeft = viewportWidth - popupWidth - paddingFromViewportEdge;
            }
            popupLeft = Math.max(paddingFromViewportEdge, popupLeft);


            seniorPhotoPopup.style.left = `${popupLeft}px`;
            seniorPhotoPopup.style.top = `${popupTop}px`;
        }

        function hideSeniorPhotoPopup() {
            if (seniorPhotoPopup) {
                seniorPhotoPopup.classList.remove('visible');
                if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                    exitZoomMode(false); 
                }
                currentlyZoomedSeniorOriginalIndex = null; // Reset when popup is hidden
                 if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
                 if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
            }
        }

        function exitZoomMode(hideSmallPopupAfter = true) {
            if (!seniorPhotoPopup || !seniorPopupImage) return;

            const parentPopup = seniorPhotoPopup;
             if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
             if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
             parentPopup.classList.remove('zoomed-state');


            if (seniorPopupImage.classList.contains('zoomed')) {
                seniorPopupImage.classList.remove('zoomed');

                if (photoZoomOverlay) photoZoomOverlay.style.display = 'none';
                if (zoomExitNote) zoomExitNote.style.display = 'none';

                parentPopup.style.transform = parentPopup.dataset.originalTransform || '';
                parentPopup.style.left = parentPopup.dataset.originalLeft || '';
                parentPopup.style.top = parentPopup.dataset.originalTop || '';
                parentPopup.style.width = parentPopup.dataset.originalWidth || '';
                parentPopup.style.height = parentPopup.dataset.originalHeight || '';
                parentPopup.style.backgroundColor = parentPopup.dataset.originalBg || '';
                parentPopup.style.border = parentPopup.dataset.originalBorder || '';
                parentPopup.style.boxShadow = parentPopup.dataset.originalBoxShadow || '';
                parentPopup.style.padding = parentPopup.dataset.originalPadding || '';
                parentPopup.style.pointerEvents = parentPopup.dataset.originalPointerEvents || 'auto';

                delete parentPopup.dataset.originalTransform;
                delete parentPopup.dataset.originalLeft;
                delete parentPopup.dataset.originalTop;
                delete parentPopup.dataset.originalWidth;
                delete parentPopup.dataset.originalHeight;
                delete parentPopup.dataset.originalBg;
                delete parentPopup.dataset.originalBorder;
                delete parentPopup.dataset.originalBoxShadow;
                delete parentPopup.dataset.originalPadding;
                delete parentPopup.dataset.originalPointerEvents;


                if (hideSmallPopupAfter) {
                     hideSeniorPhotoPopup();
                }
            } else if (hideSmallPopupAfter) { 
                hideSeniorPhotoPopup();
            }
        }


        function getHonorarySuffixHTML(rawCollegeName) {
            let suffixHtml = "";
            const rawLower = rawCollegeName.toLowerCase();
            if (rawLower.includes("(macaulay)")) suffixHtml = ' <span class="honorary-suffix">(Macaulay)</span>';
            else if (rawLower.includes("(questbridge)")) suffixHtml = ' <span class="honorary-suffix">(QuestBridge)</span>';
            else if (rawLower.includes("(posse)")) suffixHtml = ' <span class="honorary-suffix">(POSSE)</span>';
            return suffixHtml;
        }


        function handleListItemInteraction(event, originalIndex, isHover) {
             if (event && event.target && event.target.type === 'checkbox') return;
             if (originalIndex === undefined || !allData[originalIndex]) {
                console.warn("Invalid originalIndex or data for list item interaction:", originalIndex);
                return;
             }

             const schoolData = allData[originalIndex];
             const markerInfo = allMarkers[originalIndex]; 

             if (!schoolData.isVisible) {
                if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                    const currentCaption = seniorPopupCaption.textContent;
                    if (currentCaption.includes(schoolData.seniorName)) {
                        hideSeniorPhotoPopup();
                    }
                }
                return;
             }
            const currentTargetListItem = event ? event.currentTarget : document.querySelector(`.list-content li[data-original-index="${originalIndex}"]`);


             if (isHover) {
                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                    }
                }
                showSeniorPhotoPopup(currentTargetListItem, schoolData);
             } else { 
                if (infowindow && infowindow.getMap()) {
                    infowindow.close();
                }

                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                        map.setZoom(Math.max(map.getZoom(), 12));

                        let contentString = `<div class="info-window-content">`;
                        const targetUrl = schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#' ? schoolData.collegeHomepageUrl : '#';
                        const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                        if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                            contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${schoolData.collegeImageUrl}" alt="${schoolData.collegeName} logo/photo"></a>`;
                        }
                        contentString += `<b>${schoolData.seniorName}</b>`;
                        contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[schoolData.gradClass] || '#ccc'};">Class: ${schoolData.gradClass}</span>`;

                        const suffixHtml = getHonorarySuffixHTML(schoolData.collegeNameRaw);
                        if (targetUrl !== '#') {
                            contentString += `<br>Attending: <a href="${targetUrl}" ${openInNewTab}>${schoolData.collegeName}</a>${suffixHtml}`;
                        } else {
                            contentString += `<br>Attending: ${schoolData.collegeName}${suffixHtml}`;
                        }
                        contentString += `<br>Major: ${schoolData.major || 'Undecided Major'} (${schoolData.majorArea || 'N/A'})`;
                        contentString += `<br><span class="info-window-type">Type: ${schoolData.collegeType} (${schoolData.isCampusPublic ? 'Public' : 'Private'}, ${schoolData.locationFocus})</span>`;
                        if (schoolData.lat !== 0 || schoolData.lng !== 0) {
                            contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${schoolData.lat},${schoolData.lng}" target="_blank">Get Directions</a>`;
                        }
                        contentString += `</div>`;
                        infowindow.setContent(contentString);
                        infowindow.open({ map: map, anchor: markerInfo.marker });
                    }
                }
                showSeniorPhotoPopup(currentTargetListItem, schoolData);

                 if (event && (event.ctrlKey || event.metaKey) && schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#') {
                     window.open(schoolData.collegeHomepageUrl, '_blank');
                     event.preventDefault();
                 }
             }
        }

        function navigateToSeniorPhoto(direction) {
            const visibleListItems = getVisibleListItemsDOM();
            if (visibleListItems.length === 0) return;

            let currentIndexInVisibleList = -1;
            if (currentlyZoomedSeniorOriginalIndex !== null) {
                currentIndexInVisibleList = visibleListItems.findIndex(li => 
                    parseInt(li.dataset.originalIndex) === currentlyZoomedSeniorOriginalIndex
                );
            }

            let newIndexInVisibleList;
            if (currentIndexInVisibleList === -1) { // If current not found or not set, start from beginning/end
                newIndexInVisibleList = (direction === 'next') ? 0 : visibleListItems.length - 1;
            } else {
                if (direction === 'next') {
                    newIndexInVisibleList = (currentIndexInVisibleList + 1) % visibleListItems.length;
                } else { // 'prev'
                    newIndexInVisibleList = (currentIndexInVisibleList - 1 + visibleListItems.length) % visibleListItems.length;
                }
            }

            const newListItem = visibleListItems[newIndexInVisibleList];
            if (newListItem) {
                const newOriginalIndex = parseInt(newListItem.dataset.originalIndex);
                const newSeniorData = allData[newOriginalIndex];

                if (newSeniorData) {
                    // Update zoomed photo and caption
                    currentlyZoomedSeniorOriginalIndex = newOriginalIndex;
                    seniorPopupImage.src = newSeniorData.seniorPhotoUrl; // Add error handling like in showSeniorPhotoPopup
                     seniorPopupImage.onerror = function() {
                        this.src = newSeniorData.seniorPhotoUrlPng;
                        this.onerror = function() {
                            if (newSeniorData.collegeImageUrl && newSeniorData.collegeImageUrl !== 'x' && !newSeniorData.collegeImageUrl.startsWith('placeholder')) {
                                this.src = newSeniorData.collegeImageUrl;
                            } else { this.style.display = 'none'; }
                            this.onerror = null;
                        };
                    };
                    seniorPopupImage.alt = `${newSeniorData.seniorName}'s Photo / ${newSeniorData.collegeName} Logo`;
                    seniorPopupCaption.textContent = `Congrats, ${newSeniorData.seniorName}!`;

                    // Update main list selection and map focus
                    currentListSelectionIndex = newIndexInVisibleList;
                    updateCurrentSelectionHighlight();
                    newListItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     newListItem.focus();


                    // Simulate click interaction for map and info window
                    handleListItemInteraction({ currentTarget: newListItem, target: newListItem, ctrlKey: false, metaKey: false }, newOriginalIndex, false);
                    
                     // Ensure marker highlighting is correct
                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== newOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    if (allMarkers[newOriginalIndex]?.marker && allData[newOriginalIndex]) {
                         allMarkers[newOriginalIndex].marker.setIcon(getMarkerIcon(allData[newOriginalIndex], true, isDarkMode));
                         allMarkers[newOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                         activeHoverMarkerIndex = newOriginalIndex;
                    }
                }
            }
        }


        function zoomToSelectedSchools() {
            if (!google || !map || !allMarkers) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            schoolsSelectedForZoom.forEach(originalIndex => {
                const schoolData = allData[originalIndex];
                const markerInfo = allMarkers[originalIndex];

                if (schoolData && schoolData.isVisible && markerInfo && markerInfo.marker) {
                    if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {
                        // Skip
                    } else if (schoolData.lat === 0 && schoolData.lng === 0) {
                        console.warn("Skipping school with 0,0 coordinates from zoom:", schoolData.displayName);
                    }
                    else {
                        bounds.extend(markerInfo.marker.getPosition());
                        validVisiblePoints++;
                    }
                }
            });

            if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }

        function zoomToAllVisibleMarkers() {
            if (!google || !map || !allMarkers || !allData) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            allData.forEach(schoolData => {
                if (schoolData.isVisible) {
                    const markerInfo = allMarkers[schoolData.originalIndex];
                     if (markerInfo && markerInfo.marker) {
                        if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {
                           // skip
                        } else if (schoolData.lat === 0 && schoolData.lng === 0) {
                            // skip
                        } else {
                            bounds.extend(markerInfo.marker.getPosition());
                            validVisiblePoints++;
                        }
                    }
                }
            });
             if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }


        function handleSearchInput() {
             const input = document.getElementById('schoolSearchInput');
             const suggestionsDiv = document.getElementById('searchSuggestions');
             const searchTerm = input.value.toLowerCase().trim();

             suggestionsDiv.innerHTML = '';
             suggestionsDiv.style.display = 'none';

             if (searchTerm.length < 2) {
                filterSchoolList();
                return;
             }

             if (!allData) return;

             const matchingEntries = allData.filter(entry =>
                entry.isVisible &&
                 (
                    (entry.seniorName && entry.seniorName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeName && entry.collegeName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeNameRaw && entry.collegeNameRaw.toLowerCase().includes(searchTerm)) ||
                    (entry.major && entry.major.toLowerCase().includes(searchTerm)) ||
                    (entry.majorArea && entry.majorArea.toLowerCase().includes(searchTerm))
                )
             ).slice(0, 10);

             if (matchingEntries.length > 0) {
                 matchingEntries.forEach(entry => {
                     const div = document.createElement('div');
                     const suffixHtml = getHonorarySuffixHTML(entry.collegeNameRaw);
                     div.innerHTML = `${entry.seniorName} (${entry.gradClass}) → ${entry.collegeName}${suffixHtml} (${entry.major || 'Undecided'})`;

                     div.onclick = () => {
                         input.value = entry.seniorName;
                         suggestionsDiv.style.display = 'none';
                         filterSchoolList(); 

                         const clickedOriginalIndex = entry.originalIndex;
                         const listItem = document.querySelector(`.list-content li[data-original-index="${clickedOriginalIndex}"]`);
                         if (listItem) {
                            handleListItemInteraction({ currentTarget: listItem, target: listItem, ctrlKey: false, metaKey: false }, clickedOriginalIndex, false);
                            listItem.scrollIntoView({behavior: 'smooth', block: 'nearest'});

                            const listUl = document.querySelector('#school-list-control .list-content ul');
                            const visibleListItemsAfterSearch = getVisibleListItemsDOM();
                            currentListSelectionIndex = visibleListItemsAfterSearch.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                            if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                                allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                                allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                            }
                            if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                                allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                                allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                                activeHoverMarkerIndex = clickedOriginalIndex;
                            }
                            updateCurrentSelectionHighlight();
                         }
                     };
                     suggestionsDiv.appendChild(div);
                 });
                 suggestionsDiv.style.display = 'block';
             }
             filterSchoolList();
        }


        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function sortAndRebuildList(sortOption) {
            currentSortOption = sortOption;
            if (!allData) return;

            allData.sort((a, b) => {
                let comparison = 0;
                const gradClassA = parseInt(a.gradClass.substring(1));
                const gradClassB = parseInt(b.gradClass.substring(1));
                const firstNameA = getFirstName(a.seniorName);
                const firstNameB = getFirstName(b.seniorName);
                const lastNameA = getLastName(a.seniorName);
                const lastNameB = getLastName(b.seniorName);

                switch (sortOption) {
                    case 'grad_first':
                        if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                        comparison = firstNameA.localeCompare(firstNameB);
                        break;
                    case 'grad_last':
                        if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                        comparison = lastNameA.localeCompare(lastNameB);
                        if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                        break;
                    case 'first_name':
                        comparison = firstNameA.localeCompare(firstNameB);
                        if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB);
                        break;
                    case 'last_name':
                        comparison = lastNameA.localeCompare(lastNameB);
                        if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                        break;
                    case 'college_name':
                        comparison = a.collegeName.localeCompare(b.collegeName);
                        if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB);
                        if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                        break;
                    default:
                        if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                        comparison = firstNameA.localeCompare(firstNameB);
                        break;
                }
                return comparison;
            });
            rebuildSchoolListHTML();
            currentListSelectionIndex = -1; 
            updateCurrentSelectionHighlight();
        }

        function rebuildSchoolListHTML() {
            const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            if (!schoolListCollapsibleContentDiv) {
                console.error("School list collapsible content div not found.");
                return;
            }
            let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
            const noResultsMessage = document.getElementById('no-results-message');

            if (!schoolListUl) {
                schoolListUl = document.createElement('ul');
                schoolListCollapsibleContentDiv.insertBefore(schoolListUl, noResultsMessage); 
            }

            schoolListUl.innerHTML = '';

            if (!allData) {
                schoolListUl.innerHTML = '<li>Data is not available.</li>';
                noResultsMessage.style.display = 'none';
                return;
            }

            let previousGradClass = null;
            const showSeparators = currentSortOption === 'grad_first' || currentSortOption === 'grad_last';

            allData.forEach(seniorChoice => {

                const listItem = document.createElement('li');
                const originalIndex = seniorChoice.originalIndex;
                listItem.setAttribute('data-original-index', originalIndex);
                listItem.setAttribute('tabindex', '0'); 
                listItem.setAttribute('title', `Click: Zoom & Info. Ctrl+Click: Homepage. Hover: Photo. Shift+Click checkbox: Group Zoom.`);

                const schoolCheckbox = document.createElement('input');
                schoolCheckbox.type = 'checkbox';
                schoolCheckbox.checked = seniorChoice.isVisible; // Check reflects current filter state
                schoolCheckbox.id = `school-checkbox-${originalIndex}`;
                schoolCheckbox.setAttribute('aria-label', `Toggle visibility for ${seniorChoice.displayName}`);

                schoolCheckbox.addEventListener('change', (event) => {
                    const isChecked = event.target.checked;
                     // This checkbox directly controls the schoolData.isVisible for THIS item only.
                     // The overall visibility update will then be triggered.
                    if (allData[originalIndex]) {
                         allData[originalIndex].isVisFilterControlled = isChecked; // A new flag if needed, or just use isVisible if this is the SOLE controller
                         // For simplicity, let's assume checking/unchecking *this* checkbox directly sets the desire for it to be visible
                         // and updateMarkersVisibility will then consider *all* filter criteria.
                         // This checkbox's direct effect might be overridden by other filters.
                         // The true source of 'isVisible' comes from updateMarkersVisibility.
                         // So, this checkbox might be more of a "request to include/exclude if other filters allow".
                         // A better approach: the checkbox state should reflect and *influence* one of the filter states.
                         // For now, let's have it toggle for group zoom and allow updateMarkersVisibility to handle the rest.
                    }


                    if (event.shiftKey) {
                        event.preventDefault();
                        if (isChecked && allData[originalIndex]?.isVisible) { // Only add if overall visible
                            schoolsSelectedForZoom.add(originalIndex);
                        } else {
                            schoolsSelectedForZoom.delete(originalIndex);
                        }
                        zoomToSelectedSchools();
                    } else if (!isChecked) {
                        schoolsSelectedForZoom.delete(originalIndex);
                        // If unchecking, we might want to make this specific item not visible
                        // This is complex as 'isVisible' is a result of multiple filters.
                        // Simplest: if unchecked, it's OUT for zoom. Visibility still by master filters.
                    }
                    // No direct call to updateMarkersVisibility here; that could cause loops or override other filters.
                    // The checkbox is for group zoom or can be a part of a "manual selection" filter type if added.
                    // If this checkbox is *meant* to be a direct visibility toggle, then:
                    // allData[originalIndex].isVisible = isChecked; updateMarkersVisibility();
                    // But that bypasses other filters for this single item.
                    // Let's assume it's primarily for the shift-click zoom for now.
                    // The `checked` state will be set by `filterSchoolList` based on `schoolData.isVisible`.
                });


                const nameSpan = document.createElement('span');
                nameSpan.className = 'school-name';
                const suffixHtml = getHonorarySuffixHTML(seniorChoice.collegeNameRaw);
                nameSpan.innerHTML = `${seniorChoice.seniorName} <span style="color: ${gradClassColors[seniorChoice.gradClass] || '#ccc'}; font-weight: bold;">(${seniorChoice.gradClass})</span> → ${seniorChoice.collegeName}${suffixHtml} <span class="list-item-major">(${(seniorChoice.major || 'Undecided Major')})</span>`;

               if (isGalleryViewEnabled) {
    listItem.style.backgroundColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';

    // Checkbox - append directly to listItem for absolute positioning within it
    listItem.appendChild(schoolCheckbox);

    // Grad Class Text Overlay
    const gradClassTextElement = document.createElement('div');
    gradClassTextElement.className = 'gallery-grad-class-overlay';
    gradClassTextElement.textContent = seniorChoice.gradClass;

    // Determine text color for contrast with background
    const bgColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
    if (bgColor.startsWith('#')) {
        const r = parseInt(bgColor.slice(1, 3), 16);
        const g = parseInt(bgColor.slice(3, 5), 16);
        const b = parseInt(bgColor.slice(5, 7), 16);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        gradClassTextElement.style.color = brightness > 135 ? '#1A1A1A' : '#FAFAFA'; // Darker/lighter text
    } else {
        gradClassTextElement.style.color = '#FFFFFF'; // Default for non-hex
    }
    listItem.appendChild(gradClassTextElement);

    // Container for the photo, to manage spacing below the overlay
    const galleryPhotoDiv = document.createElement('div');
    galleryPhotoDiv.className = 'gallery-photo-div'; // New class

    const galleryImg = document.createElement('img');
    galleryImg.className = 'gallery-photo';
    galleryImg.src = seniorChoice.seniorPhotoUrl;
    galleryImg.alt = `${seniorChoice.seniorName}'s Photo`;
    galleryImg.onerror = function() {
        this.src = seniorChoice.seniorPhotoUrlPng;
        this.onerror = function() {
            this.src = seniorChoice.collegeImageUrl && !seniorChoice.collegeImageUrl.startsWith('placeholder') ? seniorChoice.collegeImageUrl : 'placeholder-logo.png';
            this.onerror = null;
        };
    };
    galleryPhotoDiv.appendChild(galleryImg);
    listItem.appendChild(galleryPhotoDiv);

    // nameSpan is NOT appended in gallery view
} else {
    // Standard List View: checkbox and then the full nameSpan
    listItem.appendChild(schoolCheckbox);
    listItem.appendChild(nameSpan);
}


                listItem.addEventListener('mouseenter', (event) => {
                    const currentOriginalIndex = originalIndex;
                    const schoolData = allData[currentOriginalIndex];
                    const markerInfo = allMarkers[currentOriginalIndex];
                    if (markerInfo?.marker && schoolData?.isVisible) {
                        markerInfo.marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                        markerInfo.marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                        handleListItemInteraction(event, currentOriginalIndex, true);
                    }
                    listItem.classList.add('list-item-highlight');
                });

                listItem.addEventListener('mouseleave', (event) => {
                    const currentOriginalIndex = originalIndex;
                    const schoolData = allData[currentOriginalIndex];
                    const markerInfo = allMarkers[currentOriginalIndex];

                    let isKeyboardSelected = false;
                    if (currentListSelectionIndex !== -1) {
                        const listUl = document.querySelector('#school-list-control .list-content ul');
                        const visibleLIs = getVisibleListItemsDOM();
                        if (currentListSelectionIndex < visibleLIs.length) {
                            const kbdSelectedLi = visibleLIs[currentListSelectionIndex];
                            if (kbdSelectedLi && parseInt(kbdSelectedLi.dataset.originalIndex) === currentOriginalIndex) {
                                isKeyboardSelected = true;
                            }
                        }
                    }

                    if (!isKeyboardSelected && markerInfo?.marker && schoolData) {
                        markerInfo.marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                        markerInfo.marker.setZIndex(null);
                    }
                     if (!isKeyboardSelected) { 
                        listItem.classList.remove('list-item-highlight');
                    }
                });

                listItem.addEventListener('click', (event) => {
                    if (event.target.type === 'checkbox') return;

                    const clickedOriginalIndex = originalIndex;
                    handleListItemInteraction(event, clickedOriginalIndex, false);

                    const listUl = document.querySelector('#school-list-control .list-content ul');
                    const visibleListItems = getVisibleListItemsDOM();
                    currentListSelectionIndex = visibleListItems.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                         allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                         allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                         activeHoverMarkerIndex = clickedOriginalIndex;
                    }
                    updateCurrentSelectionHighlight();
                });

                if (showSeparators && previousGradClass !== null && seniorChoice.gradClass !== previousGradClass && schoolListUl.lastChild) {
                    const separatorLi = document.createElement('li');
                    separatorLi.className = 'grad-class-separator';
                    separatorLi.setAttribute('aria-hidden', 'true');
                    schoolListUl.appendChild(separatorLi);
                }

                schoolListUl.appendChild(listItem);

                if (showSeparators) {
                    previousGradClass = seniorChoice.gradClass;
                }
            });

            filterSchoolList(); // Apply current filters and search to set display styles and checkbox states
        }

        function updateCurrentSelectionHighlight() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const allEntryListItems = Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)'));

            allEntryListItems.forEach(item => {
                item.classList.remove('current-selection-highlight');
                item.classList.remove('list-item-highlight'); 
            });

            const visibleListItems = getVisibleListItemsDOM();

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const selectedLi = visibleListItems[currentListSelectionIndex];
                if (selectedLi) { 
                    selectedLi.classList.add('current-selection-highlight');
                }
            }
        }

        function navigateList(direction) {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const visibleListItems = getVisibleListItemsDOM();

            if (visibleListItems.length === 0) {
                if (activeHoverMarkerIndex !== null && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                }
                activeHoverMarkerIndex = null;
                currentListSelectionIndex = -1;
                updateCurrentSelectionHighlight();
                return;
            }

            let newVisibleIndex = currentListSelectionIndex;

            if (newVisibleIndex === -1) {
                newVisibleIndex = (direction === 'down') ? 0 : visibleListItems.length - 1;
            } else {
                if (direction === 'down') {
                    newVisibleIndex = (newVisibleIndex + 1) % visibleListItems.length;
                } else if (direction === 'up') {
                    newVisibleIndex = (newVisibleIndex - 1 + visibleListItems.length) % visibleListItems.length;
                }
            }

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const previouslySelectedLi = visibleListItems[currentListSelectionIndex];
                if (previouslySelectedLi) {
                    const prevOriginalIndex = parseInt(previouslySelectedLi.dataset.originalIndex);
                    const newOriginalIndexIfKnown = visibleListItems[newVisibleIndex] ? parseInt(visibleListItems[newVisibleIndex].dataset.originalIndex) : -1;

                    if (!isNaN(prevOriginalIndex) && allMarkers[prevOriginalIndex]?.marker && allData[prevOriginalIndex]) {
                         if(prevOriginalIndex !== newOriginalIndexIfKnown && prevOriginalIndex !== activeHoverMarkerIndex) {
                            allMarkers[prevOriginalIndex].marker.setIcon(getMarkerIcon(allData[prevOriginalIndex], false, isDarkMode));
                            allMarkers[prevOriginalIndex].marker.setZIndex(null);
                         }
                    }
                }
            }

            currentListSelectionIndex = newVisibleIndex;
            const selectedLi = visibleListItems[currentListSelectionIndex];

            if (selectedLi) {
                const originalIndexOfNewSelection = parseInt(selectedLi.dataset.originalIndex);
                if (!isNaN(originalIndexOfNewSelection) && allData[originalIndexOfNewSelection]) {
                    handleListItemInteraction({ currentTarget: selectedLi, target: selectedLi, ctrlKey: false, metaKey: false }, originalIndexOfNewSelection, false);
                    selectedLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    selectedLi.focus();

                    if (allMarkers[originalIndexOfNewSelection]?.marker) {
                        allMarkers[originalIndexOfNewSelection].marker.setIcon(getMarkerIcon(allData[originalIndexOfNewSelection], true, isDarkMode));
                        allMarkers[originalIndexOfNewSelection].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                        if(activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== originalIndexOfNewSelection && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                             allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                             allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                        }
                        activeHoverMarkerIndex = originalIndexOfNewSelection;
                    }
                }
            }
            updateCurrentSelectionHighlight();
        }


        function initMap() {
            console.log("[DEBUG] initMap function called.");

            if (!window.isDataReadyForMap || !allData || !Array.isArray(allData)) {
                console.error("[DEBUG] initMap: Data is not ready or allData is invalid. Aborting map initialization.");
                const mapDiv = document.getElementById("map");
                if (mapDiv) {
                    mapDiv.innerHTML = `<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;"><strong>Error: Map data is not available or is invalid.</strong><br>The map cannot be initialized. This usually indicates a problem during the initial data loading and processing phase.<br>Please check the browser's developer console for more detailed error messages that might have occurred before this point.</p>`;
                }
                const controlsContainer = document.getElementById('controls-and-list-container');
                if (controlsContainer) {
                    controlsContainer.style.opacity = '0.5';
                    controlsContainer.style.pointerEvents = 'none';
                }
                return;
            }
            console.log(`[DEBUG] initMap: Data is ready. Proceeding with allData containing ${allData.length} items.`);

            baseMarkerIcon = { path: google.maps.SymbolPath.CIRCLE, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            highlightedMarkerIcon = { ...baseMarkerIcon, scale: 10, strokeWeight: 2.0 };

            seniorPhotoPopup = document.getElementById('senior-photo-popup');
            if (!seniorPhotoPopup) {
                console.error("[DEBUG] CRITICAL: senior-photo-popup element not found in the DOM!");
                document.getElementById('map').innerHTML = '<p style="color:red; text-align:center;">Error: UI element (senior-photo-popup) missing. Cannot initialize map features.</p>';
                return;
            }

            seniorPopupImage = seniorPhotoPopup.querySelector('img');
            seniorPopupCaption = document.getElementById('senior-photo-caption');
            closeSeniorPhotoBtn = document.getElementById('close-senior-photo-popup');
            zoomExitNote = document.getElementById('zoom-exit-note');
            prevSeniorPhotoBtn = document.getElementById('prev-senior-photo');
            nextSeniorPhotoBtn = document.getElementById('next-senior-photo');


            if (!seniorPopupImage) console.error("[DEBUG] CRITICAL: senior-photo-popup img element not found!");
            if (!seniorPopupCaption) console.error("[DEBUG] CRITICAL: senior-photo-caption element not found!");
            if (!closeSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: close-senior-photo-popup element not found!");
            if (!zoomExitNote) console.error("[DEBUG] CRITICAL: zoom-exit-note element not found!");
            if (!prevSeniorPhotoBtn || !nextSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: Photo navigation arrow buttons not found!");


            photoZoomOverlay = document.createElement('div');
            photoZoomOverlay.id = 'photo-zoom-overlay';
            document.body.appendChild(photoZoomOverlay);

            if (closeSeniorPhotoBtn) closeSeniorPhotoBtn.addEventListener('click', () => exitZoomMode(true));
            if (photoZoomOverlay) photoZoomOverlay.addEventListener('click', () => exitZoomMode(true));
            if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('prev'));
            if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('next'));


            if(zoomExitNote){
                const zoomExitNoteDismissButton = zoomExitNote.querySelector('.dismiss-button');
                if (zoomExitNoteDismissButton) {
                    zoomExitNoteDismissButton.removeAttribute('onclick');
                    zoomExitNoteDismissButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        this.parentElement.style.display = 'none';
                    });
                }
            }

            if (seniorPopupImage) {
                seniorPopupImage.addEventListener('click', function(e) {
                    if (e.target === seniorPopupImage && !this.classList.contains('zoomed')) {
                        const parentPopup = this.closest('#senior-photo-popup');
                        parentPopup.classList.add('zoomed-state'); // Add class to parent

                        this.classList.add('zoomed');
                        if (photoZoomOverlay) photoZoomOverlay.style.display = 'block';
                        if (zoomExitNote) zoomExitNote.style.display = 'block';
                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'block';
                        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'block';


                        parentPopup.dataset.originalTransform = getComputedStyle(parentPopup).transform;
                        parentPopup.dataset.originalLeft = parentPopup.style.left;
                        parentPopup.dataset.originalTop = parentPopup.style.top;
                        parentPopup.dataset.originalWidth = parentPopup.style.width;
                        parentPopup.dataset.originalHeight = parentPopup.style.height;
                        parentPopup.dataset.originalBg = parentPopup.style.backgroundColor;
                        parentPopup.dataset.originalBorder = getComputedStyle(parentPopup).border;
                        parentPopup.dataset.originalBoxShadow = getComputedStyle(parentPopup).boxShadow;
                        parentPopup.dataset.originalPadding = getComputedStyle(parentPopup).padding;
                        parentPopup.dataset.originalPointerEvents = getComputedStyle(parentPopup).pointerEvents || 'auto';

                        parentPopup.style.transform = 'none';
                        parentPopup.style.left = '0px'; parentPopup.style.top = '0px';
                        parentPopup.style.width = '100vw'; parentPopup.style.height = '100vh';
                        parentPopup.style.padding = '0';
                        parentPopup.style.backgroundColor = 'transparent';
                        parentPopup.style.border = 'none'; parentPopup.style.boxShadow = 'none';
                        parentPopup.style.pointerEvents = 'none';

                        this.style.pointerEvents = 'auto';
                        if(seniorPopupCaption) seniorPopupCaption.style.pointerEvents = 'auto';
                        if(closeSeniorPhotoBtn) closeSeniorPhotoBtn.style.pointerEvents = 'auto';

                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.pointerEvents = 'auto';
if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.pointerEvents = 'auto';
                    }
                });
            }

            sortAndRebuildList(currentSortOption);

            gradClassFilterState = {};
            gradClassNames.forEach(gc => gradClassFilterState[gc] = true);

            const locationFocusKeys = ["InCityNYC", "InStateNYOther", "OutOfStateUS", "International", "N/A"]; 
            locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);

            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);


            const mapOptions = {
                center: { lat: 41.8, lng: -74.5 }, zoom: 7,
                mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
                styles: null,
                fullscreenControl: true, streetViewControl: true, zoomControl: true, mapTypeControl: true,
                gestureHandling: 'greedy'
            };
            map = new google.maps.Map(document.getElementById("map"), mapOptions);
            infowindow = new google.maps.InfoWindow();
            schoolsSelectedForZoom = new Set();
            transitLayer = new google.maps.TransitLayer();

            const locationFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            locationFocusCheckboxes.forEach(checkbox => {
                const focusKey = checkbox.dataset.locationFocus;
                checkbox.checked = locationFocusFilterState[focusKey];
                checkbox.addEventListener('change', (event) => {
                    locationFocusFilterState[focusKey] = event.target.checked;
                    updateCheckAllLocationFocusButtonState();
                    updateMarkersVisibility();
                });
            });

            const checkAllLocationFocusBtn = document.getElementById('checkAllLocationFocusBtn');
            checkAllLocationFocusBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                locationFocusCheckboxes.forEach(cb => {
                    const focusKey = cb.dataset.locationFocus;
                    locationFocusFilterState[focusKey] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });
            updateCheckAllLocationFocusButtonState(); 


            const gradClassFiltersContainer = document.getElementById('grad-class-filters-container');
            const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const schoolSearchInput = document.getElementById('schoolSearchInput');
            const listHeaderContainer = document.querySelector('#school-list-control .list-header-container');
            const toggleSchoolListBtn = document.getElementById('toggleSchoolListBtn');
            const toggleSatelliteViewBtn = document.getElementById('toggleSatelliteViewBtn');
            const toggleTransitBtn = document.getElementById('toggleTransitBtn');
            const checkAllGradClassesBtn = document.getElementById('checkAllGradClassesBtn');
            const uncheckAllGradClassesBtn = document.getElementById('uncheckAllGradClassesBtn');
            const zoomToVisibleBtn = document.getElementById('zoomToVisibleBtn');
            const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
            const toggleGalleryViewBtn = document.getElementById('toggleGalleryViewBtn');

            gradClassFiltersContainer.innerHTML = '';
            const fragmentGradClassFilters = document.createDocumentFragment();
            gradClassNames.sort().forEach(gcName => {
                const filterId = `filter-grad-${gcName.replace(/\W+/g, '-')}`;
                const itemDiv = document.createElement('div'); itemDiv.className = 'filter-item';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = filterId; checkbox.value = gcName;
                checkbox.checked = gradClassFilterState[gcName];
                checkbox.addEventListener('change', (event) => { gradClassFilterState[gcName] = event.target.checked; updateMarkersVisibility(); });
                const label = document.createElement('label'); label.htmlFor = filterId;
                const colorBox = document.createElement('span'); colorBox.className = 'filter-color-box'; colorBox.style.backgroundColor = gradClassColors[gcName] || '#cccccc';
                label.appendChild(colorBox);
                const seniorCountForClass = allData.filter(s => s.gradClass === gcName).length;
                label.appendChild(document.createTextNode(` ${gcName} (${seniorCountForClass})`));
                itemDiv.appendChild(checkbox); itemDiv.appendChild(label); fragmentGradClassFilters.appendChild(itemDiv);
            });
            gradClassFiltersContainer.appendChild(fragmentGradClassFilters);

            if (listHeaderContainer && !document.getElementById('schoolListTip')) {
                 const tipDiv = document.createElement('div'); tipDiv.id = 'schoolListTip'; tipDiv.className = 'tip-message';
                 const tipText = document.createElement('span');
                tipText.innerHTML = 'Tips: <br>• Filters update Stats & Major tables.<br>• Checkboxes toggle visibility.<br>• <b>Shift + Click checkbox</b>: Group Zoom.<br>• <b>CTRL/CMD + Click name</b>: College Homepage.<br>• Hover list/marker to highlight & see photo.<br>• Click senior photo to zoom (Esc to close).<br>• Use ↑↓ keys to navigate list; ← → in zoomed photo.<br>• Left panel is resizable.';
                 const dismissBtn = document.createElement('span'); dismissBtn.className = 'dismiss-button'; dismissBtn.textContent = 'x'; dismissBtn.title = 'Dismiss this tip';
                 dismissBtn.onclick = () => { tipDiv.style.display = 'none'; };
                 tipDiv.appendChild(tipText); tipDiv.appendChild(dismissBtn);
                 listHeaderContainer.insertAdjacentElement('afterend', tipDiv);
            }

            toggleSchoolListBtn.addEventListener('click', () => {
                const listContent = document.querySelector('.school-list-collapsible-content');
                const isHidden = listContent.classList.toggle('hidden');
                toggleSchoolListBtn.textContent = isHidden ? 'Show List' : 'Hide List';
                toggleSchoolListBtn.title = isHidden ? 'Show college and senior list' : 'Hide college and senior list';
            });

            toggleTransitBtn.addEventListener('click', () => {
                if (transitLayerEnabled) {
                    transitLayer.setMap(null); toggleTransitBtn.textContent = '🚇 Show Transit'; toggleTransitBtn.title = 'Show Transit Layer';
                } else {
                    transitLayer.setMap(map); toggleTransitBtn.textContent = '🚇 Hide Transit'; toggleTransitBtn.title = 'Hide Transit Layer';
                }
                transitLayerEnabled = !transitLayerEnabled;
            });

            zoomToVisibleBtn.addEventListener('click', zoomToAllVisibleMarkers);

            clearAllFiltersBtn.addEventListener('click', () => {
                gradClassNames.forEach(gc => gradClassFilterState[gc] = true);
                gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = true);

                locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);
                document.querySelectorAll('.location-focus-filter').forEach(cb => cb.checked = true);
                updateCheckAllLocationFocusButtonState();

                PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);
                Object.keys(majorAreaFilterState).forEach(area => majorAreaFilterState[area] = true);
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCheckAllMajorAreasButtonState();

                schoolSearchInput.value = '';
                updateMarkersVisibility();
            });

            toggleGalleryViewBtn.addEventListener('click', () => {
                isGalleryViewEnabled = !isGalleryViewEnabled;
                const listContentDiv = document.querySelector('#school-list-control .list-content'); 
                if (listContentDiv) listContentDiv.classList.toggle('gallery-view', isGalleryViewEnabled);
                toggleGalleryViewBtn.textContent = isGalleryViewEnabled ? '🖼️ List View' : '🖼️ Gallery View';
                toggleGalleryViewBtn.title = isGalleryViewEnabled ? 'Switch to List View' : 'Switch to Gallery View';
                rebuildSchoolListHTML(); 
            });

            if (toggleSatelliteViewBtn) { // <--- START ADDING HERE
    toggleSatelliteViewBtn.addEventListener('click', () => {
        if (!map) return;
        isSatelliteViewEnabled = !isSatelliteViewEnabled;
        if (isSatelliteViewEnabled) {
            map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
            toggleSatelliteViewBtn.textContent = '🗺️ Roadmap View';
            toggleSatelliteViewBtn.title = 'Switch to Roadmap View';
        } else {
            map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
            toggleSatelliteViewBtn.textContent = '🛰️ Satellite View';
            toggleSatelliteViewBtn.title = 'Switch to Satellite View';
        }
    });
}

            const checkAllMajorAreasBtn = document.getElementById('checkAllMajorAreasBtn');
            checkAllMajorAreasBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => {
                    const area = cb.dataset.majorArea;
                    majorAreaFilterState[area] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });


            let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
            if (!schoolListUl) {
                schoolListUl = document.createElement('ul');
                schoolListCollapsibleContentDiv.insertBefore(schoolListUl, document.getElementById('no-results-message'));
            }
            schoolListUl.setAttribute('tabindex', '-1');


            const sortOptionsSelect = document.getElementById('sortOptions');
            sortOptionsSelect.addEventListener('change', (event) => {
                sortAndRebuildList(event.target.value);
            });

            allMarkers = new Array(allData.length).fill(null);
            allData.forEach((seniorChoice) => {
                 const index = seniorChoice.originalIndex;
                 const markerInitialIcon = getMarkerIcon(seniorChoice, false, isDarkMode);
                 const marker = new google.maps.Marker({
                     position: { lat: seniorChoice.lat, lng: seniorChoice.lng },
                     map: map,
                     title: `${seniorChoice.seniorName} (${seniorChoice.gradClass}) → ${seniorChoice.collegeName} (${seniorChoice.major || 'Undecided Major'})`,
                     icon: markerInitialIcon,
                     visible: seniorChoice.isVisible 
                 });
                 allMarkers[index] = { marker: marker, school: seniorChoice };

                 marker.addListener("click", () => {
                     const schoolData = allData[index];
                     if (!schoolData.isVisible) return;

                     if (infowindow && infowindow.getMap()) { infowindow.close(); }

                     let contentString = `<div class="info-window-content">`;
                     const targetUrl = schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#' ? schoolData.collegeHomepageUrl : '#';
                     const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                     if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                         contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${schoolData.collegeImageUrl}" alt="${schoolData.collegeName} logo/photo"></a>`;
                     }
                     contentString += `<b>${schoolData.seniorName}</b>`;
                     contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[schoolData.gradClass] || '#ccc'};">Class: ${schoolData.gradClass}</span>`;

                     const suffixHtml = getHonorarySuffixHTML(schoolData.collegeNameRaw);
                     if (targetUrl !== '#') {
                        contentString += `<br>Attending: <a href="${targetUrl}" ${openInNewTab}>${schoolData.collegeName}</a>${suffixHtml}`;
                     } else {
                        contentString += `<br>Attending: ${schoolData.collegeName}${suffixHtml}`;
                     }
                     contentString += `<br>Major: ${schoolData.major || 'Undecided Major'} (${schoolData.majorArea || 'N/A'})`;
                     contentString += `<br><span class="info-window-type">Type: ${schoolData.collegeType} (${schoolData.isCampusPublic ? 'Public' : 'Private'}, ${schoolData.locationFocus})</span>`;
                     if (schoolData.lat !== 0 || schoolData.lng !== 0) {
                        contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${schoolData.lat},${schoolData.lng}" target="_blank">Get Directions</a>`;
                     }
                     contentString += `</div>`;
                     infowindow.setContent(contentString);
                     infowindow.open({ map: map, anchor: marker });

                     const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                     showSeniorPhotoPopup(listItem, schoolData);

                     const clickedOriginalIndex = index;
                     const listUl = document.querySelector('#school-list-control .list-content ul');
                     const visibleListItems = getVisibleListItemsDOM();
                     currentListSelectionIndex = visibleListItems.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                    marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                    activeHoverMarkerIndex = clickedOriginalIndex;

                    updateCurrentSelectionHighlight();
                 });

                 marker.addListener('mouseover', () => {
                     const schoolData = allData[index];
                     if (schoolData.isVisible) {
                        document.getElementById('searchSuggestions').style.display = 'none';
                        const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                        if (listItem) {
                            listItem.classList.add('list-item-highlight');
                            showSeniorPhotoPopup(listItem, schoolData);
                        } else {
                             showSeniorPhotoPopup(null, schoolData);
                        }
                        marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                        marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                     }
                 });
                 marker.addListener('mouseout', () => {
                    const schoolData = allData[index];
                    const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                    if (listItem) {
                         listItem.classList.remove('list-item-highlight');
                    }
                    if (activeHoverMarkerIndex !== index) { 
                         marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                         marker.setZIndex(null);
                    }
                 });
            });

            darkModeToggle.addEventListener('click', () => {
                 isDarkMode = !isDarkMode; document.body.classList.toggle('dark-mode', isDarkMode);
                 map.setOptions({ styles: isDarkMode ? darkMapStyle : null });
                 allMarkers.forEach((mInfo, idx) => {
                     if (mInfo && mInfo.marker && mInfo.school) {
                         const currentSchoolData = allData[idx];
                         const isHighlighted = activeHoverMarkerIndex === idx;
                         mInfo.marker.setIcon(getMarkerIcon(currentSchoolData, isHighlighted, isDarkMode));
                     }
                 });
                 darkModeToggle.textContent = isDarkMode ? '☀️ Light Mode' : '🌙 Dark Mode';
                 darkModeToggle.title = isDarkMode ? 'Light Mode' : 'Dark Mode';
            });

            const debouncedSearch = debounce(handleSearchInput, 250);
            schoolSearchInput.addEventListener('input', debouncedSearch);
            document.addEventListener('click', (event) => {
                 const searchContainer = document.getElementById('schoolSearchContainer');
                 const suggestionsDiv = document.getElementById('searchSuggestions');
                 if (searchContainer && suggestionsDiv &&
                     !searchContainer.contains(event.target) &&
                     !suggestionsDiv.contains(event.target)) {
                     suggestionsDiv.style.display = 'none';
                 }
            });

            checkAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = true; cb.checked = true; });
                 updateMarkersVisibility();
            });
            uncheckAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = false; cb.checked = false; });
                 updateMarkersVisibility();
            });

            const resizer = document.getElementById('panel-resizer');
            const leftPanel = document.getElementById('controls-and-list-container');
            const mapPanel = document.getElementById('map');
            let startX = 0; let startWidth = 0;
            const savedWidth = localStorage.getItem('leftPanelWidth');
            if (savedWidth) leftPanel.style.width = savedWidth; else leftPanel.style.width = '30%';

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault(); startX = e.clientX; startWidth = parseInt(document.defaultView.getComputedStyle(leftPanel).width, 10);
                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
                document.body.style.userSelect = 'none'; document.body.style.pointerEvents = 'none'; mapPanel.style.pointerEvents = 'none';
            });
            function doDrag(e) {
                let newWidth = startWidth + e.clientX - startX;
                const containerWidth = document.getElementById('map-container').offsetWidth;
                const minWidth = 250; const maxWidthPercentage = 0.60;
                newWidth = Math.max(minWidth, newWidth); newWidth = Math.min(newWidth, containerWidth * maxWidthPercentage);
                leftPanel.style.width = newWidth + 'px';
            }
            function stopDrag() {
                document.documentElement.removeEventListener('mousemove', doDrag, false);
                document.documentElement.removeEventListener('mouseup', stopDrag, false);
                localStorage.setItem('leftPanelWidth', leftPanel.style.width);
                document.body.style.userSelect = ''; document.body.style.pointerEvents = ''; mapPanel.style.pointerEvents = '';
                if (map && google && google.maps && google.maps.event) {
                    google.maps.event.trigger(map, 'resize');
                }
            }

            document.addEventListener('keydown', (event) => {
                if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                    if (event.key === 'ArrowLeft') {
                        navigateToSeniorPhoto('prev');
                        event.preventDefault();
                    } else if (event.key === 'ArrowRight') {
                        navigateToSeniorPhoto('next');
                        event.preventDefault();
                    } else if (event.key === 'Escape') {
                         exitZoomMode(true);
                         event.preventDefault();
                    }
                } else if (event.key === 'Escape') {
                    if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                        hideSeniorPhotoPopup();
                    } else if (infowindow && infowindow.getMap()) {
                        infowindow.close();
                    }
                    event.preventDefault();
                } else if (event.key === 'ArrowDown') {
                    if (document.activeElement !== schoolSearchInput && ! (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) ) { 
                        navigateList('down');
                        event.preventDefault();
                    }
                } else if (event.key === 'ArrowUp') {
                     if (document.activeElement !== schoolSearchInput && ! (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) ) {
                        navigateList('up');
                        event.preventDefault();
                    }
                }
            });


            rebuildSchoolListHTML(); // Initial build based on default sort
            updateMarkersVisibility(); // Then apply filters to set initial visibility and update dependent UI
            // updateStatsTable(); // Called by updateMarkersVisibility
            // updateMajorSummaryTable(); // Called by updateMarkersVisibility
        }

        function updateCheckAllLocationFocusButtonState() {
            const checkAllBtn = document.getElementById('checkAllLocationFocusBtn');
            if (!checkAllBtn) return;
            const allFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            if (allFocusCheckboxes.length === 0) {
                 checkAllBtn.checked = true;
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allFocusCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allFocusCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }


        function gmLoadError() {
            console.error("Google Maps failed to load.");
            document.getElementById('map').innerHTML = '<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;">Error: Could not load Google Maps. Please check your API key and ensure the Maps JavaScript API is enabled.</p>';
            const controlsContainer = document.getElementById('controls-and-list-container');
            if (controlsContainer) {
                controlsContainer.style.opacity = '0.5';
                controlsContainer.style.pointerEvents = 'none';
            }
            window.isDataReadyForMap = false;
        }
    </script>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVEZB2WjUpEhqnqGjY_zMCQSKUHTdjAWc&callback=initMap&onerror=gmLoadError&v=weekly"
        async
        defer
    ></script> <!-- IMPORTANT: Replace YOUR_GOOGLE_MAPS_API_KEY with your actual Google Maps API key -->
</body>
</html>


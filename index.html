<!DOCTYPE html>
<html lang="en">

    <script src="collegeCoordsAndInfo.js"></script>
    <script src="majorToAreaMapping.js"></script>
    <script src="normalizeCollegeName.js"></script>
     <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<head>
    <link rel="icon" href="photos/favicon/favicon.jpg" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEST+m Senior College Destinations Map 🦅</title>
    <style>

body .panel-desktop-hidden ~ .hamburger {
  left: .75rem;
}

.list-content li .social-icon-link svg,
.info-window-content .social-icon-link svg {
    width: 16px; 
    height: 16px;
    vertical-align: middle;
    margin-left: 4px;
}
.list-content li .social-icon-link {
    text-decoration: none; 
}

#zoomed-grad-class-info {
    padding: 8px 12px;
    margin-bottom: 12px; 
    border-radius: 5px;
    text-align: center;
    font-size: 1.05em;
    border: 1px solid #ddd; 
    background-color: #111; 
    transition: background-color 0.3s, border-color 0.3s;
}

#zoomed-grad-class-info .grad-class-label {
    font-weight: bold;
    color: #f0f0f0; 
    margin-right: 6px;
    transition: color 0.3s;
}

#zoomed-grad-class-info #zoomed-grad-class-value {
    font-weight: bold;

}

body.dark-mode #zoomed-grad-class-info {
    background-color: #f8f9fa; 
    border-color: #555;
}

body.dark-mode #zoomed-grad-class-info .grad-class-label {
    color: #222; 
}

#zoomed-info-panel {
    position: fixed;
    right: 100px; 
    top: 50%;
    transform: translateY(-50%);
    width: 500px; 
    max-height: 80vh;
    overflow-y: auto;
    background-color: rgba(255, 255, 255, 0.92);
    color: #333;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 2020;
    font-size: 0.9em;
    line-height: 1.5;
    border: 1px solid #ccc;
    transition: background-color 0.3s, color 0.3s, border-color 0.3s, right .25s ease, width .25s ease; 
}
#zoomed-bio-caption-content {
    margin-top: 0;
    margin-bottom: 12px;
    white-space: pre-wrap; 
}

#zoomed-social-links-container a {
    margin-right: 10px; 
    text-decoration: none;
    display: inline-block; 
}
#zoomed-social-links-container svg {
    width: 28px; 
    height: 28px;
    vertical-align: middle;
}

body.dark-mode #zoomed-info-panel {
    background-color: rgba(40, 40, 40, 0.95); 
    color: #e0e0e0;
    border-color: #555;
}

#senior-photo-popup.zoomed-state.with-side-panel p#senior-photo-caption {
    display: none !important;
}

   #credits {
        text-align: center;
        font-size: 0.8em;
        padding: 6px 15px;
        margin-top: -10px; 
        margin-bottom: 10px; 
        border-top: 1px solid #eee;
        position: relative;
        background-color: #f8f9fa; 
        color: #555; 
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    #credits a {
        text-decoration: none;
        vertical-align: middle;
        color: #007bff; 
        font-weight: bold;
        transition: color 0.3s;
    }
    #credits a:hover {
        text-decoration: underline;
    }
    #credits svg {
        vertical-align: middle;
        fill: currentColor; 
        margin-right: 3px;
    }
    body.dark-mode #credits {
        background-color: #1a1a1a;
        color: #bbb;
        border-top-color: #444;
    }
    body.dark-mode #credits a {
        color: #007bff; 
        font-weight: bold;
    }

    .grad-class-separator {
        height: 1px;
        background-color: #ccc;
        margin: 10px 5px;
        list-style-type: none;
        padding: 0;
    }
    body.dark-mode .grad-class-separator {
        background-color: #444;
    }
    .list-content.gallery-view .grad-class-separator {
        flex-basis: 100% !important; width: 100% !important; height: 1px !important;
        background-color: #ccc; margin: 15px 0 !important; padding: 0 !important;
        border: none !important; list-style-type: none !important; box-sizing: border-box !important;
        display: block !important; min-width: 0 !important; text-align: left !important;
        align-items: stretch !important;
    }
    body.dark-mode .list-content.gallery-view .grad-class-separator {
        background-color: #444 !important;
    }

    .honorary-suffix {
        font-weight: bold; font-style: normal; padding: 1px 4px; border-radius: 3px;
        background-color: rgba(0, 0, 0, 0.05); color: #333; margin-left: 4px;
        font-size: 0.9em; border: 1px solid rgba(0,0,0,0.1);
    }
    body.dark-mode .honorary-suffix {
        background-color: rgba(255, 255, 255, 0.1); color: #ddd;
        border-color: rgba(255,255,255,0.2);
    }

    html, body {
    height: 100%; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
    background-color: #f8f9fa; color: #212529;
    transition: background-color 0.3s, color 0.3s; overflow: hidden;
    font-size: 17px; 
}

input, button, select, textarea {
    font-family: inherit; 
    font-size: inherit; 
}

    #map-container {
        display: flex; height: 100%; width: 100%;
        position: relative; 
    }

    #controls-and-list-container {
    width: 30%;
    min-width: 320px; 
    max-width: 60%;
    height: 100%;
    background-color: #f8f9fa;
    border-right: 1px solid #ccc;
    overflow-y: auto;
    padding: 15px; 
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    position: relative;
    transform: translateX(0);
    transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s;
    z-index: 500;
    font-size: 1rem; 
    line-height: 1.7;   
}

    #controls-and-list-container.panel-desktop-hidden{
    transform: translateX(-100%);
    position: absolute;   
    left: 0;              
    top: 0;
    height: 100%;
}

    #panel-resizer {
        width: 14px;
        height: 100%;
        background-color: #ddd;
        cursor: col-resize;
        z-index: 501; 
        display: flex; 
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s, display 0s; 
    }
    #panel-resizer::before {
        content: ""; display: block; width: 4px; height: 35px;
        background-image: repeating-linear-gradient(to bottom, #777, #777 3px, transparent 3px, transparent 7px);
        opacity: 0.5; transition: opacity 0.3s;
    }
    #panel-resizer:hover { background-color: #bbb; }

    #panel-resizer.resizer-desktop-hidden {
        display: none;
    }

    #map {
        flex-grow: 1; 
        height: 100%;
        background-color: grey;
        position: relative;
    }

      .hamburger{
    position: absolute;
    top: .75rem;
    left: .75rem;           
    right: auto;
    width: 44px;
    height: 44px;
    font-size: 1.8rem;
    background: rgba(255,255,255,.85);
    border: 1px solid rgba(0,0,0,.15);
    border-radius: 8px;
    line-height: 1;
    z-index: 1100;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    transition: background-color .3s, border-color .3s, color .3s, left .3s ease-out;

}

body:not(.panel-desktop-hidden) .hamburger {
  left: .75rem !important;
  right: auto !important;   
}

    .info-window-content { line-height: 1.4; max-width: 250px; }
    .info-window-content b { font-size: 1.1em; display: block; margin-bottom: 4px; }
    .info-window-content img { max-width: 100%; height: auto; display: block; margin-bottom: 8px; border-radius: 4px; border: none; }
    .info-window-content a { color: inherit; text-decoration: none; }
    .info-window-content a:hover { text-decoration: underline; cursor: pointer; }
    .info-window-type { color: #555; font-style: italic; }
    .info-window-grad-class { font-weight: bold; }

    .map-control {
    background-color: rgba(255, 255, 255, 0.9);
    padding: 15px 20px; 
    margin-bottom: 18px; 
    border: 1px solid #bbb;
    border-radius: 4px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    color: #222;
    box-sizing: border-box;
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    flex-shrink: 0;

}
    .map-control h4 {
    margin-top: 0;
    margin-bottom: 12px; 
    padding-bottom: 8px;  
    border-bottom: 1px solid #eee;
    font-size: 1.15em;   
    font-weight: bold;
    transition: border-color 0.3s;
    display: inline-block;
    margin-right: 10px;
    cursor: pointer;
}
    .map-control h4::after { content: " [-]"; font-weight: normal; font-size: 0.9em; }
    .map-control h4.collapsed::after { content: " [+]"; }
    .map-control .control-content { display: block; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 2000px; opacity: 1; overflow: hidden; }
    .map-control .control-content.collapsed { max-height: 0; opacity: 0; margin-top:0; margin-bottom:0; padding-top:0; padding-bottom:0; border-top: none; }

    .tip-message { background-color: #eef5ff; border: 1px solid #b8d4ff; color: #31708f; padding: 8px 10px; margin-top: 8px; margin-bottom: 12px; border-radius: 4px; font-size: 0.85em; line-height: 1.4; position: relative; overflow: hidden; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    .dismiss-button { float: right; cursor: pointer; font-weight: bold; margin-left: 10px; padding: 0 5px; color: #a1a1a1; border-radius: 3px; line-height: 1.4; user-select: none; transition: color 0.2s, background-color 0.2s; }
    .dismiss-button:hover { color: #333; background-color: #e0e0e0; }

    #description-control {
    font-size: 1.0em;
    cursor: default;
    overflow: hidden; 
    padding: 10px 15px;
    text-align: center;
    background-color: purple;
    color: white;
    position: relative; 
}
    #description-control span { display: inline-block; line-height: 28px; vertical-align: middle; }

    #map-options-control { margin-bottom:10px; display: flex; justify-content: space-evenly; align-items: center; flex-wrap: wrap; }
    .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn, #showFaqBtn, #toggleNestmBtn, #zoomToNestmBtn {
        font-size: 0.85em; padding: 5px 10px; margin: 5px; border: 1px solid #bbb; border-radius: 4px;
        background-color: rgba(245, 245, 245, 0.9); color: #222; cursor: pointer; user-select: none;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s; line-height: 1.5; flex-basis: auto; text-align: center;
        display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;
    }
        .dark-mode-toggle-control:hover, #toggleTransitBtn:hover, #toggleSatelliteViewBtn:hover, #zoomToVisibleBtn:hover, #clearAllFiltersBtn:hover, #toggleGalleryViewBtn:hover, #showFaqBtn:hover, #toggleNestmBtn:hover, #zoomToNestmBtn:hover {
        background-color: rgba(230, 230, 230, 0.95);
    }

    #filter-control { font-size: 0.9em; }
    #filter-control .filter-header {
    margin-top: 0;
    margin-bottom: 10px; 
    font-size: 1.1em;    
    font-weight: bold;
    padding-bottom: 6px; 
    border-bottom: 1px solid #ddd;
}
   .filter-item {
    display: block;
    margin-bottom: 10px; 
    cursor: pointer;
}

.filter-item label {
    margin-left: 8px; 
    vertical-align: middle;
    cursor: pointer;

}
    .filter-item input[type="checkbox"] { vertical-align: middle; cursor: pointer; }
    .filter-color-box { width: 12px; height: 12px; border: 1px solid #ccc; margin-right: 5px; display: inline-block; vertical-align: middle; transition: border-color 0.3s; }
    .filter-control-buttons { display: inline-block; vertical-align: middle; margin-bottom: 8px; margin-left: 5px; }
    .filter-control-buttons button { font-size: 0.8em; padding: 2px 6px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; }
    .filter-control-buttons button:hover { background-color: #e0e0e0; }

    #instagram-links-control { display: flex; justify-content: space-around; align-items: center; padding-top: 10px; margin-bottom: 8px; }
    .instagram-link-button { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: inherit; font-size: 0.8em; }
    .instagram-link-button svg.instagram-logo { width: 28px; height: 28px; margin-bottom: 3px; fill: #C13584; }
    body.dark-mode .instagram-link-button svg.instagram-logo { fill: #E1306C; }
    .instagram-link-button span { font-weight: bold; }

    #stats-table-control { font-size: 0.9em; margin-top: 10px; }
    #stats-table-control h4 { margin-bottom: 8px; }
    #stats-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    #stats-table th, #stats-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: center; font-size: 0.9em; }
    #stats-table th { background-color: #f0f0f0; font-weight: bold; }
    #stats-table td.row-header { text-align: left; font-weight: bold; background-color: #f9f9f9;}

    #major-summary-control { font-size: 0.9em; margin-top: 10px; }
    #major-summary-control h4 { margin-bottom: 8px; }
    #major-summary-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
    #major-summary-table th, #major-summary-table td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 0.9em; }
    #major-summary-table th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
    #major-summary-table td:last-child { text-align: center; }
    #major-summary-table td:nth-last-child(2) { text-align: center; }

    #school-list-control { font-size: 0.9em; flex-grow: 1;  display: flex; flex-direction: column; overflow: hidden;  }
    .list-header-container { overflow: visible;  margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; transition: border-color 0.3s; flex-shrink: 0;  }
    .list-header-container h4 { float: left; margin-bottom: 0; border-bottom: none; padding-bottom: 0; line-height: 26px; }
    #toggleSchoolListBtn { float: right; font-size: 0.8em; padding: 3px 8px; margin-left: 5px; cursor: pointer; border: 1px solid #bbb; border-radius: 3px; background-color: #f0f0f0; transition: background-color 0.2s; line-height: normal; vertical-align: middle; }
    #toggleSchoolListBtn:hover { background-color: #e0e0e0; }
    #schoolSearchContainer { float: right; width: 45%; position: relative;  }
    #schoolSearchInput { width: 100%; padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; box-sizing: border-box; }
    #searchSuggestions { position: absolute; top: 100%;  left: 0; right: 0; background-color: white; border: 1px solid #ccc; border-top: none; border-radius: 0 0 3px 3px; max-height: 150px;  overflow-y: auto; z-index: 1000;  box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;  }
    #searchSuggestions div { padding: 5px 8px; font-size: 0.9em; cursor: pointer; }
    #searchSuggestions div:hover { background-color: #eee; }

   #sort-controls-container,
.list-content {
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out, padding 0.3s ease-out;
    max-height: 2000px; 
    opacity: 1;
    overflow: hidden;
}

#sort-controls-container.collapsed,
.list-content.collapsed {
    max-height: 0 !important;
    opacity: 0 !important;
    margin-top:0 !important;
    margin-bottom:0 !important;
    padding-top:0 !important;
    padding-bottom:0 !important;
    border-top: none !important;
    overflow: hidden !important;
}

    body.dark-mode #sort-controls-container { border-bottom-color: #444; }
    body.dark-mode #sort-controls-container select { background-color: #333; border-color: #555; color: #e0e0e0; }
    #sort-controls-container optgroup { font-style: italic; }
    #sort-controls-container optgroup option { font-style: normal; }

    .school-list-collapsible-content { overflow-y: auto; flex-grow: 1; }
    .school-list-collapsible-content.hidden { display: none; }
    .list-content { overflow-y: auto; flex-grow: 1;  }
    .list-content ul { list-style: none; padding: 0; margin: 0 0 10px 0; }
    .list-content li {
    padding: 6px 3px; 
    word-wrap: break-word;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
    position: relative;

    line-height: 1.6; 
}
    .list-content li.list-item-highlight, .list-content li.current-selection-highlight { background-color: #d6eaff;  }
    body.dark-mode .list-content li.list-item-highlight, body.dark-mode .list-content li.current-selection-highlight { background-color: #2a3950; }
    .list-content li input[type="checkbox"] { margin-right: 6px; flex-shrink: 0; cursor: pointer; vertical-align: middle; }
    .list-content li span.school-name { flex-grow: 1; vertical-align: middle; line-height: 1.4;  }
    .list-content a { color: #007bff; text-decoration: none; }
    .list-content a:hover { text-decoration: underline; }
    .list-item-major { font-size: 0.85em; color: #555; margin-left: 3px; }
    #no-results-message { padding: 10px; text-align: center; font-style: italic; color: #777; display: none; }
    body.dark-mode #no-results-message { color: #aaa; }

    .list-content.gallery-view ul { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 10px; padding-top: 5px; }
    .list-content.gallery-view li:not(.grad-class-separator) {
        flex-direction: column; align-items: center; padding: 8px; border: 1px solid #eee; border-radius: 4px;
        flex-grow: 0; flex-shrink: 1; flex-basis: calc((100% - 2 * 10px) / 3); min-width: 150px;
        box-sizing: border-box; margin-bottom: 10px; position: relative; height: 180px; justify-content: flex-start;
    }
    body.dark-mode .list-content.gallery-view li:not(.grad-class-separator) { border-color: #444; }
    .list-content.gallery-view li:not(.grad-class-separator) > input[type="checkbox"] {
        position: absolute; top: 4px; right: 4px; z-index: 2; margin: 0;
    }
    .gallery-grad-class-overlay {
        position: absolute; top: 4px; left: 0; right: 0; text-align: center; font-size: 1.6em; font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3), -1px -1px 2px rgba(0,0,0,0.3);
        z-index: 1; pointer-events: none; line-height: 1;
    }
    .list-content.gallery-view li .gallery-photo-div {
        width: calc(100% - 8px); height: calc(100% - 30px); margin-top: 28px;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
    }
    .list-content.gallery-view li .gallery-photo-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; width: 100%; }
    .list-content.gallery-view li .gallery-photo-container input[type="checkbox"] { margin-bottom: 8px; margin-right: 0; }
    .list-content.gallery-view li .gallery-photo { max-width: 100%; max-height: 100%; object-fit: cover; border-radius: 3px; display: block; }
    body.dark-mode .list-content.gallery-view li .gallery-photo { border-color: #555; }
    .list-content.gallery-view li span.school-name { display: none !important; }

    #senior-photo-popup {
    position: fixed;
    background-color: white;
    border: 1px solid #ccc;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 5px;
    z-index: 2000;
    display: none;
    width: 200px; 
    transition: opacity 0.2s, transform 0.2s;
    opacity: 0;
    transform: scale(0.95);
    max-height: 75vh; 
    overflow-y: auto;  
}
    #senior-photo-popup.visible { display: block; opacity: 1; transform: scale(1); }
    #close-senior-photo-popup { position: absolute; top: 2px; right: 5px; font-size: 18px; line-height: 1; padding: 2px 5px; z-index: 2001; pointer-events: auto; }
    #senior-photo-popup img { max-width: 100%; height: auto; border-radius: 3px; cursor: zoom-in; display: block; pointer-events: auto; }
       #senior-photo-popup img.zoomed {
     position: fixed;
    top: 50%;
    left: 50%; 
    transform: translate(-50%, -50%); 
    max-width: 95vw;
    max-height: 95vh;
    object-fit: contain;    
    z-index: 2000;
    cursor: default; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    border: 2px solid white; 
    background: #fff; 
    transition: transform .25s ease, left .25s ease, max-width .25s ease; 
    pointer-events: auto;
}

#senior-photo-popup.with-side-panel img.zoomed {

    max-width: calc(100vw - 525px); 

    left: calc(65px + ( (100vw - 525px) / 2 ) ); 

}

#senior-photo-popup img.zoomed:hover {

    cursor: default;
}

    body.dark-mode #senior-photo-popup img.zoomed { border-color: #333; background-color: #282828; }
    #senior-photo-popup p#senior-photo-caption { margin: 5px 0 0 0; font-size: 0.9em; text-align: center; pointer-events: auto; }
    #senior-photo-popup img.zoomed + p#senior-photo-caption,
    #senior-photo-popup.zoomed-state p#senior-photo-caption {
        position: fixed; bottom: 65px; left: 50%; transform: translateX(-50%);
        background-color: #222222; color: white; padding: 6px 12px; border-radius: 4px; font-size: 0.9em;
        z-index: 2001; pointer-events: auto;
    }
    body.dark-mode #senior-photo-popup img.zoomed + p#senior-photo-caption,
    body.dark-mode #senior-photo-popup.zoomed-state p#senior-photo-caption { background-color: #e0e0e0; color: #121212; }

    .photo-nav-arrow {
        position: fixed; top: 50%; transform: translateY(-50%); background-color: rgba(0, 0, 0, 0.4);
        color: white; border: none; font-size: 2.5em; padding: 10px; cursor: pointer; z-index: 2005;
        border-radius: 50%; width: 50px; height: 50px; line-height: 30px; text-align: center;
        opacity: 0.6; transition: opacity 0.2s, background-color 0.2s; user-select: none;
    }
    .photo-nav-arrow:hover { opacity: 1; background-color: rgba(0, 0, 0, 0.7); }
    .photo-nav-arrow.prev { left: 15px; }
    .photo-nav-arrow.next { right: 15px; }
    body.dark-mode .photo-nav-arrow { background-color: rgba(255, 255, 255, 0.25); color: #e0e0e0; }
    body.dark-mode .photo-nav-arrow:hover { background-color: rgba(255, 255, 255, 0.5); }

    #photo-zoom-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        z-index: 1999; display: none;
    }
    #zoom-exit-note {
        position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
        z-index: 2001; padding: 8px 12px; border-radius: 4px;
    }

    .college-group-header {
        font-weight: bold; padding: 6px 3px; background-color: #e9ecef;
        border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;
        margin-top: 3px; margin-bottom: 2px; position: sticky; top: -1px; z-index: 10; cursor: default;
    }
    body.dark-mode .college-group-header { background-color: #2c2c2c; border-color: #444; color: #e0e0e0; }
    .student-sublist { list-style: none; padding-left: 15px; margin: 0; }
    .list-content li.college-group-header:hover { background-color: #e9ecef; }
    body.dark-mode .list-content li.college-group-header:hover { background-color: #2c2c2c; }
    .list-content.gallery-view .college-group-header,
    .list-content.gallery-view .student-sublist { display: none !important; }
    .list-content.gallery-view ul > li:not(.grad-class-separator):not(.college-group-header) { display: flex !important; }
    .student-sublist li { padding: 3px 0; }
    .student-sublist li.list-item-highlight, .student-sublist li.current-selection-highlight { background-color: #d6eaff; }
    body.dark-mode .student-sublist li.list-item-highlight, body.dark-mode .student-sublist li.current-selection-highlight { background-color: #2a3950; }

    body.dark-mode { background-color: #121212; color: #e0e0e0; }
    body.dark-mode #description-control { background-color: purple; color: white; }
    body.dark-mode #controls-and-list-container { background-color: #1a1a1a; border-right-color: #444; }
    body.dark-mode #panel-resizer { background-color: #333; }
    body.dark-mode #panel-resizer:hover { background-color: #555; }
    body.dark-mode .map-control { background-color: rgba(40, 40, 40, 0.9); color: #e0e0e0; border-color: #555; }
    body.dark-mode .map-control h4 { border-bottom-color: #444; }
    body.dark-mode #filter-control .filter-header { border-bottom-color: #555; }
    body.dark-mode #state-country-filters-container { border-color: #555; }
    body.dark-mode .list-header-container { border-bottom-color: #444; }
    body.dark-mode #stats-table th, body.dark-mode #stats-table td { border-color: #555; }
    body.dark-mode #stats-table th { background-color: #2a2a2a; }
    body.dark-mode #stats-table td.row-header { background-color: #222; }
    body.dark-mode #major-summary-table th, body.dark-mode #major-summary-table td { border-color: #555; }
    body.dark-mode #major-summary-table th { background-color: #2a2a2a; }
    body.dark-mode .list-item-major { color: #bbb; }
    body.dark-mode #toggleSchoolListBtn { background-color: #444; border-color: #666; color: #e0e0e0; }
    body.dark-mode #senior-photo-popup { background-color: #282828; border-color: #555; color: #e0e0e0;}
    body.dark-mode #schoolSearchInput { background-color: #333; border-color: #555; color: #e0e0e0; }
    body.dark-mode #searchSuggestions { background-color: #333; border-color: #555; color: #e0e0e0; }
    body.dark-mode #searchSuggestions div:hover { background-color: #444; }
    body.dark-mode .filter-color-box { border-color: #666; }
        .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn, #showFaqBtn, #toggleNestmBtn, #zoomToNestmBtn {
    font-size: 0.9em; 
    padding: 7px 11px; 
    margin: 5px;
    border: 1px solid #bbb;
    border-radius: 4px;
    background-color: rgba(245, 245, 245, 0.9);
    color: #222;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    line-height: 1.5;
    flex-basis: auto;
    text-align: center;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-sizing: border-box;
}
               body.dark-mode .dark-mode-toggle-control:hover, body.dark-mode #toggleTransitBtn:hover, body.dark-mode #toggleSatelliteViewBtn:hover, body.dark-mode #zoomToVisibleBtn:hover, body.dark-mode #clearAllFiltersBtn:hover, body.dark-mode #toggleGalleryViewBtn:hover, body.dark-mode #showFaqBtn:hover, body.dark-mode #toggleNestmBtn:hover, body.dark-mode #zoomToNestmBtn:hover {
        background-color: rgba(70, 70, 70, 0.95);
    }
    body.dark-mode .gm-style-iw-c { background-color: #282828 !important; box-shadow: 0 2px 7px 1px rgba(255, 255, 255, 0.2); }
    body.dark-mode .gm-style-iw-d { color: #e0e0e0 !important; overflow: visible !important; }
    body.dark-mode .info-window-content { color: #e0e0e0; }
    body.dark-mode .info-window-content b { color: #ffffff; }
    body.dark-mode .info-window-content a { color: #90caf9 !important; }
    body.dark-mode .info-window-content a:hover { color: #bbdefb !important; }
    body.dark-mode .info-window-type { color: #aaa; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] , body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] { background: none !important; border: none !important; box-shadow: none !important; opacity: 1 !important; border-radius: 2px !important; padding: 4px !important; right: 6px !important; top: 6px !important; cursor: pointer; transition: background-color 0.2s ease; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"]:hover, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"]:hover { background-color: rgba(255, 255, 255, 0.2) !important; }
    body.dark-mode .gm-style .gm-style-iw-c button[title="Close"] img, body.dark-mode .gm-style .gm-style-iw-c button[aria-label="Close"] img { display: block !important; width: 14px !important; height: 14px !important; filter: contrast(0) sepia(1) hue-rotate(0deg) saturate(0) brightness(1.5) invert(1) !important; opacity: 1 !important; transform: scale(1) !important; }
    body.dark-mode .gm-style .gm-style-mtc , body.dark-mode .gmnoprint .gm-style-mtc { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5); border: 1px solid #444 !important; border-radius: 2px; }
    body.dark-mode .gm-style .gm-style-mtc button, body.dark-mode .gm-style .gm-style-mtc div { color: #ffffff !important; font-weight: 500 !important; background-color: transparent !important; text-shadow: none !important; }
    body.dark-mode .gm-style .gm-style-mtc button:hover, body.dark-mode .gm-style .gm-style-mtc div:hover { background-color: #444 !important; }
    body.dark-mode .gm-style .gm-style-mtc .gm-active { background-color: #555 !important; color: #fff !important; border-left: none !important; border-right: none !important; }
    body.dark-mode .gm-style .gm-style-mtc .gm-active div, body.dark-mode .gm-style .gm-style-mtc .gm-active button { color: #fff !important; background-color: #555 !important; }
    body.dark-mode .gmnoprint .gm-control-active, body.dark-mode .gm-svpc, body.dark-mode .gm-fullscreen-control { background-color: #303030 !important; box-shadow: 0 1px 4px rgba(0, 0, 0, 0.5) !important; border: 1px solid #444 !important; border-radius: 2px !important; }
    body.dark-mode .gmnoprint .gm-control-active:hover, body.dark-mode .gm-svpc:hover, body.dark-mode .gm-fullscreen-control:hover { background-color: #444 !important; }
    body.dark-mode .gm-fullscreen-control img, body.dark-mode .gm-svpc img, body.dark-mode .gm-style-mtc button img, body.dark-mode button[aria-label*="Zoom in"] img, body.dark-mode button[aria-label*="Zoom out"] img { filter: brightness(0) invert(1) !important; opacity: 1 !important; }
    body.dark-mode .gm-style > .gmnoprint > div { background: transparent !important; box-shadow: none !important; border: none !important; border-radius: 2px; }
    body.dark-mode .gm-style > .gmnoprint > div > div + div { background-color: #555 !important; }
    body.dark-mode .gm-style .gm-style-cc, body.dark-mode .gm-style .gm-style-cc a, body.dark-mode .gm-style .gm-style-cc span, body.dark-mode .gm-style .gm-style-cc div { color: #ffffff !important; text-shadow: none !important; font-weight: 400 !important; opacity: 0.9 !important; }
    body.dark-mode .gm-style .gm-style-cc a:link, body.dark-mode .gm-style .gm-style-cc a:visited { color: #ffffff !important; text-decoration: none !important; opacity: 0.9 !important; }
    body.dark-mode .gm-style .gm-style-cc a:hover { color: #ffffff !important; text-decoration: underline !important; opacity: 1 !important; }
    body.dark-mode .list-content li:hover span.school-name { text-decoration: underline; }
    body.dark-mode .tip-message { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
    body.dark-mode .dismiss-button { color: #888; }
    body.dark-mode .dismiss-button:hover { color: #ddd; background-color: #444; }
    body.dark-mode .filter-control-buttons button { background-color: #444; border-color: #666; color: #e0e0e0; }
    body.dark-mode .filter-control-buttons button:hover { background-color: #555; }
    body.dark-mode #zoom-exit-note { background-color: #2a3a50; border-color: #4a6a90; color: #bcd8f0; }
    body.dark-mode #zoom-exit-note .dismiss-button { color: #888;}
    body.dark-mode #zoom-exit-note .dismiss-button:hover { color: #ddd; background-color: #444; }

    #trends-control { font-size: 0.9em; margin-top: 10px; }
    #trends-control h4 { margin-bottom: 10px; }
    #trends-control h5 { margin-top: 0; margin-bottom: 8px; font-size: 1em; font-weight: bold; text-align: center; }
    .chart-container {
        position: relative; margin: 0 auto 15px auto; padding: 5px; border: 1px solid #ddd; border-radius: 4px;
        background-color: #fdfdfd; width: 100%; height: 280px; box-sizing: border-box;
    }
    body.dark-mode .chart-container { border-color: #555; background-color: #2a2a2a; }
    #trends-control canvas { max-width: 100%; margin-bottom: 10px; }
    #trends-control .chart-container p { font-size: 0.8em; text-align: center; margin-top: 5px; margin-bottom: 5px; line-height: 1.3; color: black; }
    body.dark-mode #trends-control .chart-container p { color: #aaa; }

    #faq-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        z-index: 2999; display: none;
    }
    #faq-popup {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 80%; max-width: 700px; max-height: 80vh; background-color: #ffffff;
        border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        padding: 20px; z-index: 3000; display: none; flex-direction: column;
    }
    #faq-popup h2 { margin-top: 0; margin-bottom: 15px; text-align: center; font-size: 1.5em; color: #333; }
    #close-faq-popup { position: absolute; top: 10px; right: 15px; font-size: 24px;  }
    #faq-content { overflow-y: auto; flex-grow: 1; line-height: 1.6; padding-right: 10px; }
    #faq-content h4 { margin-top: 15px; margin-bottom: 5px; color: #555; font-size: 1.1em; } 
    #faq-content h4:first-child { margin-top: 0; }
    #faq-content p,
    #faq-content li { 
        margin-top: 0;
        margin-bottom: 10px;
        color: #444;
        font-size: 0.95em; 
        font-weight: normal; 
    }
    #faq-content ol {
        margin-top: 0; 
        margin-bottom: 10px; 
        padding-left: 25px; 
    }
    #faq-content ul { 
        margin-top: 0;
        margin-bottom: 10px;
        padding-left: 25px;
    }

    body.dark-mode #faq-popup { background-color: #282c34; border-color: #555; color: #e0e0e0; }
    body.dark-mode #faq-popup h2 { color: #e8e8e8; }
    body.dark-mode #faq-content h4 { color: #bbbec3; }
    body.dark-mode #faq-content p,
    body.dark-mode #faq-content li { 
        color: #afb3b8;
        font-weight: normal; 
    }

    @media (max-width: 768px) {
  #trends-control .chart-container {
        height: 300px; 
    }
    #trends-control .chart-container:first-child { 
        height: 360px; 
    }



        #controls-and-list-container {

            position: absolute;
            inset: 0 auto 0 0;
            width: 85%; 
            max-width: 320px; 
            transform: translateX(-100%); 
            border-right: none; 
            box-shadow: 2px 0 10px rgba(0,0,0,.25);
            z-index: 1000; 
        }

        #controls-and-list-container.panel-mobile-open {
            transform: translateX(0);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        #controls-and-list-container.panel-desktop-hidden {
            transform: translateX(-100%) !important; 
        }

        .map-control h4 { font-size: 1em; }
                               .dark-mode-toggle-control, #toggleTransitBtn, #toggleSatelliteViewBtn, #zoomToVisibleBtn, #clearAllFiltersBtn, #toggleGalleryViewBtn, #showFaqBtn, #toggleNestmBtn, #zoomToNestmBtn {
            font-size: 0.8em; padding: 4px 8px;
        }
        #schoolSearchContainer { width: 100%; float: none; margin-top: 5px; }
        .list-header-container h4 { float: none; display: block; }
        #toggleSchoolListBtn { font-size:0.75em; }
        .list-content.gallery-view li:not(.grad-class-separator) {
            flex-basis: calc((100% - 1 * 10px) / 2); min-width: 120px;
        }

        #controls-and-list-container button,
        #controls-and-list-container input[type="checkbox"] + label {
            font-size: 1.0rem; 

        }
        .list-content li, 
        .filter-item label { 
             font-size: 1.0rem;
        }

         #senior-photo-popup img.zoomed {
        max-width: 85vw;  
        max-height: 85vh; 

    }

        #senior-photo-popup.zoomed-state p#senior-photo-caption {
        bottom: 45px; 
        font-size: 0.8em; 
        padding: 5px 10px; 
    }

    .photo-nav-arrow {
        font-size: 1.8em;    
        width: 38px;       
        height: 38px;
        line-height: 1;    
        padding: 6px;      
    }
    .photo-nav-arrow.prev {
        left: 8px;        
    }
    .photo-nav-arrow.next {
        right: 8px;
    }

    #zoom-exit-note {

        font-size: 0.8em; 
        padding: 6px 10px; 

    }

    }

    @media (max-width: 480px) {

        #controls-and-list-container {

        }
        .list-content.gallery-view li:not(.grad-class-separator) {
            min-width: 100px;
        }
    }

</style>

</head>

<body>

   <div id="map-container">

        <button id="menu-toggle" aria-label="Toggle list" class="hamburger">
          ☰
        </button>
        <div id="controls-and-list-container">

            <div id="description-control" class="map-control">
                <span><b>NEST+m Senior College Destinations Map</b> 🦅</span>
            </div>

                        <div id="credits">
    <span>Created by: </span>
    <a href="https://github.com/norman-mei" target="_blank" title="GitHub Profile">
        Norman Mei ('25) 
        <svg height="18" viewBox="0 0 16 16" version="1.1" width="18" aria-hidden="true" style="margin-left: 4px;"> 
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
    </a>
    <a href="https://www.instagram.com/normanmei_/" target="_blank" title="Instagram Profile" style="vertical-align: middle;"> 
        <svg height="18" viewBox="0 0 24 24" width="18" aria-hidden="true"> 
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"></path>
        </svg>
    </a>
</div>

                                         <div id="map-options-control" class="map-control">
                <button id="darkModeToggle" class="dark-mode-toggle-control" title="Toggle Dark Mode">🌙 Dark Mode</button>
                <button id="toggleTransitBtn" title="Show Transit Layer">🚇 Show Transit</button>
                <button id="toggleSatelliteViewBtn" title="Switch to Satellite View">🛰️ Satellite View</button>
                <button id="zoomToVisibleBtn" title="Zoom to fit all visible markers">👁️ Zoom to Visible</button>
                <button id="zoomToNestmBtn" title="Zoom to NEST+m">🏠 Zoom Back to Home</button>
                <button id="clearAllFiltersBtn" title="Clear all active filters and search">🧹 Clear All Filters</button>
                <button id="toggleGalleryViewBtn" title="Toggle Gallery View in List">🖼️ Toggle Gallery View</button>
                <button id="showFaqBtn" title="Show Frequently Asked Questions">❓ FAQ</button>
                <button id="toggleNestmBtn" title="Show/Hide NEST+m Marker">🦅 Show NEST+m</button>
            </div>
            <div id="filter-control" class="map-control">
                 <h4 class="filter-header">Filter by Graduating Class</h4>
                 <div class="control-content">
                     <div class="filter-control-buttons">
                         <button id="checkAllGradClassesBtn" title="Check all graduating class filters">Check All</button>
                         <button id="uncheckAllGradClassesBtn" title="Uncheck all graduating class filters">Uncheck All</button>
                     </div>
                     <div id="instagram-links-control">
                        <a href="https://www.instagram.com/nestmdecisions2021/" target="_blank" class="instagram-link-button" title="Instagram '21 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'21</span>
                        </a>
                        <a href="https://www.instagram.com/nestm2022decisions/" target="_blank" class="instagram-link-button" title="Instagram '22 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                               <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'22</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions2023/" target="_blank" class="instagram-link-button" title="Instagram '23 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'23</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions2024/" target="_blank" class="instagram-link-button" title="Instagram '24 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                               <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'24</span>
                        </a>
                        <a href="https://www.instagram.com/nestmdecisions25/" target="_blank" class="instagram-link-button" title="Instagram '25 Decisions">
                            <svg width="24" height="24" viewBox="0 0 24 24" class="instagram-logo">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                            <span>'25</span>
                        </a>
                    </div>
                     <div style="clear: both;"></div>
                     <div id="grad-class-filters-container">
                         {} 
                     </div>

                 <h4 class="filter-header" style="margin-top: 15px;">Filter by State/Country</h4>
                      <div class="control-content">
                         <div class="filter-control-buttons">
                             <button id="checkAllStateCountryBtn" title="Check all state/country filters">Check All</button>
                             <button id="uncheckAllStateCountryBtn" title="Uncheck all state/country filters">Uncheck All</button>
                         </div>
                         <div id="state-country-filters-container" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 5px; margin-top: 5px; font-size: 0.9em;">

                         </div>
                     </div> 
                 </div> 
            </div>
            <div id="stats-table-control" class="map-control">
                <h4>College Attendance Statistics</h4>
                <div class="control-content">
                    <table id="stats-table">
                        <thead>
                            <tr>
                                <th>Location Focus</th>
                                <th>Public</th>
                                <th>Private</th>
                                <th>Total</th>
                                <th>Filter <input type="checkbox" id="checkAllLocationFocusBtn" title="Toggle all location focus filters" checked></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="row-header">In City (NYC)</td>
                                <td data-stat="InCityNYC-Public">0</td>
                                <td data-stat="InCityNYC-Private">0</td>
                                <td data-stat="InCityNYC-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="InCityNYC" title="Filter by In City (NYC)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">In State (NY, Other)</td>
                                <td data-stat="InStateNYOther-Public">0</td>
                                <td data-stat="InStateNYOther-Private">0</td>
                                <td data-stat="InStateNYOther-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="InStateNYOther" title="Filter by In State (NY, Other)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">Out of State (US)</td>
                                <td data-stat="OutOfStateUS-Public">0</td>
                                <td data-stat="OutOfStateUS-Private">0</td>
                                <td data-stat="OutOfStateUS-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="OutOfStateUS" title="Filter by Out of State (US)" checked></td>
                            </tr>
                            <tr>
                                <td class="row-header">International</td>
                                <td data-stat="International-Public">0</td>
                                <td data-stat="International-Private">0</td>
                                <td data-stat="International-Total">0</td>
                                <td><input type="checkbox" class="location-focus-filter" data-location-focus="International" title="Filter by International" checked></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td class="row-header">Grand Total</td>
                                <td data-stat="Total-Public" style="font-weight:bold;">0</td>
                                <td data-stat="Total-Private" style="font-weight:bold;">0</td>
                                <td data-stat="Total-Overall" style="font-weight:bold;">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div> 
            </div>

            <div id="major-summary-control" class="map-control">
                <h4>Major Area Summary</h4>
                 <div class="control-content">
                    <table id="major-summary-table">
                        <thead>
                            <tr>
                                <th>Major Area</th>
                                <th>Count</th>
                                <th>Filter <input type="checkbox" id="checkAllMajorAreasBtn" title="Toggle all major area filters" checked></th>
                            </tr>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div> 
            </div>

             <div id="trends-control" class="map-control">
                <h4>Data Trends Over Time</h4>
                <div class="control-content">
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <h5>Major Area Popularity (% of Grads/Year)</h5>
                        <canvas id="majorAreaTrendChart"></canvas>
                    </div>
                    <div class="chart-container" style="margin-bottom: 20px;">
                        <h5>Location Focus Distribution (% of Grads/Year)</h5>
                        <canvas id="locationFocusTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h5>Top 5 Colleges By Overall Attendance (% of Grads/Year)</h5>
                        <canvas id="popularCollegesTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="school-list-control" class="map-control">
                <div class="list-header-container"> 
                    <h4>College List & Seniors</h4>
                     <button id="toggleSchoolListBtn" title="Show/Hide List">Hide List</button>
                    <div id="schoolSearchContainer">
                        <input type="text" id="schoolSearchInput" placeholder="Search seniors or colleges..." autocomplete="off">
                        <div id="searchSuggestions"></div>
                    </div>
                </div>

                <div id="sort-controls-container" style="padding: 5px 0px 10px 0px; border-bottom: 1px solid #eee; margin-bottom: 8px;">
                    <div>
                        <label for="primarySortTarget" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Target:</label>
                        <select id="primarySortTarget" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc; margin-right: 10px;">
                            <option value="students" selected>Students</option>
                            <option value="colleges">Colleges</option>
                        </select>
                    </div>
                    <div id="collegeSortOptionsContainer" style="display: none; margin-top: 8px;">
                        <label for="collegeSortSelect" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Colleges by:</label>
                        <select id="collegeSortSelect" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc;">
                            <option value="name_asc" selected>Name (A-Z)</option>
                            <option value="name_desc">Name (Z-A)</option>
                            <option value="count_desc">Student Count (Most)</option>
                            <option value="count_asc">Student Count (Least)</option>
                        </select>
                    </div>
                    <div id="studentSortOptionsContainer" style="margin-top: 8px;"> 
                        <label for="studentSortSelect" style="margin-right: 5px; font-size: 0.9em; vertical-align: middle;">Sort Students by:</label>
                        <select id="studentSortSelect" style="padding: 4px; font-size: 0.85em; vertical-align: middle; border-radius: 3px; border: 1px solid #ccc;">
                            <option value="grad_first" selected>Grad Class, First Name</option>
                            <option value="grad_last">Grad Class, Last Name</option>
                            <option value="first_name">First Name (Overall)</option>
                            <option value="last_name">Last Name (Overall)</option>
                        </select>
                    </div>
                </div>

                 <div class="list-content">
                     <div class="school-list-collapsible-content">

                          <div id="no-results-message">No seniors match your current filters.</div>
                     </div>
                 </div>
            </div>
        </div>
        <div id="panel-resizer"></div>
        <div id="map"></div>

    </div>

    <div id="senior-photo-popup">
        <span id="close-senior-photo-popup" class="dismiss-button" title="Close Photo (Esc)">&times;</span>
        <img src="#" alt="Senior Photo" onerror="this.style.display='none'; this.onerror=null;">
        <p id="senior-photo-caption">Senior Name</p>
        <button id="prev-senior-photo" class="photo-nav-arrow prev" title="Previous Senior (Left Arrow)" style="display: none;">&lt;</button>
        <button id="next-senior-photo" class="photo-nav-arrow next" title="Next Senior (Right Arrow)" style="display: none;">&gt;</button>
    </div>
    <div id="zoom-exit-note" class="tip-message" style="display: none;">
        <span>To exit zooming, click out of the picture or press Esc.</span>
        <span class="dismiss-button" onclick="this.parentElement.style.display='none';">×</span>
    </div>

    <div id="faq-overlay"></div>
    <div id="faq-popup">
        <span id="close-faq-popup" class="dismiss-button" title="Close FAQ">×</span>
        <h2>Frequently Asked Questions</h2>
        <div id="faq-content">

             <h4>Q: I have questions, concerns, and comments about the project. </h4>
            <p> For any questions, concerns and comments, please message me on Instagram: @normanmei_</p>

            <h4>Q: How is the data collected?</h4>
            <p>A: Data is pulled / sourced all done manually from publicly available Instagram posts (e.g., "college decisions" accounts for NEST+m graduating classes) and voluntarily submitted information. All data aims to be respectful of privacy and focuses on publicly shared commitments.</p>

            <h4>Q: How often is the data updated?</h4>
<p>A: Can't say for sure. I have real life obligiations to attend to so basically whenever I am free to do so.</p>

<h4> Q: What is the next thing you are going to add?</h4>
<p>A: Can't say. </p>

<h4>Q: How long did this project take? What was the inspiration?</h4>
            <p>A: I started this project in late May 2025 for my APCSP final project just for fun. Putting in all the data manually probably took a combined total of 60 hours or more.</p>

   <h4>Q: Is my personal information shared publicly?</h4>
<p>A: Only your first and last name, graduating class, the school you commmited to, Instagram profile, LinkedIn profile, and college choice are displayed. No other personal details (e.g., home address, email) are collected or shown, to respect privacy.</p>

            <h4>Q: Have you considered using the Instagram API?</h4>
<p>
  A: Yes, I thought of this at first to completely futureproof my project for future graduating classes but as I did a little more research, I found out that I simply <b>can't</b> do it because I need a solution that works for accounts I don’t own and maintains minimal ongoing effort, the official Instagram APIs simply won’t do.
</p>
<ol>
  <li><strong>Basic Display API is gone:</strong> Meta deprecated it on December 4, 2024, so any calls now just error out.</li>
  <li><strong>Graph API requires ownership & verification:</strong> I’d have to convert the school’s accounts to Business/Creator, pass App Review, and complete Business Verification—none of which I control.</li>
  <li><strong>oEmbed only returns embed HTML:</strong> I can’t pull separate JSON fields for photos, bios, or profile pics—just a blockquote snippet.</li>
  <li><strong>Scraping is brittle (& against IG ToS):</strong> While it’s technically possible, it can break whenever the site changes (too much work to fix over time if it keeps breaking) and not to mention it violates Instagram’s Terms of Service, and risks bans.</li>
</ol>
<p>
  Bottom line: Without owning and verifying the accounts, there’s no official API route to auto-fetch seniors’ photos or bios, so I that's why I don't use any API of sort, everything is done manually.
</p>

            <h4>Q: How are "Major Areas" determined?</h4>
            <p>A: Specific majors are mapped to broader "Major Areas" using a combination of a JS file and keyword-based logic in the main script. This helps in summarizing trends. Combined majors (e.g., "CS & Econ") may be split or categorized based on their components.</p>

            <h4>Q: Why can't I see a specific senior's photo?</h4>
            <p>A: Photos are linked based on filenames derived from senior names and graduating years. If a photo is missing, it might be because it wasn't available or a naming convention mismatch. The system attempts fallbacks (PNG, college logo) if the primary JPG is not found.</p>

            <h4>Q: How do the filters work?</h4>
            <p>A: You can filter by graduating class, state/country of the college, location focus (NYC, NY State, Out of State, International), and major area. Filters are generally additive (AND logic). The lists and map will update to show only seniors matching all active filter criteria. "Clear All Filters" resets everything.</p>

            <h4>Q: What do the different colors for map markers mean?</h4>
            <p>A: Map marker colors correspond to the graduating class of the senior, using the same color scheme as in the "Filter by Graduating Class" section.</p>

            <h4>Q: What is "Gallery View"?</h4>
            <p>A: Gallery View changes the student list into a card-based layout, often showing senior photos or college logos more prominently. It's an alternative way to browse the data.</p>

            <h4>Q: How can I use the list navigation with keyboard?</h4>
            <p>A: When the list has focus (and you're not typing in the search bar), use the Up and Down arrow keys to navigate between seniors. If a senior's photo is zoomed in, use Left and Right arrow keys to navigate to the previous/next senior's photo. Press 'Escape' to close popups or zoomed photos.</p>

            <h4>Q: When at some point when you stop maintaining this project or let someone else take over?</h4>
            <p>A: Probably whenever I am in college and preferably it has someone that my school's college counselor recommended me to let them take over the project.</p>

        </div>
    </div>

     <script>

        let map;
        let infowindow;
        let isDarkMode = false;
        let allMarkers = []; 
        let gradClassFilterState = {};
        let schoolsSelectedForZoom = new Set();
        let zoomedGradClassInfoDiv, zoomedGradClassValueSpan; 
     let panelJustToggledOpen = false;
        let activeHoverMarkerIndex = null; 
        let seniorPhotoPopup, seniorPopupImage, seniorPopupCaption, closeSeniorPhotoBtn, zoomExitNote, photoZoomOverlay;
        let prevSeniorPhotoBtn, nextSeniorPhotoBtn; 
        let faqPopup, faqOverlay;
        let currentlyZoomedSeniorOriginalIndex = null; 

let panelToggleTimeout = null;
        let transitLayer;
           let currentPrimarySortTarget = 'students'; 
let currentCollegeSortValue = 'name_asc'; 
let currentStudentSortValue = 'grad_first'; 
        let isSatelliteViewEnabled = false;
        let transitLayerEnabled = false;
        let locationFocusFilterState = {}; 
        let majorAreaFilterState = {}; 
         let stateCountryFilterState = {};
        let isGalleryViewEnabled = false;
        let currentListSelectionIndex = -1; 

        let markerClustererInstance;

        let majorAreaChartInstance, locationFocusChartInstance, popularCollegesChartInstance;

       

const LINKEDIN_SVG_PATH = "M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.776 13.019H3.561V9h3.552v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.225 0z";
        const INSTAGRAM_SVG_PATH = "M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4s1.791-4 4-4 4 1.79 4 4-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z";

        function createSocialLinkSVG(type, size = 16, currentIsDarkMode, forZoomedPanel = false) {
            const path = type === 'linkedin' ? LINKEDIN_SVG_PATH : INSTAGRAM_SVG_PATH;
            let fillColor;
            if (type === 'linkedin') {
                fillColor = currentIsDarkMode ? (forZoomedPanel ? '#88C5F6' : '#70B4F0') : (forZoomedPanel ? '#0A66C2' : '#0077B5');
            } else { 
                fillColor = currentIsDarkMode ? (forZoomedPanel ? '#F56040' :'#E1306C') : (forZoomedPanel ? '#E1306C' : '#C13584');
            }
            const marginStyle = forZoomedPanel ? 'margin: 5px;' : 'margin-left: 4px; margin-right: 1px;'; 
            return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${fillColor}" style="vertical-align: middle; ${marginStyle}"><path d="${path}"></path></svg>`;
        }
        const CHART_COLORS_LIST = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#8A2BE2', '#5F9EA0', '#D2691E', '#FF7F50', '#6495ED', '#DC143C',
    '#008B8B', '#B8860B', '#006400', '#8B0000', '#FF8C00', '#2F4F4F'
];
let chartColorIndex = 0;
function getNextChartColor() {
    const color = CHART_COLORS_LIST[chartColorIndex % CHART_COLORS_LIST.length];
    chartColorIndex++;
    return color;
}

        let baseMarkerIcon;
        let highlightedMarkerIcon;

                const gradClassColors = {
            "'21": "#00FFFF", 
            "'22": "#FF0000", 
            "'23": "#99CC00", 
            "'24": "#FFBB33", 
            "'25": "#007FFF"  
        };
        const gradClassNames = Object.keys(gradClassColors);

        const NYC_BOUNDS = { north: 40.92, south: 40.47, west: -74.26, east: -73.70 };
                const PREDEFINED_MAJOR_AREAS = [
             "Engineering", "Physical Sciences", "Life Sciences", 
            "Business/Economics",
            "Humanities", "Social Sciences",  
            "Arts/Design", "Health Sciences", "Education",
            "Undecided/Other", "Other", 
        ].sort((a,b) => { 
            const special = ["Undecided/Other", "Other", "Unknown"];
            if (special.includes(a) && !special.includes(b)) return 1;
            if (!special.includes(a) && special.includes(b)) return -1;
            if (special.includes(a) && special.includes(b)) return special.indexOf(a) - special.indexOf(b);
            return a.localeCompare(b);
        });

      const collegeTypeMappings = {
            "FIT": TYPE_SUNY, "Fashion Institute of Technology": TYPE_SUNY,
            "AMDA": TYPE_OTHER_PRIVATE, "AMDA College of the Performing Arts": TYPE_OTHER_PRIVATE,
            "Undecided": TYPE_UNDECIDED,
        };

        const darkMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
            { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#263c3f" }] },
            { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#6b9a76" }] },
            { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] },
            { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] },
            { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] },
            { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] },
            { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#1f2835" }] },
            { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#f3d19c" }] },
            { featureType: "transit", elementType: "geometry", stylers: [{ color: "#2f3948" }] },
            { featureType: "transit.station", elementType: "labels.text.fill", stylers: [{ color: "#d59563" }] },
            { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
            { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#515c6d" }] },
            { featureType: "water", elementType: "labels.text.stroke", stylers: [{ color: "#17263c" }] },
        ];

        for (const collegeName in collegeCoordsAndInfo) {
            if (collegeCoordsAndInfo.hasOwnProperty(collegeName)) {
                const properties = getCollegeProperties(collegeCoordsAndInfo[collegeName]);
                collegeCoordsAndInfo[collegeName].isCampusPublic = properties.isCampusPublic;
                collegeCoordsAndInfo[collegeName].locationFocus = properties.locationFocus;
            }
        }

        let seniorCollegeChoices;
        let allData;
        window.isDataReadyForMap = false;

        function getMarkerIcon(seniorChoice, isHighlighted = false, currentIsDarkMode) {
            let displayColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
            if (seniorChoice.collegeName === "Undecided") displayColor = '#999999';

            const currentBaseIcon = baseMarkerIcon || { path: google.maps.SymbolPath.CIRCLE, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            const currentHighlightedIcon = highlightedMarkerIcon || { ...currentBaseIcon, scale: 10, strokeWeight: 2.0 };

            const iconConfig = isHighlighted ? currentHighlightedIcon : currentBaseIcon;
            return { ...iconConfig, fillColor: displayColor, strokeColor: currentIsDarkMode ? '#111111' : '#ffffff' };
        }

               function getCollegeProperties(collegeEntry) {
            let isCampusPublic = false;

            if ([TYPE_SUNY, TYPE_CUNY, TYPE_OTHER_PUBLIC, TYPE_PURDUE].includes(collegeEntry.type)) {
                isCampusPublic = true;
            } else if ([TYPE_IVY_LEAGUE, TYPE_OTHER_PRIVATE].includes(collegeEntry.type)) {
                isCampusPublic = false;
            }

            if (collegeEntry.type === "Purdue University System" || collegeEntry.name === "Purdue University") isCampusPublic = true;

            let locationFocus = "N/A"; 
            const stateOrCountryUpper = collegeEntry.stateOrCountry ? collegeEntry.stateOrCountry.trim().toUpperCase() : null;

            if (collegeEntry.name === "Undecided" || (collegeEntry.lat === 0 && collegeEntry.lng === 0)) {

            } else {
                let isInternationallyFlagged = false;

                if (collegeEntry.name) {
                    const lowerName = collegeEntry.name.toLowerCase();
                    if (lowerName.includes("shanghai") || 
                        lowerName.includes("london") || 
                        lowerName.includes("edinburgh") || 
                        lowerName.includes("mcgill") ||
                        lowerName.includes("st andrews") ||
                        lowerName.includes("maastricht university")) { 
                        isInternationallyFlagged = true;
                    }
                }

                if (!isInternationallyFlagged && stateOrCountryUpper) {
                    const US_STATES_ABBR = [
                        "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", 
                        "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", 
                        "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", 
                        "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", 
                        "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"
                    ];

                    if (stateOrCountryUpper !== "USA" && !US_STATES_ABBR.includes(stateOrCountryUpper)) {
                        isInternationallyFlagged = true;
                    }
                }

                if (isInternationallyFlagged) {
                    locationFocus = "International";
                } else {

                    if (collegeEntry.lat >= NYC_BOUNDS.south && collegeEntry.lat <= NYC_BOUNDS.north &&
                        collegeEntry.lng >= NYC_BOUNDS.west && collegeEntry.lng <= NYC_BOUNDS.east) {
                        locationFocus = "InCityNYC";
                    } else if (stateOrCountryUpper === "NY") {
                        locationFocus = "InStateNYOther";
                    } else {

                        locationFocus = "OutOfStateUS"; 
                    }
                }
            }
            return { isCampusPublic, locationFocus };
        }

        function normalizeForFilename(str) {
            if (!str) return '';
            return str
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
        }

        function getFirstName(seniorName) {
            if (!seniorName) return "";
            return seniorName.split(' ')[0];
        }

        function getLastName(seniorName) {
            if (!seniorName) return "";
            const parts = seniorName.split(' ');
            return parts.length > 1 ? parts[parts.length - 1] : parts[0];
        }

    function aggregateTrendsBase(data, categoryExtractor, itemValidator, categoryFilter) {
        const rawCounts = {}; 
        const studentsPerYear = {}; 
        const allCategories = new Set();
        const years = [...new Set(data.map(item => item.gradClass))].sort();

        years.forEach(year => {
            rawCounts[year] = {};
            studentsPerYear[year] = 0;
        });

        data.forEach(item => {
            if (!itemValidator(item)) return;

            const year = item.gradClass;
            studentsPerYear[year]++;

            const categories = categoryExtractor(item);
            categories.forEach(cat => {
                if (categoryFilter(cat)) {
                    allCategories.add(cat);
                    rawCounts[year][cat] = (rawCounts[year][cat] || 0) + 1;
                }
            });
        });

        const trendsInPercentage = {};
        years.forEach(year => trendsInPercentage[year] = {});

        years.forEach(year => {
            const totalRelevantStudents = studentsPerYear[year];
            allCategories.forEach(cat => { 
                 trendsInPercentage[year][cat] = 0;
            });
            if (totalRelevantStudents > 0) {
                for (const cat in rawCounts[year]) {
                    trendsInPercentage[year][cat] = (rawCounts[year][cat] / totalRelevantStudents) * 100;
                }
            }
        });
        return { trends: trendsInPercentage, years, categories: Array.from(allCategories).sort() };
    }

    function aggregateMajorAreaTrends(data) {
        return aggregateTrendsBase(data,
            item => item.majorArea.split(' & ').map(s => s.trim()), 
            item => item.collegeName !== "Undecided", 
            area => area && area !== "Unknown" && area !== "Undecided/Other" 
        );
    }

    function aggregateLocationFocusTrends(data) {
        return aggregateTrendsBase(data,
            item => [item.locationFocus], 
            item => item.collegeName !== "Undecided" && item.locationFocus !== "N/A", 
            focus => focus 
        );
    }

    function aggregatePopularCollegeTrends(data, topN = 5) {
        const collegeCountsOverall = {};
        data.forEach(item => {
            if (item.collegeName && item.collegeName !== "Undecided") {
                collegeCountsOverall[item.collegeName] = (collegeCountsOverall[item.collegeName] || 0) + 1;
            }
        });

        const popularCollegesOverall = Object.entries(collegeCountsOverall)
            .sort(([, countA], [, countB]) => countB - countA)
            .slice(0, topN)
            .map(([name]) => name);

        const result = aggregateTrendsBase(data,
            item => [item.collegeName], 
            item => item.collegeName !== "Undecided" && popularCollegesOverall.includes(item.collegeName), 
            collegeName => collegeName 
        );

        result.categories = popularCollegesOverall;
        return result;
    }

function getChartJsConfigOptions(
    titleText,
    currentIsDarkMode,
    isMobile = false,
    isMajorAreaChart = false
) {
    const gridColor   = currentIsDarkMode ? 'rgba(255, 255, 255, 0.1)'
                                          : 'rgba(0, 0, 0, 0.1)';
    const ticksColor  = currentIsDarkMode ? '#ccc' : '#666';
    const legendColor = currentIsDarkMode ? '#eee' : '#333';

    let legendPosition     = 'top';
    let legendAlign        = 'start';
    let layoutPaddingTop   = 10;

    if (isMobile && isMajorAreaChart) {
        legendPosition   = 'bottom';     
        legendAlign      = 'center';     
        layoutPaddingTop = 10;           
    } else if (isMobile) {

        layoutPaddingTop = 25;
    }

    const legendFontSize     = isMobile ? 9.5 : Chart.defaults.font.size;
    const legendBoxWidth     = isMobile ? 9   : 12;
    const legendItemsPadding = isMobile ? 4   : 8;

    return {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
            padding: {
                top  : layoutPaddingTop,
                right: isMobile ? 5  : 10,
                bottom: isMobile ? 15 : 20,
                left : isMobile ? 5  : 10
            }
        },
        plugins: {
            legend: {
                position: legendPosition,
                align   : legendAlign,
                labels  : {
                    color   : legendColor,
                    boxWidth: legendBoxWidth,
                    padding : legendItemsPadding,
                    font    : { size: legendFontSize }
                }
            },

            title: { display: false, text: titleText, font: { size: 14 } },
            tooltip: {
                callbacks: {
                    label: (ctx) => {
                        let l = ctx.dataset.label ? `${ctx.dataset.label}: ` : '';
                        if (ctx.parsed.y != null) l += `${ctx.parsed.y.toFixed(1)}%`;
                        return l;
                    }
                }
            }
        },
        scales: {
            x: { grid: { color: gridColor }, ticks: { color: ticksColor } },
            y: {
                beginAtZero: true,
                grid : { color: gridColor },
                ticks: {
                    color: ticksColor,
                    precision: 0,
                    callback: (v) => `${v}%`
                }
            }
        }
    };
}

        function calculateDynamicYAxisMax(datasets) {
            let maxValue = 0;
            datasets.forEach(dataset => {
                if (dataset.data && Array.isArray(dataset.data)) {
                    dataset.data.forEach(value => {
                        if (typeof value === 'number' && value > maxValue) {
                            maxValue = value;
                        }
                    });
                }
            });

            if (maxValue === 0) {
                return 10; 
            }

            let yMaxWithHeadroom = maxValue * 1.2;
            let yMax = Math.ceil(yMaxWithHeadroom / 5) * 5;

            return Math.min(100, yMax); 
        }

      function renderMajorAreaTrendChart(data, years, majorAreasList, currentIsDarkMode) {
            const ctx = document.getElementById('majorAreaTrendChart').getContext('2d');
            if (majorAreaChartInstance) majorAreaChartInstance.destroy();
            chartColorIndex = 0; 

            const datasets = majorAreasList.map(area => {
                const areaData = years.map(year => data[year][area] || 0);
                return {
                    label: area,
                    data: areaData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const isMobile = window.innerWidth <= 768;
            const chartOptions = getChartJsConfigOptions('Major Area Popularity Over Years', currentIsDarkMode, isMobile, true); 

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            majorAreaChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions
            });
        }

        function renderLocationFocusTrendChart(data, years, locationFocusesList, currentIsDarkMode) {
            const ctx = document.getElementById('locationFocusTrendChart').getContext('2d');
            if (locationFocusChartInstance) locationFocusChartInstance.destroy();
            chartColorIndex = 0; 

            const datasets = locationFocusesList.map(focus => {
                const focusData = years.map(year => data[year][focus] || 0);
                return {
                    label: focus,
                    data: focusData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Location Focus Distribution Over Years', currentIsDarkMode);

            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            locationFocusChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions 
            });
        }

        function renderPopularCollegesTrendChart(data, years, popularCollegesList, currentIsDarkMode) {
            const ctx = document.getElementById('popularCollegesTrendChart').getContext('2d');
            if (popularCollegesChartInstance) popularCollegesChartInstance.destroy();
            chartColorIndex = 0; 

            const datasets = popularCollegesList.map(college => {
                const collegeData = years.map(year => data[year][college] || 0);
                return {
                    label: college,
                    data: collegeData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Top College Attendance Over Years', currentIsDarkMode);

            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            popularCollegesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions 
            });
        }

        function renderLocationFocusTrendChart(data, years, locationFocusesList, currentIsDarkMode) {
            const ctx = document.getElementById('locationFocusTrendChart').getContext('2d');
            if (locationFocusChartInstance) locationFocusChartInstance.destroy();
            chartColorIndex = 0; 

            const datasets = locationFocusesList.map(focus => {
                const focusData = years.map(year => data[year][focus] || 0);
                return {
                    label: focus,
                    data: focusData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Location Focus Distribution Over Years', currentIsDarkMode);

            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            locationFocusChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions 
            });
        }

        function renderPopularCollegesTrendChart(data, years, popularCollegesList, currentIsDarkMode) {
            const ctx = document.getElementById('popularCollegesTrendChart').getContext('2d');
            if (popularCollegesChartInstance) popularCollegesChartInstance.destroy();
            chartColorIndex = 0; 

            const datasets = popularCollegesList.map(college => {
                const collegeData = years.map(year => data[year][college] || 0);
                return {
                    label: college,
                    data: collegeData,
                    borderColor: getNextChartColor(),
                    tension: 0.1,
                    fill: false
                };
            });

            const yAxisMax = calculateDynamicYAxisMax(datasets);
            const chartOptions = getChartJsConfigOptions('Top College Attendance Over Years', currentIsDarkMode);

            if (!chartOptions.scales) chartOptions.scales = {};
            if (!chartOptions.scales.y) chartOptions.scales.y = { beginAtZero: true };
            else chartOptions.scales.y.beginAtZero = true;
            chartOptions.scales.y.max = yAxisMax;

            popularCollegesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: chartOptions 
            });
        }

              function getMajorArea(specificMajor) {
            if (!specificMajor) return "Unknown";

            const lowerSpecificMajor = specificMajor.toLowerCase().trim();
            if (lowerSpecificMajor === "" || lowerSpecificMajor === "undecided" || lowerSpecificMajor === "undecided major" || lowerSpecificMajor === "n/a" || lowerSpecificMajor === "exploratory") {
                return "Undecided/Other";
            }

            for (const keyInMap in majorToAreaMapping) {
                if (keyInMap.toLowerCase() === lowerSpecificMajor) {
                    return majorToAreaMapping[keyInMap]; 
                }
            }

            if (lowerSpecificMajor.includes('&') || lowerSpecificMajor.includes(' and ')) {
                const rawParts = lowerSpecificMajor.split(/\s*&\s*|\s+and\s+/);
                const areas = rawParts.map(part => {
                    part = part.trim();
                    if (part === "") return "Unknown";

                    let mappedAreaOfPart = "Other"; 

                    for (const keyInMapForPart in majorToAreaMapping) {
                        if (keyInMapForPart.toLowerCase() === part) {
                            mappedAreaOfPart = majorToAreaMapping[keyInMapForPart];
                            break;
                        }
                    }

                    if (mappedAreaOfPart === "Other" || !PREDEFINED_MAJOR_AREAS.includes(mappedAreaOfPart)) {
                        if (part.includes("computer sci") || part.includes("information tech") || (part.includes("software eng") && !part.includes("game design"))) mappedAreaOfPart = "Computer Science & IT";
                        else if (part.includes("engineering") && !part.includes("software eng") && !part.includes("financial eng")) mappedAreaOfPart = "Engineering"; 
                        else if (part.includes("math") || part.includes("stat")) mappedAreaOfPart = "Mathematics & Statistics";
                        else if (part.includes("physics") || part.includes("chemist") || part.includes("astronomy") || part.includes("earth sci") || (part.includes("environmental sci") && !part.includes("studies") && !part.includes("policy"))) mappedAreaOfPart = "Physical Sciences";
                        else if (part.includes("biolog") || part.includes("neurosci") || part.includes("biochem") || part.includes("molecular bio") || part.includes("genetics") || (part.includes("environmental sci") && (part.includes("studies") || part.includes("policy")) )) mappedAreaOfPart = "Life Sciences";
                        else if (part.includes("business") || part.includes("econ") || part.includes("financ") || part.includes("market") || part.includes("account") || part.includes("manag")) mappedAreaOfPart = "Business/Economics";
                        else if (part.includes("english") || part.includes("history") || part.includes("philosophy") || part.includes("literature") || part.includes("language") || part.includes("classic") || part.includes("liberal arts") || part.includes("humanities")) mappedAreaOfPart = "Humanities";
                        else if (part.includes("psych") || part.includes("socio") || part.includes("anthro") || part.includes("political sci") || part.includes("internation rel") || part.includes("government") || part.includes("urban studies") || part.includes("cognitive sci") || part.includes("gender studies") || part.includes("area studies") || part.includes("public policy")) mappedAreaOfPart = "Social Sciences";
                        else if (part.includes("communicat") || part.includes("journalis") || part.includes("media studies")) mappedAreaOfPart = "Communications & Journalism";
                        else if (part.includes("art") || part.includes("design") || part.includes("music") || part.includes("theat") || part.includes("film") || part.includes("drama") || part.includes("visual") || part.includes("game design")) mappedAreaOfPart = "Arts/Design";
                        else if (part.includes("health") || part.includes("medic") || part.includes("nurs") || part.includes("pre-med") || part.includes("public health") || part.includes("pharmacy")) mappedAreaOfPart = "Health Sciences";
                        else if (part.includes("educat") || part.includes("teach")) mappedAreaOfPart = "Education";
                        else mappedAreaOfPart = "Other"; 
                    }
                    return mappedAreaOfPart;
                });

                const finalAreas = areas.filter(a => a !== "Unknown" && a !== "Other");
                if (finalAreas.length > 0) {
                    const uniqueFinalAreas = [...new Set(finalAreas)];
                    if (uniqueFinalAreas.length === 1) return uniqueFinalAreas[0];

                    return uniqueFinalAreas.sort().join(' & ');
                } else {
                    return "Other"; 
                }
            }

            let bestContainedKey = null;
            let longestContainedKeyLength = 0;
            for (const keyInMap in majorToAreaMapping) {
                if (lowerSpecificMajor.includes(keyInMap.toLowerCase())) {

                    if (keyInMap.length > longestContainedKeyLength) {
                        longestContainedKeyLength = keyInMap.length;
                        bestContainedKey = keyInMap;
                    }
                }
            }
            if (bestContainedKey) {
                return majorToAreaMapping[bestContainedKey]; 
            }

            if (lowerSpecificMajor.includes("computer sci") || lowerSpecificMajor.includes("information tech") || (lowerSpecificMajor.includes("software eng") && !lowerSpecificMajor.includes("game design"))) return "Computer Science & IT";
            if (lowerSpecificMajor.includes("engineering") && !lowerSpecificMajor.includes("software eng") && !lowerSpecificMajor.includes("financial eng")) return "Engineering";
            if (lowerSpecificMajor.includes("math") || lowerSpecificMajor.includes("stat")) return "Mathematics & Statistics";
            if (lowerSpecificMajor.includes("physics") || lowerSpecificMajor.includes("chemist") || lowerSpecificMajor.includes("astronomy")|| lowerSpecificMajor.includes("earth sci") || (lowerSpecificMajor.includes("environmental sci") && !lowerSpecificMajor.includes("studies") && !lowerSpecificMajor.includes("policy"))) return "Physical Sciences";
            if (lowerSpecificMajor.includes("biolog") || lowerSpecificMajor.includes("neurosci") || lowerSpecificMajor.includes("biochem") || lowerSpecificMajor.includes("molecular bio") || lowerSpecificMajor.includes("genetics") || (lowerSpecificMajor.includes("environmental sci") && (lowerSpecificMajor.includes("studies") || lowerSpecificMajor.includes("policy")) )) return "Life Sciences";
            if (lowerSpecificMajor.includes("business") || lowerSpecificMajor.includes("econ") || lowerSpecificMajor.includes("financ") || lowerSpecificMajor.includes("market") || lowerSpecificMajor.includes("account")|| lowerSpecificMajor.includes("manag")) return "Business/Economics";
            if (lowerSpecificMajor.includes("english") || lowerSpecificMajor.includes("history") || lowerSpecificMajor.includes("philosophy") || lowerSpecificMajor.includes("literature") || lowerSpecificMajor.includes("language") || lowerSpecificMajor.includes("classic") || lowerSpecificMajor.includes("liberal arts") || lowerSpecificMajor.includes("humanities")) return "Humanities";
            if (lowerSpecificMajor.includes("psych") || lowerSpecificMajor.includes("socio") || lowerSpecificMajor.includes("anthro") || lowerSpecificMajor.includes("political sci") || lowerSpecificMajor.includes("internation rel") || lowerSpecificMajor.includes("government") || lowerSpecificMajor.includes("urban studies") || lowerSpecificMajor.includes("cognitive sci") || lowerSpecificMajor.includes("gender studies") || lowerSpecificMajor.includes("area studies") || lowerSpecificMajor.includes("public policy")) return "Social Sciences";
            if (lowerSpecificMajor.includes("communicat") || lowerSpecificMajor.includes("journalis") || lowerSpecificMajor.includes("media studies")) return "Communications & Journalism";
            if (lowerSpecificMajor.includes("art") || lowerSpecificMajor.includes("design") || lowerSpecificMajor.includes("music") || lowerSpecificMajor.includes("theat") || lowerSpecificMajor.includes("film") || lowerSpecificMajor.includes("drama") || lowerSpecificMajor.includes("visual") || lowerSpecificMajor.includes("game design")) return "Arts/Design";
            if (lowerSpecificMajor.includes("health") || lowerSpecificMajor.includes("medic") || lowerSpecificMajor.includes("nurs") || lowerSpecificMajor.includes("pre-med") || lowerSpecificMajor.includes("public health") || lowerSpecificMajor.includes("pharmacy")) return "Health Sciences";
            if (lowerSpecificMajor.includes("educat") || lowerSpecificMajor.includes("teach")) return "Education";

            return "Other"; 
        }

       function parseRawData(jsonData) { 
            if (!Array.isArray(jsonData)) {
                console.error("Error: Input to parseRawData is not a JSON array.", jsonData);
                return [];
            }

            const rawEntries = [];

            for (const entry of jsonData) {
                if (!entry || typeof entry.name !== 'string' || typeof entry.classYear !== 'string' || typeof entry.college !== 'string') {
                    console.warn("Skipping malformed entry in JSON data:", entry);
                    continue;
                }

                const seniorName = entry.name.trim();
                const collegeNameRaw = entry.college.trim();
                const major = (entry.major && entry.major.trim() !== "") ? entry.major.trim() : "Undecided Major";
                const gradClass = entry.classYear.trim(); 

                const linkedInUrl = (entry.linkedin && entry.linkedin.trim() !== "") ? entry.linkedin.trim() : null;
                const instagramUrl = (entry.instagram && entry.instagram.trim() !== "") ? entry.instagram.trim() : null;
                const bioCaption = (entry.congratsCaption && entry.congratsCaption.trim() !== "") ? entry.congratsCaption.trim() : null;

                const originalFirstName = seniorName.split(' ')[0];

                rawEntries.push({
                    seniorName,
                    collegeNameRaw,
                    major,
                    gradClass: `'${gradClass}`, 
                    originalFirstName,
                    linkedInUrl,
                    instagramUrl,
                    bioCaption
                });
            }

            const firstNameCountsByClass = new Map();
            for (const entry of rawEntries) {

                if (!firstNameCountsByClass.has(entry.gradClass)) {
                    firstNameCountsByClass.set(entry.gradClass, new Map());
                }
                const classCounts = firstNameCountsByClass.get(entry.gradClass);
                const normalizedFirstNameForCount = normalizeForFilename(entry.originalFirstName.split(' ')[0]);
                classCounts.set(normalizedFirstNameForCount, (classCounts.get(normalizedFirstNameForCount) || 0) + 1);
            }

            const choices = [];
            for (const entry of rawEntries) {
                const { seniorName, collegeNameRaw, major, gradClass, originalFirstName, linkedInUrl, instagramUrl, bioCaption } = entry;

                const photoYear = gradClass.replace("'", ""); 
                let photoFilename;

                const normalizedFirstNameForLookup = normalizeForFilename(originalFirstName.split(' ')[0]);

                const classCountsMap = firstNameCountsByClass.get(gradClass);
                if (classCountsMap && classCountsMap.get(normalizedFirstNameForLookup) > 1) {
                    photoFilename = normalizeForFilename(seniorName);
                } else {
                    photoFilename = normalizedFirstNameForLookup;
                }

                const seniorPhotoUrlBase = `photos/${photoYear}/${photoFilename}`;
                const normalizedNameKey = normalizeCollegeName(collegeNameRaw);
                const collegeDetails = collegeCoordsAndInfo[normalizedNameKey] || collegeCoordsAndInfo["Generic College"];

                let finalCollegeName = collegeDetails.name;
                if (collegeDetails === collegeCoordsAndInfo["Generic College"] && normalizedNameKey !== "Undecided") {
                    finalCollegeName = normalizedNameKey;
                }
                if (normalizedNameKey === "Undecided") finalCollegeName = "Undecided";

                let collegeTypeToUse = collegeDetails.type;
                if (collegeTypeMappings[normalizedNameKey]) {
                    collegeTypeToUse = collegeTypeMappings[normalizedNameKey];
                } else if (collegeTypeMappings[collegeNameRaw]) {
                     collegeTypeToUse = collegeTypeMappings[collegeNameRaw];
                }

                choices.push({
                    seniorName: seniorName,
                    gradClass: gradClass, 
                    collegeName: finalCollegeName,
                    collegeKey: normalizedNameKey,
                    collegeNameRaw: collegeNameRaw,
                    major: major,
                    lat: collegeDetails.lat,
                    lng: collegeDetails.lng,
                    collegeType: collegeTypeToUse,
                    collegeImageUrl: collegeDetails.imageUrl,
                    collegeHomepageUrl: collegeDetails.homepageUrl,
                    isCampusPublic: collegeDetails.isCampusPublic,
                    locationFocus: collegeDetails.locationFocus,
                    stateOrCountry: collegeDetails.stateOrCountry,
                    seniorPhotoUrl: `${seniorPhotoUrlBase}.jpg`,
                    seniorPhotoUrlPng: `${seniorPhotoUrlBase}.png`,
                    linkedInUrl: linkedInUrl,
                    instagramUrl: instagramUrl,
                    bioCaption: bioCaption,
                });
            }
            return choices;
        }

        function updateStatsTable() {
            const stats = {
                "InCityNYC": { Public: 0, Private: 0, Total: 0 },
                "InStateNYOther": { Public: 0, Private: 0, Total: 0 },
                "OutOfStateUS": { Public: 0, Private: 0, Total: 0 },
                "International": { Public: 0, Private: 0, Total: 0 },
                "Total": { Public: 0, Private: 0, Overall: 0 }
            };

            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided" && school.locationFocus !== "N/A") {
                    const focus = school.locationFocus;
                    const type = school.isCampusPublic ? "Public" : "Private";

                    if (stats[focus]) {
                        stats[focus][type]++;
                        stats[focus].Total++;
                        stats.Total[type]++;
                        stats.Total.Overall++;
                    }
                }
            });

            for (const focus in stats) {
                if (stats.hasOwnProperty(focus)) {
                    if (focus === "Total") {
                        document.querySelector(`#stats-table td[data-stat="Total-Public"]`).textContent = stats.Total.Public;
                        document.querySelector(`#stats-table td[data-stat="Total-Private"]`).textContent = stats.Total.Private;
                        document.querySelector(`#stats-table td[data-stat="Total-Overall"]`).textContent = stats.Total.Overall;
                    } else {
                        document.querySelector(`#stats-table td[data-stat="${focus}-Public"]`).textContent = stats[focus].Public;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Private"]`).textContent = stats[focus].Private;
                        document.querySelector(`#stats-table td[data-stat="${focus}-Total"]`).textContent = stats[focus].Total;
                    }
                }
            }
        }

        function updateMajorSummaryTable() {
            const majorAreaCounts = {};
            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaCounts[area] = 0);
            const allPresentMajorAreasInFilteredData = new Set(PREDEFINED_MAJOR_AREAS);

            if (!allData) return;

            allData.forEach(school => {
                if (school.isVisible && school.collegeName !== "Undecided") {
                    const majorAreaResult = school.majorArea;
                    const areasToCount = [];
                    if (typeof majorAreaResult === 'string' && majorAreaResult.includes(' & ')) {
                        areasToCount.push(...majorAreaResult.split(' & ').map(s => s.trim()));
                    } else if (typeof majorAreaResult === 'string') {
                        areasToCount.push(majorAreaResult.trim());
                    }

                    areasToCount.forEach(area => {
                        if (area && area !== "Unknown") {
                             allPresentMajorAreasInFilteredData.add(area);
                            if (majorAreaCounts.hasOwnProperty(area)) {
                                majorAreaCounts[area]++;
                            } else {
                                majorAreaCounts[area] = 1;
                                if (!PREDEFINED_MAJOR_AREAS.includes(area)) {

                                }
                            }
                        }
                    });
                }
            });

            const tableBody = document.querySelector("#major-summary-table tbody");
            tableBody.innerHTML = "";

            const sortedAreasToDisplay = Array.from(allPresentMajorAreasInFilteredData).sort((a, b) => {
                if ((a === "Undecided/Other" || a === "Other") && (b !== "Undecided/Other" && b !== "Other")) return 1;
                if ((b === "Undecided/Other" || b === "Other") && (a !== "Undecided/Other" && a !== "Other")) return -1;
                return a.localeCompare(b);
            });

            sortedAreasToDisplay.forEach(area => {
                if (majorAreaCounts[area] > 0 || PREDEFINED_MAJOR_AREAS.includes(area) || majorAreaFilterState.hasOwnProperty(area) ) {
                    const row = tableBody.insertRow();
                    const cellArea = row.insertCell();
                    const cellCount = row.insertCell();
                    const cellFilter = row.insertCell();

                    cellArea.textContent = area;
                    cellCount.textContent = majorAreaCounts[area] || 0;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = majorAreaFilterState[area] !== undefined ? majorAreaFilterState[area] : true;
                    checkbox.title = `Filter by ${area}`;
                    checkbox.dataset.majorArea = area;
                    checkbox.addEventListener('change', (event) => {
                        majorAreaFilterState[area] = event.target.checked;
                        updateCheckAllMajorAreasButtonState();
                        updateMarkersVisibility();
                    });
                    cellFilter.appendChild(checkbox);
                }
            });
            updateCheckAllMajorAreasButtonState();
        }

        function updateCheckAllMajorAreasButtonState() {
            const checkAllBtn = document.getElementById('checkAllMajorAreasBtn');
            if (!checkAllBtn) return;
            const allMajorCheckboxes = document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]');
            if (allMajorCheckboxes.length === 0) {
                 checkAllBtn.checked = true;
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allMajorCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allMajorCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }

   function updateMarkersVisibility() {
            if (!allMarkers || !allData) return;

            let visibleCount = 0; 

            const allGradClassesEffectivelyChecked = gradClassNames.every(gc => gradClassFilterState[gc]);

            const noGradClassesActuallyChecked = gradClassNames.length > 0 && gradClassNames.every(gc => !gradClassFilterState[gc]);

            const locationFocusFilterKeys = Object.keys(locationFocusFilterState);
            const allLocationFocusEffectivelyChecked = locationFocusFilterKeys.length === 0 || locationFocusFilterKeys.every(key => locationFocusFilterState[key]);
            const noLocationFocusActuallyChecked = locationFocusFilterKeys.length > 0 && locationFocusFilterKeys.every(key => !locationFocusFilterState[key]);

            const majorAreaFilterKeys = Object.keys(majorAreaFilterState);
            const allMajorAreasEffectivelyChecked = majorAreaFilterKeys.length === 0 || majorAreaFilterKeys.every(key => majorAreaFilterState[key]);
            const noMajorAreasActuallyChecked = majorAreaFilterKeys.length > 0 && majorAreaFilterKeys.every(key => !majorAreaFilterState[key]);

            const UNKNOWN_STATE_COUNTRY_KEY_FOR_CHECK = "Unknown/Not Applicable";
            const stateCountryFilterKeys = Object.keys(stateCountryFilterState);
            const allStateCountryEffectivelyChecked = stateCountryFilterKeys.length === 0 || stateCountryFilterKeys.every(key => stateCountryFilterState[key]);
            const noStateCountryActuallyChecked = stateCountryFilterKeys.length > 0 && stateCountryFilterKeys.every(key => !stateCountryFilterState[key]);

            allData.forEach((school) => {
                let meetsGradClassCriteria;
                if (noGradClassesActuallyChecked) {
                    meetsGradClassCriteria = false;
                } else {

                    meetsGradClassCriteria = allGradClassesEffectivelyChecked || (gradClassFilterState[school.gradClass] === true);
                }

                let meetsLocationFocusCriteria;
                if (noLocationFocusActuallyChecked) {
                    meetsLocationFocusCriteria = false;
                } else {
                    meetsLocationFocusCriteria = allLocationFocusEffectivelyChecked || (locationFocusFilterState[school.locationFocus] === true);
                }

                let meetsMajorAreaCriteria;
                if (noMajorAreasActuallyChecked) {
                    meetsMajorAreaCriteria = false;
                } else {
                    const schoolMajorAreas = school.majorArea.split(' & ').map(s => s.trim());
                    meetsMajorAreaCriteria = allMajorAreasEffectivelyChecked || schoolMajorAreas.some(area => majorAreaFilterState[area] === true);
                }

                let meetsStateCountryCriteria;
                const schoolSCKey = (school.stateOrCountry && school.stateOrCountry.trim() !== "" && school.stateOrCountry !== "N/A") ? school.stateOrCountry.trim() : UNKNOWN_STATE_COUNTRY_KEY_FOR_CHECK;
                if (noStateCountryActuallyChecked) {
                    meetsStateCountryCriteria = false;
                } else {
                    meetsStateCountryCriteria = allStateCountryEffectivelyChecked || (stateCountryFilterState[schoolSCKey] === true);
                }

                if (school.collegeName === "Undecided") {
                    const undecidedMajorAreaKey = "Undecided/Other";
                    let passesUndecidedMajorAreaLogic;
                    if (noMajorAreasActuallyChecked) {
                        passesUndecidedMajorAreaLogic = false;
                    } else {

                        passesUndecidedMajorAreaLogic = allMajorAreasEffectivelyChecked || (majorAreaFilterState[undecidedMajorAreaKey] === true);
                    }
                    school.isVisible = meetsGradClassCriteria && passesUndecidedMajorAreaLogic && meetsLocationFocusCriteria && meetsStateCountryCriteria;
                } else {
                    school.isVisible = meetsGradClassCriteria && meetsLocationFocusCriteria && meetsMajorAreaCriteria && meetsStateCountryCriteria;
                }

                if (school.isVisible) {
                    visibleCount++;
                } else {

                    if(schoolsSelectedForZoom.has(school.originalIndex)) {
                        schoolsSelectedForZoom.delete(school.originalIndex);

                        const checkboxInList = document.getElementById(`school-checkbox-${school.originalIndex}`);
                        if (checkboxInList) checkboxInList.checked = false;
                    }
                    const markerInfo = allMarkers[school.originalIndex];
                    if (infowindow && infowindow.getMap() && markerInfo && infowindow.anchor === markerInfo.marker) {
                        infowindow.close();
                    }

                    if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible') && currentlyZoomedSeniorOriginalIndex === school.originalIndex) {
                        hideSeniorPhotoPopup();
                    }

                    if (activeHoverMarkerIndex === school.originalIndex) {
                        if (markerInfo && markerInfo.marker) {
                            markerInfo.marker.setIcon(getMarkerIcon(school, false, isDarkMode)); 
                            markerInfo.marker.setZIndex(null);
                        }
                        activeHoverMarkerIndex = null;
                    }
                }
            });

            filterSchoolList(); 
            updateStatsTable();
            updateMajorSummaryTable();
            updateCurrentSelectionHighlight(); 

            if (markerClustererInstance && typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
                markerClustererInstance.clearMarkers();
                const visibleMapMarkers = [];
                allData.forEach(schoolDataFromAllData => {
                    if (schoolDataFromAllData.isVisible) {
                        const markerInfo = allMarkers[schoolDataFromAllData.originalIndex];

                        if (markerInfo && markerInfo.marker && !(schoolDataFromAllData.lat === 0 && schoolDataFromAllData.lng === 0)) {
                            visibleMapMarkers.push(markerInfo.marker);
                        }
                    }
                });
                markerClustererInstance.addMarkers(visibleMapMarkers);
            }
        }

        function getVisibleListItemsDOM() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return [];

            if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
                 return Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'))
                            .filter(li => li.style.display !== 'none' && !li.classList.contains('college-group-header'));
            } 

            else {
                const items = [];
                const collegeGroupHeaders = listUl.querySelectorAll('li.college-group-header');
                collegeGroupHeaders.forEach(header => {

                    if (header.style.display !== 'none') {
                        const studentSublist = header.nextElementSibling;
                        if (studentSublist && studentSublist.classList.contains('student-sublist') && studentSublist.style.display !== 'none') {
                            Array.from(studentSublist.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'))
                                .filter(li => li.style.display !== 'none')
                                .forEach(li => items.push(li));
                        }
                    }
                });
                return items;
            }
        }

            function filterSchoolList() {
            const searchTerm = document.getElementById('schoolSearchInput').value.toLowerCase().trim();
            const listContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            if (!listContentDiv || !listContentDiv.querySelector('ul')) return;

            const mainUl = listContentDiv.querySelector('ul');
            const noResultsMessage = document.getElementById('no-results-message');
            let hasVisibleItemsOverall = false;

            if (isGalleryViewEnabled || (currentPrimarySortTarget === 'students' && !isGalleryViewEnabled) ) {
                const listItems = mainUl.querySelectorAll('li:not(.grad-class-separator)[data-original-index]'); 
                listItems.forEach(item => {
                    const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                    const schoolData = (!isNaN(originalIndex) && allData && allData[originalIndex]) ? allData[originalIndex] : null;

                    if (!schoolData) { 
                        item.style.display = 'none';
                        return;
                    }

                    const meetsGlobalFilters = schoolData.isVisible;
                    let matchesSearch = searchTerm === '';
                    if (!matchesSearch && meetsGlobalFilters) { 
                        const itemTextContent = item.textContent.toLowerCase(); 
                        matchesSearch = itemTextContent.includes(searchTerm);
                    }

                    if (meetsGlobalFilters && matchesSearch) {
                        item.style.display = isGalleryViewEnabled ? 'flex' : 'flex'; 
                        hasVisibleItemsOverall = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
            }

            else {
                const collegeGroupHeaders = mainUl.querySelectorAll('li.college-group-header');
                collegeGroupHeaders.forEach(header => {
                    let groupHasVisibleStudentsMatchingSearchOrFilter = false;
                    const studentSublist = header.nextElementSibling;
                    let collegeNameInHeaderText = header.textContent.toLowerCase(); 

                    if (studentSublist && studentSublist.classList.contains('student-sublist')) {
                        const studentItems = studentSublist.querySelectorAll('li[data-original-index]');
                        studentItems.forEach(item => {
                            const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                            const schoolData = (!isNaN(originalIndex) && allData && allData[originalIndex]) ? allData[originalIndex] : null;

                            if (!schoolData) { item.style.display = 'none'; return; }

                            const meetsGlobalFilters = schoolData.isVisible;
                            let matchesSearch = searchTerm === '';

                            if (!matchesSearch && meetsGlobalFilters) {
                                const nameSpan = item.querySelector('span.school-name');
                                const studentLiText = nameSpan ? nameSpan.textContent.toLowerCase() : item.textContent.toLowerCase(); 

                                matchesSearch = studentLiText.includes(searchTerm) ||
                                                (schoolData.collegeName && schoolData.collegeName.toLowerCase().includes(searchTerm)) ||
                                                collegeNameInHeaderText.includes(searchTerm);
                            }

                            if (meetsGlobalFilters && matchesSearch) {
                                item.style.display = 'flex';
                                groupHasVisibleStudentsMatchingSearchOrFilter = true;
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    }

                    let headerItselfMatchesSearch = searchTerm !== '' && collegeNameInHeaderText.includes(searchTerm);

                    if (groupHasVisibleStudentsMatchingSearchOrFilter || headerItselfMatchesSearch) {
                        header.style.display = 'list-item';
                        if (studentSublist) studentSublist.style.display = 'block';
                        hasVisibleItemsOverall = true;

                        if (headerItselfMatchesSearch && !groupHasVisibleStudentsMatchingSearchOrFilter && studentSublist) {
                             const studentItems = studentSublist.querySelectorAll('li[data-original-index]');
                             studentItems.forEach(item => {
                                const originalIndex = parseInt(item.getAttribute('data-original-index'), 10);
                                const schoolData = allData[originalIndex];
                                if(schoolData && schoolData.isVisible) { 
                                    item.style.display = 'flex'; 

                                }
                             });
                        }

                    } else {
                        header.style.display = 'none';
                        if (studentSublist) studentSublist.style.display = 'none';
                    }
                });
            }

            noResultsMessage.style.display = hasVisibleItemsOverall ? 'none' : 'block';
            updateCurrentSelectionHighlight();
            updateSeparators();
        }

        function updateSeparators() {
            const listContentDiv = document.querySelector('#school-list-control .list-content');
            if (!listContentDiv) return;

            const mainUl = listContentDiv.querySelector('ul');
            if (!mainUl) return;

            const processUlForSeparators = (ulElement, isSubListContext) => {

                ulElement.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());

                let shouldAddSeparatorsInThisContext = false;
                if (isSubListContext) { 
                    shouldAddSeparatorsInThisContext = (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last');
                } else { 
                    shouldAddSeparatorsInThisContext =
                        (isGalleryViewEnabled && (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last')) ||
                        (currentPrimarySortTarget === 'students' && !isGalleryViewEnabled && (currentStudentSortValue === 'grad_first' || currentStudentSortValue === 'grad_last'));
                }

                if (!shouldAddSeparatorsInThisContext) {
                    return;
                }

                const visibleListItemsInUl = Array.from(ulElement.querySelectorAll(':scope > li:not(.grad-class-separator)[data-original-index]'))
                    .filter(li => li.style.display !== 'none' && !li.classList.contains('college-group-header'));

                if (visibleListItemsInUl.length === 0) return;

                const visibleGradClassesInUl = visibleListItemsInUl.map(li => {
                    const originalIndex = parseInt(li.dataset.originalIndex);
                    return allData[originalIndex]?.gradClass;
                }).filter(gc => gc); 

                const uniqueVisibleGradClassesInUl = new Set(visibleGradClassesInUl);

                if (uniqueVisibleGradClassesInUl.size <= 1) {
                    return; 
                }

                let previousVisibleGradClass = null;
                for (let i = 0; i < visibleListItemsInUl.length; i++) {
                    const currentLi = visibleListItemsInUl[i];
                    const originalIndex = parseInt(currentLi.dataset.originalIndex);
                    const currentGradClass = allData[originalIndex]?.gradClass;

                    if (currentGradClass) {
                        if (previousVisibleGradClass !== null && currentGradClass !== previousVisibleGradClass) {
                            const separatorLi = document.createElement('li');
                            separatorLi.className = 'grad-class-separator';

                            ulElement.insertBefore(separatorLi, currentLi);
                        }
                        previousVisibleGradClass = currentGradClass;
                    }
                }
            };

            if (currentPrimarySortTarget === 'students' || isGalleryViewEnabled) {

                processUlForSeparators(mainUl, false);
            } else { 

                mainUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());

                const studentSublists = mainUl.querySelectorAll('ul.student-sublist');
                studentSublists.forEach(sublistUl => {
                    const parentHeader = sublistUl.previousElementSibling;

                    if (parentHeader && parentHeader.classList.contains('college-group-header') && parentHeader.style.display !== 'none') {
                        if (sublistUl.style.display !== 'none') {
                           processUlForSeparators(sublistUl, true);
                        } else {

                           sublistUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());
                        }
                    } else {

                         sublistUl.querySelectorAll(':scope > li.grad-class-separator').forEach(sep => sep.remove());
                    }
                });
            }
        }

                     function showSeniorPhotoPopup(listItem, schoolData) {
         if (!seniorPhotoPopup || !seniorPopupImage || !seniorPopupCaption) {
             console.error("[DEBUG] Senior photo popup elements not initialized properly.");
             return;
         }
         currentlyZoomedSeniorOriginalIndex = schoolData.originalIndex;

         seniorPopupImage.style.display = 'block';
         seniorPopupImage.src = schoolData.seniorPhotoUrl;

         seniorPopupImage.onerror = function() {
             this.src = schoolData.seniorPhotoUrlPng;
             this.onerror = function() {
                 if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                     this.src = schoolData.collegeImageUrl;
                     this.onerror = function() {
                         this.style.display = 'none';
                         this.onerror = null;
                     };
                 } else {
                     this.style.display = 'none';
                     this.onerror = null;
                 }
             };
         };

         seniorPopupImage.alt = `${schoolData.seniorName}'s Photo / ${schoolData.collegeName} Logo`;

         const isImageFullyZoomed = seniorPopupImage && seniorPopupImage.classList.contains('zoomed');
         const isPopupContainerInZoomedState = seniorPhotoPopup && seniorPhotoPopup.classList.contains('zoomed-state');
         const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
         const zoomedBioCaptionEl = document.getElementById('zoomed-bio-caption-content');
         const zoomedSocialLinksEl = document.getElementById('zoomed-social-links-container');

         if (isImageFullyZoomed && isPopupContainerInZoomedState && zoomedInfoPanel && zoomedBioCaptionEl && zoomedSocialLinksEl) {

             if (zoomedGradClassInfoDiv && zoomedGradClassValueSpan) {
                 zoomedGradClassValueSpan.textContent = schoolData.gradClass;
                 zoomedGradClassValueSpan.style.color = gradClassColors[schoolData.gradClass] || (isDarkMode ? '#EEE' : '#111'); 
                 zoomedGradClassInfoDiv.style.display = 'block';
             }

             zoomedBioCaptionEl.innerHTML = schoolData.bioCaption || `Congrats, ${schoolData.seniorName}!`;

             zoomedSocialLinksEl.innerHTML = ''; 
             if (schoolData.linkedInUrl) { 
                 const liLink = document.createElement('a');
                 liLink.href = schoolData.linkedInUrl;
                 liLink.target = "_blank";
                 liLink.title = "LinkedIn Profile";
                 liLink.innerHTML = createSocialLinkSVG('linkedin', 28, isDarkMode, true);
                 zoomedSocialLinksEl.appendChild(liLink);
             }
             if (schoolData.instagramUrl) { 
                 const igLink = document.createElement('a');
                 igLink.href = schoolData.instagramUrl;
                 igLink.target = "_blank";
                 igLink.title = "Instagram Profile";
                 igLink.innerHTML = createSocialLinkSVG('instagram', 28, isDarkMode, true);
                 zoomedSocialLinksEl.appendChild(igLink);
             }

             zoomedInfoPanel.style.display = 'block';
             seniorPhotoPopup.classList.add('with-side-panel');
             if (seniorPopupCaption) seniorPopupCaption.style.display = 'none'; 

         } else {

             if (schoolData.bioCaption && schoolData.bioCaption.trim() !== "") {
                 seniorPopupCaption.innerHTML = schoolData.bioCaption;
             } else {
                 seniorPopupCaption.textContent = `Congrats, ${schoolData.seniorName}!`;
             }
             if (seniorPopupCaption) seniorPopupCaption.style.display = ''; 

             if (zoomedInfoPanel) zoomedInfoPanel.style.display = 'none'; 

             if (zoomedGradClassInfoDiv) zoomedGradClassInfoDiv.style.display = 'none';

             seniorPhotoPopup.classList.remove('with-side-panel'); 
         }

         const controlsPanel = document.getElementById('controls-and-list-container');
         const isDesktopView = window.innerWidth > 768;
         const isPanelClosedDesktop = isDesktopView && controlsPanel.classList.contains('panel-desktop-hidden');

         let popupFinalWidth, popupLeft, popupTop;

         if (isPanelClosedDesktop && !(isImageFullyZoomed && isPopupContainerInZoomedState) ) { 
             popupFinalWidth = 350;
             seniorPhotoPopup.style.width = `${popupFinalWidth}px`;
             seniorPopupImage.style.maxHeight = '450px';
             popupLeft = 20;
             popupTop = 70;
              if (popupLeft + popupFinalWidth > window.innerWidth - 10) {
                 popupLeft = Math.max(10, window.innerWidth - popupFinalWidth - 10);
             }
             let approxPopupHeight = Math.min(seniorPopupImage.naturalHeight || 450, 450) + (seniorPopupCaption.offsetHeight || 20) + 20;
             if (popupTop + approxPopupHeight > window.innerHeight - 10) {
                 popupTop = Math.max(10, window.innerHeight - approxPopupHeight - 10);
             }
             popupTop = Math.max(10, popupTop);

         } else if (!(isImageFullyZoomed && isPopupContainerInZoomedState)) { 
             seniorPhotoPopup.style.width = '200px';
             seniorPopupImage.style.maxHeight = '';
             popupFinalWidth = seniorPhotoPopup.offsetWidth;
             let popupCurrentHeight = seniorPhotoPopup.offsetHeight;
             const viewportWidth = window.innerWidth;
             const viewportHeight = window.innerHeight;
             const marginFromPanel = 15;
             const paddingFromViewportEdge = 10;
             const leftPanelRect = controlsPanel.getBoundingClientRect();

             if (listItem) {
                 const listItemRect = listItem.getBoundingClientRect();
                 popupTop = listItemRect.top;
             } else {
                 const mapDiv = document.getElementById('map');
                 const mapRect = mapDiv.getBoundingClientRect();
                 popupTop = mapRect.top + 70;
             }
             popupTop = Math.max(paddingFromViewportEdge, popupTop);
             if (popupTop + popupCurrentHeight > viewportHeight - paddingFromViewportEdge) {
                 popupTop = viewportHeight - popupCurrentHeight - paddingFromViewportEdge;
             }
             popupTop = Math.max(paddingFromViewportEdge, popupTop);
             popupLeft = leftPanelRect.right + marginFromPanel;
             if ((popupLeft + popupFinalWidth > viewportWidth - paddingFromViewportEdge) ||
                 (leftPanelRect.width > viewportWidth * 0.6 && leftPanelRect.left < viewportWidth / 2)) {
                 popupLeft = leftPanelRect.left - popupFinalWidth - marginFromPanel;
                 if (popupLeft < paddingFromViewportEdge || leftPanelRect.width >= viewportWidth - (2 * paddingFromViewportEdge)) {
                     const mapElement = document.getElementById('map');
                     if (mapElement && mapElement.offsetWidth > popupFinalWidth / 2) {
                         popupLeft = leftPanelRect.right + marginFromPanel;
                         if (popupLeft + popupFinalWidth > viewportWidth - paddingFromViewportEdge) {
                             const mapRect = mapElement.getBoundingClientRect();
                             popupLeft = mapRect.left + (mapRect.width - popupFinalWidth) / 2;
                         }
                     } else {
                         popupLeft = (viewportWidth - popupFinalWidth) / 2;
                     }
                 }
             }
             popupLeft = Math.max(paddingFromViewportEdge, popupLeft);
             popupLeft = Math.min(popupLeft, viewportWidth - popupFinalWidth - paddingFromViewportEdge);
         }

         if (!(isImageFullyZoomed && isPopupContainerInZoomedState)) {
              seniorPhotoPopup.style.left = `${popupLeft}px`;
              seniorPhotoPopup.style.top = `${popupTop}px`;
         }
         seniorPhotoPopup.classList.add('visible');
     }

            function exitZoomMode(hideSmallPopupAfter = true) {
         if (!seniorPhotoPopup || !seniorPopupImage) return;

         const parentPopup = seniorPhotoPopup;
          if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
          if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
          parentPopup.classList.remove('zoomed-state');

           const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
         if (zoomedInfoPanel) zoomedInfoPanel.style.display = 'none';

         if (zoomedGradClassInfoDiv) zoomedGradClassInfoDiv.style.display = 'none';

         parentPopup.classList.remove('with-side-panel');

         if (seniorPopupImage.classList.contains('zoomed')) {
             seniorPopupImage.classList.remove('zoomed');

             if (photoZoomOverlay) photoZoomOverlay.style.display = 'none';
             if (zoomExitNote) zoomExitNote.style.display = 'none';

             parentPopup.style.transform = parentPopup.dataset.originalTransform || '';
             parentPopup.style.left = parentPopup.dataset.originalLeft || '';
             parentPopup.style.top = parentPopup.dataset.originalTop || '';
             parentPopup.style.width = parentPopup.dataset.originalWidth || '';
             parentPopup.style.height = parentPopup.dataset.originalHeight || '';
             parentPopup.style.backgroundColor = parentPopup.dataset.originalBg || '';
             parentPopup.style.border = parentPopup.dataset.originalBorder || '';
             parentPopup.style.boxShadow = parentPopup.dataset.originalBoxShadow || '';
             parentPopup.style.padding = parentPopup.dataset.originalPadding || '';
             parentPopup.style.pointerEvents = parentPopup.dataset.originalPointerEvents || 'auto';

             delete parentPopup.dataset.originalTransform;
             delete parentPopup.dataset.originalLeft;

             delete parentPopup.dataset.originalPointerEvents;

             if (hideSmallPopupAfter) {
                  hideSeniorPhotoPopup();
             }
         } else if (hideSmallPopupAfter) {
             hideSeniorPhotoPopup();
         }
     }

        function getHonorarySuffixHTML(rawCollegeName) {
            let suffixHtml = "";
            const rawLower = rawCollegeName.toLowerCase();
            if (rawLower.includes("(macaulay)")) suffixHtml = ' <span class="honorary-suffix">Macaulay</span>';
            else if (rawLower.includes("(questbridge)")) suffixHtml = ' <span class="honorary-suffix">QuestBridge</span>';
            else if (rawLower.includes("(posse)")) suffixHtml = ' <span class="honorary-suffix">POSSE</span>';
            return suffixHtml;
        }

                function handleListItemInteraction(event, originalIndex, isHover) {
             if (event && event.target && event.target.type === 'checkbox') return;
             if (originalIndex === undefined || !allData[originalIndex]) {
                console.warn("Invalid originalIndex or data for list item interaction:", originalIndex);
                return;
             }

             const schoolData = allData[originalIndex]; 
             const markerInfo = allMarkers[originalIndex];

             if (!schoolData.isVisible) {
                if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                    const currentCaption = seniorPopupCaption.textContent;
                    if (currentCaption.includes(schoolData.seniorName)) {
                        hideSeniorPhotoPopup();
                    }
                }
                return;
             }
            const currentTargetListItem = event ? event.currentTarget : document.querySelector(`.list-content li[data-original-index="${originalIndex}"]`);

             if (isHover) { 
                if (panelJustToggledOpen) return;
                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                    }
                }
                showSeniorPhotoPopup(currentTargetListItem, schoolData);
             } else { 
                if (infowindow && infowindow.getMap()) {
                    infowindow.close();
                }

                if (markerInfo && markerInfo.marker && (schoolData.lat !== 0 || schoolData.lng !== 0)) {
                    const position = markerInfo.marker.getPosition();
                    if (position && map) {
                        map.panTo(position);
                        map.setZoom(Math.max(map.getZoom(), 12));

                        let contentString = `<div class="info-window-content">`;
                        const targetUrl = schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#' ? schoolData.collegeHomepageUrl : '#';
                        const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                        if (schoolData.collegeImageUrl && schoolData.collegeImageUrl !== 'x' && !schoolData.collegeImageUrl.startsWith('placeholder')) {
                            contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${schoolData.collegeImageUrl}" alt="${schoolData.collegeName} logo/photo"></a>`;
                        }

                        if (targetUrl !== '#') {
                            contentString += `<b><a href="${targetUrl}" ${openInNewTab}>${schoolData.collegeName}</a></b>`;
                        } else {
                            contentString += `<b>${schoolData.collegeName}</b>`;
                        }
                        contentString += `<br><span class="info-window-type">Type: ${schoolData.collegeType} (${schoolData.isCampusPublic ? 'Public' : 'Private'}, ${schoolData.locationFocus})</span>`;
                        if (schoolData.lat !== 0 || schoolData.lng !== 0) {
                            contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${schoolData.lat},${schoolData.lng}" target="_blank">Get Directions</a>`;
                        }
                        contentString += `<hr style="margin: 5px 0;">`;

                        if (schoolData.collegeName === "Undecided") {
                            const suffixHtml = getHonorarySuffixHTML(schoolData.collegeNameRaw);
                            contentString += `<b>${schoolData.seniorName}</b>${suffixHtml}`;
                            contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[schoolData.gradClass] || '#ccc'};">Class: ${schoolData.gradClass}</span>`;
                            contentString += `<br>Major: ${schoolData.major || 'Undecided Major'} (${schoolData.majorArea || 'N/A'})`;
                        } else {
                            const studentsAtSameCollege = allData.filter(s =>
                                s.isVisible &&
                                s.collegeName === schoolData.collegeName &&
                                s.collegeName !== "Undecided"
                            ).sort((a, b) => {
                                if (a.gradClass !== b.gradClass) return a.gradClass.localeCompare(b.gradClass);
                                const lastNameA = getLastName(a.seniorName);
                                const lastNameB = getLastName(b.seniorName);
                                if (lastNameA !== lastNameB) return lastNameA.localeCompare(lastNameB);
                                return getFirstName(a.seniorName).localeCompare(getFirstName(b.seniorName));
                            });

                            if (studentsAtSameCollege.length > 0) {
                                contentString += `<u>Students Attending (Visible):</u><ul style="margin-top: 3px; margin-bottom: 3px; padding-left: 18px;">`;
                                studentsAtSameCollege.forEach(student => {
                                    const suffixHtml = getHonorarySuffixHTML(student.collegeNameRaw);
                                    let studentEntry = `<li>`;
                                    if (student.originalIndex === originalIndex) studentEntry += `<b>`; 
                                    studentEntry += `${student.seniorName}${suffixHtml} <span class="info-window-grad-class" style="color: ${gradClassColors[student.gradClass] || '#ccc'};">(${student.gradClass})</span>`;
                                    if (student.originalIndex === originalIndex) studentEntry += `</b>`;
                                    studentEntry += `<br><small style="padding-left: 10px;">Major: ${student.major || 'Undecided'} (${student.majorArea || 'N/A'})</small>`;
                                    studentEntry += `</li>`;
                                    contentString += studentEntry;
                                });
                                contentString += `</ul>`;
                            }
                        }
                        contentString += `</div>`;

                        infowindow.setContent(contentString);
                        infowindow.open({ map: map, anchor: markerInfo.marker });
                    }
                }

                showSeniorPhotoPopup(currentTargetListItem, schoolData);

                 if (event && (event.ctrlKey || event.metaKey) && schoolData.collegeHomepageUrl && schoolData.collegeHomepageUrl !== '#') {
                     window.open(schoolData.collegeHomepageUrl, '_blank');
                     event.preventDefault();
                 }
             }
        }

               function navigateToSeniorPhoto(direction) {
                console.log(`%c[NAV_DEBUG] NAVIGATE START (${direction}) ==================`, "color: blue; font-weight: bold;");
            console.log(`[NAV_DEBUG] Initial currentlyZoomedSeniorOriginalIndex: ${currentlyZoomedSeniorOriginalIndex}`);

            const visibleListItems = getVisibleListItemsDOM();
            console.log(`[NAV_DEBUG] Found ${visibleListItems.length} visible list items.`);
             if (visibleListItems.length > 0) {

            }
            if (visibleListItems.length === 0) {
                 console.warn("[NAV_DEBUG] No visible list items. Navigation aborted.");
                return;
            }
            let currentIndexInVisibleList = -1;
            if (currentlyZoomedSeniorOriginalIndex !== null) {
                currentIndexInVisibleList = visibleListItems.findIndex(li =>
                    parseInt(li.dataset.originalIndex) === currentlyZoomedSeniorOriginalIndex
                );
            }
             console.log(`[NAV_DEBUG] currentIndexInVisibleList (index in visibleListItems for current photo): ${currentIndexInVisibleList}`);

            let newIndexInVisibleList;
            if (currentIndexInVisibleList === -1) {
                newIndexInVisibleList = (direction === 'next') ? 0 : visibleListItems.length - 1;
                console.log(`[NAV_DEBUG] current index was -1, defaulting newIndexInVisibleList to: ${newIndexInVisibleList}`);
            } else {
                if (direction === 'next') {
                    newIndexInVisibleList = (currentIndexInVisibleList + 1) % visibleListItems.length;
                } else {
                    newIndexInVisibleList = (currentIndexInVisibleList - 1 + visibleListItems.length) % visibleListItems.length;
                }
                console.log(`[NAV_DEBUG] Calculated newIndexInVisibleList (0-based in visibleListItems): ${newIndexInVisibleList}`);
            }

            const newListItem = visibleListItems[newIndexInVisibleList];
            if (newListItem) {
                const newOriginalIndex = parseInt(newListItem.dataset.originalIndex);
                console.log(`[NAV_DEBUG] Target newListItem found. Its originalIndex: ${newOriginalIndex}`);
                const newSeniorData = allData[newOriginalIndex];

                if (newSeniorData) {
                      console.log(`[NAV_DEBUG] Navigating to senior: ${newSeniorData.seniorName} (originalIndex: ${newOriginalIndex})`);
                    currentlyZoomedSeniorOriginalIndex = newOriginalIndex; 

                    seniorPopupImage.src = newSeniorData.seniorPhotoUrl;
                     seniorPopupImage.onerror = function() {
                        this.src = newSeniorData.seniorPhotoUrlPng;
                        this.onerror = function() {
                            if (newSeniorData.collegeImageUrl && newSeniorData.collegeImageUrl !== 'x' && !newSeniorData.collegeImageUrl.startsWith('placeholder')) {
                                this.src = newSeniorData.collegeImageUrl;
                            } else { this.style.display = 'none'; }
                            this.onerror = null;
                        };
                    };
                    seniorPopupImage.alt = `${newSeniorData.seniorName}'s Photo / ${newSeniorData.collegeName} Logo`;

                    currentListSelectionIndex = newIndexInVisibleList;
                    updateCurrentSelectionHighlight(); 
                    newListItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     newListItem.focus(); 

                      console.log(`[NAV_DEBUG] Calling handleListItemInteraction for originalIndex: ${newOriginalIndex}. This should update currentlyZoomedSeniorOriginalIndex.`);
                    handleListItemInteraction({ currentTarget: newListItem, target: newListItem, ctrlKey: false, metaKey: false }, newOriginalIndex, false);

                     console.log(`[NAV_DEBUG] currentlyZoomedSeniorOriginalIndex *after* handleListItemInteraction: ${currentlyZoomedSeniorOriginalIndex}`);
                    if (currentlyZoomedSeniorOriginalIndex !== newOriginalIndex) {
                        console.error(`[NAV_DEBUG] CRITICAL MISMATCH! Expected currentlyZoomedSeniorOriginalIndex to be ${newOriginalIndex}, but it is ${currentlyZoomedSeniorOriginalIndex}. This is the cause of skipping!`);

                    }

                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== newOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    if (allMarkers[newOriginalIndex]?.marker && allData[newOriginalIndex]) {
                         allMarkers[newOriginalIndex].marker.setIcon(getMarkerIcon(allData[newOriginalIndex], true, isDarkMode));
                         allMarkers[newOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                         activeHoverMarkerIndex = newOriginalIndex;
                    }
                } else {
                    console.warn(`[NAV_DEBUG] WARN: No senior data found for newOriginalIndex: ${newOriginalIndex}`);
                }
            } else {
                console.warn(`[NAV_DEBUG] WARN: newListItem is undefined for newIndexInVisibleList: ${newIndexInVisibleList}. This might happen if visibleListItems is unexpectedly empty or index is out of bounds.`);
            }
            console.log(`%c[NAV_DEBUG] NAVIGATE END (${direction}) ====================`, "color: blue; font-weight: bold;");
        }

        function zoomToSelectedSchools() {
            if (!google || !map || !allMarkers) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            schoolsSelectedForZoom.forEach(originalIndex => {
                const schoolData = allData[originalIndex];
                const markerInfo = allMarkers[originalIndex];

                if (schoolData && schoolData.isVisible && markerInfo && markerInfo.marker) {
                    if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {

                    } else if (schoolData.lat === 0 && schoolData.lng === 0) {
                        console.warn("Skipping school with 0,0 coordinates from zoom:", schoolData.displayName);
                    }
                    else {
                        bounds.extend(markerInfo.marker.getPosition());
                        validVisiblePoints++;
                    }
                }
            });

            if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }

        function zoomToAllVisibleMarkers() {
            if (!google || !map || !allMarkers || !allData) return;
            const bounds = new google.maps.LatLngBounds();
            let validVisiblePoints = 0;

            allData.forEach(schoolData => {
                if (schoolData.isVisible) {
                    const markerInfo = allMarkers[schoolData.originalIndex];
                     if (markerInfo && markerInfo.marker) {
                        if (schoolData.collegeName === "Undecided" && schoolData.lat === 0 && schoolData.lng === 0) {

                        } else if (schoolData.lat === 0 && schoolData.lng === 0) {

                        } else {
                            bounds.extend(markerInfo.marker.getPosition());
                            validVisiblePoints++;
                        }
                    }
                }
            });
             if (validVisiblePoints > 0) {
                map.fitBounds(bounds);
                if (validVisiblePoints === 1 && map.getZoom() > 15) {
                    map.setZoom(15);
                } else if (map.getZoom() > 17) {
                    map.setZoom(17);
                }
            } else {
                map.setCenter({ lat: 41.8, lng: -74.5 });
                map.setZoom(7);
            }
        }

        function hideSeniorPhotoPopup() {
    if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
        seniorPhotoPopup.classList.remove('visible'); 

        seniorPhotoPopup.style.width = ''; 
        seniorPhotoPopup.style.maxHeight = '';
        seniorPhotoPopup.style.overflowY = '';
        seniorPhotoPopup.style.left = ''; 
        seniorPhotoPopup.style.top = '';  

        if (seniorPopupImage) {
            seniorPopupImage.style.maxHeight = ''; 
            if (seniorPopupImage.classList.contains('zoomed')) {

                exitZoomMode(false); 
            }
        }

        if (currentlyZoomedSeniorOriginalIndex !== null && 
            activeHoverMarkerIndex === currentlyZoomedSeniorOriginalIndex && 
            allMarkers[activeHoverMarkerIndex] && 
            allMarkers[activeHoverMarkerIndex].marker) {

            const schoolData = allData[activeHoverMarkerIndex];
            if (schoolData) { 
                allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
            }
            activeHoverMarkerIndex = null; 
        }

        currentlyZoomedSeniorOriginalIndex = null; 

        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'none';
        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'none';
    }
}

        function handleSearchInput() {
             const input = document.getElementById('schoolSearchInput');
             const suggestionsDiv = document.getElementById('searchSuggestions');
             const searchTerm = input.value.toLowerCase().trim();

             suggestionsDiv.innerHTML = '';
             suggestionsDiv.style.display = 'none';

             if (searchTerm.length < 2) {
                filterSchoolList();
                return;
             }

             if (!allData) return;

             const matchingEntries = allData.filter(entry =>
                entry.isVisible &&
                 (
                    (entry.seniorName && entry.seniorName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeName && entry.collegeName.toLowerCase().includes(searchTerm)) ||
                    (entry.collegeNameRaw && entry.collegeNameRaw.toLowerCase().includes(searchTerm)) ||
                    (entry.major && entry.major.toLowerCase().includes(searchTerm)) ||
                    (entry.majorArea && entry.majorArea.toLowerCase().includes(searchTerm))
                )
             ).slice(0, 10);

             if (matchingEntries.length > 0) {
                 matchingEntries.forEach(entry => {
                     const div = document.createElement('div');
                     const suffixHtml = getHonorarySuffixHTML(entry.collegeNameRaw);
                     div.innerHTML = `${entry.seniorName} (${entry.gradClass}) → ${entry.collegeName}${suffixHtml} (${entry.major || 'Undecided'})`;

                     div.onclick = () => {
                         input.value = entry.seniorName;
                         suggestionsDiv.style.display = 'none';
                         filterSchoolList();

                         const clickedOriginalIndex = entry.originalIndex;
                         const listItem = document.querySelector(`.list-content li[data-original-index="${clickedOriginalIndex}"]`);
                         if (listItem) {
                            handleListItemInteraction({ currentTarget: listItem, target: listItem, ctrlKey: false, metaKey: false }, clickedOriginalIndex, false);
                            listItem.scrollIntoView({behavior: 'smooth', block: 'nearest'});

                            const listUl = document.querySelector('#school-list-control .list-content ul');
                            const visibleListItemsAfterSearch = getVisibleListItemsDOM();
                            currentListSelectionIndex = visibleListItemsAfterSearch.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                            if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                                allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                                allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                            }
                            if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                                allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                                allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                                activeHoverMarkerIndex = clickedOriginalIndex;
                            }
                            updateCurrentSelectionHighlight();
                         }
                     };
                     suggestionsDiv.appendChild(div);
                 });
                 suggestionsDiv.style.display = 'block';
             }
             filterSchoolList();
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function sortAndRebuildList() {

        if (!allData) return;

        allData.sort((a, b) => {
            let comparison = 0;
            const gradClassA = parseInt(a.gradClass.substring(1));
            const gradClassB = parseInt(b.gradClass.substring(1));
            const firstNameA = getFirstName(a.seniorName);
            const firstNameB = getFirstName(b.seniorName);
            const lastNameA = getLastName(a.seniorName);
            const lastNameB = getLastName(b.seniorName);

            switch (currentStudentSortValue) { 
            case 'grad_first':
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = firstNameA.localeCompare(firstNameB);
                break;
            case 'grad_last':
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = lastNameA.localeCompare(lastNameB);
                if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                break;
            case 'first_name':
                comparison = firstNameA.localeCompare(firstNameB);
                if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB);
                break;
            case 'last_name':
                comparison = lastNameA.localeCompare(lastNameB);
                if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB);
                break;
            default:
                if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                comparison = firstNameA.localeCompare(firstNameB);
                break;
        }
        return comparison;
    });

        rebuildSchoolListHTML(); 
        currentListSelectionIndex = -1;
        updateCurrentSelectionHighlight();
    }

    function rebuildSchoolListHTML() {
        const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
        if (!schoolListCollapsibleContentDiv) {
            console.error("School list collapsible content div not found.");
            return;
        }
        let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
        const noResultsMessage = document.getElementById('no-results-message');

        if (!schoolListUl) {
            schoolListUl = document.createElement('ul');
            schoolListCollapsibleContentDiv.insertBefore(schoolListUl, noResultsMessage);
        }
        schoolListUl.innerHTML = ''; 

        if (!allData) {
            schoolListUl.innerHTML = '<li>Data is not available.</li>';
            if (noResultsMessage) noResultsMessage.style.display = 'none';
            return;
        }

        if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
            allData.forEach(seniorChoice => {
                if (seniorChoice.isVisible) { 
                    schoolListUl.appendChild(createStudentListItem(seniorChoice));
                }
            });
        } else { 
            const studentGroupsByCollege = new Map();
            allData.forEach(seniorChoice => {
                if (seniorChoice.isVisible) { 
                    const groupKey = seniorChoice.collegeKey || seniorChoice.collegeName;
                    if (!studentGroupsByCollege.has(groupKey)) {
                        studentGroupsByCollege.set(groupKey, { students: [], collegeInfo: seniorChoice });
                    }
                    studentGroupsByCollege.get(groupKey).students.push(seniorChoice);
                }
            });

            let collegeEntries = Array.from(studentGroupsByCollege.entries()).map(([key, data]) => {
                const collegeDetail = collegeCoordsAndInfo[key] || { name: data.collegeInfo.collegeName };
                return {
                    groupKey: key,
                    displayName: collegeDetail.name,
                    students: data.students
                };
            });

            collegeEntries.sort((entryA, entryB) => {
                const nameA = entryA.displayName.toLowerCase();
                const nameB = entryB.displayName.toLowerCase();
                const countA = entryA.students.length;
                const countB = entryB.students.length;
                switch (currentCollegeSortValue) {
                    case 'name_asc': return nameA.localeCompare(nameB);
                    case 'name_desc': return nameB.localeCompare(nameA);
                    case 'count_desc': return countB - countA || nameA.localeCompare(nameB);
                    case 'count_asc': return countA - countB || nameA.localeCompare(nameB);
                    default: return nameA.localeCompare(nameB);
                }
            });

            collegeEntries.forEach(collegeEntry => {
                const collegeHeaderLi = document.createElement('li');
                collegeHeaderLi.className = 'college-group-header';
                collegeHeaderLi.innerHTML = `${collegeEntry.displayName} <span style="font-weight:normal;">(Students: ${collegeEntry.students.length})</span>`;
                schoolListUl.appendChild(collegeHeaderLi);

                collegeEntry.students.sort((a, b) => { 
                    let comparison = 0;
                    const gradClassA = parseInt(a.gradClass.substring(1));
                    const gradClassB = parseInt(b.gradClass.substring(1));
                    const firstNameA = getFirstName(a.seniorName);
                    const firstNameB = getFirstName(b.seniorName);
                    const lastNameA = getLastName(a.seniorName);
                    const lastNameB = getLastName(b.seniorName);
                    switch (currentStudentSortValue) {
                        case 'grad_first':
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = firstNameA.localeCompare(firstNameB); break;
                        case 'grad_last':
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = lastNameA.localeCompare(lastNameB);
                            if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB); break;
                        case 'first_name':
                            comparison = firstNameA.localeCompare(firstNameB);
                            if (comparison === 0) comparison = lastNameA.localeCompare(lastNameB); break;
                        case 'last_name':
                            comparison = lastNameA.localeCompare(lastNameB);
                            if (comparison === 0) comparison = firstNameA.localeCompare(firstNameB); break;
                        default:
                            if (gradClassA !== gradClassB) return gradClassA - gradClassB;
                            comparison = firstNameA.localeCompare(firstNameB); break;
                    }
                    return comparison;
                });

                const studentSublistUl = document.createElement('ul');
                studentSublistUl.className = 'student-sublist';
                collegeEntry.students.forEach(student => { 
                    studentSublistUl.appendChild(createStudentListItem(student)); 
                });
                schoolListUl.appendChild(studentSublistUl);
            });
        }
        filterSchoolList();
        updateCurrentSelectionHighlight();
    }

        function createStudentListItem(seniorChoice) {
            const studentLi = document.createElement('li');
            const originalIndex = seniorChoice.originalIndex;
            studentLi.setAttribute('data-original-index', originalIndex);
            studentLi.setAttribute('tabindex', '0');

            let liTitle = "Click: Zoom & Info. Ctrl+Click: Homepage. Hover: Photo.";
            if (isGalleryViewEnabled) {
                liTitle += " Shift+Click checkbox: Group Zoom.";
            }
            studentLi.setAttribute('title', liTitle);

            const schoolCheckbox = document.createElement('input');
            schoolCheckbox.type = 'checkbox';
            schoolCheckbox.id = `school-checkbox-${originalIndex}`;
            schoolCheckbox.className = 'school-select-checkbox';
            schoolCheckbox.checked = schoolsSelectedForZoom.has(originalIndex);
            schoolCheckbox.title = `Select for Group Zoom (Shift+Click to toggle all for '${seniorChoice.collegeName}')`;

            schoolCheckbox.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                if (isChecked) {
                    schoolsSelectedForZoom.add(originalIndex);
                } else {
                    schoolsSelectedForZoom.delete(originalIndex);
                }

                if (event.shiftKey && seniorChoice.collegeName !== "Undecided") {
                    const allStudentsAtThisCollege = allData.filter(s =>
                        s.isVisible &&
                        s.collegeName === seniorChoice.collegeName
                    );
                    allStudentsAtThisCollege.forEach(student => {
                        const studentCheckboxInDOM = document.getElementById(`school-checkbox-${student.originalIndex}`);
                        if (isChecked) {
                            schoolsSelectedForZoom.add(student.originalIndex);
                            if (studentCheckboxInDOM) studentCheckboxInDOM.checked = true;
                        } else {
                            schoolsSelectedForZoom.delete(student.originalIndex);
                            if (studentCheckboxInDOM) studentCheckboxInDOM.checked = false;
                        }
                    });
                    zoomToSelectedSchools();
                }
            });

            const nameSpan = document.createElement('span');
            nameSpan.className = 'school-name';

            let studentDisplayText = `${seniorChoice.seniorName} <span style="color: ${gradClassColors[seniorChoice.gradClass] || '#ccc'}; font-weight: bold;">(${seniorChoice.gradClass})</span>`;
            const individualSuffixHtml = getHonorarySuffixHTML(seniorChoice.collegeNameRaw);

            if (isGalleryViewEnabled || currentPrimarySortTarget === 'students') {
                studentDisplayText += ` → ${seniorChoice.collegeName}`;
            }
            studentDisplayText += ` <span class="list-item-major">(${(seniorChoice.major || 'Undecided Major')})</span>`;
            if (individualSuffixHtml) {
                 studentDisplayText += individualSuffixHtml;
            }
            nameSpan.innerHTML = studentDisplayText; 

            if (seniorChoice.linkedInUrl) {
                const linkedInLink = document.createElement('a');
                linkedInLink.href = seniorChoice.linkedInUrl;
                linkedInLink.target = "_blank";
                linkedInLink.title = "LinkedIn Profile";
                linkedInLink.classList.add("social-icon-link");
                linkedInLink.innerHTML = createSocialLinkSVG('linkedin', 16, isDarkMode);
                nameSpan.appendChild(linkedInLink);
            }
            if (seniorChoice.instagramUrl) {
                const instagramLink = document.createElement('a');
                instagramLink.href = seniorChoice.instagramUrl;
                instagramLink.target = "_blank";
                instagramLink.title = "Instagram Profile";
                instagramLink.classList.add("social-icon-link");
                instagramLink.innerHTML = createSocialLinkSVG('instagram', 16, isDarkMode);
                nameSpan.appendChild(instagramLink);
            }

            if (isGalleryViewEnabled) {
                studentLi.style.backgroundColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
                studentLi.appendChild(schoolCheckbox); 

                const gradClassTextElement = document.createElement('div');
                gradClassTextElement.className = 'gallery-grad-class-overlay';
                gradClassTextElement.textContent = seniorChoice.gradClass;
                const bgColor = gradClassColors[seniorChoice.gradClass] || '#cccccc';
                if (bgColor.startsWith('#')) {
                    const r = parseInt(bgColor.slice(1, 3), 16);
                    const g = parseInt(bgColor.slice(3, 5), 16);
                    const b = parseInt(bgColor.slice(5, 7), 16);
                    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                    gradClassTextElement.style.color = brightness > 135 ? '#1A1A1A' : '#FAFAFA';
                } else {
                    gradClassTextElement.style.color = '#FFFFFF'; 
                }
                studentLi.appendChild(gradClassTextElement);

                const galleryPhotoDiv = document.createElement('div');
                galleryPhotoDiv.className = 'gallery-photo-div';
                const galleryImg = document.createElement('img');
                galleryImg.className = 'gallery-photo';
                galleryImg.src = seniorChoice.seniorPhotoUrl;
                galleryImg.alt = `${seniorChoice.seniorName}'s Photo`;
                galleryImg.onerror = function() {
                    this.src = seniorChoice.seniorPhotoUrlPng; 
                    this.onerror = function() { 
                        this.src = seniorChoice.collegeImageUrl && !seniorChoice.collegeImageUrl.startsWith('placeholder') ? seniorChoice.collegeImageUrl : 'placeholder-logo.png'; 
                        this.onerror = null; 
                    };
                };
                galleryPhotoDiv.appendChild(galleryImg);
                studentLi.appendChild(galleryPhotoDiv);

            } else { 

                studentLi.appendChild(nameSpan);
            }

            studentLi.addEventListener('mouseenter', (event) => {
                if (panelJustToggledOpen) return;

                const currentOriginalIndex = originalIndex;
                const schoolData = allData[currentOriginalIndex];
                const markerInfo = allMarkers[currentOriginalIndex];
                if (markerInfo?.marker && schoolData?.isVisible) {
                    markerInfo.marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                    markerInfo.marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                    handleListItemInteraction(event, currentOriginalIndex, true);
                }
                studentLi.classList.add('list-item-highlight');
            });
            studentLi.addEventListener('mouseleave', (event) => {
                const currentOriginalIndex = originalIndex;
                const schoolData = allData[currentOriginalIndex];
                const markerInfo = allMarkers[currentOriginalIndex];

                let isKeyboardSelected = false;
                if (currentListSelectionIndex !== -1) {
                    const visibleLIs = getVisibleListItemsDOM();
                    if (currentListSelectionIndex < visibleLIs.length) {
                        const kbdSelectedLi = visibleLIs[currentListSelectionIndex];
                        if (kbdSelectedLi && parseInt(kbdSelectedLi.dataset.originalIndex) === currentOriginalIndex) {
                            isKeyboardSelected = true;
                        }
                    }
                }

                if (!isKeyboardSelected && markerInfo?.marker && schoolData && activeHoverMarkerIndex !== currentOriginalIndex) {
                    markerInfo.marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                    markerInfo.marker.setZIndex(null);
                }
                 if (!isKeyboardSelected) {
                    studentLi.classList.remove('list-item-highlight');
                }
            });
            studentLi.addEventListener('click', (event) => {

                if (event.target.type === 'checkbox' && studentLi.contains(event.target)) return;

                const clickedOriginalIndex = originalIndex;
                handleListItemInteraction(event, clickedOriginalIndex, false);

                const visibleListItems = getVisibleListItemsDOM();
                currentListSelectionIndex = visibleListItems.findIndex(li => li === studentLi);

                if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                }
                if (allMarkers[clickedOriginalIndex]?.marker && allData[clickedOriginalIndex]) {
                     allMarkers[clickedOriginalIndex].marker.setIcon(getMarkerIcon(allData[clickedOriginalIndex], true, isDarkMode));
                     allMarkers[clickedOriginalIndex].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                     activeHoverMarkerIndex = clickedOriginalIndex;
                }
                updateCurrentSelectionHighlight();
            });
            return studentLi;
        }

        function updateCurrentSelectionHighlight() {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const allEntryListItems = Array.from(listUl.querySelectorAll('li:not(.grad-class-separator)'));

            allEntryListItems.forEach(item => {
                item.classList.remove('current-selection-highlight');
                item.classList.remove('list-item-highlight');
            });

            const visibleListItems = getVisibleListItemsDOM();

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const selectedLi = visibleListItems[currentListSelectionIndex];
                if (selectedLi) {
                    selectedLi.classList.add('current-selection-highlight');
                }
            }
        }

        function navigateList(direction) {
            const listUl = document.querySelector('#school-list-control .list-content ul');
            if (!listUl) return;

            const visibleListItems = getVisibleListItemsDOM();

            if (visibleListItems.length === 0) {
                if (activeHoverMarkerIndex !== null && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                    allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                    allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                }
                activeHoverMarkerIndex = null;
                currentListSelectionIndex = -1;
                updateCurrentSelectionHighlight();
                return;
            }

            let newVisibleIndex = currentListSelectionIndex;

            if (newVisibleIndex === -1) {
                newVisibleIndex = (direction === 'down') ? 0 : visibleListItems.length - 1;
            } else {
                if (direction === 'down') {
                    newVisibleIndex = (newVisibleIndex + 1) % visibleListItems.length;
                } else if (direction === 'up') {
                    newVisibleIndex = (newVisibleIndex - 1 + visibleListItems.length) % visibleListItems.length;
                }
            }

            if (currentListSelectionIndex !== -1 && currentListSelectionIndex < visibleListItems.length) {
                const previouslySelectedLi = visibleListItems[currentListSelectionIndex];
                if (previouslySelectedLi) {
                    const prevOriginalIndex = parseInt(previouslySelectedLi.dataset.originalIndex);
                    const newOriginalIndexIfKnown = visibleListItems[newVisibleIndex] ? parseInt(visibleListItems[newVisibleIndex].dataset.originalIndex) : -1;

                    if (!isNaN(prevOriginalIndex) && allMarkers[prevOriginalIndex]?.marker && allData[prevOriginalIndex]) {
                         if(prevOriginalIndex !== newOriginalIndexIfKnown && prevOriginalIndex !== activeHoverMarkerIndex) {
                            allMarkers[prevOriginalIndex].marker.setIcon(getMarkerIcon(allData[prevOriginalIndex], false, isDarkMode));
                            allMarkers[prevOriginalIndex].marker.setZIndex(null);
                         }
                    }
                }
            }

            currentListSelectionIndex = newVisibleIndex;
            const selectedLi = visibleListItems[currentListSelectionIndex];

            if (selectedLi) {
                const originalIndexOfNewSelection = parseInt(selectedLi.dataset.originalIndex);
                if (!isNaN(originalIndexOfNewSelection) && allData[originalIndexOfNewSelection]) {
                    handleListItemInteraction({ currentTarget: selectedLi, target: selectedLi, ctrlKey: false, metaKey: false }, originalIndexOfNewSelection, false);
                    selectedLi.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    selectedLi.focus();

                    if (allMarkers[originalIndexOfNewSelection]?.marker) {
                        allMarkers[originalIndexOfNewSelection].marker.setIcon(getMarkerIcon(allData[originalIndexOfNewSelection], true, isDarkMode));
                        allMarkers[originalIndexOfNewSelection].marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                        if(activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== originalIndexOfNewSelection && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                             allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                             allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                        }
                        activeHoverMarkerIndex = originalIndexOfNewSelection;
                    }
                }
            }
            updateCurrentSelectionHighlight();
        }

        async function initializeApp() {
    try {
        const response = await fetch('jsonData.json'); 
        if (!response.ok) {
            throw new Error(`Failed to fetch jsonData.json: ${response.status} ${response.statusText}`);
        }
        const jsonDataFromFile = await response.json(); 

        console.log("[DEBUG] Attempting to initialize seniorCollegeChoices and allData from jsonData.json...");

        seniorCollegeChoices = parseRawData(jsonDataFromFile);

        if (!Array.isArray(seniorCollegeChoices)) {
            console.error("[DEBUG] parseRawData did not return an array. Value:", seniorCollegeChoices);
            throw new Error("Data parsing failed: seniorCollegeChoices is not an array.");
        }
        console.log(`[DEBUG] seniorCollegeChoices initialized. Length: ${seniorCollegeChoices.length}`);

        console.log("[DEBUG] Initializing allData by mapping seniorCollegeChoices...");
        allData = seniorCollegeChoices.map((choice, index) => {
            if (!choice || typeof choice !== 'object') {
                console.error(`[DEBUG] Malformed item in seniorCollegeChoices at index ${index}:`, choice);

                return { 
                    displayName: `Error - Malformed Data (Index ${index})`, 
                    originalIndex: index, 
                    isVisible: false, 
                    majorArea: "Unknown" 
                };
            }

            if (typeof choice.seniorName !== 'string' || typeof choice.gradClass !== 'string' || typeof choice.collegeName !== 'string') {
                console.warn(`[DEBUG] Item with missing/invalid essential string properties in seniorCollegeChoices at index ${index}. Item:`, choice);
                return { 
                    ...choice, 
                    displayName: `Error - Missing Properties (Index ${index})`, 
                    originalIndex: index, 
                    isVisible: false,
                    majorArea: getMajorArea(choice.major) 
                };
            }
            const majorArea = getMajorArea(choice.major); 
            return {
                ...choice,
                displayName: `${choice.seniorName} (${choice.gradClass}) → ${choice.collegeName}`,
                originalIndex: index,
                isVisible: true, 
                majorArea: majorArea
            };

        }).filter(item => item && item.displayName && !item.displayName.startsWith("Error -")); 

        console.log(`[DEBUG] allData initialized. Length: ${allData.length}`);

        if (!allData || !Array.isArray(allData)) { 
            console.error("[DEBUG] allData is not a valid array after mapping.");
            throw new Error("allData initialization failed: result is not an array.");
        }
        console.log(`[DEBUG] Global: allData initialized successfully with ${allData.length} items.`);
        window.isDataReadyForMap = true;

    } catch (error) {
        console.error("CRITICAL ERROR during application data initialization:", error.message, error.stack);
        const criticalErrorDiv = document.createElement('div');
        criticalErrorDiv.id = "critical-initialization-error-message";
        criticalErrorDiv.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; background-color: #ffdddd; border-bottom: 2px solid red; padding: 15px; text-align: center; z-index: 10000; color: black; font-family: sans-serif;";
        criticalErrorDiv.innerHTML = `
            <h2 style="margin-top:0; color: red;">Application Initialization Error</h2>
            <p>There was a critical error while preparing the application's core data. The map functionality will be severely limited or unavailable.</p>
            <p><strong>Error details:</strong> ${error.message}</p>
            <p>Please check the browser's developer console for more technical information (specifically, look for errors logged *before* any 'initMap' errors).</p>`;

        if (document.body) {
            if (!document.getElementById("critical-initialization-error-message")) {
                 document.body.prepend(criticalErrorDiv);
            }
        } else {
            window.addEventListener('DOMContentLoaded', () => {
                if (document.body && !document.getElementById("critical-initialization-error-message")) {
                    document.body.prepend(criticalErrorDiv);
                }
            });
             setTimeout(() => { 
                 if (!document.getElementById("critical-initialization-error-message")) {
                    alert("CRITICAL ERROR during application data initialization: " + error.message + ". Check console.");
                 }
            }, 500);
        }
        window.isDataReadyForMap = false;
    }

    initMap();
}
let nestmMarker, distancePolyline, distanceLabel;
        const NEST_M_INFO = {
            name: "NEST+m",
            lat: 40.71956425410874, 
            lng: -73.97923619240517,
            imageUrl: "photos/NEST+m_Logo.png",
            homepageUrl: "https://nestmk12.net/",
            type: "K-12 School",
            stateOrCountry: "NY"
        };

                                                           function initMap() {
            console.log("[DEBUG] initMap function called.");

            if (!window.isDataReadyForMap || !allData || !Array.isArray(allData)) {
                console.error("[DEBUG] initMap: Data is not ready or allData is invalid. Aborting map initialization.");
                const mapDiv = document.getElementById("map");
                if (mapDiv) {
                    mapDiv.innerHTML = `<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;"><strong>Error: Map data is not available or is invalid.</strong><br>The map cannot be initialized. This usually indicates a problem during the initial data loading and processing phase.<br>Please check the browser's developer console for more detailed error messages that might have occurred before this point.</p>`;
                }
                const controlsContainer = document.getElementById('controls-and-list-container');
                if (controlsContainer) {
                    controlsContainer.style.opacity = '0.5';
                    controlsContainer.style.pointerEvents = 'none';
                }
                return;
            }
            console.log(`[DEBUG] initMap: Data is ready. Proceeding with allData containing ${allData.length} items.`);

            // Define DistanceLabel class here, after google object is available
            class DistanceLabel extends google.maps.OverlayView {
                constructor(position, text) {
                    super();
                    this.position = position;
                    this.text = text;
                    this.div = null;
                }
                onAdd() {
                    this.div = document.createElement("div");
                    this.div.style.position = "absolute";
                    this.div.style.background = isDarkMode ? "rgba(40, 40, 40, 0.9)" : "rgba(255, 255, 255, 0.9)";
                    this.div.style.color = isDarkMode ? "#e0e0e0" : "#333";
                    this.div.style.padding = "4px 8px";
                    this.div.style.border = isDarkMode ? "1px solid #555" : "1px solid #777";
                    this.div.style.borderRadius = "4px";
                    this.div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
                    this.div.style.fontSize = "0.85em";
                    this.div.style.whiteSpace = "nowrap";
                    this.div.style.zIndex = "1000";
                    this.div.innerHTML = this.text;

                    const closeButton = this.div.querySelector("#close-distance-label");
                    if (closeButton) {
                        closeButton.addEventListener("click", (e) => {
                            e.stopPropagation();
                            if (distancePolyline) distancePolyline.setMap(null);
                            this.setMap(null);
                        });
                    }

                    const panes = this.getPanes();
                    panes.floatPane.appendChild(this.div);
                }
                draw() {
                    const overlayProjection = this.getProjection();
                    const point = overlayProjection.fromLatLngToDivPixel(this.position);
                    if (point) {
                        this.div.style.left = point.x + 10 + "px";
                        this.div.style.top = point.y - 15 + "px";
                    }
                }
                onRemove() {
                    if (this.div) {
                        this.div.parentNode.removeChild(this.div);
                        this.div = null;
                    }
                }
                updateText(text) {
                    this.text = text;
                    if (this.div) {
                        this.div.innerHTML = this.text;
                    }
                }
            }

            function showDistanceToNestm(collegeData) {
                if (distancePolyline) distancePolyline.setMap(null);
                if (distanceLabel) distanceLabel.setMap(null);

                console.log("[DistanceDebug] Called showDistanceToNestm for:", collegeData.collegeName);

                if (!nestmMarker || !nestmMarker.getVisible() || !collegeData || collegeData.lat === 0) {
                    console.log("[DistanceDebug] Aborting: NEST+m marker not visible or college data invalid.");
                    return;
                }

                if (!google.maps.geometry || !google.maps.geometry.spherical) {
                    console.error("[DistanceDebug] CRITICAL: google.maps.geometry.spherical library not loaded. Please add '&libraries=geometry' to the Google Maps API script URL.");
                    return;
                }

                const collegePosition = new google.maps.LatLng(collegeData.lat, collegeData.lng);
                const nestmPosition = nestmMarker.getPosition();
                const path = [nestmPosition, collegePosition];

                distancePolyline = new google.maps.Polyline({
                    path: path,
                    geodesic: true,
                    strokeColor: '#8A2BE2', // Purple
                    strokeOpacity: 0.9,
                    strokeWeight: 2.5,
                    map: map
                });

                const distanceInMeters = google.maps.geometry.spherical.computeDistanceBetween(nestmPosition, collegePosition);
                const distanceInMiles = distanceInMeters * 0.000621371;
                const distanceInKm = distanceInMeters / 1000;

                console.log(`[DistanceDebug] Distance in meters: ${distanceInMeters}, miles: ${distanceInMiles}, km: ${distanceInKm}`);

                const midPoint = google.maps.geometry.spherical.interpolate(nestmPosition, collegePosition, 0.5);
                const labelText = `
                    ${distanceInMiles.toFixed(1)} mi / ${distanceInKm.toFixed(1)} km to NEST+m
                    <span id="close-distance-label" style="cursor: pointer; font-weight: bold; margin-left: 8px; color: #FF6347;" title="Dismiss">×</span>
                `;
                
                console.log("[DistanceDebug] Creating label with text:", labelText.trim());
                distanceLabel = new DistanceLabel(midPoint, labelText);
                distanceLabel.setMap(map);
            }

            stateCountryFilterState = {}; 

            const stateCountryFiltersContainer = document.getElementById('state-country-filters-container');
            if (stateCountryFiltersContainer && allData && allData.length > 0) {
                const uniqueStateCountries = new Set();
                const UNKNOWN_STATE_COUNTRY_KEY = "Unknown/Not Applicable";

                allData.forEach(school => {
                    if (school.collegeName === "Undecided") { 
                         uniqueStateCountries.add(UNKNOWN_STATE_COUNTRY_KEY);
                         return;
                    }
                    const stateCountry = school.stateOrCountry;
                    if (stateCountry && stateCountry.trim() !== "" && stateCountry !== "N/A") {
                        uniqueStateCountries.add(stateCountry.trim());
                    } else {
                        uniqueStateCountries.add(UNKNOWN_STATE_COUNTRY_KEY);
                    }
                });

                const sortedStateCountries = Array.from(uniqueStateCountries).sort((a, b) => {
                    if (a === UNKNOWN_STATE_COUNTRY_KEY) return 1; 
                    if (b === UNKNOWN_STATE_COUNTRY_KEY) return -1;
                    return a.localeCompare(b);
                });

                const fragmentStateCountryFilters = document.createDocumentFragment();
                                sortedStateCountries.forEach(scName => {
                    stateCountryFilterState[scName] = true; 

                    const filterId = `filter-sc-${scName.replace(/\W+/g, '-')}`;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'filter-item'; 

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = filterId;
                    checkbox.value = scName;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', (event) => {
                        stateCountryFilterState[scName] = event.target.checked;
                        updateMarkersVisibility();

                    });

                    const label = document.createElement('label');
                    label.htmlFor = filterId;

                    const studentCountForSC = allData.filter(s => {
                        const studentActualSCKey = (s.stateOrCountry && s.stateOrCountry.trim() !== "" && s.stateOrCountry !== "N/A") 
                                                 ? s.stateOrCountry.trim() 
                                                 : UNKNOWN_STATE_COUNTRY_KEY;

                        return studentActualSCKey === scName;
                    }).length;

                    label.appendChild(document.createTextNode(` ${scName} (${studentCountForSC})`));

                    itemDiv.appendChild(checkbox);
                    itemDiv.appendChild(label);
                    fragmentStateCountryFilters.appendChild(itemDiv);
                });
                stateCountryFiltersContainer.appendChild(fragmentStateCountryFilters);

                document.getElementById('checkAllStateCountryBtn').addEventListener('click', () => {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => {
                        stateCountryFilterState[cb.value] = true;
                        cb.checked = true;
                    });
                    updateMarkersVisibility();
                });
                document.getElementById('uncheckAllStateCountryBtn').addEventListener('click', () => {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => {
                        stateCountryFilterState[cb.value] = false;
                        cb.checked = false;
                    });
                    updateMarkersVisibility();
                });

            } else if (stateCountryFiltersContainer) {
                 stateCountryFiltersContainer.innerHTML = "<p style='font-style:italic; font-size:0.9em; padding:5px;'>No state/country data to filter.</p>";
            }

            document.querySelectorAll('.map-control h4').forEach(header => { 

    if (header.closest('#description-control')) { 
        header.style.cursor = 'default';
        return;
    }

    if (header.closest('#school-list-control') && header.textContent.includes('College List & Seniors')) {
        const schoolListControlDiv = header.closest('#school-list-control');
        const sortControlsContainer = schoolListControlDiv.querySelector('#sort-controls-container');
        const listContentDiv = schoolListControlDiv.querySelector('.list-content');

        if (sortControlsContainer && listContentDiv) {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                sortControlsContainer.classList.toggle('collapsed');
                listContentDiv.classList.toggle('collapsed');
                header.classList.toggle('collapsed'); 

                const toggleSchoolListBtn = document.getElementById('toggleSchoolListBtn');
                if (toggleSchoolListBtn) {
                    const isNowCollapsed = listContentDiv.classList.contains('collapsed');
                    toggleSchoolListBtn.textContent = isNowCollapsed ? 'Show List' : 'Hide List';
                    toggleSchoolListBtn.title = isNowCollapsed ? 'Show college and senior list' : 'Hide college and senior list';
                }
            });

            sortControlsContainer.classList.remove('collapsed');
            listContentDiv.classList.remove('collapsed');
            header.classList.remove('collapsed');
        }
        return; 
    }

    let contentToToggle = header.nextElementSibling;

    while (contentToToggle && !contentToToggle.classList.contains('control-content')) {
        contentToToggle = contentToToggle.nextElementSibling;
    }

    if (contentToToggle && contentToToggle.classList.contains('control-content')) {
        header.style.cursor = 'pointer';
        header.addEventListener('click', () => {
            contentToToggle.classList.toggle('collapsed');
            header.classList.toggle('collapsed'); 
        });
    }
});

            baseMarkerIcon = { path: google.maps.SymbolPath.CIRCLE, fillOpacity: 0.9, strokeWeight: 1.0, scale: 7 };
            highlightedMarkerIcon = { ...baseMarkerIcon, scale: 10, strokeWeight: 2.0 };

            seniorPhotoPopup = document.getElementById('senior-photo-popup');
            if (!seniorPhotoPopup) {
                console.error("[DEBUG] CRITICAL: senior-photo-popup element not found in the DOM!");
                document.getElementById('map').innerHTML = '<p style="color:red; text-align:center;">Error: UI element (senior-photo-popup) missing. Cannot initialize map features.</p>';
                return;
            }

            seniorPopupImage = seniorPhotoPopup.querySelector('img');
            seniorPopupCaption = document.getElementById('senior-photo-caption');
            closeSeniorPhotoBtn = document.getElementById('close-senior-photo-popup');
            zoomExitNote = document.getElementById('zoom-exit-note');
            prevSeniorPhotoBtn = document.getElementById('prev-senior-photo');
            nextSeniorPhotoBtn = document.getElementById('next-senior-photo');
            zoomedGradClassInfoDiv = document.getElementById('zoomed-grad-class-info');
         zoomedGradClassValueSpan = document.getElementById('zoomed-grad-class-value');

         if (!zoomedGradClassInfoDiv || !zoomedGradClassValueSpan) console.error("[DEBUG] CRITICAL: Zoomed grad class info elements not found!");

            if (!seniorPopupImage) console.error("[DEBUG] CRITICAL: senior-photo-popup img element not found!");
            if (!seniorPopupCaption) console.error("[DEBUG] CRITICAL: senior-photo-caption element not found!");
            if (!closeSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: close-senior-photo-popup element not found!");
            if (!zoomExitNote) console.error("[DEBUG] CRITICAL: zoom-exit-note element not found!");
            if (!prevSeniorPhotoBtn || !nextSeniorPhotoBtn) console.error("[DEBUG] CRITICAL: Photo navigation arrow buttons not found!");

            photoZoomOverlay = document.createElement('div');
            photoZoomOverlay.id = 'photo-zoom-overlay';
            document.body.appendChild(photoZoomOverlay);

            if (closeSeniorPhotoBtn) closeSeniorPhotoBtn.addEventListener('click', () => exitZoomMode(true));
            if (photoZoomOverlay) photoZoomOverlay.addEventListener('click', () => exitZoomMode(true));
            if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('prev'));
            if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('next'));

            if(zoomExitNote){
                const zoomExitNoteDismissButton = zoomExitNote.querySelector('.dismiss-button');
                if (zoomExitNoteDismissButton) {
                    zoomExitNoteDismissButton.removeAttribute('onclick');
                    zoomExitNoteDismissButton.addEventListener('click', function(event) {
                        event.stopPropagation();
                        this.parentElement.style.display = 'none';
                    });
                }
            }

                        if (seniorPopupImage) {
                seniorPopupImage.addEventListener('click', function(e) {
                    if (e.target === seniorPopupImage && !this.classList.contains('zoomed')) {
                        const parentPopup = this.closest('#senior-photo-popup');
                        parentPopup.classList.add('zoomed-state');

                        parentPopup.dataset.originalTransform = getComputedStyle(parentPopup).transform;
                        parentPopup.dataset.originalLeft = parentPopup.style.left;
                        parentPopup.dataset.originalTop = parentPopup.style.top;
                        parentPopup.dataset.originalWidth = parentPopup.style.width;
                        parentPopup.dataset.originalHeight = parentPopup.style.height;
                        parentPopup.dataset.originalBg = parentPopup.style.backgroundColor;
                        parentPopup.dataset.originalBorder = getComputedStyle(parentPopup).border;
                        parentPopup.dataset.originalBoxShadow = getComputedStyle(parentPopup).boxShadow;
                        parentPopup.dataset.originalPadding = getComputedStyle(parentPopup).padding;
                        parentPopup.dataset.originalPointerEvents = getComputedStyle(parentPopup).pointerEvents || 'auto';

                        parentPopup.style.transform = 'none';
                        parentPopup.style.left = '0px'; parentPopup.style.top = '0px';
                        parentPopup.style.width = '100vw'; parentPopup.style.height = '100vh';
                        parentPopup.style.padding = '0';
                        parentPopup.style.backgroundColor = 'transparent';
                        parentPopup.style.border = 'none'; parentPopup.style.boxShadow = 'none';
                        parentPopup.style.pointerEvents = 'none';

                        this.style.maxWidth = '';
                        this.style.maxHeight = '';

                        if (infowindow && infowindow.getMap()) {
                            infowindow.close();
                        }

                        this.classList.add('zoomed');
                        if (photoZoomOverlay) photoZoomOverlay.style.display = 'block';
                        if (zoomExitNote) zoomExitNote.style.display = 'block';
                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.display = 'block';
                        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.display = 'block';

                        const seniorData = allData[currentlyZoomedSeniorOriginalIndex];
                        const zoomedInfoPanel = document.getElementById('zoomed-info-panel');
                        const zoomedBioCaptionEl = document.getElementById('zoomed-bio-caption-content');
                        const zoomedSocialLinksEl = document.getElementById('zoomed-social-links-container');

                          if (seniorData && zoomedInfoPanel && zoomedBioCaptionEl && zoomedSocialLinksEl) {

                            if (zoomedGradClassInfoDiv && zoomedGradClassValueSpan) {
                                zoomedGradClassValueSpan.textContent = seniorData.gradClass;
                                zoomedGradClassValueSpan.style.color = gradClassColors[seniorData.gradClass] || (isDarkMode ? '#EEE' : '#111'); 
                                zoomedGradClassInfoDiv.style.display = 'block';
                            }

                            zoomedBioCaptionEl.innerHTML = seniorData.bioCaption || `Congrats, ${seniorData.seniorName}!`; 

                             zoomedSocialLinksEl.innerHTML = ''; 
                            if (seniorData.linkedInUrl) {
                                const liLink = document.createElement('a');
                                liLink.href = seniorData.linkedInUrl;
                                liLink.target = "_blank";
                                liLink.title = "LinkedIn Profile";
                                liLink.innerHTML = createSocialLinkSVG('linkedin', 28, isDarkMode, true); 
                                zoomedSocialLinksEl.appendChild(liLink);
                            }
                            if (seniorData.instagramUrl) {
                                const igLink = document.createElement('a');
                                igLink.href = seniorData.instagramUrl;
                                igLink.target = "_blank";
                                igLink.title = "Instagram Profile";
                                igLink.innerHTML = createSocialLinkSVG('instagram', 28, isDarkMode, true); 
                                zoomedSocialLinksEl.appendChild(igLink);
                            }
                            zoomedInfoPanel.style.display = 'block';

                            if(seniorPopupCaption) seniorPopupCaption.style.display = 'none';
                            parentPopup.classList.add('with-side-panel');
                        }

                        this.style.pointerEvents = 'auto';
                        if(seniorPopupCaption) seniorPopupCaption.style.pointerEvents = 'auto';
                        if(closeSeniorPhotoBtn) closeSeniorPhotoBtn.style.pointerEvents = 'auto';

                        if (prevSeniorPhotoBtn) prevSeniorPhotoBtn.style.pointerEvents = 'auto';
                        if (nextSeniorPhotoBtn) nextSeniorPhotoBtn.style.pointerEvents = 'auto';
                    }
                });
            }

            sortAndRebuildList();

            gradClassFilterState = {};
            gradClassNames.forEach(gc => gradClassFilterState[gc] = true);

            const locationFocusKeys = ["InCityNYC", "InStateNYOther", "OutOfStateUS", "International", "N/A"];
            locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);

            PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);

            const mapOptions = {
                center: { lat: 41.8, lng: -74.5 }, zoom: 7,
                mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT },
                styles: null,
                fullscreenControl: true, streetViewControl: true, zoomControl: true, mapTypeControl: true,
                gestureHandling: 'greedy'
            };
            map = new google.maps.Map(document.getElementById("map"), mapOptions); 

            infowindow = new google.maps.InfoWindow();
            schoolsSelectedForZoom = new Set();
            transitLayer = new google.maps.TransitLayer();

            const locationFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            locationFocusCheckboxes.forEach(checkbox => {
                const focusKey = checkbox.dataset.locationFocus;
                checkbox.checked = locationFocusFilterState[focusKey];
                checkbox.addEventListener('change', (event) => {
                    locationFocusFilterState[focusKey] = event.target.checked;
                    updateCheckAllLocationFocusButtonState();
                    updateMarkersVisibility();
                });
            });

            const checkAllLocationFocusBtn = document.getElementById('checkAllLocationFocusBtn');
            checkAllLocationFocusBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                locationFocusCheckboxes.forEach(cb => {
                    const focusKey = cb.dataset.locationFocus;
                    locationFocusFilterState[focusKey] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });
            updateCheckAllLocationFocusButtonState();

            const gradClassFiltersContainer = document.getElementById('grad-class-filters-container');
            const schoolListCollapsibleContentDiv = document.querySelector('#school-list-control .school-list-collapsible-content');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const schoolSearchInput = document.getElementById('schoolSearchInput');
            const listHeaderContainer = document.querySelector('#school-list-control .list-header-container');
            const toggleSchoolListBtn = document.getElementById('toggleSchoolListBtn');
            const toggleSatelliteViewBtn = document.getElementById('toggleSatelliteViewBtn');
            const toggleTransitBtn = document.getElementById('toggleTransitBtn');
            const checkAllGradClassesBtn = document.getElementById('checkAllGradClassesBtn');
            const uncheckAllGradClassesBtn = document.getElementById('uncheckAllGradClassesBtn');
            const zoomToVisibleBtn = document.getElementById('zoomToVisibleBtn');
            const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
            const toggleGalleryViewBtn = document.getElementById('toggleGalleryViewBtn');
            const toggleNestmBtn = document.getElementById('toggleNestmBtn');
            const zoomToNestmBtn = document.getElementById('zoomToNestmBtn');

            gradClassFiltersContainer.innerHTML = '';
            const fragmentGradClassFilters = document.createDocumentFragment();
            gradClassNames.sort().forEach(gcName => {
                const filterId = `filter-grad-${gcName.replace(/\W+/g, '-')}`;
                const itemDiv = document.createElement('div'); itemDiv.className = 'filter-item';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = filterId; checkbox.value = gcName;
                checkbox.checked = gradClassFilterState[gcName];
                checkbox.addEventListener('change', (event) => { gradClassFilterState[gcName] = event.target.checked; updateMarkersVisibility(); });
                const label = document.createElement('label'); label.htmlFor = filterId;
                const colorBox = document.createElement('span'); colorBox.className = 'filter-color-box'; colorBox.style.backgroundColor = gradClassColors[gcName] || '#cccccc';
                label.appendChild(colorBox);
                const seniorCountForClass = allData.filter(s => s.gradClass === gcName).length;
                label.appendChild(document.createTextNode(` ${gcName} (${seniorCountForClass})`));
                itemDiv.appendChild(checkbox); itemDiv.appendChild(label); fragmentGradClassFilters.appendChild(itemDiv);
            });
            gradClassFiltersContainer.appendChild(fragmentGradClassFilters);

            if (listHeaderContainer && !document.getElementById('schoolListTip')) {
                 const tipDiv = document.createElement('div'); tipDiv.id = 'schoolListTip'; tipDiv.className = 'tip-message';
                 const tipText = document.createElement('span');
                 tipText.innerHTML = 'Tips: <br>• Filters update Stats & Major tables.<br>• Checkboxes toggle visibility.<br>• <b>Shift + Click checkbox</b>: Group Zoom.<br>• <b>CTRL/CMD + Click name</b>: College Homepage.<br>• Hover list/marker to highlight & see photo.<br>• Click senior photo to zoom (Esc to close).<br>• Use ↑↓ keys to navigate list; ← → in zoomed photo.<br>• Left panel is resizable.<br>• Explore different sort options for colleges and students!<br>• Dark mode can be easier on the eyes.';
                 const dismissBtn = document.createElement('span'); dismissBtn.className = 'dismiss-button'; dismissBtn.textContent = 'x'; dismissBtn.title = 'Dismiss this tip';
                 dismissBtn.onclick = () => { tipDiv.style.display = 'none'; };
                 tipDiv.appendChild(tipText); tipDiv.appendChild(dismissBtn);
                 listHeaderContainer.insertAdjacentElement('afterend', tipDiv);
            }

            toggleSchoolListBtn.addEventListener('click', () => {
                const listContent = document.querySelector('.school-list-collapsible-content');
                const isHidden = listContent.classList.toggle('hidden');
                toggleSchoolListBtn.textContent = isHidden ? 'Show List' : 'Hide List';
                toggleSchoolListBtn.title = isHidden ? 'Show college and senior list' : 'Hide college and senior list';
            });

            toggleTransitBtn.addEventListener('click', () => {
                if (transitLayerEnabled) {
                    transitLayer.setMap(null); toggleTransitBtn.textContent = '🚇 Show Transit'; toggleTransitBtn.title = 'Show Transit Layer';
                } else {
                    transitLayer.setMap(map); toggleTransitBtn.textContent = '🚇 Hide Transit'; toggleTransitBtn.title = 'Hide Transit Layer';
                }
                transitLayerEnabled = !transitLayerEnabled;
            });

            zoomToVisibleBtn.addEventListener('click', zoomToAllVisibleMarkers);

            if (zoomToNestmBtn) {
                zoomToNestmBtn.addEventListener('click', () => {
                    if (map && nestmMarker) {
                        map.panTo(nestmMarker.getPosition());
                        map.setZoom(16);
                    }
                });
            }

                        if (closeSeniorPhotoBtn) {
                closeSeniorPhotoBtn.addEventListener('click', () => {

                    if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                        exitZoomMode(true); 
                    } else {
                        hideSeniorPhotoPopup(); 
                    }
                });
            }

            clearAllFiltersBtn.addEventListener('click', () => {

                gradClassNames.forEach(gc => gradClassFilterState[gc] = true);
                gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = true);

                locationFocusKeys.forEach(key => locationFocusFilterState[key] = true);
                document.querySelectorAll('.location-focus-filter').forEach(cb => cb.checked = true);
                updateCheckAllLocationFocusButtonState();

                PREDEFINED_MAJOR_AREAS.forEach(area => majorAreaFilterState[area] = true);
                Object.keys(majorAreaFilterState).forEach(area => majorAreaFilterState[area] = true); 
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => cb.checked = true);
                updateCheckAllMajorAreasButtonState();

                Object.keys(stateCountryFilterState).forEach(sc => stateCountryFilterState[sc] = true);
                if (stateCountryFiltersContainer) {
                    stateCountryFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => cb.checked = true);
                }

                schoolSearchInput.value = '';
                updateMarkersVisibility();
            });

            toggleGalleryViewBtn.addEventListener('click', () => {
                isGalleryViewEnabled = !isGalleryViewEnabled;
                const listContentDiv = document.querySelector('#school-list-control .list-content');
                if (listContentDiv) listContentDiv.classList.toggle('gallery-view', isGalleryViewEnabled);
                toggleGalleryViewBtn.textContent = isGalleryViewEnabled ? '🖼️ List View' : '🖼️ Gallery View';
                toggleGalleryViewBtn.title = isGalleryViewEnabled ? 'Switch to List View' : 'Switch to Gallery View';
                rebuildSchoolListHTML();
            });

            if (toggleSatelliteViewBtn) {
                toggleSatelliteViewBtn.addEventListener('click', () => {
                    if (!map) return;
                    isSatelliteViewEnabled = !isSatelliteViewEnabled;
                    if (isSatelliteViewEnabled) {
                        map.setMapTypeId(google.maps.MapTypeId.SATELLITE);
                        toggleSatelliteViewBtn.textContent = '🗺️ Roadmap View';
                        toggleSatelliteViewBtn.title = 'Switch to Roadmap View';
                    } else {
                        map.setMapTypeId(google.maps.MapTypeId.ROADMAP);
                        toggleSatelliteViewBtn.textContent = '🛰️ Satellite View';
                        toggleSatelliteViewBtn.title = 'Switch to Satellite View';
                    }
                });
            }

            const checkAllMajorAreasBtn = document.getElementById('checkAllMajorAreasBtn');
            checkAllMajorAreasBtn.addEventListener('change', (event) => {
                const isChecked = event.target.checked;
                document.querySelectorAll('#major-summary-table tbody input[type="checkbox"]').forEach(cb => {
                    const area = cb.dataset.majorArea;
                    majorAreaFilterState[area] = isChecked;
                    cb.checked = isChecked;
                });
                updateMarkersVisibility();
            });

            let schoolListUl = schoolListCollapsibleContentDiv.querySelector('ul');
            if (!schoolListUl) {
                schoolListUl = document.createElement('ul');
                schoolListCollapsibleContentDiv.insertBefore(schoolListUl, document.getElementById('no-results-message'));
            }
            schoolListUl.setAttribute('tabindex', '-1');

           const primarySortTargetSelect = document.getElementById('primarySortTarget');
            const collegeSortOptionsContainer = document.getElementById('collegeSortOptionsContainer');
            const studentSortOptionsContainer = document.getElementById('studentSortOptionsContainer');
            const collegeSortSelect = document.getElementById('collegeSortSelect');
            const studentSortSelect = document.getElementById('studentSortSelect');

            if (currentPrimarySortTarget === 'students') {
                studentSortOptionsContainer.style.display = 'block';
                collegeSortOptionsContainer.style.display = 'none';
            } else {
                studentSortOptionsContainer.style.display = 'none';
                collegeSortOptionsContainer.style.display = 'block';
            }

            primarySortTargetSelect.addEventListener('change', (event) => {
                currentPrimarySortTarget = event.target.value;
                if (currentPrimarySortTarget === 'students') {
                    studentSortOptionsContainer.style.display = 'block';
                    collegeSortOptionsContainer.style.display = 'none';
                } else { 
                    studentSortOptionsContainer.style.display = 'none';
                    collegeSortOptionsContainer.style.display = 'block';
                }
                sortAndRebuildList();
            });

            collegeSortSelect.addEventListener('change', (event) => {
                currentCollegeSortValue = event.target.value;
                if (currentPrimarySortTarget === 'colleges') {
                    sortAndRebuildList();
                }
            });

            studentSortSelect.addEventListener('change', (event) => {
                currentStudentSortValue = event.target.value;

                sortAndRebuildList();
            });

            const assignedCoordinatesCount = {}; 

            allMarkers = new Array(allData.length).fill(null);
            allData.forEach((seniorChoice) => {
                 const index = seniorChoice.originalIndex;
                 let lat = seniorChoice.lat;
                 let lng = seniorChoice.lng;
                 const originalCoordKey = `${seniorChoice.lat},${seniorChoice.lng}`; 

                 if (seniorChoice.lat !== 0 || seniorChoice.lng !== 0) {
                    if (assignedCoordinatesCount[originalCoordKey]) {
                        const count = assignedCoordinatesCount[originalCoordKey];
                        const offsetMagnitude = 0.00002 * Math.sqrt(count); 
                        const angleIncrement = Math.PI / 3; 
                        const angle = (count * angleIncrement);
                        lat += offsetMagnitude * Math.cos(angle);
                        lng += offsetMagnitude * Math.sin(angle);
                        assignedCoordinatesCount[originalCoordKey]++;
                    } else {
                        assignedCoordinatesCount[originalCoordKey] = 1;
                    }
                 }

                 const markerInitialIcon = getMarkerIcon(seniorChoice, false, isDarkMode);
                 const marker = new google.maps.Marker({
                     position: { lat: lat, lng: lng },
                     title: `${seniorChoice.seniorName} (${seniorChoice.gradClass}) → ${seniorChoice.collegeName} (${seniorChoice.major || 'Undecided Major'})`,
                     icon: markerInitialIcon,
                 });
                 allMarkers[index] = { marker: marker, school: seniorChoice };

                                  marker.addListener("click", () => {
                     const clickedOriginalIndex = index; 
                     const clickedSchoolData = allData[clickedOriginalIndex];
                     if (!clickedSchoolData || !clickedSchoolData.isVisible) return;

                     if (infowindow && infowindow.getMap()) { infowindow.close(); }

                     let contentString = `<div class="info-window-content">`;
                     const targetUrl = clickedSchoolData.collegeHomepageUrl && clickedSchoolData.collegeHomepageUrl !== '#' ? clickedSchoolData.collegeHomepageUrl : '#';
                     const openInNewTab = targetUrl !== '#' ? 'target="_blank"' : '';

                     if (clickedSchoolData.collegeImageUrl && clickedSchoolData.collegeImageUrl !== 'x' && !clickedSchoolData.collegeImageUrl.startsWith('placeholder')) {
                         contentString += `<a href="${targetUrl}" ${openInNewTab}><img src="${clickedSchoolData.collegeImageUrl}" alt="${clickedSchoolData.collegeName} logo/photo"></a>`;
                     }

                     if (targetUrl !== '#') {
                        contentString += `<b><a href="${targetUrl}" ${openInNewTab}>${clickedSchoolData.collegeName}</a></b>`;
                     } else {
                        contentString += `<b>${clickedSchoolData.collegeName}</b>`;
                     }
                     contentString += `<br><span class="info-window-type">Type: ${clickedSchoolData.collegeType} (${clickedSchoolData.isCampusPublic ? 'Public' : 'Private'}, ${clickedSchoolData.locationFocus})</span>`;
                     if (clickedSchoolData.lat !== 0 || clickedSchoolData.lng !== 0) {
                        contentString += `<br><a href="https://www.google.com/maps/dir/?api=1&destination=${clickedSchoolData.lat},${clickedSchoolData.lng}" target="_blank">Get Directions</a>`;
                     }
                     contentString += `<hr style="margin: 5px 0;">`;

                     if (clickedSchoolData.collegeName === "Undecided") {
                        const suffixHtml = getHonorarySuffixHTML(clickedSchoolData.collegeNameRaw);
                        contentString += `<b>${clickedSchoolData.seniorName}</b>${suffixHtml}`;
                        contentString += `<br><span class="info-window-grad-class" style="color: ${gradClassColors[clickedSchoolData.gradClass] || '#ccc'};">Class: ${clickedSchoolData.gradClass}</span>`;
                        contentString += `<br>Major: ${clickedSchoolData.major || 'Undecided Major'} (${clickedSchoolData.majorArea || 'N/A'})`;
                     } else {
                        const studentsAtSameCollege = allData.filter(s =>
                            s.isVisible &&
                            s.collegeName === clickedSchoolData.collegeName && 
                            s.collegeName !== "Undecided"
                        ).sort((a, b) => { 
                            if (a.gradClass !== b.gradClass) return a.gradClass.localeCompare(b.gradClass);
                            const lastNameA = getLastName(a.seniorName);
                            const lastNameB = getLastName(b.seniorName);
                            if (lastNameA !== lastNameB) return lastNameA.localeCompare(lastNameB);
                            return getFirstName(a.seniorName).localeCompare(getFirstName(b.seniorName));
                        });

                        if (studentsAtSameCollege.length > 0) {
                            contentString += `<u>Students Attending (Visible):</u><ul style="margin-top: 3px; margin-bottom: 3px; padding-left: 18px;">`;
                            studentsAtSameCollege.forEach(student => {
                                const suffixHtml = getHonorarySuffixHTML(student.collegeNameRaw);
                                 let studentEntry = `<li>`;
            if (student.originalIndex === clickedOriginalIndex) studentEntry += `<b>`;
            studentEntry += `${student.seniorName}${suffixHtml} <span class="info-window-grad-class" style="color: ${gradClassColors[student.gradClass] || '#ccc'};">(${student.gradClass})</span>`;

            if (student.linkedInUrl) {
                studentEntry += `<a href="${student.linkedInUrl}" target="_blank" title="LinkedIn Profile" class="social-icon-link">${createSocialLinkSVG('linkedin', 16, isDarkMode)}</a>`;
            }
            if (student.instagramUrl) {
                studentEntry += `<a href="${student.instagramUrl}" target="_blank" title="Instagram Profile" class="social-icon-link">${createSocialLinkSVG('instagram', 16, isDarkMode)}</a>`;
            }

            if (student.originalIndex === clickedOriginalIndex) studentEntry += `</b>`;
            studentEntry += `<br><small style="padding-left: 10px;">Major: ${student.major || 'Undecided'} (${student.majorArea || 'N/A'})</small>`;
            studentEntry += `</li>`;
            contentString += studentEntry;
                            });
                            contentString += `</ul>`;
                        } else {
                            contentString += `No other visible students found for this college with current filters.`;
                        }
                     }
                     contentString += `</div>`;

                     infowindow.setContent(contentString);
                     infowindow.open({ map: map, anchor: marker });

                     const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${clickedOriginalIndex}"]`);
                     showSeniorPhotoPopup(listItem, clickedSchoolData); 
                     showDistanceToNestm(clickedSchoolData);

                     const visibleListItems = getVisibleListItemsDOM();
                     currentListSelectionIndex = visibleListItems.findIndex(li => parseInt(li.dataset.originalIndex) === clickedOriginalIndex);

                    if (activeHoverMarkerIndex !== null && activeHoverMarkerIndex !== clickedOriginalIndex && allMarkers[activeHoverMarkerIndex]?.marker && allData[activeHoverMarkerIndex]) {
                        allMarkers[activeHoverMarkerIndex].marker.setIcon(getMarkerIcon(allData[activeHoverMarkerIndex], false, isDarkMode));
                        allMarkers[activeHoverMarkerIndex].marker.setZIndex(null);
                    }
                    marker.setIcon(getMarkerIcon(clickedSchoolData, true, isDarkMode));
                    marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                    activeHoverMarkerIndex = clickedOriginalIndex;

                    updateCurrentSelectionHighlight();
                 });

                                  marker.addListener('mouseover', () => {
                     if (panelJustToggledOpen) return; 

                     const schoolData = allData[index]; 
                     if (schoolData.isVisible) {
                        document.getElementById('searchSuggestions').style.display = 'none';
                        const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);

                        showSeniorPhotoPopup(listItem, schoolData); 

                        marker.setIcon(getMarkerIcon(schoolData, true, isDarkMode));
                        marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
                     }
                 });
                 marker.addListener('mouseout', () => {
                    const schoolData = allData[index];
                    const listItem = schoolListCollapsibleContentDiv.querySelector(`li[data-original-index="${index}"]`);
                    if (listItem) {
                         listItem.classList.remove('list-item-highlight');
                    }
                    if (activeHoverMarkerIndex !== index) {
                         marker.setIcon(getMarkerIcon(schoolData, false, isDarkMode));
                         marker.setZIndex(null);
                    }
                 });
            });

            const homeIconPath = 'M12 2L2 7v13h6v-7h8v7h6V7L12 2z';
            nestmMarker = new google.maps.Marker({
                position: NEST_M_INFO,
                map: map,
                title: "NEST+m High School",
                icon: {
                    path: homeIconPath,
                    fillColor: '#8A2BE2', // Purple
                    fillOpacity: 1,
                    strokeWeight: 1,
                    strokeColor: '#FFFFFF',
                    scale: 1.2,
                    anchor: new google.maps.Point(12, 22)
                },
                zIndex: 999
            });

            nestmMarker.addListener('click', () => {
                if (infowindow) infowindow.close();
                let content = `
                    <div class="info-window-content">
                        <a href="${NEST_M_INFO.homepageUrl}" target="_blank">
                            <img src="${NEST_M_INFO.imageUrl}" alt="NEST+m Logo" style="max-width: 150px; margin-bottom: 10px;">
                        </a>
                        <b><a href="${NEST_M_INFO.homepageUrl}" target="_blank">${NEST_M_INFO.name}</a></b>
                        <br>
                        <span class="info-window-type">${NEST_M_INFO.type}</span>
                    </div>`;
                infowindow.setContent(content);
                infowindow.open(map, nestmMarker);
            });

            toggleNestmBtn.addEventListener('click', () => {
                const isVisible = !nestmMarker.getVisible();
                nestmMarker.setVisible(isVisible);
                toggleNestmBtn.textContent = isVisible ? '🦅 Hide NEST+m' : '🦅 Show NEST+m';
                if (!isVisible) {
                    if (distancePolyline) distancePolyline.setMap(null);
                    if (distanceLabel) distanceLabel.setMap(null);
                }
            });

            const customClusterRenderer = {
              render: ({ count, position, markers }) => {
                let color = "red"; 
                let diameter = 50;
                let labelColor = "white";
                let labelFontSize = "12px";
                let labelFontWeight = "bold";

                if (count <= 5) { 
                  color = "green";
                  diameter = 30;
                  labelFontSize = "10px";
                  labelFontWeight = "normal";
                } else if (count <= 10) { 
                  color = "#90EE90"; 
                  diameter = 35;
                  labelColor = "black"; 
                  labelFontSize = "11px";
                  labelFontWeight = "normal";
                } else if (count <= 20) { 
                  color = "yellow";
                  diameter = 40;
                  labelColor = "black"; 
                  labelFontSize = "12px";
                } else if (count <= 50) { 
                  color = "orange";
                  diameter = 45;
                  labelFontSize = "12px";
                }

                const svg = window.btoa(`
                  <svg xmlns="http://www.w3.org/2000/svg" width="${diameter}" height="${diameter}" viewBox="0 0 ${diameter} ${diameter}">
                    <circle cx="${diameter / 2}" cy="${diameter / 2}" r="${diameter / 2 * 0.9}" fill="${color}" stroke="rgba(0,0,0,0.3)" stroke-width="${Math.max(1, diameter * 0.04)}"/>
                  </svg>`);

                return new google.maps.Marker({
                  position,
                  icon: {
                    url: `data:image/svg+xml;base64,${svg}`,
                    scaledSize: new google.maps.Size(diameter, diameter),
                    anchor: new google.maps.Point(diameter / 2, diameter / 2) 
                  },
                  label: {
                    text: String(count),
                    color: labelColor,
                    fontSize: labelFontSize,
                    fontWeight: labelFontWeight,
                  },
                  zIndex: 100 + count, 
                });
              },
            };

            if (typeof markerClusterer !== 'undefined' && markerClusterer.MarkerClusterer) {
                const initialMapMarkersForClustering = allMarkers
                    .filter(mInfo => {
                        if (!mInfo || !mInfo.marker || !mInfo.school) return false;
                        const originalSchoolData = allData[mInfo.school.originalIndex]; 
                        if (originalSchoolData.lat === 0 && originalSchoolData.lng === 0) return false;
                        return originalSchoolData.isVisible;
                    })
                    .map(mInfo => mInfo.marker);

                markerClustererInstance = new markerClusterer.MarkerClusterer({
                    map: map,
                    markers: initialMapMarkersForClustering,
                    renderer: customClusterRenderer,
                    maxZoom: 16 
                });
            } else {
                console.error("MarkerClusterer library is not loaded correctly! Markers will not be clustered.");
                allMarkers.forEach(mInfo => {
                    if (mInfo && mInfo.marker && mInfo.school) {
                        const originalSchoolData = allData[mInfo.school.originalIndex];
                         if (originalSchoolData.isVisible && !(originalSchoolData.lat === 0 && originalSchoolData.lng === 0)) {
                            mInfo.marker.setMap(map);
                        }
                    }
                });
            }

            darkModeToggle.addEventListener('click', () => {
                 isDarkMode = !isDarkMode; document.body.classList.toggle('dark-mode', isDarkMode);
                 map.setOptions({ styles: isDarkMode ? darkMapStyle : null });
                 allMarkers.forEach((mInfo, idx) => {
                     if (mInfo && mInfo.marker && mInfo.school) {
                         const currentSchoolData = allData[idx]; 
                         const isHighlighted = activeHoverMarkerIndex === idx;
                         mInfo.marker.setIcon(getMarkerIcon(currentSchoolData, isHighlighted, isDarkMode));
                     }
                 });
                 darkModeToggle.textContent = isDarkMode ? '☀️ Light Mode' : '🌙 Dark Mode';
                 darkModeToggle.title = isDarkMode ? 'Light Mode' : 'Dark Mode';

                  rebuildSchoolListHTML(); 

                   if (infowindow && infowindow.getMap()) {

                    infowindow.close(); 
                }

                  if (allData && allData.length > 0) { 
                    const majorAreaData = aggregateMajorAreaTrends(allData);
                    if (document.getElementById('majorAreaTrendChart') && majorAreaData.categories.length > 0) {
                         renderMajorAreaTrendChart(majorAreaData.trends, majorAreaData.years, majorAreaData.categories, isDarkMode);
                    }

                    const locationFocusData = aggregateLocationFocusTrends(allData);
                     if (document.getElementById('locationFocusTrendChart') && locationFocusData.categories.length > 0) {
                        renderLocationFocusTrendChart(locationFocusData.trends, locationFocusData.years, locationFocusData.categories, isDarkMode);
                    }

                    const popularCollegesData = aggregatePopularCollegeTrends(allData, 5);
                    if (document.getElementById('popularCollegesTrendChart') && popularCollegesData.categories.length > 0) {
                        renderPopularCollegesTrendChart(popularCollegesData.trends, popularCollegesData.years, popularCollegesData.categories, isDarkMode);
                    }
                }
            });

            const debouncedSearch = debounce(handleSearchInput, 250);
            schoolSearchInput.addEventListener('input', debouncedSearch);
            document.addEventListener('click', (event) => {
                 const searchContainer = document.getElementById('schoolSearchContainer');
                 const suggestionsDiv = document.getElementById('searchSuggestions');
                 if (searchContainer && suggestionsDiv &&
                     !searchContainer.contains(event.target) &&
                     !suggestionsDiv.contains(event.target)) {
                     suggestionsDiv.style.display = 'none';
                 }
            });

            checkAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = true; cb.checked = true; });
                 updateMarkersVisibility();
            });
            uncheckAllGradClassesBtn.addEventListener('click', () => {
                 gradClassFiltersContainer.querySelectorAll('.filter-item input[type="checkbox"]').forEach(cb => { gradClassFilterState[cb.value] = false; cb.checked = false; });
                 updateMarkersVisibility();
            });

            const resizer = document.getElementById('panel-resizer');
            const controlPanel = document.getElementById('controls-and-list-container');
            const mapDisplayPanel = document.getElementById('map');

            const isDesktopViewInitial = window.innerWidth > 768;
            if (isDesktopViewInitial) {
                const savedDesktopWidth = localStorage.getItem('controlPanelWidthDesktop');
                if (savedDesktopWidth) {
                    controlPanel.style.width = savedDesktopWidth;
                } else {
                    controlPanel.style.width = '30%'; 
                }

                controlPanel.style.height = '100%';
                mapDisplayPanel.style.height = '100%';
            } else {

                controlPanel.style.width = ''; 
                controlPanel.style.height = '100%'; 
                mapDisplayPanel.style.height = '100%'; 
            }

            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                const isMobileViewCurrent = window.innerWidth <= 768;

                if (isMobileViewCurrent) {
                    return;
                }

                startX = e.clientX;
                startWidth = parseInt(window.getComputedStyle(controlPanel).width, 10);

                document.documentElement.addEventListener('mousemove', doDrag, false);
                document.documentElement.addEventListener('mouseup', stopDrag, false);
                document.body.style.userSelect = 'none';
                document.body.style.pointerEvents = 'none'; 
                mapDisplayPanel.style.pointerEvents = 'none';
                controlPanel.style.pointerEvents = 'none';
            });

            function doDrag(e) {

                const isMobileViewCurrent = window.innerWidth <= 768;
                if (isMobileViewCurrent) return; 

                let newWidth = startWidth + e.clientX - startX;
                const containerWidth = document.getElementById('map-container').offsetWidth;
                const minWidth = parseFloat(getComputedStyle(controlPanel).minWidth) || 200;
                const maxWidthPercentage = 0.60; 
                newWidth = Math.max(minWidth, newWidth);
                newWidth = Math.min(newWidth, containerWidth * maxWidthPercentage);
                controlPanel.style.width = newWidth + 'px';
            }

            function stopDrag() {
                document.documentElement.removeEventListener('mousemove', doDrag, false);
                document.documentElement.removeEventListener('mouseup', stopDrag, false);
                document.body.style.userSelect = '';
                document.body.style.pointerEvents = '';
                mapDisplayPanel.style.pointerEvents = '';
                controlPanel.style.pointerEvents = '';

                if (window.innerWidth > 768) {
                    localStorage.setItem('controlPanelWidthDesktop', controlPanel.style.width);
                }

                if (map && google && google.maps && google.maps.event) {
                    google.maps.event.trigger(map, 'resize'); 
                }
            }

           document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                    exitZoomMode(true);
                    event.preventDefault();
                } else if (faqPopup && faqPopup.style.display !== 'none') { 
                    const closeFaqFunc = () => { 
                        if (faqPopup) faqPopup.style.display = 'none';
                        if (faqOverlay) faqOverlay.style.display = 'none';

                    };
                    closeFaqFunc();
                    event.preventDefault();
                } else if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                    hideSeniorPhotoPopup();
                    event.preventDefault();
                } else if (infowindow && infowindow.getMap()) {
                    infowindow.close();
                    event.preventDefault();
                }
            } else if (seniorPopupImage && seniorPopupImage.classList.contains('zoomed')) {
                if (event.key === 'ArrowLeft') {
                    navigateToSeniorPhoto('prev');
                    event.preventDefault();
                } else if (event.key === 'ArrowRight') {
                    navigateToSeniorPhoto('next');
                    event.preventDefault();
                }
            } else if (document.activeElement !== schoolSearchInput && 
                       !(faqPopup && faqPopup.style.display !== 'none') && 
                       !(seniorPopupImage && seniorPopupImage.classList.contains('zoomed'))) {
                if (event.key === 'ArrowDown') {
                    navigateList('down');
                    event.preventDefault();
                } else if (event.key === 'ArrowUp') {
                    navigateList('up');
                    event.preventDefault();
                }
            }
        });
            if (allData && allData.length > 0) {
                const majorAreaData = aggregateMajorAreaTrends(allData);
                if (document.getElementById('majorAreaTrendChart') && majorAreaData.categories.length > 0) {
                     renderMajorAreaTrendChart(majorAreaData.trends, majorAreaData.years, majorAreaData.categories, isDarkMode);
                }

                const locationFocusData = aggregateLocationFocusTrends(allData);
                if (document.getElementById('locationFocusTrendChart') && locationFocusData.categories.length > 0) {
                    renderLocationFocusTrendChart(locationFocusData.trends, locationFocusData.years, locationFocusData.categories, isDarkMode);
                }

                const popularCollegesData = aggregatePopularCollegeTrends(allData, 5); 
                if (document.getElementById('popularCollegesTrendChart') && popularCollegesData.categories.length > 0) {
                    renderPopularCollegesTrendChart(popularCollegesData.trends, popularCollegesData.years, popularCollegesData.categories, isDarkMode);
                }
            }

            rebuildSchoolListHTML(); 
            updateMarkersVisibility(); 

             const showFaqBtn = document.getElementById('showFaqBtn');
            const faqPopup = document.getElementById('faq-popup');
            const faqOverlay = document.getElementById('faq-overlay');
            const closeFaqPopupBtn = document.getElementById('close-faq-popup');

            if (showFaqBtn && faqPopup && faqOverlay && closeFaqPopupBtn) {
                showFaqBtn.addEventListener('click', () => {
                    faqPopup.style.display = 'flex'; 
                    faqOverlay.style.display = 'block';

                });

                const closeFaq = () => {
                    faqPopup.style.display = 'none';
                    faqOverlay.style.display = 'none';

                };

                closeFaqPopupBtn.addEventListener('click', closeFaq);
                faqOverlay.addEventListener('click', (event) => {

                    if (event.target === faqOverlay) {
                        closeFaq();
                    }
                });

            } else {
                console.warn("FAQ popup elements not found. FAQ functionality will be disabled.");
            }
        }

      const menuToggleBtn  = document.getElementById('menu-toggle');
const controlsPanel  = document.getElementById('controls-and-list-container');
const panelResizer   = document.getElementById('panel-resizer');

function handleMenuToggle() {
    const isMobileView      = window.innerWidth <= 768;
    const menuToggleBtn     = document.getElementById('menu-toggle');
    const controlsPanelEl   = document.getElementById('controls-and-list-container');
    const panelResizerEl    = document.getElementById('panel-resizer');

    panelJustToggledOpen = false;
    if (panelToggleTimeout) clearTimeout(panelToggleTimeout);

    if (isMobileView) {

        controlsPanelEl.classList.toggle('panel-mobile-open');
        controlsPanelEl.classList.remove('panel-desktop-hidden');

        if (controlsPanelEl.classList.contains('panel-mobile-open')) {           
            panelResizerEl.style.display  = 'flex';
            panelResizerEl.style.position = 'absolute';
            const panelWidth = controlsPanelEl.offsetWidth;
            panelResizerEl.style.left   = `${panelWidth}px`;
            panelResizerEl.style.top    = '0';
            panelResizerEl.style.height = `${controlsPanelEl.offsetHeight}px`;
            panelResizerEl.style.zIndex =
                (parseInt(window.getComputedStyle(controlsPanelEl).zIndex) || 0) + 1;
        } else {                                                                 
            panelResizerEl.style.display = 'none';
        }

        if (menuToggleBtn) menuToggleBtn.style.left = '.75rem';

        if (controlsPanelEl.classList.contains('panel-mobile-open') &&
            seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
            hideSeniorPhotoPopup();
        }

    } else {
        controlsPanelEl.classList.toggle('panel-desktop-hidden');
        const panelIsHidden = controlsPanelEl.classList.contains('panel-desktop-hidden');

        if (panelIsHidden) {
            panelResizerEl.style.display = 'none';
            panelResizerEl.classList.add('resizer-desktop-hidden');
            if (menuToggleBtn) menuToggleBtn.style.left = '.75rem';

            if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible') &&
                currentlyZoomedSeniorOriginalIndex !== null &&
                seniorPopupImage && !seniorPopupImage.classList.contains('zoomed')) {
                const item = document.querySelector(
                  `.list-content li[data-original-index="${currentlyZoomedSeniorOriginalIndex}"]`);
                if (item) showSeniorPhotoPopup(item, allData[currentlyZoomedSeniorOriginalIndex]);
            }

        } else {
            panelResizerEl.style.display = 'flex';
            panelResizerEl.style.position = '';
            panelResizerEl.style.left   = '';
            panelResizerEl.style.top    = '';
            panelResizerEl.style.height = '100%';
            panelResizerEl.classList.remove('resizer-desktop-hidden');

            if (menuToggleBtn) {
                const panelWidth = controlsPanelEl.offsetWidth;

                const cs = window.getComputedStyle(panelResizerEl);
                let resizerWidth = parseFloat(cs.width);
                if (isNaN(resizerWidth) || resizerWidth === 0) resizerWidth = 14;

                menuToggleBtn.style.left = `${panelWidth + resizerWidth + 12}px`;
            }

            if (seniorPhotoPopup && seniorPhotoPopup.classList.contains('visible')) {
                hideSeniorPhotoPopup();
                panelJustToggledOpen = true;
                panelToggleTimeout   = setTimeout(() => { panelJustToggledOpen = false; }, 300);
            }
        }

        setTimeout(() => {
            if (window.map && google?.maps?.event) {
                google.maps.event.trigger(window.map, 'resize');
            }
        }, 310); 
    }
}

if (menuToggleBtn && controlsPanel && panelResizer) {
    menuToggleBtn.addEventListener('click', handleMenuToggle);
}
function initPhotoNavArrows() {
  if (!prevSeniorPhotoBtn.dataset.listenerAdded) {
    prevSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('prev'));
    prevSeniorPhotoBtn.dataset.listenerAdded = 'true';
  }
  if (!nextSeniorPhotoBtn.dataset.listenerAdded) {
    nextSeniorPhotoBtn.addEventListener('click', () => navigateToSeniorPhoto('next'));
    nextSeniorPhotoBtn.dataset.listenerAdded = 'true';
  }
}

function adjustLayoutOnResize() {
    const isMobileView = window.innerWidth <= 768;
    const menuToggleBtn = document.getElementById('menu-toggle');
    const mapDisplayPanel = document.getElementById('map');
    const controlPanel = document.getElementById('controls-and-list-container');
    const panelResizerEl = document.getElementById('panel-resizer');

    if (isMobileView) {

        controlPanel.classList.remove('panel-desktop-hidden'); 

        if (controlPanel.classList.contains('panel-mobile-open')) {
            panelResizerEl.style.display = 'flex'; 
            panelResizerEl.style.position = 'absolute'; 
            const panelWidth = controlPanel.offsetWidth;
            panelResizerEl.style.left = `${panelWidth}px`; 
            panelResizerEl.style.top = '0px'; 
            panelResizerEl.style.height = controlPanel.offsetHeight + 'px'; 
            panelResizerEl.style.zIndex = (parseInt(window.getComputedStyle(controlPanel).zIndex) || 1000) + 1; 
        } else {
            panelResizerEl.style.display = 'none'; 
        }

        if (menuToggleBtn) {
            menuToggleBtn.style.left = '.75rem'; 

        }
        if (mapDisplayPanel) mapDisplayPanel.style.height = '100%';
        if (controlPanel) {
            controlPanel.style.height = '100%';
            controlPanel.style.width = ''; 
        }

    } else { 
        if (controlPanel.classList.contains('panel-desktop-hidden')) {
            panelResizerEl.style.display = 'none';
            if (panelResizerEl) panelResizerEl.classList.add('resizer-desktop-hidden'); 
        } else {
            panelResizerEl.style.display = 'flex';
            panelResizerEl.style.position = ''; 
            panelResizerEl.style.left = '';     
            panelResizerEl.style.top = '';      
            panelResizerEl.style.height = '100%';
             if (panelResizerEl) panelResizerEl.classList.remove('resizer-desktop-hidden'); 
        }

        controlPanel.classList.remove('panel-mobile-open'); 

        if (menuToggleBtn) {
            if (controlPanel.classList.contains('panel-desktop-hidden')) {
                menuToggleBtn.style.left = '.75rem';
            } else {
                const panelWidth = controlPanel.offsetWidth;
                const resizerCurrentDisplay = window.getComputedStyle(panelResizerEl).display;

                const resizerWidth = (resizerCurrentDisplay !== 'none' && panelResizerEl.offsetWidth) ? panelResizerEl.offsetWidth : 14; 

                menuToggleBtn.style.left = `${panelWidth + resizerWidth + 12}px`; 
            }
        }
        if (mapDisplayPanel) mapDisplayPanel.style.height = '100%';
        if (controlPanel) {
            controlPanel.style.height = '100%';
        }
    }

    setTimeout(() => {
        if (window.map && typeof google !== 'undefined' && google.maps && google.maps.event) {
            google.maps.event.trigger(window.map, 'resize');
        }
    }, 50); 
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

window.addEventListener('resize', debounce(adjustLayoutOnResize, 200));

document.addEventListener('DOMContentLoaded', () => {

    setTimeout(() => {
        adjustLayoutOnResize();

    }, 0);

    const panelResizerElement = document.getElementById('panel-resizer');
    const controlsPanelElement = document.getElementById('controls-and-list-container');

    if (panelResizerElement && controlsPanelElement) {
        panelResizerElement.addEventListener('mousedown', function(e) {
            const isMobileView = window.innerWidth <= 768;
            const isPanelDesktopHidden = controlsPanelElement.classList.contains('panel-desktop-hidden');

            if (isMobileView || isPanelDesktopHidden) {
                return;
            }

        });
    }
});

        function updateCheckAllLocationFocusButtonState() {
            const checkAllBtn = document.getElementById('checkAllLocationFocusBtn');
            if (!checkAllBtn) return;
            const allFocusCheckboxes = document.querySelectorAll('.location-focus-filter');
            if (allFocusCheckboxes.length === 0) {
                 checkAllBtn.checked = true;
                 checkAllBtn.indeterminate = false;
                 return;
            }
            const allChecked = Array.from(allFocusCheckboxes).every(cb => cb.checked);
            const noneChecked = Array.from(allFocusCheckboxes).every(cb => !cb.checked);

            if (allChecked) {
                checkAllBtn.checked = true;
                checkAllBtn.indeterminate = false;
            } else if (noneChecked) {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = false;
            } else {
                checkAllBtn.checked = false;
                checkAllBtn.indeterminate = true;
            }
        }

        function gmLoadError() {
            console.error("Google Maps failed to load.");
            document.getElementById('map').innerHTML = '<p style="padding: 20px; text-align: center; color: red; background-color: #ffebee;">Error: Could not load Google Maps. Please check your API key and ensure the Maps JavaScript API is enabled.</p>';
            const controlsContainer = document.getElementById('controls-and-list-container');
            if (controlsContainer) {
                controlsContainer.style.opacity = '0.5';
                controlsContainer.style.pointerEvents = 'none';
            }
            window.isDataReadyForMap = false;
        }

        (function attachZoomDebugging () {
  const img = document.querySelector('#senior-photo-popup img');

  if (!img) {
    console.warn('[SeniorPhotoDebug] <img> not found – debug hooks not attached.');
    return;
  }

  img.addEventListener('mouseenter', () => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Hover-in on zoomed image – size:',
                  img.getBoundingClientRect());
    }
  });

  img.addEventListener('mouseleave', () => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Hover-out on zoomed image');
    }
  });

  const observer = new MutationObserver(() => {
    if (img.classList.contains('zoomed')) {
      console.log('[SeniorPhotoDebug] Entered zoomed mode – size:',
                  img.getBoundingClientRect());
    }
  });
  observer.observe(img, { attributes:true, attributeFilter:['class'] });
})();
    </script>

   <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVEZB2WjUpEhqnqGjY_zMCQSKUHTdjAWc&callback=initializeApp&onerror=gmLoadError&v=weekly&libraries=geometry"
    defer
></script>

 <div id="zoomed-info-panel" style="display: none;">

    <div id="zoomed-grad-class-info" style="display: none;">
        <span class="grad-class-label">Graduating Class:</span>
        <span id="zoomed-grad-class-value"></span>
    </div>

    <p id="zoomed-bio-caption-content"></p>
    <div id="zoomed-social-links-container">

    </div>
</div>

</body>
</html>

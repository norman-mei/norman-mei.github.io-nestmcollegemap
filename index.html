<!DOCTYPE html>
<html lang="en">

   
     <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
     <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

     <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEST+m Senior College Destinations [React/Tailwind]</title>
    <link rel="icon" href="photos/favicon/favicon.jpg" type="image/png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Your Data Scripts (Unchanged) -->
    <script src="collegeCoordsAndInfo.js"></script>
    <script src="majorToAreaMapping.js"></script>
    <script src="normalizeCollegeName.js"></script>

    <!-- Google Maps API (will be loaded by the React app) -->
    <!-- Note: The Google Maps script is now loaded dynamically in the React component -->

    <script>
        // Tailwind Customizations (Optional)
        // You can add custom theme values or plugins here if needed.
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'nestm-purple': '#8A2BE2',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans overflow-hidden">
    <div id="root"></div>

    <!-- The entire application logic is now here, written in React with JSX -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- Constants & Helper Functions (from original project) ---

        const NEST_M_INFO = { name: "NEST+m", lat: 40.71956425410874, lng: -73.97923619240517, type: "Public K-12 School" };
        const NYC_BOUNDS = { north: 40.92, south: 40.47, west: -74.26, east: -73.70 };
        const PREDEFINED_MAJOR_AREAS = ["Engineering", "Physical Sciences", "Life Sciences", "Business/Economics", "Humanities", "Social Sciences", "Arts/Design", "Health Sciences", "Education", "Undecided/Other", "Other"].sort();
        const gradClassColors = { "'21": "#00FFFF", "'22": "#FF0000", "'23": "#99CC00", "'24": "#FFBB33", "'25": "#007FFF" };
        const gradClassNames = Object.keys(gradClassColors);

        // Note: All helper functions like getCollegeProperties, getMajorArea, etc., are placed here
        // so they are available to the React components without cluttering them.
        function getCollegeProperties(collegeEntry) {
            let isCampusPublic = false;
            if (["SUNY", "CUNY", "Other Public", "Purdue"].includes(collegeEntry.type)) {
                isCampusPublic = true;
            }
            let locationFocus = "N/A";
            if (collegeEntry.name === "Undecided") {
                locationFocus = "N/A";
            } else if (collegeEntry.lat >= NYC_BOUNDS.south && collegeEntry.lat <= NYC_BOUNDS.north && collegeEntry.lng >= NYC_BOUNDS.west && collegeEntry.lng <= NYC_BOUNDS.east) {
                locationFocus = "InCityNYC";
            } else if (collegeEntry.stateOrCountry === "NY") {
                locationFocus = "InStateNYOther";
            } else if (["USA", "US"].includes(collegeEntry.country) || collegeEntry.stateOrCountry?.length === 2) {
                locationFocus = "OutOfStateUS";
            } else {
                locationFocus = "International";
            }
            return { isCampusPublic, locationFocus };
        }

        function getMajorArea(specificMajor) {
            if (!specificMajor) return "Unknown";
            const lowerSpecificMajor = specificMajor.toLowerCase().trim();
            if (["", "undecided", "undecided major", "n/a", "exploratory"].includes(lowerSpecificMajor)) {
                return "Undecided/Other";
            }
            for (const key in majorToAreaMapping) {
                if (key.toLowerCase() === lowerSpecificMajor) {
                    return majorToAreaMapping[key];
                }
            }
            // Simplified logic for combined majors and keyword matching
            if (lowerSpecificMajor.includes("engineering")) return "Engineering";
            if (lowerSpecificMajor.includes("computer sci")) return "Computer Science & IT";
            if (lowerSpecificMajor.includes("business") || lowerSpecificMajor.includes("econ")) return "Business/Economics";
            if (lowerSpecificMajor.includes("art") || lowerSpecificMajor.includes("design")) return "Arts/Design";
            // Add more rules as needed...
            return "Other";
        }

        function getFirstName(seniorName) {
            return seniorName ? seniorName.split(' ')[0] : "";
        }

        function getLastName(seniorName) {
            if (!seniorName) return "";
            const parts = seniorName.split(' ');
            return parts.length > 1 ? parts[parts.length - 1] : parts[0];
        }

        // --- React Hooks ---

        function useDarkMode() {
            const [isDarkMode, setIsDarkMode] = useState(() => localStorage.getItem('isDarkMode') === 'true');
            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDarkMode);
                localStorage.setItem('isDarkMode', isDarkMode ? 'true' : 'false');
            }, [isDarkMode]);
            return [isDarkMode, setIsDarkMode];
        }

        function useGoogleMapsApi(apiKey) {
            const [isLoaded, setIsLoaded] = useState(false);
            useEffect(() => {
                if (window.google && window.google.maps) {
                    setIsLoaded(true);
                    return;
                }
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry,places,marker&callback=initMap`;
                script.async = true;
                window.initMap = () => setIsLoaded(true);
                document.head.appendChild(script);
                return () => { delete window.initMap; };
            }, [apiKey]);
            return isLoaded;
        }
        
        // --- React Components ---

        function MapContainer({ seniors, isDarkMode, onMarkerClick, activeSenior }) {
            const mapRef = useRef(null);
            const googleMapRef = useRef(null);
            const markersRef = useRef([]);
            const infoWindowRef = useRef(null);

            // Initialize map
            useEffect(() => {
                if (!mapRef.current || googleMapRef.current) return;
                const map = new window.google.maps.Map(mapRef.current, {
                    center: { lat: 40.7, lng: -74 },
                    zoom: 7,
                    gestureHandling: 'greedy',
                    styles: isDarkMode ? darkMapStyle : [],
                    mapTypeControl: false,
                    streetViewControl: false,
                });
                googleMapRef.current = map;
                infoWindowRef.current = new window.google.maps.InfoWindow();
            }, [isDarkMode]); // Re-init map style on dark mode change

            // Update markers
            useEffect(() => {
                if (!googleMapRef.current || !seniors) return;

                // Clear existing markers
                markersRef.current.forEach(marker => marker.setMap(null));
                markersRef.current = [];

                const assignedCoords = {};
                seniors.forEach(senior => {
                    if (!senior.collegeInfo || !senior.collegeInfo.lat) return;

                    let { lat, lng } = senior.collegeInfo;
                    const coordKey = `${lat},${lng}`;
                    if(assignedCoords[coordKey]) {
                        const offset = 0.0001 * Math.sqrt(assignedCoords[coordKey]);
                        const angle = assignedCoords[coordKey] * (Math.PI / 4);
                        lat += offset * Math.cos(angle);
                        lng += offset * Math.sin(angle);
                        assignedCoords[coordKey]++;
                    } else {
                        assignedCoords[coordKey] = 1;
                    }

                    const marker = new window.google.maps.Marker({
                        position: { lat, lng },
                        map: googleMapRef.current,
                        title: `${senior.name} -> ${senior.college}`,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: gradClassColors[senior.gradClass] || '#CCC',
                            fillOpacity: 1,
                            strokeColor: isDarkMode ? '#111' : '#fff',
                            strokeWeight: 1.5,
                            scale: 7,
                        }
                    });

                    marker.addListener('click', () => {
                        onMarkerClick(senior);
                    });
                    markersRef.current.push(marker);
                });
            }, [seniors, isDarkMode, onMarkerClick]);

            // Pan map to active senior
            useEffect(() => {
                if (activeSenior && activeSenior.collegeInfo && googleMapRef.current) {
                    const { lat, lng } = activeSenior.collegeInfo;
                    googleMapRef.current.panTo({ lat, lng });
                    googleMapRef.current.setZoom(Math.max(googleMapRef.current.getZoom(), 12));
                    
                    const infoWindow = infoWindowRef.current;
                    const content = `
                        <div class="p-1">
                            <h3 class="font-bold text-black">${activeSenior.college}</h3>
                            <p class="text-sm text-gray-700">${activeSenior.name} (${activeSenior.gradClass})</p>
                        </div>`;
                    infoWindow.setContent(content);
                    const marker = markersRef.current.find(m => m.getTitle() === `${activeSenior.name} -> ${activeSenior.college}`);
                    if(marker) infoWindow.open(googleMapRef.current, marker);
                }
            }, [activeSenior]);

            const darkMapStyle = [{"elementType":"geometry","stylers":[{"color":"#242f3e"}]},{"elementType":"labels.text.stroke","stylers":[{"color":"#242f3e"}]},{"elementType":"labels.text.fill","stylers":[{"color":"#746855"}]},{"featureType":"administrative.locality","elementType":"labels.text.fill","stylers":[{"color":"#d59563"}]},{"featureType":"poi","elementType":"labels.text.fill","stylers":[{"color":"#d59563"}]},{"featureType":"poi.park","elementType":"geometry","stylers":[{"color":"#263c3f"}]},{"featureType":"poi.park","elementType":"labels.text.fill","stylers":[{"color":"#6b9a76"}]},{"featureType":"road","elementType":"geometry","stylers":[{"color":"#38414e"}]},{"featureType":"road","elementType":"geometry.stroke","stylers":[{"color":"#212a37"}]},{"featureType":"road","elementType":"labels.text.fill","stylers":[{"color":"#9ca5b3"}]},{"featureType":"road.highway","elementType":"geometry","stylers":[{"color":"#746855"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"color":"#1f2835"}]},{"featureType":"road.highway","elementType":"labels.text.fill","stylers":[{"color":"#f3d19c"}]},{"featureType":"transit","elementType":"geometry","stylers":[{"color":"#2f3948"}]},{"featureType":"transit.station","elementType":"labels.text.fill","stylers":[{"color":"#d59563"}]},{"featureType":"water","elementType":"geometry","stylers":[{"color":"#17263c"}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"color":"#515c6d"}]},{"featureType":"water","elementType":"labels.text.stroke","stylers":[{"color":"#17263c"}]}];

            return <div ref={mapRef} className="w-full h-full" />;
        }

        function App() {
            const [isDarkMode, setIsDarkMode] = useDarkMode();
            const [allData, setAllData] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isPanelOpen, setIsPanelOpen] = useState(window.innerWidth > 768);
            const [searchQuery, setSearchQuery] = useState("");
            const [activeSenior, setActiveSenior] = useState(null);

            // IMPORTANT: Replace with your actual key
            const GOOGLE_MAPS_API_KEY = "YOUR_GOOGLE_MAPS_API_KEY_HERE";
            const mapsApiLoaded = useGoogleMapsApi(GOOGLE_MAPS_API_KEY);

            // Fetch and process data
            useEffect(() => {
                async function fetchData() {
                    try {
                        const response = await fetch('jsonData.json');
                        const jsonData = await response.json();
                        
                        const processedData = jsonData.map((entry, index) => {
                            const collegeInfo = collegeCoordsAndInfo[normalizeCollegeName(entry.college)] || {};
                            const properties = getCollegeProperties(collegeInfo);
                            return {
                                ...entry,
                                id: index,
                                gradClass: `'${entry.classYear}`,
                                collegeInfo: collegeInfo,
                                ...properties,
                                majorArea: getMajorArea(entry.major),
                            };
                        });
                        setAllData(processedData);
                    } catch (error) {
                        console.error("Failed to fetch or process senior data:", error);
                    } finally {
                        setIsLoading(false);
                    }
                }
                fetchData();
            }, []);

            const filteredSeniors = useMemo(() => {
                if (!searchQuery) return allData;
                const lowerCaseQuery = searchQuery.toLowerCase();
                return allData.filter(senior =>
                    senior.name.toLowerCase().includes(lowerCaseQuery) ||
                    senior.college.toLowerCase().includes(lowerCaseQuery) ||
                    (senior.major && senior.major.toLowerCase().includes(lowerCaseQuery))
                );
            }, [allData, searchQuery]);

            const handleSeniorSelect = useCallback((senior) => {
                setActiveSenior(senior);
                if (window.innerWidth < 768) {
                    setIsPanelOpen(false);
                }
            }, []);

            if (isLoading) {
                return (
                    <div className="flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900">
                        <div className="text-2xl font-semibold text-gray-700 dark:text-gray-300 animate-pulse">Loading Destinations...</div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen w-screen">
                    {/* Side Panel */}
                    <div className={`
                        flex flex-col
                        absolute lg:relative z-20 h-full w-11/12 md:w-96
                        bg-white dark:bg-gray-800 shadow-lg
                        transform transition-transform duration-300 ease-in-out
                        ${isPanelOpen ? 'translate-x-0' : '-translate-x-full'}
                    `}>
                        <div className="p-4 border-b dark:border-gray-700">
                            <h1 className="text-2xl font-bold text-purple-600 dark:text-purple-400">NEST+m Destinations</h1>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Showing {filteredSeniors.length} of {allData.length} seniors.</p>
                            <input
                                type="text"
                                placeholder="Search by name, college, major..."
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                className="w-full mt-3 p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500"
                            />
                        </div>
                        
                        <div className="flex-grow overflow-y-auto">
                            <ul>
                                {filteredSeniors.map(senior => (
                                    <li 
                                        key={senior.id}
                                        onClick={() => handleSeniorSelect(senior)}
                                        className={`
                                            p-3 cursor-pointer border-b dark:border-gray-700
                                            hover:bg-purple-50 dark:hover:bg-gray-700 transition-colors duration-150
                                            ${activeSenior && activeSenior.id === senior.id ? 'bg-purple-100 dark:bg-gray-600' : ''}
                                        `}
                                    >
                                        <div className="flex justify-between items-center">
                                            <p className="font-semibold text-gray-800 dark:text-gray-100">{senior.name}</p>
                                            <span className="text-xs font-bold" style={{ color: gradClassColors[senior.gradClass] }}>{senior.gradClass}</span>
                                        </div>
                                        <p className="text-sm text-gray-600 dark:text-gray-300">{senior.college}</p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400 italic">{senior.major || 'Undecided'}</p>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>

                    {/* Map Area */}
                    <div className="relative flex-grow">
                        <button 
                            onClick={() => setIsPanelOpen(!isPanelOpen)}
                            className="absolute top-4 left-4 z-30 p-2 bg-white dark:bg-gray-700 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all"
                        >
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                        </button>
                        
                        <button 
                            onClick={() => setIsDarkMode(!isDarkMode)}
                            className="absolute top-4 right-4 z-10 p-2 bg-white dark:bg-gray-700 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
                        >
                            {isDarkMode ? '☀️' : '🌙'}
                        </button>

                        {mapsApiLoaded ? (
                            <MapContainer 
                                seniors={filteredSeniors} 
                                isDarkMode={isDarkMode}
                                onMarkerClick={handleSeniorSelect}
                                activeSenior={activeSenior}
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full bg-gray-200 dark:bg-gray-700">
                                <div className="text-lg animate-pulse">Loading Map...</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Render the App
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>


</html>
